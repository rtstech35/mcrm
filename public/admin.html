<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007bff">
    <title>Admin Panel - Saha CRM</title>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/mobile.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/admin-orders.js"></script>

</head>
<body>
    <!-- User Profile Dropdown -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px;">
        <div onclick="toggleProfileMenu()" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
            <div>
                <div id="userName" style="font-weight: 600; color: #2d3748; font-size: 0.9em;">Kullanıcı</div>
                <div id="currentDateTime" style="font-size: 0.75em; color: #666; margin-top: 2px;">--</div>
            </div>
            <div style="color: #666; font-size: 0.8em;">▼</div>
        </div>
        <div id="profileMenu" style="display: none; border-top: 1px solid #e2e8f0; padding: 8px 0;">
            <a href="#" onclick="openProfile()" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; text-decoration: none; color: #2d3748; font-size: 0.875em;">
                <span>👤</span> Profil
            </a>
            <a href="#" onclick="logout()" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; text-decoration: none; color: #2d3748; font-size: 0.875em;">
                <span>🚪</span> Çıkış
            </a>
        </div>
    </div>
<body>
    <div class="header">
        <h1>Admin Panel - Saha CRM</h1>
    </div>

    <div class="container">
        <div class="sidebar" style="background: #007bff; position: fixed; width: 280px; height: 100vh; overflow-y: auto;">
            <h3 style="color: white; padding: 0 1.5rem; margin-bottom: 1rem;">Menü</h3>
            <ul id="adminMenu" style="list-style: none; padding: 0; padding-left: 1.5rem;">
                <li data-key="admin_dashboard"><a href="#" onclick="showDashboard()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📊 Dashboard</a></li>
                <li data-key="admin_users"><a href="#" onclick="showUsers()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">👥 Kullanıcılar</a></li>
                <li data-key="admin_customers"><a href="#" onclick="showCustomers()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🏢 Müşteriler</a></li>
                <li data-key="admin_products"><a href="#" onclick="showProducts()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📦 Ürünler</a></li>
                <li data-key="admin_orders"><a href="#" onclick="showOrders()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📋 Siparişler</a></li>
                <li data-key="admin_departments"><a href="#" onclick="showDepartments()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🏢 Departmanlar</a></li>
                <li data-key="admin_roles"><a href="#" onclick="showRoles()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🔐 Roller</a></li>
                <li data-key="admin_permissions"><a href="#" onclick="showPermissions()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🔑 Yetki Yönetimi</a></li>
                <li data-key="admin_delivery_notes"><a href="#" onclick="showDeliveryNotes()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📋 İrsaliyeler</a></li>
                <li data-key="admin_appointments"><a href="#" onclick="showAppointments()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📅 Randevular</a></li>
                <li data-key="admin_accounts"><a href="#" onclick="showCariHesap()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">💰 Cari Hesap</a></li>
                <li data-key="admin_mail_settings"><a href="mail-settings.html" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">📧 Mail Ayarları</a></li>
                <li data-key="admin_setup"><a href="setup.html" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🔧 Sistem Kurulumu</a></li>
                <li data-key="admin_map"><a href="/map.html" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🗺️ Harita</a></li>
                <li data-key="admin_api_test"><a href="#" onclick="testAPI()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🧪 API Test</a></li>
                <li data-key="admin_test_data"><a href="#" onclick="createTestData()" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.5rem 0;">🎯 Test Verilerini Oluştur</a></li>
                <li data-key="logout"><a href="#" onclick="logout()" style="margin-top: 2rem; color: rgba(255,255,255,0.6); text-decoration: none; display: block; padding: 0.5rem 0;">🚺 Çıkış</a></li>
            </ul>
            
        </div>

        <div class="content" id="content" style="margin-left: 280px; padding: 2rem; min-height: 100vh;">
            <div class="card">
                <h2>Dashboard</h2>
                <p>Admin paneline hoş geldiniz!</p>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h3>👤 Profil Bilgileri</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label>Ad Soyad:</label>
                    <input type="text" id="profile_full_name" required>
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="profile_email" required>
                </div>
                <div class="form-group">
                    <label>Yeni Şifre (isteğe bağlı):</label>
                    <input type="password" id="new_password">
                </div>
                <div class="form-group">
                    <label>Yeni Şifre Tekrar:</label>
                    <input type="password" id="confirm_password">
                </div>
                <button type="submit" class="btn">Güncelle</button>
            </form>
        </div>
    </div>
    <!-- Ürün Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h3>Yeni Ürün</h3>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.875rem;">
                <strong>💡 İpucu:</strong> KDV alanları görünmüyorsa, Setup sayfasından "Ürün KDV Düzelt" butonunu kullanın.
            </div>
            <form id="productForm">
                <div class="form-group">
                    <label>Ürün Adı:</label>
                    <input type="text" id="product_name" required>
                </div>
                <div class="form-group">
                    <label>Açıklama:</label>
                    <input type="text" id="product_description">
                </div>
                <div class="form-group">
                    <label>Birim Fiyat (KDV Hariç):</label>
                    <input type="number" id="product_unit_price" step="0.01" required onchange="calculateVAT()">
                </div>
                <div class="form-group">
                    <label>KDV Oranı (%) <small style="color: #666;">(opsiyonel)</small>:</label>
                    <select id="vat_rate" onchange="calculateVAT()">
                        <option value="0">%0</option>
                        <option value="1">%1</option>
                        <option value="10">%10</option>
                        <option value="20" selected>%20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Birim Fiyat (KDV Dahil) <small style="color: #666;">(otomatik hesaplanır)</small>:</label>
                    <input type="number" id="price_with_vat" step="0.01" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>Birim:</label>
                    <select id="product_unit" required>
                        <option value="adet">Adet</option>
                        <option value="kg">Kilogram</option>
                        <option value="lt">Litre</option>
                        <option value="m">Metre</option>
                        <option value="m2">Metrekare</option>
                    </select>
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Kullanıcı Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userModal')">&times;</span>
            <h3 id="userModalTitle">Yeni Kullanıcı</h3>
            <form id="userForm">
                <div class="form-group">
                    <label>Kullanıcı Adı:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Ad Soyad:</label>
                    <input type="text" id="full_name" required>
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="text" id="phone">
                </div>
                <div class="form-group">
                    <label>Şifre:</label>
                    <input type="password" id="password" autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label>Departman:</label>
                    <select id="department_id" required></select>
                </div>
                <div class="form-group">
                    <label>Rol:</label>
                    <select id="role_id" required onchange="showTargetFields()"></select>
                </div>
                
                <!-- Hedef Bilgileri -->
                <div id="targetSection" style="border-top: 1px solid #ddd; margin-top: 20px; padding-top: 20px; display: none;">
                    <h4>📊 Aylık Hedefler (Mevcut Ay)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div class="form-group">
                            <label>Satış Hedefi (₺):</label>
                            <input type="number" id="user_target_sales" placeholder="500000" step="1000">
                        </div>
                        <div class="form-group">
                            <label>Ziyaret Hedefi (Adet):</label>
                            <input type="number" id="user_target_visits" placeholder="50" min="0">
                        </div>
                        <div class="form-group">
                            <label>Üretim Hedefi (Adet):</label>
                            <input type="number" id="user_target_production" placeholder="100" min="0">
                        </div>
                        <div class="form-group">
                            <label>Sevkiyat Hedefi (Adet):</label>
                            <input type="number" id="user_target_shipping" placeholder="120" min="0">
                        </div>
                        <div class="form-group">
                            <label>Ciro Hedefi (₺):</label>
                            <input type="number" id="user_target_revenue" placeholder="1000000" step="1000">
                        </div>
                        <div class="form-group">
                            <label>Tahsilat Hedefi (₺):</label>
                            <input type="number" id="user_target_collection" placeholder="400000" step="1000">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Departman Modal -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('departmentModal')">&times;</span>
            <h3>Yeni Departman</h3>
            <form id="departmentForm">
                <div class="form-group">
                    <label>Departman Adı:</label>
                    <input type="text" id="department_name" required>
                </div>
                <div class="form-group">
                    <label>Açıklama:</label>
                    <textarea id="department_description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Müşteri Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
            <h3>Yeni Müşteri</h3>
            <form id="customerForm">
                <div class="form-group">
                    <label>Şirket Adı:</label>
                    <input type="text" id="customer_company_name" required>
                </div>
                <div class="form-group">
                    <label>Yetkili Kişi:</label>
                    <input type="text" id="customer_contact_person" required>
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="customer_phone" required>
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="customer_email">
                </div>
                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="customer_address" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Satış Temsilcisi:</label>
                    <select id="customer_sales_rep"></select>
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Hedef Modal -->
    <div id="targetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('targetModal')">&times;</span>
            <h3 id="targetModalTitle">Hedef Düzenle</h3>
            <form id="targetEditForm">
                <div class="form-group">
                    <label>Kullanıcı:</label>
                    <input type="text" id="target_user_name" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>Aylık Satış Hedefi (TL):</label>
                    <input type="number" id="target_monthly_sales" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Aylık Üretim Hedefi:</label>
                    <input type="number" id="target_monthly_production" step="1" required>
                </div>
                <div class="form-group">
                    <label>Aylık Gelir Hedefi (TL):</label>
                    <input type="number" id="target_monthly_revenue" step="0.01" required>
                </div>
                <button type="submit" class="btn">Güncelle</button>
            </form>
        </div>
    </div>

    <!-- Cari Hesap İşlem Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transactionModal')">&times;</span>
            <h3>Yeni Cari Hesap İşlemi</h3>
            <form id="transactionForm">
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="transaction_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>İşlem Tipi:</label>
                    <select id="transaction_type" required>
                        <option value="">Seçiniz</option>
                        <option value="debit">Borç</option>
                        <option value="credit">Alacak</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tutar (TL):</label>
                    <input type="number" id="transaction_amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>İşlem Tarihi:</label>
                    <input type="date" id="transaction_date" required>
                </div>
                <div class="form-group">
                    <label>Açıklama:</label>
                    <textarea id="transaction_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Referans No:</label>
                    <input type="text" id="transaction_reference">
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Rol Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('roleModal')">&times;</span>
            <h3 id="roleModalTitle">Yeni Rol</h3>
            <form id="roleForm">
                <div class="form-group">
                    <label>Rol Adı: <span style="color: red;">*</span></label>
                    <input type="text" id="role_name" required placeholder="Örn: Sales Manager">
                    <div class="form-help">Rol adı benzersiz olmalıdır</div>
                </div>

                <div class="form-group">
                    <label>Açıklama: <span style="color: red;">*</span></label>
                    <textarea id="role_description" rows="3" required placeholder="Bu rolün yetkilerini ve sorumluluklarını açıklayın..."></textarea>
                    <div class="form-help">Rolün ne yapabileceğini detaylı olarak açıklayın</div>
                </div>

                <div class="form-group">
                    <label>Yetki Seviyesi:</label>
                    <select id="role_level">
                        <option value="1">Seviye 1 - Viewer (Sadece Görüntüleme)</option>
                        <option value="2">Seviye 2 - Employee (Temel İşlemler)</option>
                        <option value="3">Seviye 3 - Manager (Yönetim Yetkileri)</option>
                        <option value="4">Seviye 4 - Admin (Tüm Yetkiler)</option>
                    </select>
                    <div class="form-help">Yetki seviyesi rolün sistem erişimini belirler</div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="role_active" checked>
                        Aktif Rol
                    </label>
                    <div class="form-help">Pasif roller kullanıcılara atanamaz</div>
                </div>

                <input type="hidden" id="role_edit_id">
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Departman Modal -->
    <div id="departmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('departmentModal')">&times;</span>
            <h3 id="departmentModalTitle">Yeni Departman</h3>
            <form id="departmentEditForm">
                <div class="form-group">
                    <label>Departman Adı: <span style="color: red;">*</span></label>
                    <input type="text" id="dept_name" required placeholder="Örn: Satış Departmanı">
                    <div class="form-help">Departman adı benzersiz olmalıdır</div>
                </div>

                <div class="form-group">
                    <label>Açıklama: <span style="color: red;">*</span></label>
                    <textarea id="dept_description" rows="3" required placeholder="Bu departmanın görevlerini ve sorumluluklarını açıklayın..."></textarea>
                    <div class="form-help">Departmanın ne yaptığını detaylı olarak açıklayın</div>
                </div>

                <div class="form-group">
                    <label>Departman Kodu:</label>
                    <input type="text" id="dept_code" placeholder="Örn: SALES, PROD, SHIP" maxlength="10">
                    <div class="form-help">Kısa kod (opsiyonel, raporlarda kullanılır)</div>
                </div>

                <div class="form-group">
                    <label>Departman Yöneticisi:</label>
                    <select id="dept_manager_id">
                        <option value="">Yönetici Seçiniz (Opsiyonel)</option>
                    </select>
                    <div class="form-help">Bu departmanın sorumlu yöneticisi</div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="dept_active" checked>
                        Aktif Departman
                    </label>
                    <div class="form-help">Pasif departmanlara kullanıcı atanamaz</div>
                </div>

                <input type="hidden" id="dept_id">
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Hedef Modal -->
    <div id="targetModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('targetModal')">&times;</span>
            <h3 id="targetModalTitle">Kullanıcı Hedefi Belirle</h3>
            <form id="targetForm">
                <div class="form-group">
                    <label>Kullanıcı: <span style="color: red;">*</span></label>
                    <select id="target_user_id" required>
                        <option value="">Kullanıcı Seçiniz</option>
                    </select>
                    <div class="form-help">Hedef belirlenecek kullanıcıyı seçin</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Hedef Yılı:</label>
                        <select id="target_year" required>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Hedef Ayı:</label>
                        <select id="target_month" required>
                            <option value="1">Ocak</option>
                            <option value="2">Şubat</option>
                            <option value="3">Mart</option>
                            <option value="4">Nisan</option>
                            <option value="5">Mayıs</option>
                            <option value="6">Haziran</option>
                            <option value="7">Temmuz</option>
                            <option value="8">Ağustos</option>
                            <option value="9">Eylül</option>
                            <option value="10">Ekim</option>
                            <option value="11">Kasım</option>
                            <option value="12">Aralık</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Satış Hedefi (TL):</label>
                        <input type="number" id="target_sales" step="0.01" min="0" placeholder="0.00">
                        <div class="form-help">Aylık satış tutarı hedefi</div>
                    </div>

                    <div class="form-group">
                        <label>Ziyaret Hedefi:</label>
                        <input type="number" id="target_visits" min="0" placeholder="0">
                        <div class="form-help">Aylık müşteri ziyaret sayısı</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Üretim Hedefi (Adet):</label>
                        <input type="number" id="target_production" min="0" placeholder="0">
                        <div class="form-help">Aylık üretim adet hedefi</div>
                    </div>

                    <div class="form-group">
                        <label>Ciro Hedefi (TL):</label>
                        <input type="number" id="target_revenue" step="0.01" min="0" placeholder="0.00">
                        <div class="form-help">Aylık toplam ciro hedefi</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tahsilat Hedefi (TL):</label>
                    <input type="number" id="target_collection" step="0.01" min="0" placeholder="0.00">
                    <div class="form-help">Aylık tahsilat tutarı hedefi</div>
                </div>

                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="target_notes" rows="3" placeholder="Hedef ile ilgili notlarınızı yazın..."></textarea>
                    <div class="form-help">Hedef hakkında ek bilgiler</div>
                </div>

                <input type="hidden" id="target_id">
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- İrsaliye Modal -->
    <div id="deliveryNoteModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('deliveryNoteModal')">&times;</span>
            <h3 id="deliveryNoteModalTitle">Yeni İrsaliye</h3>
            <form id="deliveryNoteForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>İrsaliye No: <span style="color: red;">*</span></label>
                        <input type="text" id="delivery_number" required placeholder="Otomatik oluşturulacak" readonly>
                        <div class="form-help">Sistem tarafından otomatik oluşturulur</div>
                    </div>

                    <div class="form-group">
                        <label>Sipariş:</label>
                        <select id="delivery_order_id">
                            <option value="">Sipariş Seçiniz (Opsiyonel)</option>
                        </select>
                        <div class="form-help">Hangi siparişe ait irsaliye</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Müşteri: <span style="color: red;">*</span></label>
                        <select id="delivery_customer_id" required>
                            <option value="">Müşteri Seçiniz</option>
                        </select>
                        <div class="form-help">Teslimat yapılacak müşteri</div>
                    </div>

                    <div class="form-group">
                        <label>Sevkiyat Personeli:</label>
                        <select id="delivery_delivered_by">
                            <option value="">Personel Seçiniz</option>
                        </select>
                        <div class="form-help">Teslimatı yapacak personel</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Teslimat Tarihi: <span style="color: red;">*</span></label>
                        <input type="date" id="delivery_date" required>
                        <div class="form-help">Planlanan teslimat tarihi</div>
                    </div>

                    <div class="form-group">
                        <label>Teslimat Saati:</label>
                        <input type="time" id="delivery_time">
                        <div class="form-help">Planlanan teslimat saati</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Teslimat Adresi:</label>
                    <textarea id="delivery_address" rows="2" placeholder="Teslimat yapılacak adres..."></textarea>
                    <div class="form-help">Müşteri adresinden farklıysa belirtin</div>
                </div>

                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="delivery_notes" rows="3" placeholder="İrsaliye ile ilgili notlar..."></textarea>
                    <div class="form-help">Teslimat sırasında dikkat edilecek hususlar</div>
                </div>

                <div class="form-group">
                    <label>Dahili Notlar:</label>
                    <textarea id="delivery_internal_notes" rows="2" placeholder="Sadece personelin göreceği notlar..."></textarea>
                    <div class="form-help">Bu notlar müşteri tarafından görülmez</div>
                </div>

                <input type="hidden" id="delivery_note_id">
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- İmza Görüntüleme Modal -->
    <div id="signatureModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('signatureModal')">&times;</span>
            <h3>Dijital İmza</h3>
            <div id="signatureContent">
                <!-- İmza içeriği buraya yüklenecek -->
            </div>
        </div>
    </div>

    <!-- Sipariş Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h3>Yeni Sipariş</h3>
            <form id="orderForm">
                <div class="form-group">
                    <label>Sipariş No:</label>
                    <input type="text" id="order_number" required>
                </div>
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="order_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Satış Temsilcisi:</label>
                    <select id="order_sales_rep_id"></select>
                </div>
                <div class="form-group">
                    <label>Sipariş Tarihi:</label>
                    <input type="date" id="order_date" required>
                </div>
                <div class="form-group">
                    <label>Toplam Tutar:</label>
                    <input type="number" id="order_total_amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="order_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Randevu Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('appointmentModal')">&times;</span>
            <h3 id="appointmentModalTitle">Yeni Randevu</h3>
            <form id="appointmentForm">
                <div class="form-group">
                    <label>Başlık: <span style="color: red;">*</span></label>
                    <input type="text" id="appointment_title" required placeholder="Randevu başlığı...">
                    <div class="form-help">Randevunun kısa açıklaması</div>
                </div>

                <div class="form-group">
                    <label>Açıklama:</label>
                    <textarea id="appointment_description" rows="3" placeholder="Detaylı açıklama..."></textarea>
                    <div class="form-help">Randevu hakkında ek bilgiler</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Tür: <span style="color: red;">*</span></label>
                        <select id="appointment_type" required>
                            <option value="">Tür Seçiniz</option>
                            <option value="appointment">📅 Randevu</option>
                            <option value="task">✅ Görev</option>
                            <option value="visit">🏢 Ziyaret</option>
                            <option value="call">📞 Arama</option>
                            <option value="meeting">👥 Toplantı</option>
                        </select>
                        <div class="form-help">Randevu türünü seçin</div>
                    </div>

                    <div class="form-group">
                        <label>Öncelik:</label>
                        <select id="appointment_priority">
                            <option value="low">🟢 Düşük</option>
                            <option value="medium" selected>🟡 Orta</option>
                            <option value="high">🟠 Yüksek</option>
                            <option value="urgent">🔴 Acil</option>
                        </select>
                        <div class="form-help">Öncelik seviyesi</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Başlangıç Tarihi: <span style="color: red;">*</span></label>
                        <input type="date" id="appointment_start_date" required>
                        <div class="form-help">Randevu tarihi</div>
                    </div>

                    <div class="form-group">
                        <label>Başlangıç Saati:</label>
                        <input type="time" id="appointment_start_time">
                        <div class="form-help">Randevu saati (opsiyonel)</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Bitiş Tarihi:</label>
                        <input type="date" id="appointment_end_date">
                        <div class="form-help">Bitiş tarihi (opsiyonel)</div>
                    </div>

                    <div class="form-group">
                        <label>Bitiş Saati:</label>
                        <input type="time" id="appointment_end_time">
                        <div class="form-help">Bitiş saati (opsiyonel)</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="appointment_all_day">
                        Tüm Gün
                    </label>
                    <div class="form-help">Bu randevu tüm gün sürecek</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Atanan Kişi: <span style="color: red;">*</span></label>
                        <select id="appointment_assigned_to" required>
                            <option value="">Kişi Seçiniz</option>
                        </select>
                        <div class="form-help">Randevudan sorumlu kişi</div>
                    </div>

                    <div class="form-group">
                        <label>Müşteri:</label>
                        <select id="appointment_customer_id">
                            <option value="">Müşteri Seçiniz (Opsiyonel)</option>
                        </select>
                        <div class="form-help">İlgili müşteri</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Konum:</label>
                    <input type="text" id="appointment_location" placeholder="Randevu yeri...">
                    <div class="form-help">Randevunun yapılacağı yer</div>
                </div>

                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="appointment_address" rows="2" placeholder="Detaylı adres..."></textarea>
                    <div class="form-help">Konum adresi</div>
                </div>

                <div class="form-group">
                    <label>Hatırlatma:</label>
                    <select id="appointment_reminder_minutes">
                        <option value="0">Hatırlatma Yok</option>
                        <option value="5">5 dakika önce</option>
                        <option value="15" selected>15 dakika önce</option>
                        <option value="30">30 dakika önce</option>
                        <option value="60">1 saat önce</option>
                        <option value="1440">1 gün önce</option>
                    </select>
                    <div class="form-help">Ne kadar önce hatırlatma gönderilsin</div>
                </div>

                <input type="hidden" id="appointment_id">
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        // Global profile functions
        window.toggleProfileMenu = function() {
            const menu = document.getElementById('profileMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        };

        window.updateDateTime = function() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR');
            const timeStr = now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
            
            const userNameEl = document.getElementById('userName');
            const dateTimeEl = document.getElementById('currentDateTime');
            
            if (userNameEl) {
                let welcomeName = currentUser.full_name || 'Kullanıcı';
                if (currentUser.role_name) {
                    welcomeName += ` (${currentUser.role_name})`;
                }
                userNameEl.textContent = welcomeName;
            }
            if (dateTimeEl) dateTimeEl.textContent = `${dateStr} - ${timeStr}`;
        };

        window.openProfile = function() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                document.getElementById('profile_full_name').value = currentUser.full_name || '';
                document.getElementById('profile_email').value = currentUser.email || '';
                modal.style.display = 'block';
            }
            toggleProfileMenu();
        };

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            if (newPassword && newPassword !== confirmPassword) {
                alert('Şifreler eşleşmiyor!'); return;
            }
            const formData = {
                full_name: document.getElementById('profile_full_name').value,
                email: document.getElementById('profile_email').value,
            };
            if (newPassword) formData.password = newPassword;
            
            try {
                await apiCall(`/api/users/${currentUser.id}`, { method: 'PUT', body: JSON.stringify(formData) });
                currentUser.full_name = formData.full_name;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                alert('Profil güncellendi!');
                closeModal('profileModal');
                updateDateTime();
            } catch (error) { alert('Güncelleme hatası: ' + error.message); }
        });
    </script>
    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        if (!authToken) {
            window.location.href = '/';
        }

        function setupMenuVisibility() {
            const permissions = currentUser.permissions || {};

            // Admin (permissions.all: true) her şeyi görür
            if (permissions.all === true) {
                console.log('Admin kullanıcısı, tüm menüler gösteriliyor.');
                return;
            }

            console.log('Kullanıcı yetkileri kontrol ediliyor:', permissions);
            const menuItems = document.querySelectorAll('#adminMenu [data-key]');

            menuItems.forEach(item => {
                const key = item.dataset.key;
                // 'logout' gibi anahtar kelimeleri her zaman göster
                if (key && key !== 'logout' && !permissions[key]) {
                    console.log(`🚫 Menü gizleniyor: ${key}`);
                    item.style.display = 'none';
                }
            });
        }

        async function apiCall(url, options = {}) {
            try {
                console.log('🔄 API çağrısı:', url);

                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(url, {
                    ...options,
                    headers: headers
                });

                console.log('📡 API yanıt:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = `API hatası: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.text();
                        try {
                            const jsonError = JSON.parse(errorData);
                            errorMessage = jsonError.message || jsonError.error || errorMessage;
                        } catch {
                            errorMessage = errorData || errorMessage;
                        }
                    } catch (e) {
                        console.log('Hata mesajı okunamadı:', e.message);
                    }
                    console.error('❌ API hatası:', errorMessage);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('✅ API başarılı:', data);
                return data;

            } catch (error) {
                console.error('🚨 API çağrısı başarısız:', error);
                throw error;
            }
        }

        // Test API'sini çağır
        async function testAPI() {
            try {
                console.log('🧪 API Test başlatılıyor...');

                // Önce health check API'sini dene
                const healthResult = await apiCall('/api/health');
                console.log('✅ Health check başarılı:', healthResult);

                let message = '✅ API Test Başarılı!\n\n';
                message += `Database Bağlantısı: ✅ Çalışıyor\n`;
                message += `Tablolar: ${healthResult.tables.length} adet\n`;
                message += `Tablolar: ${healthResult.tables.join(', ')}\n\n`;

                if (healthResult.table_counts) {
                    message += 'Tablo Kayıt Sayıları:\n';
                    Object.entries(healthResult.table_counts).forEach(([table, count]) => {
                        message += `• ${table}: ${count}\n`;
                    });
                }

                alert(message);

            } catch (error) {
                console.error('❌ API Test hatası:', error);

                let errorMessage = '❌ API Test Başarısız!\n\n';
                errorMessage += `Hata: ${error.message}\n\n`;
                errorMessage += 'Muhtemel Çözümler:\n';
                errorMessage += '1. Setup sayfasından database kurulumunu yapın\n';
                errorMessage += '2. Migration\'ları çalıştırın\n';
                errorMessage += '3. Database bağlantısını kontrol edin';

                alert(errorMessage);
            }
        }

        // Test verilerini oluştur
        async function createTestData() {
            if (!confirm('Kapsamlı test verileri oluşturulsun mu?\n\nBu işlem:\n- Test kullanıcıları oluşturacak\n- Örnek müşteriler, ürünler ve cari hesap hareketleri ekleyecek.\n\nNOT: Mevcut veriler silinmez, sadece eksik olanlar eklenir.')) {
                return;
            }

            try {
                console.log('🎯 Kapsamlı test verileri oluşturuluyor...');

                const result = await apiCall('/api/create-comprehensive-data', {
                    method: 'POST'
                });

                let message = '✅ Kapsamlı test verileri başarıyla oluşturuldu!\n\n';
                message += `Kullanıcılar: ${result.stats.users} adet\n`;
                message += `Müşteriler: ${result.stats.customers} adet\n`;
                message += `Ürünler: ${result.stats.products} adet\n`;
                message += `Cari İşlemler: ${result.stats.transactions} adet\n\n`;
                message += 'Sistemi şimdi test edebilirsiniz.';

                alert(message);

            } catch (error) {
                console.error('❌ Test verileri oluşturulamadı:', error);
                alert('❌ Kapsamlı test verileri oluşturulamadı: ' + error.message);
            }
        }

        // Yetki Yönetimi Fonksiyonları
        const allMenuItems = {
            "Admin Paneli": {
                icon: "👑",
                permissions: [
                    { key: 'admin_dashboard', text: 'Dashboard' },
                    { key: 'admin_users', text: 'Kullanıcılar' },
                    { key: 'admin_customers', text: 'Müşteriler' },
                    { key: 'admin_products', text: 'Ürünler' },
                    { key: 'admin_orders', text: 'Siparişler' },
                    { key: 'admin_departments', text: 'Departmanlar' },
                    { key: 'admin_roles', text: 'Roller' },
                    { key: 'admin_permissions', text: 'Yetki Yönetimi' },
                    { key: 'admin_delivery_notes', text: 'İrsaliyeler' },
                    { key: 'admin_appointments', text: 'Randevular' },
                    { key: 'admin_accounts', text: 'Cari Hesap' },
                    { key: 'admin_mail_settings', text: 'Mail Ayarları' },
                    { key: 'admin_setup', text: 'Sistem Kurulumu' },
                    { key: 'admin_map', text: 'Harita' },
                    { key: 'admin_api_test', text: 'API Test' },
                    { key: 'admin_test_data', text: 'Test Verileri Oluştur' },
                ]
            },
            "Satış Paneli": {
                icon: "💼",
                permissions: [
                    { key: 'sales_dashboard', text: 'Dashboard' },
                    { key: 'sales_customers', text: 'Müşteriler' },
                    { key: 'sales_orders', text: 'Siparişler' },
                    { key: 'sales_delivery_notes', text: 'İrsaliyeler' },
                    { key: 'sales_appointments', text: 'Randevu & Görevler' },
                    { key: 'sales_new_visit', text: 'Yeni Ziyaret' },
                    { key: 'sales_accounts', text: 'Cari Hesap' },
                    { key: 'sales_invoices', text: 'Faturalar' },
                    { key: 'sales_map', text: 'Harita' },
                ]
            },
            "Üretim Paneli": {
                icon: "🏭",
                permissions: [
                    { key: 'production_dashboard', text: 'Dashboard' },
                    { key: 'production_orders', text: 'Siparişler' },
                    { key: 'production_customers', text: 'Müşteriler' },
                    { key: 'production_delivery_notes', text: 'İrsaliyeler' },
                ]
            },
            "Sevkiyat Paneli": {
                icon: "🚚",
                permissions: [
                    { key: 'shipping_dashboard', text: 'Dashboard' },
                    { key: 'shipping_delivery_notes', text: 'İrsaliyeler' },
                    { key: 'shipping_map', text: 'Harita' },
                ]
            },
            "Muhasebe Paneli": {
                icon: "💰",
                permissions: [
                    { key: 'accounting_dashboard', text: 'Dashboard' },
                    { key: 'accounting_customers', text: 'Müşteriler' },
                    { key: 'accounting_invoices', text: 'Faturalar' },
                    { key: 'accounting_accounts', text: 'Cari Hesap' },
                    { key: 'accounting_delivery_notes', text: 'İrsaliyeler' },
                ]
            }
        };

        async function showPermissions() {
            try {
                const rolesResponse = await apiCall('/api/roles');
                const roles = rolesResponse.roles.filter(role => role.id !== 1); // Admin rolünü hariç tut
                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>🔑 Yetki Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">Rollerin hangi menüleri ve özellikleri kullanabileceğini buradan ayarlayabilirsiniz.</p>
                            </div>
                        </div>

                        <div class="form-group" style="max-width: 400px; margin-bottom: 2rem;">
                            <label for="permissionRoleSelect" style="font-weight: 600;">Rol Seçin:</label>
                            <select id="permissionRoleSelect" onchange="loadPermissionsForRole(this.value)" class="form-control">
                                <option value="">Rol Seçiniz...</option>
                                ${roles.map(role => `<option value="${role.id}">${role.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div id="permissionsContainer" style="display: none; margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 2rem;"></div>
                        
                        <div id="permissionsActions" style="display: none; margin-top: 2rem; text-align: right;">
                            <button id="savePermissionsBtn" class="btn btn-success" onclick="savePermissions()">
                                💾 Yetkileri Kaydet
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                alert('Roller yüklenemedi: ' + error.message);
            }
        }

        async function loadPermissionsForRole(roleId) {
            const container = document.getElementById('permissionsContainer');
            const actionsDiv = document.getElementById('permissionsActions');
            if (!roleId) {
                container.style.display = 'none';
                actionsDiv.style.display = 'none';
                return;
            }

            try {
                const roleResponse = await apiCall(`/api/roles/${roleId}`);
                const currentPermissions = roleResponse.role.permissions || {};
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">';
                
                for (const panel in allMenuItems) {
                    const panelData = allMenuItems[panel];
                    html += `
                        <div class="permission-panel" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h4 style="margin-top: 0; margin-bottom: 1rem; color: #2d3748; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">${panelData.icon}</span>
                                ${panel} Yetkileri
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    `;
                    panelData.permissions.forEach(item => {
                        const isChecked = currentPermissions[item.key] ? 'checked' : '';
                        html += `
                            <label class="permission-label" style="display: flex; align-items: center; gap: 0.75rem; font-weight: normal; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background-color 0.2s;">
                                <input type="checkbox" class="permission-checkbox" data-key="${item.key}" ${isChecked} style="width: 16px; height: 16px; accent-color: var(--primary);">
                                <span>${item.text}</span>
                            </label>
                        `;
                    });
                    html += '</div></div>';
                }
                html += '</div>';

                container.innerHTML = html;
                container.style.display = 'block';
                actionsDiv.style.display = 'block';

                // Add hover effect to labels
                document.querySelectorAll('.permission-label').forEach(label => {
                    label.addEventListener('mouseover', () => label.style.backgroundColor = '#e9ecef');
                    label.addEventListener('mouseout', () => label.style.backgroundColor = 'transparent');
                });

            } catch (error) {
                alert(`Yetkiler yüklenemedi: ${error.message}`);
            }
        }

        async function savePermissions() {
            const roleId = document.getElementById('permissionRoleSelect').value;
            if (!roleId) return;

            const newPermissions = {};
            document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    newPermissions[checkbox.dataset.key] = true;
                }
            });

            try {
                await apiCall(`/api/roles/${roleId}/permissions`, {
                    method: 'PUT',
                    body: JSON.stringify({ permissions: newPermissions })
                });
                alert('Yetkiler başarıyla güncellendi!');
            } catch (error) {
                alert(`Yetkiler kaydedilemedi: ${error.message}`);
            }
        }

        async function showDashboard() {
            try {
                // Dashboard istatistiklerini çek
                const statsResponse = await apiCall('/api/dashboard/stats');
                const stats = statsResponse.stats || {};

                // Yüzdeleri hesapla
                const salesPercentage = stats.monthlySalesTarget > 0 ?
                    Math.round((stats.currentMonthlySales / stats.monthlySalesTarget) * 100) : 0;

                const visitPercentage = stats.monthlyVisitTarget > 0 ?
                    Math.round((stats.currentMonthlyVisits / stats.monthlyVisitTarget) * 100) : 0;

                const collectionPercentage = stats.monthlyCollectionTarget > 0 ?
                    Math.round((stats.currentMonthlyCollection / stats.monthlyCollectionTarget) * 100) : 0;
                
                document.getElementById('content').innerHTML = `
                    <!-- Üst 3 Blok -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;" id="topStats">
                        <div class="stat-card clickable" onclick="showOrders()">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="stat-number">${(stats.currentMonthlySales || 0).toLocaleString('tr-TR')} ₺</div>
                                    <div class="stat-label">Aylık Satış</div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Hedef: ${(stats.monthlySalesTarget || 0).toLocaleString('tr-TR')} ₺</div>
                                </div>
                                <div style="width: 80px; height: 60px; position: relative;">
                                    <canvas id="salesChart" width="80" height="60" style="border-radius: 8px;"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card clickable" onclick="showAppointments()">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="stat-number">${stats.currentMonthlyVisits || 0}</div>
                                    <div class="stat-label">Aylık Ziyaret</div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Hedef: ${stats.monthlyVisitTarget || 0}</div>
                                </div>
                                <div style="width: 80px; height: 60px; position: relative;">
                                    <canvas id="visitsChart" width="80" height="60" style="border-radius: 8px;"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card clickable" onclick="showCariHesap()">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="stat-number">${(stats.currentMonthlyCollection || 0).toLocaleString('tr-TR')} ₺</div>
                                    <div class="stat-label">Aylık Tahsilat</div>
                                    <div style="font-size: 0.75rem; color: var(--text-light);">Hedef: ${(stats.monthlyCollectionTarget || 0).toLocaleString('tr-TR')} ₺</div>
                                </div>
                                <div style="width: 80px; height: 60px; position: relative;">
                                    <canvas id="collectionChart" width="80" height="60" style="border-radius: 8px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Sipariş Durumu 4 Kutu -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2>📦 Sipariş Durumu</h2>
                            <div style="width: 200px; height: 100px;">
                                <canvas id="ordersDonutChart" width="200" height="100"></canvas>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="stat-card clickable" onclick="showOrders('pending')" style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; position: relative; overflow: hidden;">
                                <div class="stat-number" style="color: white;">${stats.pendingOrders || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Bekleyen</div>
                                <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.3;">⏳</div>
                            </div>
                            <div class="stat-card clickable" onclick="showOrders('production')" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; position: relative; overflow: hidden;">
                                <div class="stat-number" style="color: white;">${stats.productionOrders || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Üretimde</div>
                                <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.3;">⚙️</div>
                            </div>
                            <div class="stat-card clickable" onclick="showOrders('completed')" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; position: relative; overflow: hidden;">
                                <div class="stat-number" style="color: white;">${stats.completedOrders || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Tamamlanan</div>
                                <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.3;">✅</div>
                            </div>
                            <div class="stat-card clickable" onclick="showOrders('delivered')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; position: relative; overflow: hidden;">
                                <div class="stat-number" style="color: white;">${stats.deliveredOrders || 0}</div>
                                <div class="stat-label" style="color: rgba(255,255,255,0.9);">Teslim Edilen</div>
                                <div style="position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.3;">🚚</div>
                            </div>
                        </div>
                    </div>

                    <!-- Randevu Takibi -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2>📅 Bugünkü Randevular</h2>
                            <div style="width: 150px; height: 80px;">
                                <canvas id="appointmentsChart" width="150" height="80"></canvas>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: linear-gradient(90deg, #fff3cd, #ffeaa7); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 1.5rem;">🕰️</div>
                                    <div>
                                        <div style="font-weight: 600;">09:00 - ABC Teknoloji</div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Satış görüşmesi</div>
                                    </div>
                                </div>
                                <span class="status-badge warning">Bekleyen</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: linear-gradient(90deg, #d4edda, #c3e6cb); border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #28a745;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 1.5rem;">✅</div>
                                    <div>
                                        <div style="font-weight: 600;">14:00 - XYZ İnşaat</div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Proje sunumu</div>
                                    </div>
                                </div>
                                <span class="status-badge success">Tamamlandı</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: linear-gradient(90deg, #cce7ff, #b3d9ff); border-radius: 8px; border-left: 4px solid #007bff;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="font-size: 1.5rem;">💼</div>
                                    <div>
                                        <div style="font-weight: 600;">16:30 - DEF Lojistik</div>
                                        <div style="font-size: 0.875rem; color: var(--text-light);">Teknik toplantı</div>
                                    </div>
                                </div>
                                <span class="status-badge info">Devam Eden</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Müşteri Haritası -->
                    <div class="card">
                        <h2>🗺️ Müşteri Haritası</h2>
                        <div id="customerMap" style="height: 400px; border-radius: 12px; overflow: hidden; margin-top: 1rem;"></div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem; font-size: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                                <span>Aktif Müşteri</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                                <span>Potansiyel</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
                                <span>İlgilenmiyor</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Grafikleri çiz
                setTimeout(() => {
                    drawSalesChart(stats.currentMonthlySales || 0, stats.monthlySalesTarget || 100000);
                    drawVisitsChart(stats.currentMonthlyVisits || 0, stats.monthlyVisitTarget || 50);
                    drawCollectionChart(stats.currentMonthlyCollection || 0, stats.monthlyCollectionTarget || 80000);
                    drawOrdersDonutChart(stats);
                    drawAppointmentsChart();
                    initCustomerMap();
                }, 100);
                
            } catch (error) {
                console.error('Dashboard yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>📊 Dashboard</h2>
                        <p>Hoş geldiniz, ${currentUser.full_name}</p>
                        <div style="background: var(--danger-light); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="color: var(--danger-solid); margin: 0;">
                                ⚠️ Dashboard verileri yüklenemedi: ${error.message}
                            </p>
                            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                                Lütfen setup sayfasından database migration'ları çalıştırın.
                            </p>
                        </div>
                        <div style="text-align: center; margin: 2rem 0;">
                            <a href="/setup" class="btn" style="text-decoration: none;">
                                🔧 Setup Sayfasına Git
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        async function showUsers() {
            try {
                const usersResponse = await apiCall('/api/users');
                const rolesResponse = await apiCall('/api/roles');
                const departmentsResponse = await apiCall('/api/departments');
                
                const users = usersResponse.users || [];
                const roles = rolesResponse.roles || [];
                const departments = departmentsResponse.departments || [];
                
                let html = `
                    <div class="card">
                        <h2>Kullanıcı Yönetimi</h2>
                        <button class="btn" onclick="openUserModal()">Yeni Kullanıcı</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Kullanıcı Adı</th>
                                    <th>Ad Soyad</th>
                                    <th>E-posta</th>
                                    <th>Departman</th>
                                    <th>Rol</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                users.forEach(user => {
                    html += `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.full_name}</td>
                            <td>${user.email}</td>
                            <td>${user.department_name || '-'}</td>
                            <td>${user.role_name || '-'}</td>
                            <td>${user.is_active ? 'Aktif' : 'Pasif'}</td>
                            <td>
                                <button class="btn" onclick="editUser(${user.id})">Düzenle</button>
                                <button class="btn btn-danger" onclick="deleteUser(${user.id})">Sil</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
                // Modal için seçenekleri hazırla
                window.rolesData = roles;
                window.departmentsData = departments;
                
            } catch (error) {
                console.error('Kullanıcılar yüklenemedi:', error.message);
                document.getElementById('content').innerHTML = `
                    <div class="card error">
                        <strong>Kullanıcılar Yüklenemedi:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function showCustomers() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                let html = `
                    <div class="card">
                        <h2>Müşteri Yönetimi</h2>
                        <button class="btn" onclick="openCustomerModal()">Yeni Müşteri</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Şirket Adı</th>
                                    <th>Yetkili</th>
                                    <th>Telefon</th>
                                    <th>Satış Temsilcisi</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                customers.forEach(customer => {
                    html += `
                        <tr onclick="viewCustomerDetail(${customer.id})" style="cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                            <td>${customer.id}</td>
                            <td>${customer.company_name}</td>
                            <td>${customer.contact_person || '-'}</td>
                            <td>${customer.phone || '-'}</td>
                            <td>${customer.sales_rep_name || '-'}</td>
                            <td>${customer.customer_status}</td>
                            <td>
                                <button class="btn" onclick="event.stopPropagation(); editCustomer(${customer.id})">Düzenle</button>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCustomer(${customer.id})">Sil</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Müşteriler yüklenemedi:', error.message);
                document.getElementById('content').innerHTML = `
                    <div class="card error">
                        <strong>Müşteriler Yüklenemedi:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function openUserModal() {
            try {
                const [departmentsResponse, rolesResponse] = await Promise.all([
                    apiCall('/api/departments'),
                    apiCall('/api/roles')
                ]);

                window.departmentsData = departmentsResponse.departments || [];
                window.rolesData = rolesResponse.roles || [];

                const departmentSelect = document.getElementById('department_id');
                const roleSelect = document.getElementById('role_id');

                departmentSelect.innerHTML = '';
                departmentSelect.add(new Option('Seçiniz', ''));

                if (window.departmentsData && window.departmentsData.length > 0) {
                    window.departmentsData.forEach(dept => {
                        departmentSelect.add(new Option(dept.name, dept.id));
                    });
                } else {
                    departmentSelect.add(new Option('Satış Departmanı', '1'));
                    departmentSelect.add(new Option('Üretim Departmanı', '2'));
                    departmentSelect.add(new Option('Sevkiyat Departmanı', '3'));
                    departmentSelect.add(new Option('Muhasebe Departmanı', '4'));
                    departmentSelect.add(new Option('IT Departmanı', '5'));
                }

                roleSelect.innerHTML = '';
                roleSelect.add(new Option('Seçiniz', ''));

                if (window.rolesData && window.rolesData.length > 0) {
                    window.rolesData.forEach(role => {
                        roleSelect.add(new Option(role.name, role.id));
                    });
                } else {
                    roleSelect.add(new Option('Yönetici', '1'));
                    roleSelect.add(new Option('Satış Temsilcisi', '2'));
                    roleSelect.add(new Option('Üretim Personeli', '3'));
                    roleSelect.add(new Option('Sevkiyat Personeli', '4'));
                    roleSelect.add(new Option('Muhasebe Personeli', '5'));
                }

                document.getElementById('userModal').style.display = 'block';
                showTargetFields();
            } catch (error) {
                console.error('Modal açılırken hata:', error.message);
                alert('Departman ve rol verileri yüklenirken hata oluştu: ' + error.message);
            }
        }

        function showTargetFields() {
            const roleSelect = document.getElementById('role_id');
            const targetSection = document.getElementById('targetSection');
            const targetFields = document.getElementById('targetFields');
            
            const selectedRoleId = roleSelect.value;
            const selectedRole = window.rolesData?.find(role => role.id == selectedRoleId);
            
            // Rol seçildiğinde hedef bölümünü her zaman göster
            if (selectedRoleId) {
                targetSection.style.display = 'block';
            } else {
                targetSection.style.display = 'none';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Form'u temizle ve başlığı sıfırla
            if (modalId === 'userModal') {
                document.getElementById('userForm').reset();
                document.getElementById('userModalTitle').textContent = 'Yeni Kullanıcı';
                document.getElementById('userForm').removeAttribute('data-user-id');
            } else if (modalId === 'customerModal') {
                document.getElementById('customerForm').reset();
            } else if (modalId === 'productModal') {
                document.getElementById('productForm').reset();
                document.getElementById('price_with_vat').value = '';
            } else if (modalId === 'targetModal') {
                document.getElementById('targetEditForm').reset();
                document.getElementById('targetEditForm').removeAttribute('data-target-id');
            }
        }

        async function editUser(userId) {
            try {
                // Kullanıcı bilgilerini getir
                const userResponse = await apiCall(`/api/users/${userId}`);
                const user = userResponse.user || userResponse;

                console.log('Düzenlenecek kullanıcı:', user);

                // Modal'ı aç
                await openUserModal();

                // Form'u doldur
                document.getElementById('username').value = user.username || '';
                document.getElementById('full_name').value = user.full_name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('password').value = ''; // Şifre boş bırak
                document.getElementById('department_id').value = user.department_id || '';
                document.getElementById('role_id').value = user.role_id || '';

                // Hedef alanlarını güncelle
                showTargetFields();
                
                // Mevcut hedefi yükle
                setTimeout(async () => {
                    try {
                        const currentDate = new Date();
                        const targetResponse = await apiCall(`/api/user-targets/${userId}?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`);
                        const userTargetInput = document.getElementById('user_target');
                        if (targetResponse.target) {
                            document.getElementById('user_target_sales').value = targetResponse.target.sales_target || '';
                            document.getElementById('user_target_visits').value = targetResponse.target.visit_target || '';
                            document.getElementById('user_target_production').value = targetResponse.target.production_target || '';
                            document.getElementById('user_target_shipping').value = targetResponse.target.shipping_target || '';
                            document.getElementById('user_target_revenue').value = targetResponse.target.revenue_target || '';
                            document.getElementById('user_target_collection').value = targetResponse.target.collection_target || '';
                        }
                    } catch (error) {
                        console.log('Hedef yüklenemedi:', error.message);
                    }
                }, 100);

                // Modal başlığını değiştir
                document.getElementById('userModalTitle').textContent = 'Kullanıcı Düzenle';

                // Form'a user ID'sini ekle (güncelleme için)
                document.getElementById('userForm').setAttribute('data-user-id', userId);

            } catch (error) {
                console.error('Kullanıcı düzenleme hatası:', error.message);
                alert('Kullanıcı bilgileri yüklenirken hata oluştu: ' + error.message);
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Bu kullanıcıyı silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                await apiCall(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                alert('Kullanıcı başarıyla silindi!');
                showUsers();
            } catch (error) {
                console.error('Kullanıcı silme hatası:', error.message);
                alert('Kullanıcı silinirken hata oluştu: ' + error.message);
            }
        }

        function openProductModal() {
            document.getElementById('productModal').style.display = 'block';
        }
        
        // KDV hesaplama fonksiyonu
        function calculateVAT() {
            const price = parseFloat(document.getElementById('product_unit_price').value) || 0;
            const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
            const priceWithVat = price * (1 + vatRate / 100);
            document.getElementById('price_with_vat').value = priceWithVat.toFixed(2);
        }
        
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('product_name').value,
                description: document.getElementById('product_description').value,
                unit_price: document.getElementById('product_unit_price').value,
                vat_rate: document.getElementById('vat_rate').value,
                price_with_vat: document.getElementById('price_with_vat').value,
                unit: document.getElementById('product_unit').value
            };
            
            try {
                const result = await apiCall('/api/products', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                console.log('Ürün ekleme sonucu:', result);
                alert('Ürün başarıyla oluşturuldu!');
                document.getElementById('productForm').reset();
                closeModal('productModal');

                // Kısa bir gecikme sonrası listeyi yenile
                setTimeout(() => {
                    showProducts();
                }, 500);
            } catch (error) {
                console.error('Ürün ekleme hatası:', error.message);
                alert('Hata: ' + error.message);
            }
        });
        
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const userId = form.getAttribute('data-user-id');
            const isEdit = !!userId;

            const formData = {
                username: document.getElementById('username').value,
                full_name: document.getElementById('full_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                department_id: document.getElementById('department_id').value,
                role_id: document.getElementById('role_id').value
            };
            
            // Hedef bilgisi
            const targetData = {
                sales_target: parseFloat(document.getElementById('user_target_sales').value) || 0,
                visit_target: parseInt(document.getElementById('user_target_visits').value) || 0,
                production_target: parseInt(document.getElementById('user_target_production').value) || 0,
                shipping_target: parseInt(document.getElementById('user_target_shipping').value) || 0,
                revenue_target: parseFloat(document.getElementById('user_target_revenue').value) || 0,
                collection_target: parseFloat(document.getElementById('user_target_collection').value) || 0
            };
            // Şifre kontrolü
            const password = document.getElementById('password').value;
            
            // Yeni kullanıcı için şifre zorunlu
            if (!isEdit && (!password || password.trim() === '')) {
                alert('Yeni kullanıcı için şifre gerekli!');
                return;
            }
            
            // Şifre varsa ekle
            if (password && password.trim() !== '') {
                formData.password = password;
            }

            try {
                let result;
                if (isEdit) {
                    // Güncelleme
                    result = await apiCall(`/api/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    
                    // Hedefi kaydet
                    if (Object.values(targetData).some(v => v > 0)) {
                        const currentDate = new Date();
                        const targetPayload = {
                            user_id: parseInt(userId),
                            target_year: currentDate.getFullYear(),
                            target_month: currentDate.getMonth() + 1,
                            ...targetData
                        };
                        
                        try {
                            // Mevcut hedefi güncelle veya yenisini oluştur
                            await apiCall(`/api/user-targets/${userId}`, { method: 'PUT', body: JSON.stringify(targetPayload) });
                        } catch (targetError) {
                            console.log('Hedef kaydetme hatası:', targetError.message);
                        }
                    }
                    
                    alert('Kullanıcı ve hedefler başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    result = await apiCall('/api/users', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    
                    // Hedefi kaydet
                    if (Object.values(targetData).some(v => v > 0)) {
                        const newUserId = result.user ? result.user.id : result.id;
                        const currentDate = new Date();
                        const targetPayload = {
                            user_id: newUserId,
                            target_year: currentDate.getFullYear(),
                            target_month: currentDate.getMonth() + 1,
                            ...targetData
                        };
                        
                        try {
                            await apiCall('/api/user-targets', {
                                method: 'POST',
                                body: JSON.stringify(targetPayload)
                            });
                        } catch (targetError) {
                            console.log('Hedef kaydetme hatası:', targetError.message);
                        }
                    }
                    
                    alert('Kullanıcı ve hedefler başarıyla oluşturuldu!');
                }

                document.getElementById('userForm').reset();
                closeModal('userModal');
                showUsers();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        document.getElementById('departmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('department_name').value,
                description: document.getElementById('department_description').value
            };

            try {
                await apiCall('/api/departments', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                alert('Departman başarıyla oluşturuldu!');
                document.getElementById('departmentForm').reset();
                closeModal('departmentModal');
                showDepartments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const customerId = form.getAttribute('data-customer-id');
            const isEdit = !!customerId;

            const formData = {
                company_name: document.getElementById('customer_company_name').value,
                contact_person: document.getElementById('customer_contact_person').value,
                phone: document.getElementById('customer_phone').value,
                email: document.getElementById('customer_email').value,
                address: document.getElementById('customer_address').value,
                assigned_sales_rep: document.getElementById('customer_sales_rep').value || null
            };

            try {
                if (isEdit) {
                    // Güncelleme
                    await apiCall(`/api/customers/${customerId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Müşteri başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/customers', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Müşteri başarıyla oluşturuldu!');
                }

                document.getElementById('customerForm').reset();
                form.removeAttribute('data-customer-id');
                closeModal('customerModal');
                showCustomers();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        document.getElementById('targetEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            const targetId = form.getAttribute('data-target-id');

            const formData = {
                monthly_sales_target: document.getElementById('target_monthly_sales').value,
                monthly_production_target: document.getElementById('target_monthly_production').value,
                monthly_revenue_target: document.getElementById('target_monthly_revenue').value
            };

            try {
                await apiCall(`/api/targets/${targetId}`, {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });

                alert('Hedef başarıyla güncellendi!');
                document.getElementById('targetEditForm').reset();
                closeModal('targetModal');
                showTargets();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        document.getElementById('transactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                customer_id: document.getElementById('transaction_customer_id').value,
                transaction_type: document.getElementById('transaction_type').value,
                amount: document.getElementById('transaction_amount').value,
                transaction_date: document.getElementById('transaction_date').value,
                description: document.getElementById('transaction_description').value,
                reference_number: document.getElementById('transaction_reference').value
            };

            try {
                await apiCall('/api/account-transactions', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                alert('Cari hesap işlemi başarıyla oluşturuldu!');
                document.getElementById('transactionForm').reset();
                closeModal('transactionModal');
                showCariHesap();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // Rol form submit handler
        document.getElementById('roleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roleId = document.getElementById('role_edit_id').value;
            const formData = {
                name: document.getElementById('role_name').value,
                description: document.getElementById('role_description').value,
                level: parseInt(document.getElementById('role_level').value),
                is_active: document.getElementById('role_active').checked
            };

            try {
                if (roleId) {
                    // Güncelleme
                    await apiCall(`/api/roles/${roleId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Rol başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/roles', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Rol başarıyla oluşturuldu!');
                }

                document.getElementById('roleForm').reset();
                closeModal('roleModal');
                showRoles(); // Listeyi yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // Departman form submit handler
        document.getElementById('departmentEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const deptId = document.getElementById('dept_id').value;
            const formData = {
                name: document.getElementById('dept_name').value,
                description: document.getElementById('dept_description').value,
                code: document.getElementById('dept_code').value,
                manager_id: document.getElementById('dept_manager_id').value || null,
                is_active: document.getElementById('dept_active').checked
            };

            try {
                if (deptId) {
                    // Güncelleme
                    await apiCall(`/api/departments/${deptId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Departman başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/departments', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Departman başarıyla oluşturuldu!');
                }

                document.getElementById('departmentForm').reset();
                closeModal('departmentModal');
                showDepartments(); // Listeyi yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // Hedef form submit handler
        document.getElementById('targetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const targetId = document.getElementById('target_id').value;
            const formData = {
                user_id: parseInt(document.getElementById('target_user_id').value),
                target_year: parseInt(document.getElementById('target_year').value),
                target_month: parseInt(document.getElementById('target_month').value),
                sales_target: parseFloat(document.getElementById('target_sales').value) || 0,
                visit_target: parseInt(document.getElementById('target_visits').value) || 0,
                production_target: parseInt(document.getElementById('target_production').value) || 0,
                revenue_target: parseFloat(document.getElementById('target_revenue').value) || 0,
                collection_target: parseFloat(document.getElementById('target_collection').value) || 0,
                notes: document.getElementById('target_notes').value
            };

            try {
                if (targetId) {
                    // Güncelleme
                    await apiCall(`/api/user-targets/${targetId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Hedef başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/user-targets', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Hedef başarıyla oluşturuldu!');
                }

                document.getElementById('targetForm').reset();
                closeModal('targetModal');

                // Listeyi yenile
                const year = document.getElementById('targetYearFilter').value;
                const month = document.getElementById('targetMonthFilter').value;
                await loadTargetsForMonth(parseInt(year), parseInt(month));
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // İrsaliye form submit handler
        document.getElementById('deliveryNoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const deliveryNoteId = document.getElementById('delivery_note_id').value;
            const formData = {
                delivery_number: document.getElementById('delivery_number').value,
                order_id: document.getElementById('delivery_order_id').value || null,
                customer_id: parseInt(document.getElementById('delivery_customer_id').value),
                delivered_by: document.getElementById('delivery_delivered_by').value || null,
                delivery_date: document.getElementById('delivery_date').value,
                delivery_time: document.getElementById('delivery_time').value || null,
                delivery_address: document.getElementById('delivery_address').value,
                notes: document.getElementById('delivery_notes').value,
                internal_notes: document.getElementById('delivery_internal_notes').value
            };

            try {
                if (deliveryNoteId) {
                    // Güncelleme
                    await apiCall(`/api/delivery-notes/${deliveryNoteId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('İrsaliye başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/delivery-notes', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('İrsaliye başarıyla oluşturuldu!');
                }

                document.getElementById('deliveryNoteForm').reset();
                closeModal('deliveryNoteModal');
                await loadDeliveryNotes(); // Listeyi yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        // Randevu form submit handler
        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const appointmentId = document.getElementById('appointment_id').value;
            const formData = {
                title: document.getElementById('appointment_title').value,
                description: document.getElementById('appointment_description').value,
                type: document.getElementById('appointment_type').value,
                priority: document.getElementById('appointment_priority').value,
                start_date: document.getElementById('appointment_start_date').value,
                start_time: document.getElementById('appointment_start_time').value || null,
                end_date: document.getElementById('appointment_end_date').value || null,
                end_time: document.getElementById('appointment_end_time').value || null,
                all_day: document.getElementById('appointment_all_day').checked,
                assigned_to: parseInt(document.getElementById('appointment_assigned_to').value),
                customer_id: document.getElementById('appointment_customer_id').value || null,
                location: document.getElementById('appointment_location').value,
                address: document.getElementById('appointment_address').value,
                reminder_minutes: parseInt(document.getElementById('appointment_reminder_minutes').value) || 0
            };

            try {
                if (appointmentId) {
                    // Güncelleme
                    await apiCall(`/api/appointments/${appointmentId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Randevu başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Randevu başarıyla oluşturuldu!');
                }

                document.getElementById('appointmentForm').reset();
                closeModal('appointmentModal');
                await loadAppointments(); // Listeyi yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        function viewOrderDetail(orderId) {
            window.location.href = `/order-detail-admin.html?id=${orderId}`;
        }
        
        async function showCariHesap() {
            try {
                console.log('Cari hesap verileri yüklenmeye başlanıyor...');
                const transactionsResponse = await apiCall('/api/account-transactions');
                const transactions = transactionsResponse.transactions || [];
                console.log('Cari hesap işlem sayısı:', transactions.length);
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2 style="color: #2d3748; margin-bottom: 2rem;">Cari Hesap Yönetimi</h2>
                        <button class="btn" onclick="openTransactionModal()" style="margin-bottom: 1rem;">Yeni İşlem</button>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Müşteri</th>
                                    <th>İşlem Tipi</th>
                                    <th>Tutar</th>
                                    <th>Açıklama</th>
                                    <th>Referans No</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.map(transaction => `
                                    <tr>
                                        <td>${new Date(transaction.transaction_date).toLocaleDateString('tr-TR')}</td>
                                        <td>${transaction.customer_name || '-'}</td>
                                        <td>
                                            <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;
                                                  background: ${transaction.transaction_type === 'debit' ? '#f8d7da' : '#d4edda'};
                                                  color: ${transaction.transaction_type === 'debit' ? '#721c24' : '#155724'};">
                                                ${transaction.transaction_type === 'debit' ? 'Borç' : 'Alacak'}
                                            </span>
                                        </td>
                                        <td>${transaction.amount.toFixed(2)} ₺</td>
                                        <td>${transaction.description || '-'}</td>
                                        <td>${transaction.reference_number || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Cari hesap verileri yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>Cari Hesap Yönetimi</h2>
                        <p style="color: red;">Veriler yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }
        

        
        function createInvoiceFromDeliveryNotes() {
            window.location.href = '/invoice-from-delivery.html';
        }
        
        async function createInvoiceFromDeliveryNotesOld() {
            try {
                // Faturalanmamış irsaliyeleri getir
                const deliveryNotes = await apiCall('/api/cari/delivery-notes');
                const unInvoicedNotes = deliveryNotes.filter(dn => !dn.is_invoiced);
                
                if (unInvoicedNotes.length === 0) {
                    alert('Faturalanmamış irsaliye bulunamadı!');
                    return;
                }
                
                // Müşterilere göre grupla
                const customerGroups = {};
                unInvoicedNotes.forEach(dn => {
                    if (!customerGroups[dn.customer_id]) {
                        customerGroups[dn.customer_id] = {
                            customer_name: dn.customer_name,
                            notes: []
                        };
                    }
                    customerGroups[dn.customer_id].notes.push(dn);
                });
                
                // Modal içeriği oluştur
                let modalContent = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto;">
                            <h3 style="margin-bottom: 1rem;">İrsaliyelerden Fatura Oluştur</h3>
                            <p style="margin-bottom: 1rem; color: #666;">Müşteri seçin ve irsaliyelerini işaretleyin:</p>
                `;
                
                Object.keys(customerGroups).forEach(customerId => {
                    const group = customerGroups[customerId];
                    modalContent += `
                        <div style="border: 1px solid #e2e8f0; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem; color: #2d3748;">${group.customer_name}</h4>
                            <div style="margin-bottom: 0.5rem;">
                                <label style="font-size: 0.875rem; color: #666;">
                                    <input type="checkbox" onchange="toggleAllCustomer(${customerId})" id="customer_${customerId}"> Tümünü Seç
                                </label>
                            </div>
                    `;
                    
                    group.notes.forEach(dn => {
                        modalContent += `
                            <div style="margin-left: 1rem; margin-bottom: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" class="delivery-note-cb customer-${customerId}" value="${dn.id}">
                                    <span>${dn.delivery_note_number} - ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')} - ${dn.total_amount} TL</span>
                                </label>
                            </div>
                        `;
                    });
                    
                    modalContent += `</div>`;
                });
                
                modalContent += `
                            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="closeInvoiceModal()" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Kapat</button>
                                <button onclick="createInvoiceFromSelected()" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Fatura Oluştur</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Modal'i sayfaya ekle
                const modalDiv = document.createElement('div');
                modalDiv.id = 'invoiceModal';
                modalDiv.innerHTML = modalContent;
                document.body.appendChild(modalDiv);
                
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        function toggleAllCustomer(customerId) {
            const customerCheckbox = document.getElementById(`customer_${customerId}`);
            const deliveryCheckboxes = document.querySelectorAll(`.customer-${customerId}`);
            
            deliveryCheckboxes.forEach(cb => {
                cb.checked = customerCheckbox.checked;
            });
        }
        
        async function createInvoiceFromSelected() {
            const selectedCheckboxes = document.querySelectorAll('.delivery-note-cb:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Lütfen en az bir irsaliye seçin!');
                return;
            }
            
            // Seçilen irsaliyeleri müşterilere göre grupla
            const customerInvoices = {};
            selectedCheckboxes.forEach(cb => {
                const deliveryNoteId = cb.value;
                const customerClass = cb.className.match(/customer-(\d+)/)[1];
                
                if (!customerInvoices[customerClass]) {
                    customerInvoices[customerClass] = [];
                }
                customerInvoices[customerClass].push(deliveryNoteId);
            });
            
            try {
                // Her müşteri için ayrı fatura oluştur
                for (const customerId in customerInvoices) {
                    const deliveryNoteIds = customerInvoices[customerId];
                    
                    const result = await apiCall('/api/cari/invoices/from-delivery-notes', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            customerId: parseInt(customerId),
                            deliveryNoteIds: deliveryNoteIds.map(id => parseInt(id))
                        })
                    });
                    
                    console.log(`Fatura oluşturuldu: ${result.invoiceNumber}`);
                }
                
                alert('Faturalar başarıyla oluşturuldu!');
                closeInvoiceModal();
                showCariHesap(); // Sayfayı yenile
                
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        function closeInvoiceModal() {
            const modal = document.getElementById('invoiceModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function viewDeliveryNote(id) {
            window.location.href = `/delivery-note-detail.html?id=${id}`;
        }
        
        function viewInvoice(id) {
            window.location.href = `/invoice-detail.html?id=${id}`;
        }
        
        function viewCustomerDetail(customerId) {
            window.location.href = `/customer-detail-admin.html?id=${customerId}`;
        }
        
        async function editCustomer(customerId) {
            try {
                const customerResponse = await apiCall(`/api/customers/${customerId}`);
                const customer = customerResponse.customer || customerResponse;
                
                // Satış temsilcilerini yükle
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                
                const salesRepSelect = document.getElementById('customer_sales_rep');
                salesRepSelect.innerHTML = '';
                salesRepSelect.add(new Option('Satış Temsilcisi Seçiniz', ''));
                
                users.forEach(user => {
                    salesRepSelect.add(new Option(`${user.full_name} (${user.role_name || 'Rol Yok'})`, user.id));
                });
                
                // Form'u doldur
                document.getElementById('customer_company_name').value = customer.company_name || '';
                document.getElementById('customer_contact_person').value = customer.contact_person || '';
                document.getElementById('customer_phone').value = customer.phone || '';
                document.getElementById('customer_email').value = customer.email || '';
                document.getElementById('customer_address').value = customer.address || '';
                document.getElementById('customer_sales_rep').value = customer.assigned_sales_rep || '';
                
                // Form'a customer ID'sini ekle
                document.getElementById('customerForm').setAttribute('data-customer-id', customerId);
                
                document.getElementById('customerModal').style.display = 'block';
                
            } catch (error) {
                console.error('Müşteri düzenleme hatası:', error.message);
                alert('Müşteri bilgileri yüklenirken hata oluştu: ' + error.message);
            }
        }
        
        async function deleteCustomer(customerId) {
            if (!confirm('Bu müşteriyi silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                await apiCall(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });
                
                alert('Müşteri başarıyla silindi!');
                showCustomers();
            } catch (error) {
                console.error('Müşteri silme hatası:', error.message);
                alert('Müşteri silinirken hata oluştu: ' + error.message);
            }
        }
        
        async function openCustomerModal() {
            try {
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                
                const salesRepSelect = document.getElementById('customer_sales_rep');
                salesRepSelect.innerHTML = '';
                salesRepSelect.add(new Option('Satış Temsilcisi Seçiniz', ''));
                
                users.forEach(user => {
                    salesRepSelect.add(new Option(`${user.full_name} (${user.role_name || 'Rol Yok'})`, user.id));
                });
                
                document.getElementById('customerModal').style.display = 'block';
            } catch (error) {
                console.error('Müşteri modal açılırken hata:', error.message);
                alert('Kullanıcı verileri yüklenirken hata oluştu: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        // Grafik çizim fonksiyonları
        function drawSalesChart(current, target) {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const percentage = target > 0 ? (current / target) * 100 : 0;
            const angle = (percentage / 100) * 2 * Math.PI;
            
            // Arka plan daire
            ctx.beginPath();
            ctx.arc(40, 30, 25, 0, 2 * Math.PI);
            ctx.fillStyle = '#e2e8f0';
            ctx.fill();
            
            // Progress daire
            ctx.beginPath();
            ctx.arc(40, 30, 25, -Math.PI/2, -Math.PI/2 + angle);
            ctx.lineWidth = 6;
            ctx.strokeStyle = '#3b82f6';
            ctx.stroke();
            
            // Yüzde metni
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(Math.round(percentage) + '%', 40, 35);
        }
        
        function drawVisitsChart(current, target) {
            const canvas = document.getElementById('visitsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const percentage = target > 0 ? (current / target) * 100 : 0;
            
            // Bar chart
            const barWidth = 8;
            const maxHeight = 50;
            const barHeight = (percentage / 100) * maxHeight;
            
            // Arka plan barlar
            for (let i = 0; i < 6; i++) {
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(10 + i * 12, 10, barWidth, maxHeight);
                
                // Progress barlar
                if (i < 6 * (percentage / 100)) {
                    ctx.fillStyle = '#10b981';
                    ctx.fillRect(10 + i * 12, 10 + maxHeight - barHeight, barWidth, barHeight);
                }
            }
        }
        
        function drawCollectionChart(current, target) {
            const canvas = document.getElementById('collectionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const percentage = target > 0 ? (current / target) * 100 : 0;
            
            // Line chart
            const points = [20, 35, 25, 40, 30, 45];
            const scaledPoints = points.map(p => p * (percentage / 100));
            
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            scaledPoints.forEach((point, index) => {
                const x = 10 + index * 12;
                const y = 50 - point;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            
            ctx.stroke();
            
            // Noktalar
            scaledPoints.forEach((point, index) => {
                const x = 10 + index * 12;
                const y = 50 - point;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#f59e0b';
                ctx.fill();
            });
        }
        
        function drawOrdersDonutChart(stats) {
            const canvas = document.getElementById('ordersDonutChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = 100;
            const centerY = 50;
            const radius = 35;
            const innerRadius = 20;
            
            const data = [
                { value: stats.pendingOrders || 5, color: '#f59e0b', label: 'Bekleyen' },
                { value: stats.productionOrders || 8, color: '#6366f1', label: 'Üretimde' },
                { value: stats.completedOrders || 12, color: '#06b6d4', label: 'Tamamlanan' },
                { value: stats.deliveredOrders || 15, color: '#10b981', label: 'Teslim' }
            ];
            
            const total = data.reduce((sum, item) => sum + item.value, 0);
            let currentAngle = -Math.PI / 2;
            
            data.forEach(item => {
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                // Dış daire
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.fillStyle = item.color;
                ctx.fill();
                
                currentAngle += sliceAngle;
            });
            
            // Merkez daire
            ctx.beginPath();
            ctx.arc(centerX, centerY, innerRadius, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            
            // Toplam sayı
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(total.toString(), centerX, centerY + 5);
        }
        
        function drawAppointmentsChart() {
            const canvas = document.getElementById('appointmentsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Basit progress bar
            const completed = 2;
            const total = 3;
            const percentage = (completed / total) * 100;
            
            // Arka plan
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(10, 30, 130, 20);
            
            // Progress
            ctx.fillStyle = '#10b981';
            ctx.fillRect(10, 30, (130 * percentage / 100), 20);
            
            // Metin
            ctx.fillStyle = '#1f2937';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${completed}/${total} Tamamlandı`, 75, 65);
        }

        // Gerçek harita fonksiyonu
        function initCustomerMap() {
            const mapElement = document.getElementById('customerMap');
            if (!mapElement) return;
            
            // İstanbul koordinatları
            const map = L.map('customerMap').setView([41.0082, 28.9784], 11);
            
            // OpenStreetMap katmanı
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Müşteri konumları
            const customers = [
                { name: 'ABC Teknoloji', lat: 41.0150, lng: 28.9850, status: 'active' },
                { name: 'XYZ İnşaat', lat: 41.0050, lng: 28.9750, status: 'active' },
                { name: 'DEF Lojistik', lat: 41.0200, lng: 28.9900, status: 'potential' },
                { name: 'GHI Market', lat: 40.9950, lng: 28.9650, status: 'potential' },
                { name: 'JKL Restaurant', lat: 41.0100, lng: 29.0000, status: 'not_interested' }
            ];
            
            // Marker renklerı
            const colors = {
                active: '#10b981',
                potential: '#f59e0b', 
                not_interested: '#ef4444'
            };
            
            // Marker'ları ekle
            customers.forEach(customer => {
                const marker = L.circleMarker([customer.lat, customer.lng], {
                    color: 'white',
                    fillColor: colors[customer.status],
                    fillOpacity: 0.8,
                    radius: 8,
                    weight: 2
                }).addTo(map);
                
                const statusText = {
                    active: 'Aktif Müşteri',
                    potential: 'Potansiyel Müşteri', 
                    not_interested: 'İlgilenmiyor'
                };
                
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <b>${customer.name}</b><br>
                        <span style="color: ${colors[customer.status]}; font-weight: bold;">${statusText[customer.status]}</span><br>
                        <button onclick="viewCustomerDetail(${customer.id || 1})" style="margin-top: 5px; padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Detay</button>
                    </div>
                `);
            });
            
            // Haritaya tıklayınca yeni müşteri ekleme
            map.on('click', function(e) {
                if (confirm('Bu konuma yeni müşteri eklemek ister misiniz?')) {
                    const newMarker = L.circleMarker([e.latlng.lat, e.latlng.lng], {
                        color: 'white',
                        fillColor: '#6366f1',
                        fillOpacity: 0.8,
                        radius: 8,
                        weight: 2
                    }).addTo(map);
                    
                    newMarker.bindPopup(`
                        <div style="text-align: center;">
                            <b>Yeni Müşteri</b><br>
                            <span style="color: #6366f1;">Koordinat: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}</span><br>
                            <button onclick="openCustomerModalWithLocation(${e.latlng.lat}, ${e.latlng.lng})" style="margin-top: 5px; padding: 3px 8px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Kaydet</button>
                        </div>
                    `).openPopup();
                }
            });
        }

        // Eski harita çizim fonksiyonu
        function drawCustomerMap() {
            const canvas = document.getElementById('mapCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Basit harita arka planı
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#e3f2fd');
            gradient.addColorStop(1, '#bbdefb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);
            
            // Şehir sınırları (basit)
            ctx.strokeStyle = '#90a4ae';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(100, 100);
            ctx.lineTo(700, 120);
            ctx.lineTo(680, 300);
            ctx.lineTo(120, 280);
            ctx.closePath();
            ctx.stroke();
            
            // Örnek müşteri konumları
            const customers = [
                // Aktif müşteriler (yeşil)
                { x: 200, y: 150, status: 'active', name: 'ABC Restaurant' },
                { x: 350, y: 180, status: 'active', name: 'XYZ Cafe' },
                { x: 500, y: 160, status: 'active', name: 'DEF Otel' },
                { x: 300, y: 220, status: 'active', name: 'GHI Market' },
                { x: 450, y: 200, status: 'active', name: 'JKL Restaurant' },
                
                // Potansiyel müşteriler (mavi)
                { x: 250, y: 200, status: 'potential', name: 'MNO Cafe' },
                { x: 400, y: 140, status: 'potential', name: 'PQR Restaurant' },
                { x: 320, y: 250, status: 'potential', name: 'STU Otel' },
                { x: 480, y: 240, status: 'potential', name: 'VWX Market' },
                
                // İlgilenmeyen müşteriler (kırmızı)
                { x: 180, y: 240, status: 'not_interested', name: 'YZ Restaurant' },
                { x: 420, y: 180, status: 'not_interested', name: 'ABC2 Cafe' },
                { x: 380, y: 260, status: 'not_interested', name: 'DEF2 Otel' }
            ];
            
            // Müşteri noktalarını çiz
            customers.forEach(customer => {
                const colors = {
                    'active': '#48bb78',
                    'potential': '#42A5F5',
                    'not_interested': '#f56565'
                };
                
                // Dış çember (vurgu)
                ctx.beginPath();
                ctx.arc(customer.x, customer.y, 8, 0, 2 * Math.PI);
                ctx.fillStyle = colors[customer.status] + '40';
                ctx.fill();
                
                // İç nokta
                ctx.beginPath();
                ctx.arc(customer.x, customer.y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = colors[customer.status];
                ctx.fill();
                
                // Beyaz kenar
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // Şehir isimleri
            ctx.fillStyle = '#37474f';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('İstanbul Bölgesi', width / 2, 50);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#546e7a';
            ctx.fillText('Hizmet Verilen Alan', width / 2, 70);
        }
        
        async function showProducts() {
            try {
                const productsResponse = await apiCall('/api/products');
                console.log('Products API response:', productsResponse);
                const products = productsResponse.products || [];
                console.log('Products array:', products);

                let html = `
                    <div class="card">
                        <h2>Ürün Yönetimi</h2>
                        <button class="btn" onclick="openProductModal()">Yeni Ürün</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ürün Adı</th>
                                    <th>Açıklama</th>
                                    <th>Fiyat (KDV Hariç)</th>
                                    <th>KDV %</th>
                                    <th>Fiyat (KDV Dahil)</th>
                                    <th>Birim</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (products.length === 0) {
                    html += `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 2rem; color: #666;">
                                Henüz ürün eklenmemiş. "Yeni Ürün" butonunu kullanarak ürün ekleyebilirsiniz.
                            </td>
                        </tr>
                    `;
                } else {
                    products.forEach(product => {
                        html += `
                            <tr>
                                <td>${product.id}</td>
                                <td>${product.name}</td>
                                <td>${product.description || '-'}</td>
                                <td>${product.unit_price} TL</td>
                                <td>${product.vat_rate ? '%' + product.vat_rate : '-'}</td>
                                <td>${product.price_with_vat ? product.price_with_vat + ' TL' : '-'}</td>
                                <td>${product.unit}</td>
                                <td>${product.is_active ? 'Aktif' : 'Pasif'}</td>
                                <td>
                                    <button class="btn" onclick="editProduct(${product.id})">Düzenle</button>
                                    <button class="btn" onclick="deleteProduct(${product.id})" style="background: #dc3545; margin-left: 0.5rem;">Sil</button>
                                </td>
                            </tr>
                        `;
                    });
                }

                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Ürünler yüklenemedi:', error.message);
                document.getElementById('content').innerHTML = `
                    <div class="card error">
                        <strong>Ürünler Yüklenemedi:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function deleteProduct(id) {
            if (confirm('Bu ürünü silmek istediğinizden emin misiniz?')) {
                try {
                    await apiCall(`/api/products/${id}`, { method: 'DELETE' });
                    alert('Ürün silindi!');
                    showProducts();
                } catch (error) {
                    alert('Silme hatası: ' + error.message);
                }
            }
        }
        
        async function showOrders(statusFilter = '') {
            try {
                const ordersResponse = await apiCall('/api/orders');
                let orders = ordersResponse.orders || [];

                if (statusFilter) {
                    orders = orders.filter(order => order.status === statusFilter);
                }
                
                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2>Sipariş Yönetimi ${statusFilter ? `(${statusFilter})` : ''}</h2>
                            <div>
                                ${statusFilter ? `<button class="btn" onclick="showOrders()" style="background: #6c757d; margin-right: 0.5rem;">Tümünü Göster</button>` : ''}
                                <button class="btn" onclick="openOrderModal()">Yeni Sipariş</button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Müşteri</th>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                orders.forEach(order => {
                    html += `
                        <tr onclick="viewOrderDetail(${order.id})" style="cursor: pointer;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                            <td>#${order.order_number}</td>
                            <td>${order.customer_name || 'Bilinmiyor'}</td>
                            <td>${new Date(order.order_date).toLocaleDateString('tr-TR')}</td>
                            <td>${order.total_amount} TL</td>
                            <td>${order.status}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Siparişler yüklenemedi:', error.message);
                document.getElementById('content').innerHTML = `
                    <div class="card error">
                        <strong>Siparişler Yüklenemedi:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function showTargets() {
            try {
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                
                // Targets API'si henüz yok, varsayılan değerler kullan
                const targets = [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>Hedef Yönetimi</h2>
                        <p>Kullanıcıların aylık hedeflerini belirleyin</p>
                        
                        <div style="margin: 2rem 0;">
                            <h3>Hedef Belirleme</h3>
                            <form id="targetForm" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; align-items: end;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Kullanıcı:</label>
                                    <select id="target_user_id" required>
                                        <option value="">Kullanıcı Seçiniz</option>
                                        ${users.map(user => `<option value="${user.id}">${user.full_name} (${user.role})</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Hedef Tipi:</label>
                                    <select id="target_type" required>
                                        <option value="">Tip Seçiniz</option>
                                        <option value="sales">Satış Cirosu (TL)</option>
                                        <option value="visits">Ziyaret Sayısı</option>
                                        <option value="production">Üretim Adedi</option>
                                        <option value="shipping">Sevkiyat Adedi</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Hedef Değer:</label>
                                    <input type="number" id="target_value" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Ay:</label>
                                    <input type="month" id="target_month" value="${new Date().toISOString().slice(0, 7)}" required>
                                </div>
                                <button type="submit" class="btn">Hedef Belirle</button>
                            </form>
                        </div>
                        
                        <h3>Mevcut Hedefler</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Kullanıcı</th>
                                    <th>Rol</th>
                                    <th>Hedef Tipi</th>
                                    <th>Hedef Değer</th>
                                    <th>Ay</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${targets.map(target => {
                                    const typeText = {
                                        'sales': 'Satış Cirosu',
                                        'visits': 'Ziyaret Sayısı',
                                        'production': 'Üretim Adedi',
                                        'shipping': 'Sevkiyat Adedi'
                                    };
                                    return `
                                        <tr>
                                            <td>${target.full_name || 'Bilinmiyor'}</td>
                                            <td>${target.role || 'Bilinmiyor'}</td>
                                            <td>${typeText[target.target_type] || target.target_type}</td>
                                            <td>${target.target_value}${target.target_type === 'sales' ? ' TL' : ' adet'}</td>
                                            <td>${target.target_month}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Form submit event
                setTimeout(() => {
                    document.getElementById('targetForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const formData = {
                            user_id: document.getElementById('target_user_id').value,
                            target_type: document.getElementById('target_type').value,
                            target_value: document.getElementById('target_value').value,
                            target_month: document.getElementById('target_month').value
                        };
                        
                        try {
                            await apiCall('/api/targets', {
                                method: 'POST',
                                body: JSON.stringify(formData)
                            });
                            
                            alert('Hedef başarıyla belirlendi!');
                            showTargets();
                        } catch (error) {
                            alert('Hata: ' + error.message);
                        }
                    });
                }, 100);
                
            } catch (error) {
                console.error('Hedefler yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>Hedef Yönetimi</h2>
                        <p style="color: red;">Hedefler yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function showSalesTargets() {
            try {
                const targets = await apiCall('/api/targets');
                const salesTargets = targets.filter(t => t.target_type === 'sales');
                
                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2>Satış Hedefleri ve Gerçekleşme Durumu</h2>
                            <button class="btn" onclick="showDashboard()" style="background: #6c757d;">← Dashboard'a Dön</button>
                        </div>
                        <div style="margin-bottom: 2rem;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #42A5F5;">600.000 TL</h4>
                                    <p>Toplam Hedef</p>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #66BB6A;">450.000 TL</h4>
                                    <p>Gerçekleşen</p>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                    <h4 style="color: #FFA726;">75%</h4>
                                    <p>Başarı Oranı</p>
                                </div>
                            </div>
                        </div>
                `;
                
                // Satışçı detayları (örnek veri)
                const salesReps = [
                    { name: 'Ahmet Yılmaz', target: 150000, achieved: 125000 },
                    { name: 'Ayşe Kaya', target: 200000, achieved: 180000 },
                    { name: 'Mehmet Demir', target: 120000, achieved: 85000 },
                    { name: 'Fatma Öz', target: 130000, achieved: 60000 }
                ];
                
                salesReps.forEach(rep => {
                    const percentage = Math.round((rep.achieved / rep.target) * 100);
                    const statusColor = percentage >= 80 ? '#66BB6A' : percentage >= 60 ? '#FFA726' : '#f56565';
                    
                    html += `
                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <h4>${rep.name}</h4>
                                <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">${percentage}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Hedef: ${rep.target.toLocaleString()} TL</span>
                                <span>Gerçekleşen: ${rep.achieved.toLocaleString()} TL</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: ${statusColor}; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Satış hedefleri yüklenemedi:', error);
            }
        }
        
        async function showVisitTargets() {
            let html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Ziyaret Hedefleri ve Gerçekleşme Durumu</h2>
                        <button class="btn" onclick="showDashboard()" style="background: #6c757d;">← Dashboard'a Dön</button>
                    </div>
                    <div style="margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="color: #66BB6A;">200</h4>
                                <p>Toplam Hedef</p>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="color: #42A5F5;">164</h4>
                                <p>Gerçekleşen</p>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="color: #FFA726;">82%</h4>
                                <p>Başarı Oranı</p>
                            </div>
                        </div>
                    </div>
            `;
            
            const visitReps = [
                { name: 'Ahmet Yılmaz', target: 50, achieved: 45 },
                { name: 'Ayşe Kaya', target: 60, achieved: 52 },
                { name: 'Mehmet Demir', target: 45, achieved: 38 },
                { name: 'Fatma Öz', target: 45, achieved: 29 }
            ];
            
            visitReps.forEach(rep => {
                const percentage = Math.round((rep.achieved / rep.target) * 100);
                const statusColor = percentage >= 80 ? '#66BB6A' : percentage >= 60 ? '#FFA726' : '#f56565';
                
                html += `
                    <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4>${rep.name}</h4>
                            <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">${percentage}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Hedef: ${rep.target} ziyaret</span>
                            <span>Gerçekleşen: ${rep.achieved} ziyaret</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${statusColor}; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }
        
        async function showProductionTargets() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Üretim Hedefleri ve Kapasite Kullanımı</h2>
                        <button class="btn" onclick="showDashboard()" style="background: #6c757d;">← Dashboard'a Dön</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #FFA726;">50</h4>
                            <p>Hedef Sipariş</p>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #66BB6A;">34</h4>
                            <p>Tamamlanan</p>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #42A5F5;">68%</h4>
                            <p>Kapasite Kullanımı</p>
                        </div>
                    </div>
                    <p style="color: #718096;">Aylık üretim kapasitesi ve gerçekleşme durumu takip edilmektedir.</p>
                </div>
            `;
        }
        
        async function showCollectionRates() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Tahsilat Oranları ve Performans</h2>
                        <button class="btn" onclick="showDashboard()" style="background: #6c757d;">← Dashboard'a Dön</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #AB47BC;">450.000 TL</h4>
                            <p>Toplam Alacak</p>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #66BB6A;">401.000 TL</h4>
                            <p>Tahsil Edilen</p>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #f56565;">49.000 TL</h4>
                            <p>Bekleyen</p>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                            <h4 style="color: #42A5F5;">89%</h4>
                            <p>Tahsilat Oranı</p>
                        </div>
                    </div>
                    <p style="color: #718096;">Aylık tahsilat performansı ve bekleyen alacaklar takip edilmektedir.</p>
                </div>
            `;
        }
        
        function drawConversionChart() {
            const canvas = document.getElementById('conversionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const months = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz'];
            const visits = [45, 52, 38, 48, 55, 42];
            const conversions = [12, 18, 15, 20, 22, 18];
            
            ctx.strokeStyle = '#42A5F5';
            ctx.lineWidth = 3;
            ctx.beginPath();
            visits.forEach((visit, index) => {
                const x = 60 + (index * 50);
                const y = 200 - (visit * 2);
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            ctx.strokeStyle = '#66BB6A';
            ctx.beginPath();
            conversions.forEach((conv, index) => {
                const x = 60 + (index * 50);
                const y = 200 - (conv * 4);
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }
        
        function drawDeliveryChart() {
            const canvas = document.getElementById('deliveryChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const data = [85, 92, 78, 88, 95, 82];
            
            data.forEach((value, index) => {
                const x = 60 + (index * 50);
                const height = value * 1.5;
                const y = 200 - height;
                
                ctx.fillStyle = '#FFA726';
                ctx.fillRect(x - 15, y, 30, height);
            });
        }
        
        // Departman yönetimi fonksiyonları
        async function showDepartments() {
            try {
                const departmentsResponse = await apiCall('/api/departments');
                const departments = departmentsResponse.departments || [];
                
                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>🏢 Departman Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    Organizasyonel yapıyı ve departmanları yönetin
                                </p>
                            </div>
                            <button class="btn" onclick="openDepartmentModal()">
                                ➕ Yeni Departman
                            </button>
                        </div>

                        <div style="background: var(--primary-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-solid); margin-bottom: 0.5rem;">💡 Departman Bilgileri:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                <div><strong>Satış:</strong> Müşteri ilişkileri ve satış süreçleri</div>
                                <div><strong>Üretim:</strong> Ürün üretimi ve kalite kontrol</div>
                                <div><strong>Sevkiyat:</strong> Lojistik ve teslimat işlemleri</div>
                                <div><strong>Muhasebe:</strong> Mali işler ve raporlama</div>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Departman Adı</th>
                                    <th>Açıklama</th>
                                    <th>Kullanıcı Sayısı</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Kullanıcı sayılarını hesapla (örnek - gerçek veri users tablosundan gelecek)
                const userCounts = {
                    1: 8,  // Satış Departmanı
                    2: 5,  // Üretim Departmanı
                    3: 3,  // Sevkiyat Departmanı
                    4: 4,  // Muhasebe Departmanı
                    5: 2,  // IT Departmanı
                    6: 3,  // İnsan Kaynakları
                    7: 2   // Kalite Kontrol
                };

                departments.forEach(dept => {
                    const userCount = userCounts[dept.id] || 0;
                    const deptIcon = {
                        'Satış Departmanı': '💼',
                        'Üretim Departmanı': '🏭',
                        'Sevkiyat Departmanı': '🚚',
                        'Muhasebe Departmanı': '💰',
                        'IT Departmanı': '💻',
                        'İnsan Kaynakları': '👥',
                        'Kalite Kontrol': '🔍'
                    }[dept.name] || '🏢';

                    const isActive = dept.is_active !== false;

                    html += `
                        <tr>
                            <td>${dept.id}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${deptIcon}</span>
                                    <strong>${dept.name}</strong>
                                </div>
                            </td>
                            <td>${dept.description || '-'}</td>
                            <td>
                                <span class="status-badge info">${userCount} kullanıcı</span>
                            </td>
                            <td>
                                <span class="status-badge ${isActive ? 'success' : 'danger'}">
                                    ${isActive ? 'Aktif' : 'Pasif'}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="editDepartment(${dept.id})">
                                        ✏️ Düzenle
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${dept.id})">
                                        🗑️ Sil
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Cari hesap verileri yüklenemedi:', error.message);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>🏢 Departman Yönetimi</h2>
                        <p style="color: red;">Departmanlar yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Departman modal fonksiyonları
        function openDepartmentModal(deptId = null) {
            const modal = document.getElementById('departmentModal');
            const title = document.getElementById('departmentModalTitle');
            const form = document.getElementById('departmentForm');

            if (deptId) {
                title.textContent = 'Departman Düzenle';
                loadDepartmentData(deptId);
            } else {
                title.textContent = 'Yeni Departman';
                form.reset();
                document.getElementById('dept_active').checked = true;
                document.getElementById('dept_id').value = '';
                loadManagerOptions();
            }

            modal.style.display = 'block';
        }

        async function loadDepartmentData(deptId) {
            try {
                const response = await apiCall(`/api/departments/${deptId}`);
                const dept = response.department || response;

                document.getElementById('dept_id').value = dept.id;
                document.getElementById('dept_name').value = dept.name;
                document.getElementById('dept_description').value = dept.description || '';
                document.getElementById('dept_code').value = dept.code || '';
                document.getElementById('dept_manager_id').value = dept.manager_id || '';
                document.getElementById('dept_active').checked = dept.is_active !== false;

                await loadManagerOptions();
            } catch (error) {
                console.error('Departman verileri yüklenemedi:', error);
                alert('Departman verileri yüklenemedi: ' + error.message);
            }
        }

        async function loadManagerOptions() {
            try {
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                const managerSelect = document.getElementById('dept_manager_id');

                managerSelect.innerHTML = '';
                managerSelect.add(new Option('Yönetici Seçiniz (Opsiyonel)', ''));

                // Sadece Manager ve Admin rolündeki kullanıcıları göster
                const managers = users.filter(user => 
                    user.role_name && user.role_name.includes('Yönetici')
                );

                managers.forEach(user => {
                    managerSelect.add(new Option(`${user.full_name} (${user.role_name})`, user.id));
                });
            } catch (error) {
                console.error('Yönetici listesi yüklenemedi:', error);
            }
        }

        function editDepartment(deptId) {
            openDepartmentModal(deptId);
        }

        async function deleteDepartment(deptId) {
            if (!confirm('Bu departmanı silmek istediğinizden emin misiniz?\n\nBu departman silindiğinde, bu departmana ait kullanıcılar varsayılan departmana atanacaktır.')) {
                return;
            }

            try {
                await apiCall(`/api/departments/${deptId}`, {
                    method: 'DELETE'
                });

                alert('Departman başarıyla silindi!');
                showDepartments(); // Listeyi yenile
            } catch (error) {
                alert('Departman silinemedi: ' + error.message);
            }
        }

        // Rol yönetimi fonksiyonları
        async function showRoles() {
            try {
                const rolesResponse = await apiCall('/api/roles');
                const roles = rolesResponse.roles || [];

                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>🔐 Rol Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    Kullanıcı rollerini ve yetkilerini yönetin
                                </p>
                            </div>
                            <button class="btn" onclick="openRoleModal()">
                                ➕ Yeni Rol
                            </button>
                        </div>

                        <div style="background: var(--primary-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-solid); margin-bottom: 0.5rem;">💡 Rol Açıklamaları:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                <div><strong>Admin:</strong> Tüm sistem yetkilerine sahip</div>
                                <div><strong>Manager:</strong> Departman yönetimi ve raporlama</div>
                                <div><strong>Employee:</strong> Temel işlem yetkilerine sahip</div>
                                <div><strong>Viewer:</strong> Sadece görüntüleme yetkisi</div>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Rol Adı</th>
                                    <th>Açıklama</th>
                                    <th>Kullanıcı Sayısı</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Kullanıcı sayılarını hesapla (örnek - gerçek veri users tablosundan gelecek)
                const userCounts = {
                    1: 5, // Admin
                    2: 8, // Manager
                    3: 15, // Employee
                    4: 3  // Viewer
                };

                roles.forEach(role => {
                    const userCount = userCounts[role.id] || 0;
                    const roleIcon = {
                        'Admin': '👑',
                        'Manager': '👨‍💼',
                        'Employee': '👤',
                        'Viewer': '👁️'
                    }[role.name] || '🔐';

                    html += `
                        <tr>
                            <td>${role.id}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${roleIcon}</span>
                                    <strong>${role.name}</strong>
                                </div>
                            </td>
                            <td>${role.description || '-'}</td>
                            <td>
                                <span class="status-badge info">${userCount} kullanıcı</span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="editRole(${role.id})">
                                        ✏️ Düzenle
                                    </button>
                                    ${role.name !== 'Admin' ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteRole(${role.id})">
                                            🗑️ Sil
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;

            } catch (error) {
                console.error('Roller yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>🔐 Rol Yönetimi</h2>
                        <p style="color: red;">Roller yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Rol modal fonksiyonları
        function openRoleModal(roleId = null) {
            const modal = document.getElementById('roleModal');
            const title = document.getElementById('roleModalTitle');
            const form = document.getElementById('roleForm');

            if (roleId) {
                title.textContent = 'Rol Düzenle';
                // Rol verilerini yükle ve formu doldur
                loadRoleData(roleId);
            } else {
                title.textContent = 'Yeni Rol';
                form.reset();
                document.getElementById('role_active').checked = true;
                document.getElementById('role_id').value = '';
            }

            modal.style.display = 'block';
        }

        async function loadRoleData(roleId) {
            try {
                const response = await apiCall(`/api/roles/${roleId}`);
                const role = response.role || response;

                document.getElementById('role_edit_id').value = role.id;
                document.getElementById('role_name').value = role.name;
                document.getElementById('role_description').value = role.description || '';
                document.getElementById('role_level').value = role.level || 2;
                document.getElementById('role_active').checked = role.is_active !== false;
            } catch (error) {
                console.error('Rol verileri yüklenemedi:', error);
                alert('Rol verileri yüklenemedi: ' + error.message);
            }
        }

        function editRole(roleId) {
            openRoleModal(roleId);
        }

        async function deleteRole(roleId) {
            if (!confirm('Bu rolü silmek istediğinizden emin misiniz?\n\nBu rol silindiğinde, bu role sahip kullanıcılar varsayılan role atanacaktır.')) {
                return;
            }

            try {
                await apiCall(`/api/roles/${roleId}`, {
                    method: 'DELETE'
                });

                alert('Rol başarıyla silindi!');
                showRoles(); // Listeyi yenile
            } catch (error) {
                alert('Rol silinemedi: ' + error.message);
            }
        }

        // Cari hesap yönetimi
        async function showCariHesap() {
            try {
                const transactionsResponse = await apiCall('/api/account-transactions');
                const transactions = transactionsResponse.transactions || [];
                
                let html = `
                    <div class="card">
                        <h2>Cari Hesap Yönetimi</h2>
                        <button class="btn" onclick="openTransactionModal()">Yeni İşlem</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Müşteri</th>
                                    <th>İşlem Tipi</th>
                                    <th>Tutar</th>
                                    <th>Açıklama</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                transactions.forEach(transaction => {
                    html += `
                        <tr>
                            <td>${new Date(transaction.transaction_date).toLocaleDateString('tr-TR')}</td>
                            <td>${transaction.customer_name || '-'}</td>
                            <td>${transaction.transaction_type}</td>
                            <td>${transaction.amount} TL</td>
                            <td>${transaction.description || '-'}</td>
                            <td>
                                <button class="btn" onclick="editTransaction(${transaction.id})">Düzenle</button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Cari hesap verileri yüklenemedi:', error);
            }
        }

        // Hedef yönetimi
        async function showTargets() {
            try {
                // Kullanıcıları ve hedefleri çek
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];

                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;

                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>🎯 Hedef Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    Kullanıcı hedeflerini belirleyin ve takip edin - ${currentYear}/${currentMonth.toString().padStart(2, '0')}
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <select id="targetYearFilter" onchange="filterTargets()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                                    <option value="${currentYear}">${currentYear}</option>
                                    <option value="${currentYear - 1}">${currentYear - 1}</option>
                                    <option value="${currentYear + 1}">${currentYear + 1}</option>
                                </select>
                                <select id="targetMonthFilter" onchange="filterTargets()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                                    ${Array.from({length: 12}, (_, i) => {
                                        const month = i + 1;
                                        const monthName = new Date(2024, i, 1).toLocaleDateString('tr-TR', { month: 'long' });
                                        return `<option value="${month}" ${month === currentMonth ? 'selected' : ''}>${monthName}</option>`;
                                    }).join('')}
                                </select>
                                <button class="btn" onclick="openTargetModal()">
                                    ➕ Hedef Belirle
                                </button>
                            </div>
                        </div>

                        <div style="background: var(--primary-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-solid); margin-bottom: 0.5rem;">💡 Hedef Türleri:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                <div><strong>Satış:</strong> Aylık satış tutarı hedefi</div>
                                <div><strong>Ziyaret:</strong> Aylık müşteri ziyaret sayısı</div>
                                <div><strong>Üretim:</strong> Aylık üretim adet hedefi</div>
                                <div><strong>Ciro:</strong> Aylık toplam ciro hedefi</div>
                                <div><strong>Tahsilat:</strong> Aylık tahsilat tutarı</div>
                            </div>
                        </div>

                        <div id="targetsTable">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Kullanıcı</th>
                                        <th>Departman</th>
                                        <th>Satış Hedefi</th>
                                        <th>Ziyaret Hedefi</th>
                                        <th>Üretim Hedefi</th>
                                        <th>Ciro Hedefi</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="targetsTableBody">
                                    <!-- Hedefler buraya yüklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = html;

                // Hedefleri yükle
                await loadTargetsForMonth(currentYear, currentMonth);

            } catch (error) {
                console.error('Hedefler yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>🎯 Hedef Yönetimi</h2>
                        <p style="color: red;">Hedefler yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Hedef yükleme ve filtreleme fonksiyonları
        async function loadTargetsForMonth(year, month) {
            try {
                const targetsResponse = await apiCall(`/api/user-targets?year=${year}&month=${month}`);
                const targets = targetsResponse.targets || [];

                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];

                const tableBody = document.getElementById('targetsTableBody');
                if (!tableBody) return;

                tableBody.innerHTML = '';

                users.forEach(user => {
                    const userTarget = targets.find(t => t.user_id === user.id);

                    // Hedef durumu hesapla
                    let status = 'Hedef Yok';
                    let statusClass = 'danger';

                    if (userTarget) {
                        const totalTarget = (userTarget.sales_target || 0) + (userTarget.revenue_target || 0);
                        const totalAchieved = (userTarget.sales_achieved || 0) + (userTarget.revenue_achieved || 0);

                        if (totalTarget > 0) {
                            const percentage = Math.round((totalAchieved / totalTarget) * 100);
                            if (percentage >= 100) {
                                status = `Hedef Aşıldı (%${percentage})`;
                                statusClass = 'success';
                            } else if (percentage >= 70) {
                                status = `İyi Gidiyor (%${percentage})`;
                                statusClass = 'warning';
                            } else {
                                status = `Hedefin Altında (%${percentage})`;
                                statusClass = 'danger';
                            }
                        } else {
                            status = 'Hedef Belirlendi';
                            statusClass = 'info';
                        }
                    }

                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <strong>${user.full_name}</strong>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">(${user.role_name || 'Rol Yok'})</span>
                                </div>
                            </td>
                            <td>${user.department_name || '-'}</td>
                            <td>
                                ${userTarget ?
                                    `<div>
                                        <strong>${(userTarget.sales_target || 0).toLocaleString('tr-TR')} ₺</strong>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            Gerçekleşen: ${(userTarget.sales_achieved || 0).toLocaleString('tr-TR')} ₺
                                        </div>
                                    </div>` :
                                    '<span style="color: var(--text-secondary);">-</span>'
                                }
                            </td>
                            <td>
                                ${userTarget ?
                                    `<div>
                                        <strong>${userTarget.visit_target || 0} ziyaret</strong>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            Gerçekleşen: ${userTarget.visit_achieved || 0} ziyaret
                                        </div>
                                    </div>` :
                                    '<span style="color: var(--text-secondary);">-</span>'
                                }
                            </td>
                            <td>
                                ${userTarget ?
                                    `<div>
                                        <strong>${userTarget.production_target || 0} adet</strong>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            Gerçekleşen: ${userTarget.production_achieved || 0} adet
                                        </div>
                                    </div>` :
                                    '<span style="color: var(--text-secondary);">-</span>'
                                }
                            </td>
                            <td>
                                ${userTarget ?
                                    `<div>
                                        <strong>${(userTarget.revenue_target || 0).toLocaleString('tr-TR')} ₺</strong>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            Gerçekleşen: ${(userTarget.revenue_achieved || 0).toLocaleString('tr-TR')} ₺
                                        </div>
                                    </div>` :
                                    '<span style="color: var(--text-secondary);">-</span>'
                                }
                            </td>
                            <td>
                                <span class="status-badge ${statusClass}">${status}</span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="editUserTarget(${user.id}, ${year}, ${month})">
                                        ${userTarget ? '✏️ Düzenle' : '➕ Hedef Belirle'}
                                    </button>
                                    ${userTarget ? `
                                        <button class="btn btn-sm btn-danger" onclick="deleteUserTarget(${userTarget.id})">
                                            🗑️ Sil
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Hedefler yüklenemedi:', error);
                const tableBody = document.getElementById('targetsTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Hedefler yüklenemedi: ' + error.message + '</td></tr>';
                }
            }
        }

        async function filterTargets() {
            const year = document.getElementById('targetYearFilter').value;
            const month = document.getElementById('targetMonthFilter').value;
            await loadTargetsForMonth(parseInt(year), parseInt(month));
        }

        // Hedef modal fonksiyonları
        function openTargetModal(userId = null, year = null, month = null) {
            const modal = document.getElementById('targetModal');
            const title = document.getElementById('targetModalTitle');
            const form = document.getElementById('targetForm');

            // Varsayılan değerler
            const currentDate = new Date();
            const currentYear = year || currentDate.getFullYear();
            const currentMonth = month || (currentDate.getMonth() + 1);

            title.textContent = userId ? 'Kullanıcı Hedefi Düzenle' : 'Yeni Hedef Belirle';
            form.reset();

            // Tarih değerlerini ayarla
            document.getElementById('target_year').value = currentYear;
            document.getElementById('target_month').value = currentMonth;

            if (userId) {
                document.getElementById('target_user_id').value = userId;
                document.getElementById('target_user_id').disabled = true;
                loadTargetData(userId, currentYear, currentMonth);
            } else {
                document.getElementById('target_user_id').disabled = false;
                document.getElementById('target_id').value = '';
            }

            loadUserOptions();
            modal.style.display = 'block';
        }

        async function loadUserOptions() {
            try {
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                const userSelect = document.getElementById('target_user_id');

                userSelect.innerHTML = '';
                userSelect.add(new Option('Kullanıcı Seçiniz', ''));

                users.forEach(user => {
                    userSelect.add(new Option(`${user.full_name} (${user.role_name || 'Rol Yok'})`, user.id));
                });
            } catch (error) {
                console.error('Kullanıcı listesi yüklenemedi:', error);
            }
        }

        async function loadTargetData(userId, year, month) {
            try {
                const response = await apiCall(`/api/user-targets/${userId}?year=${year}&month=${month}`);
                const target = response.target;

                if (target) {
                    document.getElementById('target_id').value = target.id;
                    document.getElementById('target_sales').value = target.sales_target || 0;
                    document.getElementById('target_visits').value = target.visit_target || 0;
                    document.getElementById('target_production').value = target.production_target || 0;
                    document.getElementById('target_revenue').value = target.revenue_target || 0;
                    document.getElementById('target_collection').value = target.collection_target || 0;
                    document.getElementById('target_notes').value = target.notes || '';
                }
            } catch (error) {
                console.error('Hedef verileri yüklenemedi:', error);
                // Hata durumunda boş form göster
                document.getElementById('target_id').value = '';
            }
        }

        function editUserTarget(userId, year, month) {
            openTargetModal(userId, year, month);
        }

        async function deleteUserTarget(targetId) {
            if (!confirm('Bu hedefi silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                await apiCall(`/api/user-targets/${targetId}`, {
                    method: 'DELETE'
                });

                alert('Hedef başarıyla silindi!');

                // Listeyi yenile
                const year = document.getElementById('targetYearFilter').value;
                const month = document.getElementById('targetMonthFilter').value;
                await loadTargetsForMonth(parseInt(year), parseInt(month));
            } catch (error) {
                alert('Hedef silinemedi: ' + error.message);
            }
        }

        // İrsaliye yönetimi fonksiyonları
        async function showDeliveryNotes() {
            try {
                const deliveryNotesResponse = await apiCall('/api/delivery-notes');
                const deliveryNotes = deliveryNotesResponse.delivery_notes || [];

                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>📋 İrsaliye Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    Dijital irsaliyeleri yönetin ve takip edin
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <select id="deliveryStatusFilter" onchange="filterDeliveryNotes()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                                    <option value="">Tüm Durumlar</option>
                                    <option value="pending">Bekleyen</option>
                                    <option value="in_transit">Yolda</option>
                                    <option value="delivered">Teslim Edildi</option>
                                    <option value="cancelled">İptal</option>
                                </select>
                                <button class="btn" onclick="openDeliveryNoteModal()">
                                    ➕ Yeni İrsaliye
                                </button>
                            </div>
                        </div>

                        <div style="background: var(--primary-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-solid); margin-bottom: 0.5rem;">📋 İrsaliye Süreci:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                <div><strong>1. Oluştur:</strong> Sipariş bazlı irsaliye oluştur</div>
                                <div><strong>2. Sevkiyat:</strong> Sevkiyat personeline ata</div>
                                <div><strong>3. Teslimat:</strong> Müşteriye teslim et</div>
                                <div><strong>4. İmza:</strong> Dijital imza ile onayla</div>
                            </div>
                        </div>

                        <div id="deliveryNotesTable">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>İrsaliye No</th>
                                        <th>Müşteri</th>
                                        <th>Sipariş</th>
                                        <th>Teslimat Tarihi</th>
                                        <th>Sevkiyat Personeli</th>
                                        <th>Durum</th>
                                        <th>İmza</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveryNotesTableBody">
                                    <!-- İrsaliyeler buraya yüklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = html;

                // İrsaliyeleri yükle
                await loadDeliveryNotes();

            } catch (error) {
                console.error('İrsaliyeler yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>📋 İrsaliye Yönetimi</h2>
                        <p style="color: red;">İrsaliyeler yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadDeliveryNotes(statusFilter = '') {
            try {
                let url = '/api/delivery-notes';
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }

                const deliveryNotesResponse = await apiCall(url);
                const deliveryNotes = deliveryNotesResponse.delivery_notes || [];

                const tableBody = document.getElementById('deliveryNotesTableBody');
                if (!tableBody) return;

                tableBody.innerHTML = '';

                deliveryNotes.forEach(note => {
                    const statusColors = {
                        'pending': 'warning',
                        'in_transit': 'info',
                        'delivered': 'success',
                        'cancelled': 'danger'
                    };

                    const statusTexts = {
                        'pending': 'Bekleyen',
                        'in_transit': 'Yolda',
                        'delivered': 'Teslim Edildi',
                        'cancelled': 'İptal'
                    };

                    const hasSignature = note.customer_signature && note.signature_date;

                    tableBody.innerHTML += `
                        <tr>
                            <td>
                                <strong>${note.delivery_number}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${new Date(note.created_at).toLocaleDateString('tr-TR')}
                                </div>
                            </td>
                            <td>
                                <strong>${note.customer_name || 'Müşteri Bilgisi Yok'}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${note.delivery_address || '-'}
                                </div>
                            </td>
                            <td>
                                ${note.order_id ? `<a href="#" onclick="viewOrderDetail(${note.order_id})" style="color: var(--primary-solid);">Sipariş #${note.order_id}</a>` : '-'}
                            </td>
                            <td>
                                <div>${new Date(note.delivery_date).toLocaleDateString('tr-TR')}</div>
                                ${note.delivery_time ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${note.delivery_time}</div>` : ''}
                            </td>
                            <td>${note.delivered_by_name || '-'}</td>
                            <td>
                                <span class="status-badge ${statusColors[note.status] || 'secondary'}">
                                    ${statusTexts[note.status] || note.status}
                                </span>
                            </td>
                            <td>
                                ${hasSignature ?
                                    `<div style="color: var(--success-solid);">
                                        ✅ İmzalandı
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                            ${new Date(note.signature_date).toLocaleDateString('tr-TR')}
                                        </div>
                                    </div>` :
                                    '<span style="color: var(--text-secondary);">❌ İmza Yok</span>'
                                }
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="viewDeliveryNote(${note.id})">
                                        👁️ Görüntüle
                                    </button>
                                    ${note.status === 'pending' ? `
                                        <button class="btn btn-sm btn-primary" onclick="editDeliveryNote(${note.id})">
                                            ✏️ Düzenle
                                        </button>
                                    ` : ''}
                                    ${hasSignature ? `
                                        <button class="btn btn-sm btn-success" onclick="viewSignature(${note.id})">
                                            ✍️ İmza
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                if (deliveryNotes.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">Henüz irsaliye bulunmuyor</td></tr>';
                }

            } catch (error) {
                console.error('İrsaliyeler yüklenemedi:', error);
                const tableBody = document.getElementById('deliveryNotesTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">İrsaliyeler yüklenemedi: ' + error.message + '</td></tr>';
                }
            }
        }

        async function filterDeliveryNotes() {
            const statusFilter = document.getElementById('deliveryStatusFilter').value;
            await loadDeliveryNotes(statusFilter);
        }

        // İrsaliye modal fonksiyonları
        function openDeliveryNoteModal(deliveryNoteId = null) {
            const modal = document.getElementById('deliveryNoteModal');
            const title = document.getElementById('deliveryNoteModalTitle');
            const form = document.getElementById('deliveryNoteForm');

            title.textContent = deliveryNoteId ? 'İrsaliye Düzenle' : 'Yeni İrsaliye';
            form.reset();

            // Bugünün tarihini varsayılan olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('delivery_date').value = today;

            if (deliveryNoteId) {
                document.getElementById('delivery_note_id').value = deliveryNoteId;
                loadDeliveryNoteData(deliveryNoteId);
            } else {
                document.getElementById('delivery_note_id').value = '';
                generateDeliveryNumber();
            }

            loadDeliveryNoteOptions();
            modal.style.display = 'block';
        }

        async function loadDeliveryNoteOptions() {
            try {
                // Müşterileri yükle
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                const customerSelect = document.getElementById('delivery_customer_id');

                customerSelect.innerHTML = '';
                customerSelect.add(new Option('Müşteri Seçiniz', ''));
                customers.forEach(customer => {
                    customerSelect.add(new Option(customer.company_name, customer.id));
                });

                // Siparişleri yükle
                const ordersResponse = await apiCall('/api/orders');
                const orders = ordersResponse.orders || [];
                const orderSelect = document.getElementById('delivery_order_id');

                orderSelect.innerHTML = '';
                orderSelect.add(new Option('Sipariş Seçiniz (Opsiyonel)', ''));
                orders.filter(order => order.status !== 'cancelled').forEach(order => {
                    orderSelect.add(new Option(`Sipariş #${order.id} - ${order.customer_name}`, order.id));
                });

                // Sevkiyat personelini yükle
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                const deliveryPersonSelect = document.getElementById('delivery_delivered_by');

                deliveryPersonSelect.innerHTML = '';
                deliveryPersonSelect.add(new Option('Personel Seçiniz', ''));
                users.filter(user => user.role_name && (user.role_name.includes('Shipping') || user.role_name.includes('Sevkiyat'))).forEach(user => {
                    deliveryPersonSelect.add(new Option(user.full_name, user.id));
                });

                // Eğer sevkiyat personeli yoksa tüm kullanıcıları göster
                if (deliveryPersonSelect.children.length === 1) {
                    users.forEach(user => {
                        deliveryPersonSelect.add(new Option(`${user.full_name} (${user.role_name || 'Rol Yok'})`, user.id));
                    });
                }

            } catch (error) {
                console.error('İrsaliye seçenekleri yüklenemedi:', error);
            }
        }

        async function generateDeliveryNumber() {
            try {
                const response = await apiCall('/api/delivery-notes/generate-number');
                document.getElementById('delivery_number').value = response.delivery_number;
            } catch (error) {
                console.error('İrsaliye numarası oluşturulamadı:', error);
                // Fallback: Tarih bazlı numara oluştur
                const now = new Date();
                const dateStr = now.getFullYear().toString().substr(-2) +
                               (now.getMonth() + 1).toString().padStart(2, '0') +
                               now.getDate().toString().padStart(2, '0');
                const timeStr = now.getHours().toString().padStart(2, '0') +
                               now.getMinutes().toString().padStart(2, '0');
                document.getElementById('delivery_number').value = `IRS${dateStr}${timeStr}`;
            }
        }

        async function loadDeliveryNoteData(deliveryNoteId) {
            try {
                const response = await apiCall(`/api/delivery-notes/${deliveryNoteId}`);
                const note = response.delivery_note;

                document.getElementById('delivery_number').value = note.delivery_number;
                document.getElementById('delivery_order_id').value = note.order_id || '';
                document.getElementById('delivery_customer_id').value = note.customer_id;
                document.getElementById('delivery_delivered_by').value = note.delivered_by || '';
                document.getElementById('delivery_date').value = note.delivery_date;
                document.getElementById('delivery_time').value = note.delivery_time || '';
                document.getElementById('delivery_address').value = note.delivery_address || '';
                document.getElementById('delivery_notes').value = note.notes || '';
                document.getElementById('delivery_internal_notes').value = note.internal_notes || '';

            } catch (error) {
                console.error('İrsaliye verileri yüklenemedi:', error);
                alert('İrsaliye verileri yüklenemedi: ' + error.message);
            }
        }

        function editDeliveryNote(deliveryNoteId) {
            openDeliveryNoteModal(deliveryNoteId);
        }

        async function viewDeliveryNote(deliveryNoteId) {
            try {
                const response = await apiCall(`/api/delivery-notes/${deliveryNoteId}`);
                const note = response.delivery_note;

                // İrsaliye detay sayfasını aç (şimdilik alert ile göster)
                alert(`İrsaliye Detayları:\n\nNo: ${note.delivery_number}\nMüşteri: ${note.customer_name}\nTarih: ${note.delivery_date}\nDurum: ${note.status}\n\nDetay sayfası yakında eklenecek!`);

            } catch (error) {
                alert('İrsaliye detayları yüklenemedi: ' + error.message);
            }
        }

        async function viewSignature(deliveryNoteId) {
            try {
                const response = await apiCall(`/api/delivery-notes/${deliveryNoteId}`);
                const note = response.delivery_note;

                if (!note.customer_signature) {
                    alert('Bu irsaliye için imza bulunmuyor.');
                    return;
                }

                const signatureContent = document.getElementById('signatureContent');
                signatureContent.innerHTML = `
                    <div style="text-align: center;">
                        <h4>İmza Bilgileri</h4>
                        <div style="margin: 1rem 0;">
                            <strong>İmzalayan:</strong> ${note.customer_name || 'Bilinmiyor'}<br>
                            <strong>Unvan:</strong> ${note.customer_title || 'Belirtilmemiş'}<br>
                            <strong>Tarih:</strong> ${new Date(note.signature_date).toLocaleString('tr-TR')}<br>
                            <strong>IP Adresi:</strong> ${note.signature_ip || 'Bilinmiyor'}
                        </div>
                        <div style="border: 2px solid #ddd; padding: 1rem; background: #f9f9f9; border-radius: 8px;">
                            <img src="${note.customer_signature}" alt="Müşteri İmzası" style="max-width: 100%; height: auto; border: 1px solid #ccc;">
                        </div>
                    </div>
                `;

                document.getElementById('signatureModal').style.display = 'block';

            } catch (error) {
                alert('İmza bilgileri yüklenemedi: ' + error.message);
            }
        }

        // Randevu yönetimi fonksiyonları
        async function showAppointments() {
            try {
                const appointmentsResponse = await apiCall('/api/appointments');
                const appointments = appointmentsResponse.appointments || [];

                let html = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>📅 Randevu & Görev Yönetimi</h2>
                                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                                    Randevuları, görevleri ve ziyaretleri yönetin
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <select id="appointmentTypeFilter" onchange="filterAppointments()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                                    <option value="">Tüm Türler</option>
                                    <option value="appointment">Randevu</option>
                                    <option value="task">Görev</option>
                                    <option value="visit">Ziyaret</option>
                                    <option value="call">Arama</option>
                                    <option value="meeting">Toplantı</option>
                                </select>
                                <select id="appointmentStatusFilter" onchange="filterAppointments()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                                    <option value="">Tüm Durumlar</option>
                                    <option value="pending">Bekleyen</option>
                                    <option value="in_progress">Devam Eden</option>
                                    <option value="completed">Tamamlanan</option>
                                    <option value="cancelled">İptal</option>
                                    <option value="postponed">Ertelenen</option>
                                </select>
                                <button class="btn" onclick="showCalendarView()">
                                    📅 Takvim Görünümü
                                </button>
                                <button class="btn" onclick="openAppointmentModal()">
                                    ➕ Yeni Randevu
                                </button>
                            </div>
                        </div>

                        <div style="background: var(--primary-light); padding: 1rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h4 style="color: var(--primary-solid); margin-bottom: 0.5rem;">📋 Randevu Türleri:</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                                <div><strong>📅 Randevu:</strong> Müşteri randevuları</div>
                                <div><strong>✅ Görev:</strong> Yapılacak işler</div>
                                <div><strong>🏢 Ziyaret:</strong> Müşteri ziyaretleri</div>
                                <div><strong>📞 Arama:</strong> Telefon görüşmeleri</div>
                                <div><strong>👥 Toplantı:</strong> Ekip toplantıları</div>
                            </div>
                        </div>

                        <div id="appointmentsTable">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Başlık</th>
                                        <th>Tür</th>
                                        <th>Atanan Kişi</th>
                                        <th>Müşteri</th>
                                        <th>Tarih & Saat</th>
                                        <th>Öncelik</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentsTableBody">
                                    <!-- Randevular buraya yüklenecek -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('content').innerHTML = html;

                // Randevuları yükle
                await loadAppointments();

            } catch (error) {
                console.error('Randevular yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>📅 Randevu & Görev Yönetimi</h2>
                        <p style="color: red;">Randevular yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadAppointments(typeFilter = '', statusFilter = '') {
            try {
                let url = '/api/appointments';
                const params = [];
                if (typeFilter) params.push(`type=${typeFilter}`);
                if (statusFilter) params.push(`status=${statusFilter}`);
                if (params.length > 0) url += '?' + params.join('&');

                const appointmentsResponse = await apiCall(url);
                const appointments = appointmentsResponse.appointments || [];

                const tableBody = document.getElementById('appointmentsTableBody');
                if (!tableBody) return;

                tableBody.innerHTML = '';

                appointments.forEach(appointment => {
                    const typeIcons = {
                        'appointment': '📅',
                        'task': '✅',
                        'visit': '🏢',
                        'call': '📞',
                        'meeting': '👥'
                    };

                    const typeTexts = {
                        'appointment': 'Randevu',
                        'task': 'Görev',
                        'visit': 'Ziyaret',
                        'call': 'Arama',
                        'meeting': 'Toplantı'
                    };

                    const statusColors = {
                        'pending': 'warning',
                        'in_progress': 'info',
                        'completed': 'success',
                        'cancelled': 'danger',
                        'postponed': 'secondary'
                    };

                    const statusTexts = {
                        'pending': 'Bekleyen',
                        'in_progress': 'Devam Eden',
                        'completed': 'Tamamlanan',
                        'cancelled': 'İptal',
                        'postponed': 'Ertelenen'
                    };

                    const priorityColors = {
                        'low': 'secondary',
                        'medium': 'info',
                        'high': 'warning',
                        'urgent': 'danger'
                    };

                    const priorityTexts = {
                        'low': 'Düşük',
                        'medium': 'Orta',
                        'high': 'Yüksek',
                        'urgent': 'Acil'
                    };

                    const startDateTime = new Date(`${appointment.start_date}T${appointment.start_time || '00:00'}`);
                    const isOverdue = startDateTime < new Date() && appointment.status === 'pending';

                    tableBody.innerHTML += `
                        <tr ${isOverdue ? 'style="background-color: rgba(244, 67, 54, 0.1);"' : ''}>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${typeIcons[appointment.type] || '📋'}</span>
                                    <div>
                                        <strong>${appointment.title}</strong>
                                        ${appointment.description ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${appointment.description.substring(0, 50)}${appointment.description.length > 50 ? '...' : ''}</div>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="status-badge info">
                                    ${typeTexts[appointment.type] || appointment.type}
                                </span>
                            </td>
                            <td>
                                <strong>${appointment.assigned_to_name || 'Atanmamış'}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    ${appointment.assigned_to_role || ''}
                                </div>
                            </td>
                            <td>
                                ${appointment.customer_name ?
                                    `<a href="#" onclick="viewCustomerDetail(${appointment.customer_id})" style="color: var(--primary-solid);">${appointment.customer_name}</a>` :
                                    '<span style="color: var(--text-secondary);">-</span>'
                                }
                            </td>
                            <td>
                                <div>
                                    <strong>${new Date(appointment.start_date).toLocaleDateString('tr-TR')}</strong>
                                    ${appointment.start_time ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${appointment.start_time.substring(0, 5)}</div>` : ''}
                                </div>
                                ${isOverdue ? '<div style="color: var(--danger-solid); font-size: 0.75rem; font-weight: bold;">⚠️ Gecikmiş</div>' : ''}
                            </td>
                            <td>
                                <span class="status-badge ${priorityColors[appointment.priority] || 'secondary'}">
                                    ${priorityTexts[appointment.priority] || appointment.priority}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${statusColors[appointment.status] || 'secondary'}">
                                    ${statusTexts[appointment.status] || appointment.status}
                                </span>
                            </td>
                            <td>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="viewAppointment(${appointment.id})">
                                        👁️ Görüntüle
                                    </button>
                                    ${appointment.status === 'pending' || appointment.status === 'in_progress' ? `
                                        <button class="btn btn-sm btn-primary" onclick="editAppointment(${appointment.id})">
                                            ✏️ Düzenle
                                        </button>
                                    ` : ''}
                                    ${appointment.status === 'pending' ? `
                                        <button class="btn btn-sm btn-success" onclick="completeAppointment(${appointment.id})">
                                            ✅ Tamamla
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });

                if (appointments.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">Henüz randevu bulunmuyor</td></tr>';
                }

            } catch (error) {
                console.error('Randevular yüklenemedi:', error);
                const tableBody = document.getElementById('appointmentsTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Randevular yüklenemedi: ' + error.message + '</td></tr>';
                }
            }
        }

        async function filterAppointments() {
            const typeFilter = document.getElementById('appointmentTypeFilter').value;
            const statusFilter = document.getElementById('appointmentStatusFilter').value;
            await loadAppointments(typeFilter, statusFilter);
        }

        function showCalendarView() {
            alert('Takvim görünümü yakında eklenecek!\n\nÖzellikler:\n- Aylık/haftalık/günlük görünüm\n- Sürükle-bırak ile randevu taşıma\n- Hızlı randevu oluşturma\n- Renk kodlaması');
        }

        // Randevu modal fonksiyonları
        function openAppointmentModal(appointmentId = null) {
            const modal = document.getElementById('appointmentModal');
            const title = document.getElementById('appointmentModalTitle');
            const form = document.getElementById('appointmentForm');

            title.textContent = appointmentId ? 'Randevu Düzenle' : 'Yeni Randevu';
            form.reset();

            // Bugünün tarihini varsayılan olarak ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointment_start_date').value = today;

            // Varsayılan değerleri ayarla
            document.getElementById('appointment_priority').value = 'medium';
            document.getElementById('appointment_reminder_minutes').value = '15';

            if (appointmentId) {
                document.getElementById('appointment_id').value = appointmentId;
                loadAppointmentData(appointmentId);
            } else {
                document.getElementById('appointment_id').value = '';
            }

            loadAppointmentOptions();
            modal.style.display = 'block';
        }

        async function loadAppointmentOptions() {
            try {
                // Kullanıcıları yükle
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];
                const userSelect = document.getElementById('appointment_assigned_to');

                userSelect.innerHTML = '';
                userSelect.add(new Option('Kişi Seçiniz', ''));
                users.forEach(user => {
                    userSelect.add(new Option(`${user.full_name} (${user.role_name || 'Rol Yok'})`, user.id));
                });

                // Müşterileri yükle
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                const customerSelect = document.getElementById('appointment_customer_id');

                customerSelect.innerHTML = '';
                customerSelect.add(new Option('Müşteri Seçiniz (Opsiyonel)', ''));
                customers.forEach(customer => {
                    customerSelect.add(new Option(customer.company_name, customer.id));
                });

            } catch (error) {
                console.error('Randevu seçenekleri yüklenemedi:', error);
            }
        }

        async function loadAppointmentData(appointmentId) {
            try {
                const response = await apiCall(`/api/appointments/${appointmentId}`);
                const appointment = response.appointment;

                document.getElementById('appointment_title').value = appointment.title;
                document.getElementById('appointment_description').value = appointment.description || '';
                document.getElementById('appointment_type').value = appointment.type;
                document.getElementById('appointment_priority').value = appointment.priority;
                document.getElementById('appointment_start_date').value = appointment.start_date;
                document.getElementById('appointment_start_time').value = appointment.start_time || '';
                document.getElementById('appointment_end_date').value = appointment.end_date || '';
                document.getElementById('appointment_end_time').value = appointment.end_time || '';
                document.getElementById('appointment_all_day').checked = appointment.all_day;
                document.getElementById('appointment_assigned_to').value = appointment.assigned_to;
                document.getElementById('appointment_customer_id').value = appointment.customer_id || '';
                document.getElementById('appointment_location').value = appointment.location || '';
                document.getElementById('appointment_address').value = appointment.address || '';
                document.getElementById('appointment_reminder_minutes').value = appointment.reminder_minutes || 15;

            } catch (error) {
                console.error('Randevu verileri yüklenemedi:', error);
                alert('Randevu verileri yüklenemedi: ' + error.message);
            }
        }

        function editAppointment(appointmentId) {
            openAppointmentModal(appointmentId);
        }

        async function viewAppointment(appointmentId) {
            try {
                const response = await apiCall(`/api/appointments/${appointmentId}`);
                const appointment = response.appointment;

                const typeTexts = {
                    'appointment': 'Randevu',
                    'task': 'Görev',
                    'visit': 'Ziyaret',
                    'call': 'Arama',
                    'meeting': 'Toplantı'
                };

                const priorityTexts = {
                    'low': 'Düşük',
                    'medium': 'Orta',
                    'high': 'Yüksek',
                    'urgent': 'Acil'
                };

                const statusTexts = {
                    'pending': 'Bekleyen',
                    'in_progress': 'Devam Eden',
                    'completed': 'Tamamlanan',
                    'cancelled': 'İptal',
                    'postponed': 'Ertelenen'
                };

                let details = `Randevu Detayları:\n\n`;
                details += `Başlık: ${appointment.title}\n`;
                details += `Tür: ${typeTexts[appointment.type] || appointment.type}\n`;
                details += `Öncelik: ${priorityTexts[appointment.priority] || appointment.priority}\n`;
                details += `Durum: ${statusTexts[appointment.status] || appointment.status}\n`;
                details += `Tarih: ${new Date(appointment.start_date).toLocaleDateString('tr-TR')}\n`;
                if (appointment.start_time) details += `Saat: ${appointment.start_time.substring(0, 5)}\n`;
                details += `Atanan: ${appointment.assigned_to_name || 'Bilinmiyor'}\n`;
                if (appointment.customer_name) details += `Müşteri: ${appointment.customer_name}\n`;
                if (appointment.location) details += `Konum: ${appointment.location}\n`;
                if (appointment.description) details += `\nAçıklama: ${appointment.description}\n`;

                details += `\nDetay sayfası yakında eklenecek!`;

                alert(details);

            } catch (error) {
                alert('Randevu detayları yüklenemedi: ' + error.message);
            }
        }

        async function completeAppointment(appointmentId) {
            const notes = prompt('Randevu tamamlandı. Tamamlama notları (opsiyonel):');
            if (notes === null) return; // İptal edildi

            try {
                await apiCall(`/api/appointments/${appointmentId}/complete`, {
                    method: 'POST',
                    body: JSON.stringify({ completion_notes: notes })
                });

                alert('Randevu başarıyla tamamlandı!');
                await loadAppointments(); // Listeyi yenile
            } catch (error) {
                alert('Randevu tamamlanamadı: ' + error.message);
            }
        }

        // Modal fonksiyonları
        function openDepartmentModal() {
            document.getElementById('departmentModal').style.display = 'block';
        }

        async function openCustomerModal() {
            try {
                // Satış temsilcilerini yükle
                const usersResponse = await apiCall('/api/users');
                const users = usersResponse.users || [];

                const salesRepSelect = document.getElementById('customer_sales_rep');
                salesRepSelect.innerHTML = '<option value="">Seçiniz</option>';

                users.forEach(user => {
                    salesRepSelect.innerHTML += `<option value="${user.id}">${user.full_name || user.username}</option>`;
                });

                document.getElementById('customerModal').style.display = 'block';
            } catch (error) {
                console.error('Müşteri modal açılırken hata:', error);
                document.getElementById('customerModal').style.display = 'block';
            }
        }
        
        async function openCustomerModalWithLocation(lat, lng) {
            await openCustomerModal();
            
            // Koordinatları adres alanına ekle
            const addressField = document.getElementById('customer_address');
            const currentAddress = addressField.value;
            addressField.value = currentAddress + (currentAddress ? '\n' : '') + `Koordinat: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        async function openTransactionModal() {
            try {
                // Müşteri listesini yükle
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];

                const customerSelect = document.getElementById('transaction_customer_id');
                customerSelect.innerHTML = '<option value="">Seçiniz</option>';

                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });

                // Bugünün tarihini varsayılan olarak ayarla
                document.getElementById('transaction_date').value = new Date().toISOString().split('T')[0];

                document.getElementById('transactionModal').style.display = 'block';
            } catch (error) {
                console.error('İşlem modal açılırken hata:', error);
                document.getElementById('transactionModal').style.display = 'block';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Form'u temizle
            if (modalId === 'transactionModal') {
                document.getElementById('transactionForm').reset();
            } else if (modalId === 'roleModal') {
                document.getElementById('roleForm').reset();
                document.getElementById('role_active').checked = true;
                document.getElementById('role_id').value = '';
            } else if (modalId === 'departmentModal') {
                document.getElementById('departmentForm').reset();
                document.getElementById('dept_active').checked = true;
                document.getElementById('dept_id').value = '';
            } else if (modalId === 'targetModal') {
                document.getElementById('targetForm').reset();
                document.getElementById('target_user_id').disabled = false;
                document.getElementById('target_id').value = '';
            } else if (modalId === 'deliveryNoteModal') {
                document.getElementById('deliveryNoteForm').reset();
                document.getElementById('delivery_note_id').value = '';
            } else if (modalId === 'signatureModal') {
                document.getElementById('signatureContent').innerHTML = '';
            } else if (modalId === 'appointmentModal') {
                document.getElementById('appointmentForm').reset();
                document.getElementById('appointment_id').value = '';
                document.getElementById('appointment_priority').value = 'medium';
                document.getElementById('appointment_reminder_minutes').value = '15';
            }
        }

        // Sayfa yüklendiğinde yapılacaklar
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) return;

            // Kullanıcı bilgilerini ve menüyü ayarla
            updateDateTime();
            setupMenuVisibility();

            // Dashboard'u göster
            showDashboard();
            
            // Tarih/saat bilgisini her saniye güncelle
            setInterval(updateDateTime, 1000);
        });
    </script>
    <div id="adminInfo" style="position: fixed; top: 1rem; right: 1rem; background: rgba(0, 123, 255, 0.9); padding: 0.75rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px; font-size: 0.85rem;">
        <!-- JavaScript ile doldurulacak -->
    </div>
</body>
</html>