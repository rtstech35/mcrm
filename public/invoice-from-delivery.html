<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞rsaliyelerden Fatura Olu≈ütur</title>
    <link rel="stylesheet" href="/theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #007bff; color: white; padding: 1rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; display: flex; gap: 2rem; }
        .left-panel { width: 400px; background: white; border-radius: 12px; padding: 1.5rem; height: fit-content; }
        .right-panel { flex: 1; background: white; border-radius: 12px; padding: 1.5rem; }
        .btn { padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; margin-right: 1rem; }
        .btn:hover { background: #0056b3; }
        .btn-back { background: #6c757d; }
        .btn-success { background: #28a745; }
        .delivery-item { 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            margin-bottom: 0.5rem; 
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delivery-item:hover { background: #f8f9fa; }
        .delivery-item.selected { background: #e3f2fd; border-color: #2196f3; }
        .checkbox { margin-right: 0.5rem; }
        .preview-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .preview-table th { background: #f8f9fa; font-weight: 600; }
        .delivery-list { max-height: 500px; overflow-y: auto; }
        .customer-group { margin-bottom: 1.5rem; }
        .customer-header { 
            background: #f8f9fa; 
            padding: 0.75rem; 
            border-radius: 8px; 
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ƒ∞rsaliyelerden Fatura Olu≈ütur</h1>
    </div>

    <div class="container">
        <!-- Sol Panel - ƒ∞rsaliye Listesi -->
        <div class="left-panel">
            <h3 style="margin-bottom: 1rem; color: #2d3748;">üì¶ Faturalanmamƒ±≈ü ƒ∞rsaliyeler</h3>
            <div id="deliveryList" class="delivery-list">
                <!-- JavaScript ile doldurulacak -->
            </div>
            <div style="margin-top: 1rem;">
                <a href="/admin.html" class="btn btn-back">‚Üê Geri D√∂n</a>
            </div>
        </div>

        <!-- Saƒü Panel - Fatura √ñnizleme -->
        <div class="right-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: #2d3748;">üßæ Fatura √ñnizleme</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div>
                        <label style="font-size: 0.875rem; color: #666;">Fatura No (opsiyonel):</label>
                        <input type="text" id="manualInvoiceNumber" placeholder="FAT-001234" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 120px;">
                    </div>
                    <button class="btn btn-success" onclick="createInvoice()" id="createBtn" disabled>Fatura Olu≈ütur</button>
                </div>
            </div>
            
            <div id="invoicePreview">
                <p style="color: #666; text-align: center; padding: 2rem;">
                    Sol taraftan irsaliye se√ßin
                </p>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let selectedDeliveries = [];
        let deliveryNotes = [];

        if (!authToken) {
            alert('Giri≈ü yapmanƒ±z gerekiyor!');
            window.location.href = '/admin.html';
        }

        async function apiCall(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API hatasƒ±');
            }
            
            return response.json();
        }

        async function loadDeliveryNotes() {
            try {
                deliveryNotes = await apiCall('/api/cari/delivery-notes');
                const unInvoiced = deliveryNotes.filter(dn => !dn.is_invoiced);
                
                if (unInvoiced.length === 0) {
                    document.getElementById('deliveryList').innerHTML = `
                        <p style="color: #666; text-align: center; padding: 2rem;">
                            Faturalanmamƒ±≈ü irsaliye bulunamadƒ±
                        </p>
                    `;
                    return;
                }

                // M√º≈üterilere g√∂re grupla
                const customerGroups = {};
                unInvoiced.forEach(dn => {
                    if (!customerGroups[dn.customer_id]) {
                        customerGroups[dn.customer_id] = {
                            customer_name: dn.customer_name,
                            notes: []
                        };
                    }
                    customerGroups[dn.customer_id].notes.push(dn);
                });

                let html = '';
                Object.keys(customerGroups).forEach(customerId => {
                    const group = customerGroups[customerId];
                    html += `
                        <div class="customer-group">
                            <div class="customer-header">
                                üè¢ ${group.customer_name}
                                <span style="float: right; font-size: 0.875rem; font-weight: normal;">
                                    ${group.notes.length} irsaliye
                                </span>
                            </div>
                    `;
                    
                    group.notes.forEach(dn => {
                        html += `
                            <div class="delivery-item" onclick="toggleDelivery(${dn.id})" id="delivery-${dn.id}">
                                <div style="display: flex; align-items: center; pointer-events: none;">
                                    <input type="checkbox" class="checkbox" id="cb-${dn.id}">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${dn.delivery_note_number}</div>
                                        <div style="font-size: 0.875rem; color: #666;">
                                            üìÖ ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}
                                        </div>
                                        <div style="font-size: 0.875rem; color: #666;">
                                            üí∞ ${dn.total_amount} TL
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });

                document.getElementById('deliveryList').innerHTML = html;

            } catch (error) {
                console.error('ƒ∞rsaliyeler y√ºklenemedi:', error);
                document.getElementById('deliveryList').innerHTML = `
                    <p style="color: red; text-align: center; padding: 2rem;">
                        Hata: ${error.message}
                    </p>
                `;
            }
        }

        function toggleDelivery(deliveryId, event) {
            // Checkbox'a tƒ±klandƒ±ƒüƒ±nda event'in iki kez tetiklenmesini engelle
            if (event && event.target.type === 'checkbox') {
                event.stopPropagation();
            }
            const checkbox = document.getElementById(`cb-${deliveryId}`);
            const item = document.getElementById(`delivery-${deliveryId}`);
            
            if (selectedDeliveries.includes(deliveryId)) {
                selectedDeliveries = selectedDeliveries.filter(id => id !== deliveryId);
                checkbox.checked = false;
                item.classList.remove('selected');
            } else {
                selectedDeliveries.push(deliveryId);
                checkbox.checked = true;
                item.classList.add('selected');
            }
            
            updatePreview();
        }

        async function updatePreview() {
            const createBtn = document.getElementById('createBtn');
            
            if (selectedDeliveries.length === 0) {
                document.getElementById('invoicePreview').innerHTML = `
                    <p style="color: #666; text-align: center; padding: 2rem;">
                        Sol taraftan irsaliye se√ßin
                    </p>
                `;
                createBtn.disabled = true;
                return;
            }

            try {
                // Se√ßilen irsaliyelerin temel bilgilerini al
                const selectedNotes = deliveryNotes.filter(dn => selectedDeliveries.includes(dn.id));
                const customerName = selectedNotes[0].customer_name;
                
                // --- PERFORMANS ƒ∞Yƒ∞LE≈ûTƒ∞RMESƒ∞ ---
                // N+1 problemini √ß√∂zmek i√ßin, backend'e se√ßilen t√ºm irsaliye ID'lerini
                // tek bir istekte g√∂nderip t√ºm kalemleri toplu olarak alƒ±n.
                // √ñrnek: /api/cari/delivery-notes/items?ids=1,2,3
                const deliveryIds = selectedDeliveries.join(',');
                const allItems = await apiCall(`/api/cari/delivery-notes/items?ids=${deliveryIds}`);

                // Gelen kalemlere irsaliye numarasƒ±nƒ± eklemek i√ßin bir map olu≈üturalƒ±m
                const noteNumberMap = selectedNotes.reduce((acc, note) => {
                    acc[note.id] = note.delivery_note_number;
                    return acc;
                }, {});
                
                console.log('T√ºm kalemler:', allItems);

                // Aynƒ± √ºr√ºnleri birle≈ütir
                const groupedItems = {};
                allItems.forEach(item => {
                    const key = item.product_id;
                    if (!groupedItems[key]) {
                        groupedItems[key] = {
                            product_name: item.product_name,
                            unit_price: parseFloat(item.unit_price),
                            quantity: 0,
                            total_price: 0,
                            delivery_notes: []
                        };
                    }
                    groupedItems[key].quantity += parseFloat(item.quantity);
                    groupedItems[key].total_price += parseFloat(item.total_price);
                    
                    // ƒ∞rsaliye numarasƒ±nƒ± sadece bir kez ekle
                    if (!groupedItems[key].delivery_notes.includes(noteNumberMap[item.delivery_note_id])) {
                        groupedItems[key].delivery_notes.push(noteNumberMap[item.delivery_note_id]);
                    }
                });
                
                console.log('Gruplandƒ± √ºr√ºnler:', groupedItems);

                let html = `
                    <div style="margin-bottom: 1rem;">
                        <h4>M√º≈üteri: ${customerName}</h4>
                        <p style="color: #666;">Se√ßilen ƒ∞rsaliyeler: ${selectedNotes.map(n => n.delivery_note_number).join(', ')}</p>
                    </div>
                    
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>√úr√ºn</th>
                                <th>Miktar</th>
                                <th>Birim Fiyat</th>
                                <th>Toplam</th>
                                <th>ƒ∞rsaliyeler</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let grandTotal = 0;
                Object.values(groupedItems).forEach(item => {
                    // Toplam fiyatƒ± yeniden hesapla (miktar x birim fiyat)
                    const calculatedTotal = item.quantity * item.unit_price;
                    grandTotal += calculatedTotal;
                    
                    html += `
                        <tr>
                            <td>${item.product_name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit_price.toFixed(2)} TL</td>
                            <td>${calculatedTotal.toFixed(2)} TL</td>
                            <td style="font-size: 0.75rem;">${item.delivery_notes.join(', ')}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: 600;">
                                <td colspan="3">GENEL TOPLAM</td>
                                <td>${grandTotal.toFixed(2)} TL</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                `;

                document.getElementById('invoicePreview').innerHTML = html;
                createBtn.disabled = false;

            } catch (error) {
                console.error('√ñnizleme hatasƒ±:', error);
            }
        }

        async function createInvoice() {
            if (selectedDeliveries.length === 0) {
                alert('L√ºtfen en az bir irsaliye se√ßin!');
                return;
            }

            try {
                const selectedNotes = deliveryNotes.filter(dn => selectedDeliveries.includes(dn.id));
                const customerId = selectedNotes[0].customer_id;
                const manualNumber = document.getElementById('manualInvoiceNumber').value.trim();

                const result = await apiCall('/api/cari/invoices/from-delivery-notes', {
                    method: 'POST',
                    body: JSON.stringify({
                        customerId: customerId,
                        deliveryNoteIds: selectedDeliveries,
                        manualInvoiceNumber: manualNumber || null
                    })
                });

                alert(`Fatura ba≈üarƒ±yla olu≈üturuldu: ${result.invoiceNumber}`);
                window.location.href = '/admin.html';

            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }

        // Sayfa y√ºklendiƒüinde irsaliyeleri y√ºkle
        loadDeliveryNotes();
    </script>
</body>
</html>