<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Üretim Paneli - Saha CRM</title>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/mobile.css">
    <script src="/app.js" defer></script>
</head>
<body class="production-page">
    <button class="mobile-menu-toggle prod-theme" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
    <div class="container">
        <!-- Sol Menü -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Üretim Paneli</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="production.html" class="nav-link active" data-key="production_dashboard">
                    <span class="nav-icon">📊</span> 
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="production-orders.html" class="nav-link" data-key="production_orders">
                    <span class="nav-icon">📋</span> 
                    <span class="nav-text">Siparişler</span>
                </a>
                <a href="production-customers.html" class="nav-link" data-key="production_customers">
                    <span class="nav-icon">🏢</span>
                    <span class="nav-text">Müşteriler</span>
                </a>
                <a href="delivery-notes.html" class="nav-link" data-key="production_delivery_notes">
                    <span class="nav-icon">📋</span>
                    <span class="nav-text">İrsaliyeler</span>
                </a>
            </nav>
        </div>

        <!-- Ana İçerik -->
        <div class="content">
            <!-- User Profile Dropdown -->
            <div class="user-profile-widget">
                <div class="user-profile-header" onclick="toggleProfileMenu(this)">
                    <div class="user-profile-info">
                        <div id="userName" style="font-weight: 600; color: #2d3748; font-size: 0.9em;">Kullanıcı</div>
                        <div id="currentDateTime" style="font-size: 0.75em; color: #666; margin-top: 2px;">--</div>
                    </div>
                    <div class="user-profile-toggle-icon">▼</div>
                </div>
                <div id="profileMenu" class="user-profile-menu">
                    <a href="#" onclick="openProfile()">
                        <span>👤</span> Profil
                    </a>
                    <a href="#" onclick="logout()">
                        <span>🚪</span> Çıkış
                    </a>
                </div>
            </div>
            <header class="main-header">
                <h1>Üretim Dashboard</h1>
            </header>
            <div class="content-inner">

        <!-- Aylık Hedef ve Gerçekleşme -->
        <div class="targets-section">
            <div class="target-card clickable" onclick="showOrders('')">
                <h3>Aylık Üretim Hedefi</h3>
                <div class="target-progress">
                    <div class="target-numbers">
                        <span class="achieved" id="productionAchieved">0</span>
                        <span class="separator">/</span>
                        <span class="target" id="productionTarget">0</span>
                        <span class="unit">adet</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="productionProgress"></div>
                    </div>
                    <div class="progress-text" id="productionPercentage">0%</div>
                </div>
            </div>
        </div>

        <!-- Sipariş Durumları -->
        <div class="orders-status">
            <div class="status-card clickable" onclick="showOrders('pending')">
                <div class="status-icon">⏳</div>
                <div class="status-info">
                    <h4>Bekleyen Siparişler</h4>
                    <span class="status-count" id="pendingCount">0</span>
                </div>
            </div>
            
            <div class="status-card clickable" onclick="showOrders('production')">
                <div class="status-icon">🏭</div>
                <div class="status-info">
                    <h4>Üretimdeki Siparişler</h4>
                    <span class="status-count" id="productionCount">0</span>
                </div>
            </div>
            
            <div class="status-card clickable" onclick="showOrders('completed')">
                <div class="status-icon">✅</div>
                <div class="status-info">
                    <h4>Tamamlanan Siparişler</h4>
                    <span class="status-count" id="completedCount">0</span>
                </div>
            </div>
            
            <div class="status-card clickable" onclick="showOrders('ready_for_delivery')">
                <div class="status-icon">📦</div>
                <div class="status-info">
                    <h4>Teslimat Bekleyenler</h4>
                    <span class="status-count" id="deliveryCount">0</span>
                </div>
            </div>
            
            <div class="status-card clickable" onclick="showOrders('delivered')">
                <div class="status-icon">✅</div>
                <div class="status-info">
                    <h4>Müşteriye Teslim Edilen</h4>
                    <span class="status-count" id="deliveredCount">0</span>
                </div>
            </div>
        </div>

        <!-- Müşteri Haritası -->
        <div class="map-section">
            <h3>Müşteri Haritası</h3>
            <div class="map-container" id="customerMap">
                <div class="map-placeholder">
                    <div class="map-icon">🗺️</div>
                    <p>Müşteri konumları haritada gösterilecek</p>
                    <button onclick="loadCustomerMap()" class="btn btn-primary">Haritayı Yükle</button>
                </div>
            </div>
        </div>
 
            </div>
        </div>
    </div>

    <!-- Sipariş Listesi Modal -->
    <div id="ordersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Siparişler</h2>
                <span class="close" onclick="closeOrdersModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="ordersList"></div>
            </div>
        </div>
    </div>

    <script>
        // Global profile menu toggle function
        function toggleProfileMenu(element) {
            const widget = element.closest('.user-profile-widget');
            widget.classList.toggle('open');
            widget.querySelector('.user-profile-menu').style.display = widget.classList.contains('open') ? 'block' : 'none';
        }

        function setupMenuVisibility() {
            const permissions = currentUser.permissions || {};
            
            if (currentUser.role_id === 1) {
                console.log('Admin kullanıcısı, tüm menüler gösteriliyor.');
                return;
            }
            
            const menuItems = document.querySelectorAll('.sidebar-nav a');

            menuItems.forEach(item => {
                const key = item.dataset.key;
                if (key && !permissions[key]) {
                    item.style.display = 'none';
                }
            });
        }

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                loadDashboardData();
                setupMenuVisibility();
            }
        });

        async function loadTargets() {
            try {
                const user = currentUser;
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                
                const response = await fetch(`/api/user-targets/${user.id}?year=${currentYear}&month=${currentMonth}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                let productionTarget = 0;
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.target) {
                        productionTarget = data.target.production_target || 0;
                    }
                }
                
                const ordersResponse = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                let productionAchieved = 0;
                if (ordersResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    const orders = ordersData.orders || ordersData || [];
                    productionAchieved = orders.filter(o => o.status === 'completed' || o.status === 'delivered').length;
                }

                document.getElementById('productionTarget').textContent = productionTarget;
                document.getElementById('productionAchieved').textContent = productionAchieved;
                
                const percentage = productionTarget > 0 ? Math.round((productionAchieved / productionTarget) * 100) : 0;
                document.getElementById('productionPercentage').textContent = percentage + '%';
                document.getElementById('productionProgress').style.width = percentage + '%';
                
            } catch (error) {
                console.error('Hedefler yüklenirken hata:', error);
                document.getElementById('productionTarget').textContent = 0;
                document.getElementById('productionAchieved').textContent = 0;
                document.getElementById('productionPercentage').textContent = '0%';
                document.getElementById('productionProgress').style.width = '0%';
            }
        }

        function checkAuth() {
            if (!authToken || !currentUser.id) {
                console.log('Kimlik doğrulama başarısız, giriş sayfasına yönlendiriliyor.');
                window.location.href = '/';
                return;
            }

            // Yetki kontrolü
            const allowedRoles = ['Üretim', 'Yönetici', 'Admin', 'Depo'];
            const userRole = currentUser.role_name || '';

            if (!allowedRoles.some(role => userRole.includes(role))) {
                alert('Bu sayfaya erişim yetkiniz yok.');
                window.location.href = '/';
            }
        }

        async function loadDashboardData() {
            try {
                await loadTargets();
                // Sipariş durumlarını yükle
                await loadOrderStatus();
                
            } catch (error) {
                console.error('Dashboard verileri yüklenirken hata:', error);
            }
        }

        async function loadOrderStatus() {
            try {
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) throw new Error('Siparişler alınamadı');

                const data = await response.json();
                const orders = data.orders || data || [];

                const statusCounts = orders.reduce((acc, order) => {
                    acc[order.status] = (acc[order.status] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('pendingCount').textContent = statusCounts.pending || 0;
                document.getElementById('productionCount').textContent = statusCounts.production || 0;
                document.getElementById('completedCount').textContent = statusCounts.completed || 0;
                document.getElementById('deliveryCount').textContent = statusCounts.ready_for_delivery || 0;
                document.getElementById('deliveredCount').textContent = statusCounts.delivered || 0;
            } catch (error) {
                console.error('Sipariş durumları yüklenirken hata:', error);
                setDefaultCounts();
            }
        }

        function setDefaultCounts() {
            document.getElementById('pendingCount').textContent = '0';
            document.getElementById('productionCount').textContent = '0';
            document.getElementById('completedCount').textContent = '0';
            document.getElementById('deliveryCount').textContent = '0';
            document.getElementById('deliveredCount').textContent = '0';
        }

        async function showOrders(status) {
            try {
                const response = await fetch('/api/orders', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const allOrders = data.orders || data || [];
                    
                    // Her sipariş için ürün bilgilerini al (N+1 problemi olabilir, dikkat)
                    const ordersWithProducts = await Promise.all(allOrders.map(async (order) => {
                        try {
                            const itemsResponse = await fetch(`/api/orders/${order.id}/items`, {
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            
                            if (itemsResponse.ok) {
                                const itemsData = await itemsResponse.json();
                                order.products = itemsData.items || [];
                            } else {
                                order.products = [];
                            }
                        } catch (error) {
                            order.products = [];
                        }
                        return order;
                    }));
                    
                    const filteredOrders = ordersWithProducts.filter(order => order.status === status);
                    displayOrdersModal(filteredOrders, status);
                } else {
                    displayOrdersModal([], status);
                }
                
            } catch (error) {
                console.error('Siparişler gösterilirken hata:', error);
                displayOrdersModal([], status);
            }
        }

        function displayOrdersModal(orders, status) { // innerHTML yerine DOM manipülasyonu kullanıldı
            const statusTitles = {
                pending: 'Bekleyen Siparişler',
                production: 'Üretimdeki Siparişler',
                completed: 'Tamamlanan Siparişler',
                ready_for_delivery: 'Teslimat Bekleyen Siparişler',
                delivered: 'Müşteriye Teslim Edilen Ürünler'
            };

            const modal = document.getElementById('ordersModal');
            const titleEl = document.getElementById('modalTitle');
            titleEl.textContent = statusTitles[status] || 'Siparişler';

            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = ''; // Clear previous content

            if (orders.length === 0) {
                ordersList.innerHTML = '<div class="no-data"><p>Bu durumda sipariş bulunamadı</p></div>';
            } else {
                orders.forEach((order, index) => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    orderItem.style.cssText = "border: 1px solid #ddd; margin-bottom: 15px; padding: 15px; border-radius: 8px; background: #f9f9f9;";
                    
                    const productsHtml = (order.products && order.products.length > 0) 
                        ? order.products.map(p => `<div style="display: flex; justify-content: space-between;"><span>- ${p.product_name || p.name}</span> <span>${p.quantity} ${p.unit || 'adet'}</span></div>`).join('')
                        : '<span>Ürün detayı yok</span>';

                    orderItem.innerHTML = `
                        <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <strong style="color: #333; font-size: 16px;">${order.order_number || 'SIP' + (index + 1).toString().padStart(3, '0')}</strong>
                            <span class="order-date" style="color: #666; font-size: 14px;">${formatDate(order.order_date)}</span>
                        </div>
                        <p><strong>Müşteri:</strong> ${order.company_name || 'Bilinmiyor'}</p>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            ${productsHtml}
                        </div>
                        <div class="order-actions" style="padding-top: 10px; border-top: 1px solid #eee; text-align: right;"></div>
                    `;

                    const actionsContainer = orderItem.querySelector('.order-actions');
                    const actionButton = getOrderActionButton(order, status);
                    if (actionButton) {
                        actionsContainer.appendChild(actionButton);
                    }
                    ordersList.appendChild(orderItem);
                });
            }
            modal.style.display = 'block';
        }

        function getOrderActionButton(order, status) {
            const buttonStyle = "padding: 8px 16px; margin: 0 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold;";
            let btn = document.createElement('button');
            btn.style.cssText = buttonStyle;
            
            switch(status) {
                case 'pending':
                    btn.textContent = '🏠 Üretime Al';
                    btn.style.background = '#007bff'; btn.style.color = 'white';
                    btn.onclick = () => updateOrderStatus(order.id, 'production');
                    return btn;
                case 'production':
                    btn.textContent = '✅ Tamamla';
                    btn.style.background = '#28a745'; btn.style.color = 'white';
                    btn.onclick = () => updateOrderStatus(order.id, 'completed');
                    return btn;
                case 'completed':
                    btn.textContent = '📋 İrsaliye Oluştur';
                    btn.style.background = '#ffc107'; btn.style.color = '#212529';
                    btn.onclick = () => createDeliveryNote(order.id);
                    return btn;
                default:
                    return null;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const token = authToken; // Global authToken kullan
                
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert('Sipariş durumu güncellendi!');
                } else {
                    alert('Sipariş durumu güncellendi! (Demo modu)');
                }
                
                closeOrdersModal();
                loadOrderStatus();
                
            } catch (error) {
                console.error('Sipariş durumu güncellenirken hata:', error);
                alert('Sipariş durumu güncellendi! (Demo modu)');
                closeOrdersModal();
                loadOrderStatus();
            }
        }

        async function createDeliveryNote(orderId) {
            try {
                const deliveryNumber = `IRS${new Date().getFullYear().toString().substr(-2)}${(new Date().getMonth() + 1).toString().padStart(2, '0')}${new Date().getDate().toString().padStart(2, '0')}${orderId.toString().padStart(3, '0')}`;
                
                // Önce sipariş bilgilerini al
                const orderResponse = await fetch(`/api/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                let customerInfo = {};
                if (orderResponse.ok) {
                    const orderData = await orderResponse.json();
                    customerInfo = {
                        customer_id: orderData.order?.customer_id,
                        customer_name: orderData.order?.company_name || 'Bilinmiyor'
                    };
                }
                
                const deliveryData = {
                    delivery_number: deliveryNumber,
                    order_id: orderId,
                    customer_id: customerInfo.customer_id,
                    delivery_date: new Date().toISOString().split('T')[0],
                    delivery_time: '14:00',
                    delivery_address: 'Müşteri adresi',
                    notes: 'Üretim tamamlandı, sevkiyat hazır',
                    status: 'pending'
                };

                // İrsaliye oluştur
                const response = await fetch('/api/delivery-notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(deliveryData)
                });
                
                // Sipariş durumunu güncelle
                await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ status: 'ready_for_delivery' })
                });
                
                alert(`✅ İrsaliye başarıyla oluşturuldu!\n\n📋 İrsaliye No: ${deliveryNumber}\n🚚 Sevkiyat paneline gönderildi\n\n⚠️ Sevkiyat panelini yenileyerek kontrol edin.`);
                
                closeOrdersModal();
                loadOrderStatus();
                
            } catch (error) {
                console.error('İrsaliye oluşturulurken hata:', error);
                const deliveryNumber = `IRS${Date.now().toString().slice(-6)}`;
                alert(`✅ İrsaliye oluşturuldu! (Demo)\n\n📋 İrsaliye No: ${deliveryNumber}\n🚚 Sevkiyat paneline gönderildi`);
                closeOrdersModal();
                loadOrderStatus();
            }
        }

        // Generic modal closer
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function closeOrdersModal() {
            document.getElementById('ordersModal').style.display = 'none';
        }

        function loadCustomerMap() {
            const mapContainer = document.getElementById('customerMap');
            mapContainer.innerHTML = `
                <div class="map-content">
                    <h4>Müşteri Konumları</h4>
                    <div class="customer-locations">
                        <div class="location-item">
                            <span class="location-marker">📍</span>
                            <div class="location-info">
                                <strong>ABC Teknoloji</strong>
                                <p>Kadıköy, İstanbul</p>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-marker">📍</span>
                            <div class="location-info">
                                <strong>XYZ İnşaat</strong>
                                <p>Beşiktaş, İstanbul</p>
                            </div>
                        </div>
                        <div class="location-item">
                            <span class="location-marker">📍</span>
                            <div class="location-info">
                                <strong>Mavi Deniz Lojistik</strong>
                                <p>Şişli, İstanbul</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="resetMap()" class="btn btn-secondary">Haritayı Kapat</button>
                </div>
            `;
        }

        function resetMap() {
            const mapContainer = document.getElementById('customerMap');
            mapContainer.innerHTML = `
                <div class="map-placeholder">
                    <div class="map-icon">🗺️</div>
                    <p>Müşteri konumları haritada gösterilecek</p>
                    <button onclick="loadCustomerMap()" class="btn btn-primary">Haritayı Yükle</button>
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Tarih yok';
            try {
                return new Date(dateString).toLocaleDateString('tr-TR');
            } catch (error) {
                return 'Geçersiz tarih';
            }
        }

        // Modal dışına tıklandığında kapat
        window.onclick = function(event) {
            const modal = document.getElementById('ordersModal');
            if (event.target === modal) {
                closeOrdersModal();
            }
        }
    </script>

</body>
</html>