<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail Ayarları - Saha CRM</title>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="content">
        <div class="header">
            <h1>📧 Mail Ayarları</h1>
            <button onclick="window.location.href='admin.html'" class="btn btn-secondary">← Geri</button>
        </div>

        <div class="mail-tabs">
            <button class="tab-btn active" onclick="showTab('settings')">SMTP Ayarları</button>
            <button class="tab-btn" onclick="showTab('sent')">Gönderilen Mailler</button>
            <button class="tab-btn" onclick="showTab('test')">Test Gönder</button>
        </div>

        <!-- SMTP Ayarları -->
        <div id="settings-tab" class="tab-content active">
            <div class="card">
                <h2>SMTP Konfigürasyonu</h2>
                <form id="smtpForm">
                    <div class="form-group">
                        <label>SMTP Sunucu:</label>
                        <input type="text" id="smtp_host" placeholder="smtp.gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label>Port:</label>
                        <input type="number" id="smtp_port" value="587" required>
                    </div>
                    <div class="form-group">
                        <label>E-posta Adresi:</label>
                        <input type="email" id="smtp_user" placeholder="firma@example.com" required>
                    </div>
                    <div class="form-group">
                        <label>Şifre/App Password:</label>
                        <input type="password" id="smtp_pass" required>
                    </div>
                    <div class="form-group">
                        <label>Gönderen Adı:</label>
                        <input type="text" id="from_name" placeholder="Saha CRM Sistemi" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="smtp_secure"> SSL/TLS Kullan
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="testConnection()" class="btn btn-warning">🔧 Bağlantı Testi</button>
                        <button type="submit" class="btn btn-primary">💾 Ayarları Kaydet</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Gönderilen Mailler -->
        <div id="sent-tab" class="tab-content">
            <div class="card">
                <h2>Gönderilen Mail Geçmişi</h2>
                <div class="mail-filters">
                    <div class="form-group">
                        <select id="statusFilter" onchange="loadSentMails()">
                            <option value="">Tüm Durumlar</option>
                            <option value="sent">Gönderildi</option>
                            <option value="failed">Başarısız</option>
                            <option value="pending">Bekliyor</option>
                        </select>
                    </div>
                    <button onclick="loadSentMails()" class="btn btn-secondary">🔄 Yenile</button>
                </div>
                <div id="sentMailsList">
                    <!-- Mail listesi buraya yüklenecek -->
                </div>
            </div>
        </div>

        <!-- Test Mail -->
        <div id="test-tab" class="tab-content">
            <div class="card">
                <h2>Test Mail Gönder</h2>
                <form id="testMailForm">
                    <div class="form-group">
                        <label>Alıcı E-posta:</label>
                        <input type="email" id="test_email" required>
                    </div>
                    <div class="form-group">
                        <label>Konu:</label>
                        <input type="text" id="test_subject" value="Test Mail - Saha CRM" required>
                    </div>
                    <div class="form-group">
                        <label>Mesaj:</label>
                        <textarea id="test_message" rows="5" required>Bu bir test mailidir. SMTP ayarları çalışıyor.</textarea>
                    </div>
                    <button type="submit" class="btn btn-success">📧 Test Mail Gönder</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');

        if (!authToken) {
            alert('Giriş yapmanız gerekiyor!');
            window.location.href = 'admin.html';
        }

        async function apiCall(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API hatası');
            }
            
            return response.json();
        }

        function showTab(tabName) {
            // Tab butonları
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Tab içerikleri
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            if (tabName === 'sent') {
                loadSentMails();
            } else if (tabName === 'settings') {
                loadSmtpSettings();
            }
        }

        async function loadSmtpSettings() {
            try {
                const settings = await apiCall('/api/mail/settings');
                if (settings.success && settings.settings) {
                    document.getElementById('smtp_host').value = settings.settings.smtp_host || '';
                    document.getElementById('smtp_port').value = settings.settings.smtp_port || 587;
                    document.getElementById('smtp_user').value = settings.settings.smtp_user || '';
                    document.getElementById('smtp_pass').value = settings.settings.smtp_pass || '';
                    document.getElementById('from_name').value = settings.settings.from_name || '';
                    document.getElementById('smtp_secure').checked = settings.settings.smtp_secure || false;
                }
            } catch (error) {
                console.log('SMTP ayarları yüklenemedi:', error.message);
            }
        }

        async function loadSentMails() {
            try {
                const status = document.getElementById('statusFilter').value;
                let url = '/api/mail/sent';
                if (status) url += `?status=${status}`;

                const response = await apiCall(url);
                const mails = response.mails || [];

                let html = '';
                if (mails.length === 0) {
                    html = '<p class="no-data">Gönderilen mail bulunamadı</p>';
                } else {
                    html = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Alıcı</th>
                                    <th>Konu</th>
                                    <th>Durum</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    mails.forEach(mail => {
                        const statusBadge = mail.status === 'sent' ? 'success' : 
                                          mail.status === 'failed' ? 'danger' : 'warning';
                        const statusText = mail.status === 'sent' ? 'Gönderildi' :
                                         mail.status === 'failed' ? 'Başarısız' : 'Bekliyor';

                        html += `
                            <tr>
                                <td>${new Date(mail.created_at).toLocaleString('tr-TR')}</td>
                                <td>${mail.to_email}</td>
                                <td>${mail.subject}</td>
                                <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                                <td>
                                    <button onclick="viewMail(${mail.id})" class="btn btn-sm btn-primary">👁️ Görüntüle</button>
                                    ${mail.status === 'failed' ? `<button onclick="resendMail(${mail.id})" class="btn btn-sm btn-warning">🔄 Tekrar Gönder</button>` : ''}
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                }

                document.getElementById('sentMailsList').innerHTML = html;
            } catch (error) {
                document.getElementById('sentMailsList').innerHTML = `<p class="error">Mail geçmişi yüklenemedi: ${error.message}</p>`;
            }
        }

        document.getElementById('smtpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const settings = {
                smtp_host: document.getElementById('smtp_host').value,
                smtp_port: parseInt(document.getElementById('smtp_port').value),
                smtp_user: document.getElementById('smtp_user').value,
                smtp_pass: document.getElementById('smtp_pass').value,
                from_name: document.getElementById('from_name').value,
                smtp_secure: document.getElementById('smtp_secure').checked
            };

            try {
                await apiCall('/api/mail/settings', {
                    method: 'POST',
                    body: JSON.stringify(settings)
                });

                alert('SMTP ayarları başarıyla kaydedildi!');
            } catch (error) {
                alert('Ayarlar kaydedilemedi: ' + error.message);
            }
        });

        document.getElementById('testMailForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const testData = {
                to_email: document.getElementById('test_email').value,
                subject: document.getElementById('test_subject').value,
                message: document.getElementById('test_message').value
            };

            try {
                const result = await apiCall('/api/mail/test', {
                    method: 'POST',
                    body: JSON.stringify(testData)
                });

                if (result.success) {
                    alert('Test mail başarıyla gönderildi!');
                } else {
                    alert('Test mail gönderilemedi: ' + result.error);
                }
            } catch (error) {
                alert('Test mail hatası: ' + error.message);
            }
        });

        async function viewMail(mailId) {
            try {
                const mail = await apiCall(`/api/mail/${mailId}`);
                alert(`Mail Detayı:\n\nKonu: ${mail.mail.subject}\nAlıcı: ${mail.mail.to_email}\nDurum: ${mail.mail.status}\nTarih: ${new Date(mail.mail.created_at).toLocaleString('tr-TR')}\n\nİçerik:\n${mail.mail.body}`);
            } catch (error) {
                alert('Mail detayı yüklenemedi: ' + error.message);
            }
        }

        async function resendMail(mailId) {
            if (confirm('Mail tekrar gönderilsin mi?')) {
                try {
                    await apiCall(`/api/mail/${mailId}/resend`, { method: 'POST' });
                    alert('Mail tekrar gönderildi!');
                    loadSentMails();
                } catch (error) {
                    alert('Mail tekrar gönderilemedi: ' + error.message);
                }
            }
        }

        async function testConnection() {
            const settings = {
                smtp_host: document.getElementById('smtp_host').value,
                smtp_port: parseInt(document.getElementById('smtp_port').value),
                smtp_user: document.getElementById('smtp_user').value,
                smtp_pass: document.getElementById('smtp_pass').value,
                smtp_secure: document.getElementById('smtp_secure').checked
            };

            if (!settings.smtp_host || !settings.smtp_user || !settings.smtp_pass) {
                alert('Lütfen tüm SMTP bilgilerini doldurun!');
                return;
            }

            try {
                const response = await fetch('/api/mail/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ SMTP bağlantısı başarılı! Ayarları kaydedebilirsiniz.');
                } else {
                    alert('❌ SMTP bağlantısı başarısız: ' + result.error);
                }
            } catch (error) {
                alert('❌ Bağlantı testi hatası: ' + error.message);
            }
        }

        // Sayfa yüklendiğinde SMTP ayarlarını yükle
        loadSmtpSettings();
    </script>

    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .mail-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--secondary);
            color: var(--primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mail-filters {
            display: flex;
            gap: 1rem;
            align-items: end;
            margin-bottom: 1.5rem;
        }

        .mail-filters .form-group {
            margin-bottom: 0;
            min-width: 200px;
        }

        .no-data {
            text-align: center;
            color: var(--text-light);
            padding: 3rem;
            font-style: italic;
            background: var(--light);
            border-radius: 8px;
            margin: 1rem 0;
        }

        .error {
            color: var(--danger);
            text-align: center;
            padding: 1rem;
            background: rgb(239 68 68 / 0.1);
            border-radius: 8px;
            margin: 1rem 0;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .mail-tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: center;
            }

            .mail-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .mail-filters .form-group {
                min-width: auto;
            }

            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>