<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Yönetimi - Saha CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.8rem 1rem;
            margin: 0.2rem 0;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
        }
        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
            border-radius: 25px;
        }
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .badge {
            border-radius: 15px;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .stock-low {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .stock-critical {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="text-center mb-4">
                    <h4 class="text-white">
                        <i class="fas fa-chart-line me-2"></i>
                        Saha CRM
                    </h4>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link" href="/admin">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/public/customers.html">
                        <i class="fas fa-users me-2"></i> Müşteriler
                    </a>
                    <a class="nav-link active" href="/public/products.html">
                        <i class="fas fa-box me-2"></i> Ürünler
                    </a>
                    <a class="nav-link" href="/public/orders.html">
                        <i class="fas fa-shopping-cart me-2"></i> Siparişler
                    </a>
                    <a class="nav-link" href="/public/shipping.html">
                        <i class="fas fa-truck me-2"></i> Sevkiyat
                    </a>
                    <a class="nav-link" href="/public/users.html">
                        <i class="fas fa-user-cog me-2"></i> Kullanıcılar
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-box text-primary me-2"></i>Ürün Yönetimi</h2>
                        <p class="text-muted">Ürünleri ekleyin, düzenleyin ve stok durumunu takip edin</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                        <i class="fas fa-plus me-2"></i>Yeni Ürün
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-box fa-2x text-primary mb-2"></i>
                                <h5 class="card-title" id="totalProducts">0</h5>
                                <p class="card-text text-muted">Toplam Ürün</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                                <h5 class="card-title" id="totalCategories">0</h5>
                                <p class="card-text text-muted">Kategori</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                <h5 class="card-title" id="lowStockProducts">0</h5>
                                <p class="card-text text-muted">Düşük Stok</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-lira-sign fa-2x text-success mb-2"></i>
                                <h5 class="card-title" id="totalValue">0 ₺</h5>
                                <p class="card-text text-muted">Toplam Değer</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Kategori Filtresi</label>
                                <select class="form-select" id="categoryFilter">
                                    <option value="">Tüm Kategoriler</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stok Durumu</label>
                                <select class="form-select" id="stockFilter">
                                    <option value="">Tümü</option>
                                    <option value="normal">Normal Stok</option>
                                    <option value="low">Düşük Stok</option>
                                    <option value="critical">Kritik Stok</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Arama</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Ürün adı veya kodu...">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Kod</th>
                                        <th>Ürün Adı</th>
                                        <th>Kategori</th>
                                        <th>Birim Fiyat</th>
                                        <th>KDV Dahil</th>
                                        <th>Stok</th>
                                        <th>Birim</th>
                                        <th>Durum</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Yükleniyor...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Yeni Ürün Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ürün Kodu</label>
                                    <input type="text" class="form-control" id="productCode" placeholder="Örn: ELK001">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ürün Adı *</label>
                                    <input type="text" class="form-control" id="productName" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Kategori</label>
                                    <select class="form-select" id="productCategory">
                                        <option value="">Kategori Seçin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Birim Fiyat (₺) *</label>
                                    <input type="number" class="form-control" id="unitPrice" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">KDV Oranı (%)</label>
                                    <input type="number" class="form-control" id="vatRate" value="20" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Birim</label>
                                    <select class="form-select" id="productUnit">
                                        <option value="adet">Adet</option>
                                        <option value="kg">Kilogram</option>
                                        <option value="litre">Litre</option>
                                        <option value="metre">Metre</option>
                                        <option value="paket">Paket</option>
                                        <option value="kutu">Kutu</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Stok Miktarı</label>
                                    <input type="number" class="form-control" id="stockQuantity" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Min. Stok Seviyesi</label>
                                    <input type="number" class="form-control" id="minStockLevel" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tedarikçi</label>
                            <input type="text" class="form-control" id="supplier" placeholder="Tedarikçi firma adı">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">KDV Dahil Fiyat</label>
                                    <input type="text" class="form-control" id="priceWithVat" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">
                                        Aktif Ürün
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let products = [];
        let categories = [];

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            loadCategories();
            setupEventListeners();
        });

        // Event listeners
        function setupEventListeners() {
            // Fiyat hesaplama
            document.getElementById('unitPrice').addEventListener('input', calculatePriceWithVat);
            document.getElementById('vatRate').addEventListener('input', calculatePriceWithVat);
            
            // Filtreler
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            document.getElementById('stockFilter').addEventListener('change', filterProducts);
            document.getElementById('searchInput').addEventListener('input', filterProducts);
        }

        // KDV dahil fiyat hesaplama
        function calculatePriceWithVat() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
            const priceWithVat = unitPrice * (1 + vatRate / 100);
            document.getElementById('priceWithVat').value = priceWithVat.toFixed(2) + ' ₺';
        }

        // Ürünleri yükle
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                if (data.success) {
                    products = data.products;
                    displayProducts(products);
                    updateStats();
                } else {
                    console.error('Ürünler yüklenemedi:', data.error);
                }
            } catch (error) {
                console.error('API hatası:', error);
            }
        }

        // Kategorileri yükle
        async function loadCategories() {
            try {
                const response = await fetch('/api/product-categories');
                const data = await response.json();
                
                if (data.success) {
                    categories = data.categories;
                    populateCategorySelects();
                }
            } catch (error) {
                console.error('Kategoriler yüklenemedi:', error);
            }
        }

        // Kategori select'lerini doldur
        function populateCategorySelects() {
            const categoryFilter = document.getElementById('categoryFilter');
            const productCategory = document.getElementById('productCategory');
            
            // Filtre select'i
            categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            // Form select'i
            productCategory.innerHTML = '<option value="">Kategori Seçin</option>';
            categories.forEach(category => {
                productCategory.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }

        // Ürünleri göster
        function displayProducts(productsToShow) {
            const tbody = document.getElementById('productsTableBody');
            
            if (productsToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">Ürün bulunamadı</td></tr>';
                return;
            }
            
            tbody.innerHTML = productsToShow.map(product => {
                const stockClass = getStockClass(product);
                const stockBadge = getStockBadge(product);
                
                return `
                    <tr class="${stockClass}">
                        <td>${product.product_code || '-'}</td>
                        <td>
                            <strong>${product.name}</strong>
                            ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                        </td>
                        <td>${product.category || '-'}</td>
                        <td>${formatPrice(product.unit_price)}</td>
                        <td>${formatPrice(product.price_with_vat || product.unit_price * 1.2)}</td>
                        <td>
                            ${product.stock_quantity || 0}
                            ${stockBadge}
                        </td>
                        <td>${product.unit || 'adet'}</td>
                        <td>
                            <span class="badge ${product.is_active !== false ? 'bg-success' : 'bg-secondary'}">
                                ${product.is_active !== false ? 'Aktif' : 'Pasif'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Stok durumu class'ı
        function getStockClass(product) {
            const stock = product.stock_quantity || 0;
            const minLevel = product.min_stock_level || 0;
            
            if (stock === 0) return 'stock-critical';
            if (stock <= minLevel) return 'stock-low';
            return '';
        }

        // Stok durumu badge'i
        function getStockBadge(product) {
            const stock = product.stock_quantity || 0;
            const minLevel = product.min_stock_level || 0;
            
            if (stock === 0) return '<span class="badge bg-danger ms-1">Tükendi</span>';
            if (stock <= minLevel) return '<span class="badge bg-warning ms-1">Düşük</span>';
            return '';
        }

        // Fiyat formatla
        function formatPrice(price) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            }).format(price || 0);
        }

        // İstatistikleri güncelle
        function updateStats() {
            const totalProducts = products.length;
            const totalCategories = [...new Set(products.map(p => p.category).filter(Boolean))].length;
            const lowStockProducts = products.filter(p => {
                const stock = p.stock_quantity || 0;
                const minLevel = p.min_stock_level || 0;
                return stock <= minLevel;
            }).length;
            const totalValue = products.reduce((sum, p) => sum + (p.unit_price * (p.stock_quantity || 0)), 0);
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('lowStockProducts').textContent = lowStockProducts;
            document.getElementById('totalValue').textContent = formatPrice(totalValue);
        }

        // Ürünleri filtrele
        function filterProducts() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = products.filter(product => {
                // Kategori filtresi
                if (categoryFilter && product.category !== categoryFilter) return false;
                
                // Stok filtresi
                if (stockFilter) {
                    const stock = product.stock_quantity || 0;
                    const minLevel = product.min_stock_level || 0;
                    
                    if (stockFilter === 'normal' && stock <= minLevel) return false;
                    if (stockFilter === 'low' && (stock > minLevel || stock === 0)) return false;
                    if (stockFilter === 'critical' && stock !== 0) return false;
                }
                
                // Arama filtresi
                if (searchTerm) {
                    const searchFields = [
                        product.name,
                        product.product_code,
                        product.description
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            displayProducts(filtered);
        }

        // Ürün kaydet
        async function saveProduct() {
            const form = document.getElementById('productForm');
            const formData = new FormData(form);
            
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                unit_price: parseFloat(document.getElementById('unitPrice').value),
                vat_rate: parseFloat(document.getElementById('vatRate').value) || 20,
                unit: document.getElementById('productUnit').value,
                category: document.getElementById('productCategory').value,
                stock_quantity: parseInt(document.getElementById('stockQuantity').value) || 0,
                min_stock_level: parseInt(document.getElementById('minStockLevel').value) || 0,
                product_code: document.getElementById('productCode').value,
                supplier: document.getElementById('supplier').value,
                is_active: document.getElementById('isActive').checked
            };
            
            const productId = document.getElementById('productId').value;
            const isEdit = productId !== '';
            
            try {
                const url = isEdit ? `/api/products/${productId}` : '/api/products';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                    loadProducts();
                    loadCategories();
                    form.reset();
                    document.getElementById('productId').value = '';
                    alert(isEdit ? 'Ürün güncellendi!' : 'Ürün eklendi!');
                } else {
                    alert('Hata: ' + data.error);
                }
            } catch (error) {
                console.error('Kaydetme hatası:', error);
                alert('Kaydetme sırasında hata oluştu');
            }
        }

        // Ürün düzenle
        async function editProduct(id) {
            try {
                const response = await fetch(`/api/products/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    const product = data.product;
                    
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productCode').value = product.product_code || '';
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productCategory').value = product.category || '';
                    document.getElementById('unitPrice').value = product.unit_price;
                    document.getElementById('vatRate').value = product.vat_rate || 20;
                    document.getElementById('productUnit').value = product.unit || 'adet';
                    document.getElementById('stockQuantity').value = product.stock_quantity || 0;
                    document.getElementById('minStockLevel').value = product.min_stock_level || 0;
                    document.getElementById('supplier').value = product.supplier || '';
                    document.getElementById('isActive').checked = product.is_active !== false;
                    
                    calculatePriceWithVat();
                    
                    document.getElementById('modalTitle').textContent = 'Ürün Düzenle';
                    new bootstrap.Modal(document.getElementById('productModal')).show();
                } else {
                    alert('Ürün bilgileri alınamadı');
                }
            } catch (error) {
                console.error('Düzenleme hatası:', error);
                alert('Ürün bilgileri alınamadı');
            }
        }

        // Ürün sil
        async function deleteProduct(id) {
            if (!confirm('Bu ürünü silmek istediğinizden emin misiniz?')) return;
            
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadProducts();
                    alert('Ürün silindi!');
                } else {
                    alert('Silme hatası: ' + data.error);
                }
            } catch (error) {
                console.error('Silme hatası:', error);
                alert('Silme sırasında hata oluştu');
            }
        }

        // Modal temizle
        document.getElementById('productModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('modalTitle').textContent = 'Yeni Ürün Ekle';
            document.getElementById('priceWithVat').value = '';
        });
    </script>
</body>
</html>