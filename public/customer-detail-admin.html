<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√º≈üteri Detayƒ± - Admin Panel</title>
    <link rel="stylesheet" href="/theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #007bff; color: white; padding: 1rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .card { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn { padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; margin-right: 1rem; }
        .btn:hover { background: #0056b3; }
        .btn-back { background: #6c757d; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; }
        .tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 2rem; }
        .tab { padding: 1rem 2rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
        .info-item { margin-bottom: 1rem; }
        .info-item label { font-weight: 600; color: #2d3748; }
        .info-item p { color: #4a5568; margin-top: 0.25rem; }
        .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; }
        .summary-card h3 { font-size: 2rem; margin-bottom: 0.5rem; }
        .summary-card p { opacity: 0.9; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; cursor: pointer; }
        .list-item:hover { background: #f8f9fa; }
        .list-item:last-child { border-bottom: none; }
        .tab-container { max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .status-partial { background: #fff3cd; color: #856404; }
        .balance-positive { color: #28a745; font-weight: 600; }
        .balance-negative { color: #dc3545; font-weight: 600; }
    </style>
</head>
<body>
    <div class="header">
        <h1>M√º≈üteri Detayƒ± - Admin Panel</h1>
    </div>

    <div class="container" style="display: flex; flex-direction: column;">
        <div style="margin-bottom: 2rem;">
            <a href="/admin.html" class="btn btn-back">‚Üê Admin Paneline D√∂n</a>
        </div>

        <!-- M√º≈üteri Bilgileri - √úst Kutu -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üìã M√º≈üteri Bilgileri</h2>
            <div id="customerInfo">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>

        <!-- √ñzet Bilgiler - Orta Kutu -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üìä √ñzet Bilgiler</h2>
            <div id="summaryCards" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>

        <!-- Detaylƒ± Bilgiler - Alt Kutu -->
        <div class="card">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üìà Detaylƒ± Bilgiler</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('orders', this)">üìã Sipari≈üler</div>
                <div class="tab" onclick="showTab('delivery-notes', this)">üì¶ ƒ∞rsaliyeler</div>
                <div class="tab" onclick="showTab('invoices', this)">üßæ Faturalar</div>
                <div class="tab" onclick="showTab('payments', this)">üí∞ Tahsilatlar</div>
                <div class="tab" onclick="showTab('account', this)">üìä Cari Hesap</div>
                <div class="tab" onclick="showTab('ekstre', this)">üìÑ Ekstre</div>
            </div>

            <!-- Sipari≈üler Sekmesi -->
            <div id="orders-tab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üìã Sipari≈üler</h3>
                    <button class="btn btn-success" onclick="createNewOrder()">+ Yeni Sipari≈ü</button>
                </div>
                <div id="ordersList" class="tab-container">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <!-- ƒ∞rsaliyeler Sekmesi -->
            <div id="delivery-notes-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üì¶ ƒ∞rsaliyeler</h3>
                    <button class="btn btn-info" onclick="createInvoiceFromDeliveryNotes()">üìÑ Faturala≈ütƒ±r</button>
                </div>
                <div id="deliveryNotesList" class="tab-container">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <!-- Faturalar Sekmesi -->
            <div id="invoices-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üßæ Faturalar</h3>
                    <button class="btn btn-success" onclick="addPayment()">üí≥ Tahsilat Ekle</button>
                </div>
                <div id="invoicesList" class="tab-container">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <!-- Tahsilatlar Sekmesi -->
            <div id="payments-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üí∞ Tahsilatlar</h3>
                    <button class="btn btn-success" onclick="addPayment()">+ Yeni Tahsilat</button>
                </div>
                <div id="paymentsList" class="tab-container">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <!-- Cari Hesap Sekmesi -->
            <div id="account-tab" class="tab-content">
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üìä Cari Hesap Hareketleri</h3>
                </div>
                <div id="accountMovements" class="tab-container">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </div>

            <!-- Ekstre Sekmesi -->
            <div id="ekstre-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="color: #2d3748;">üìÑ M√º≈üteri Ekstresi</h3>
                    <div style="display: flex; gap: 1rem;">
                        <input type="date" id="startDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="date" id="endDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="generateEkstre()" class="btn" style="background: #007bff;">G√∂r√ºnt√ºle</button>
                        <button onclick="downloadEkstrePDF()" class="btn" style="background: #dc3545;">PDF ƒ∞ndir</button>
                        <button onclick="downloadEkstreExcel()" class="btn" style="background: #28a745;">Excel ƒ∞ndir</button>
                    </div>
                </div>
                <div id="ekstreContent" class="tab-container">
                    <div style="text-align: center; padding: 2rem; color: #718096;">
                        Tarih aralƒ±ƒüƒ± se√ßip "G√∂r√ºnt√ºle" butonuna tƒ±klayƒ±n.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let customerId = null;

        if (!authToken) {
            alert('Giri≈ü yapmanƒ±z gerekiyor!');
            window.location.href = '/admin.html';
        }
        
        console.log('Auth token:', authToken ? 'Var' : 'Yok');

        async function apiCall(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API hatasƒ±');
            }
            
            return response.json();
        }

        function editCustomerInAdmin(customerId) {
            // Redirect to admin panel and trigger the edit modal
            window.location.href = `/admin.html?action=editCustomer&id=${customerId}`;
        }

        async function deleteCustomer(customerId) {
            if (confirm('Bu m√º≈üteriyi ve ilgili t√ºm verilerini (sipari≈üler, ziyaretler vb.) silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
                try {
                    await apiCall(`/api/customers/${customerId}`, { method: 'DELETE' });
                    alert('M√º≈üteri ba≈üarƒ±yla silindi!');
                    window.location.href = '/admin.html'; // Redirect to customer list
                } catch (error) {
                    console.error('M√º≈üteri silme hatasƒ±:', error);
                    alert('Hata: ' + error.message);
                }
            }
        }

        function getCustomerIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            customerId = urlParams.get('id');
            if (customerId) {
                loadCustomerData();
            } else {
                alert('M√º≈üteri ID bulunamadƒ±');
                window.location.href = '/admin.html';
            }
        }

        async function loadCustomerData() {
            console.log('loadCustomerData ba≈ülatƒ±ldƒ±');
            console.log('customerId:', customerId);
            console.log('authToken:', authToken ? 'Var' : 'Yok');
            
            try {
                console.log('M√º≈üteri bilgileri isteniyor...');
                // M√º≈üteri bilgilerini al
                const customerResponse = await apiCall(`/api/customers/${customerId}`);
                console.log('M√º≈üteri verisi:', customerResponse);
                const customer = customerResponse.customer || customerResponse;
                
                // M√º≈üteri bilgilerini g√∂ster
                document.getElementById('customerInfo').innerHTML = `
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-bottom: 1.5rem;">
                        <button class="btn btn-warning" onclick="editCustomerInAdmin(${customer.id})">‚úèÔ∏è D√ºzenle</button>
                        <button class="btn btn-danger" onclick="deleteCustomer(${customer.id})">üóëÔ∏è Sil</button>
                    </div>
                    <div style="border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Firma Adƒ±:</strong> ${customer.company_name}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Yetkili Ki≈üi:</strong> ${customer.contact_person || 'Belirtilmemi≈ü'}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Telefon:</strong> ${customer.phone || 'Belirtilmemi≈ü'}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>E-posta:</strong> ${customer.email || 'Belirtilmemi≈ü'}
                                </div>
                            </div>
                            <div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>M√º≈üteri Durumu:</strong> ${customer.customer_status}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Satƒ±≈ü Temsilcisi:</strong> ${customer.sales_rep_name || 'Atanmamƒ±≈ü'}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Kayƒ±t Tarihi:</strong> ${new Date(customer.created_at).toLocaleDateString('tr-TR')}
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <strong>Adres:</strong> ${customer.address || 'Belirtilmemi≈ü'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // √ñzet verileri y√ºkle
                await loadSummaryData();
                
                // Sekme verilerini y√ºkle
                // Diƒüer sekmeler tƒ±klandƒ±ƒüƒ±nda y√ºklenecek (lazy loading)
                await loadOrders();

            } catch (error) {
                console.error('M√º≈üteri verileri y√ºklenemedi:', error);
                console.error('Hata detayƒ±:', error.stack);
                document.getElementById('customerInfo').innerHTML = `
                    <div style="color: red; padding: 1rem; background: #ffe6e6; border-radius: 8px;">
                        <h4>Hata: M√º≈üteri verileri y√ºklenemedi</h4>
                        <p>Detay: ${error.message}</p>
                        <p>M√º≈üteri ID: ${customerId}</p>
                        <p>Token: ${authToken ? 'Mevcut' : 'Eksik'}</p>
                    </div>
                `;
            }
        }

        async function loadSummaryData() {
            try {
                const [orders, deliveryNotes, invoices] = await Promise.all([
                    apiCall(`/api/orders?customer_id=${customerId}`),
                    apiCall(`/api/delivery-notes?customer_id=${customerId}`).catch(() => ({ delivery_notes: [] })),
                    apiCall(`/api/invoices?customer_id=${customerId}`).catch(() => ({ invoices: [] }))
                ]);

                const totalOrders = orders.orders ? orders.orders.length : (orders.length || 0);
                const totalDeliveryNotes = deliveryNotes.delivery_notes ? deliveryNotes.delivery_notes.length : 0;
                const totalInvoices = invoices.invoices ? invoices.invoices.length : 0;
                const balance = 0; // Default balance

                document.getElementById('summaryCards').innerHTML = `
                    <div style="background: linear-gradient(135deg, #42A5F5, #1E88E5); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">${totalOrders}</h3>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Toplam Sipari≈ü</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFA726, #FF7043); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">${totalDeliveryNotes}</h3>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">ƒ∞rsaliye</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #66BB6A, #43A047); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">${totalInvoices}</h3>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Fatura</p>
                    </div>
                    <div style="background: linear-gradient(135deg, ${balance >= 0 ? '#26A69A, #00897B' : '#EF5350, #E53935'}); color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem;">${balance.toFixed(2)} TL</h3>
                        <p style="margin: 0; font-size: 0.875rem; opacity: 0.9;">Cari Bakiye</p>
                    </div>
                `;

            } catch (error) {
                console.error('√ñzet veriler y√ºklenemedi:', error);
            }
        }

        // Her sekme i√ßin ayrƒ± y√ºkleme fonksiyonlarƒ±
        async function loadOrders() {
            const listEl = document.getElementById('ordersList');
            listEl.innerHTML = '<p style="text-align:center; padding: 2rem;">Y√ºkleniyor...</p>';
            try {
                const ordersResponse = await apiCall(`/api/orders?customer_id=${customerId}`);
                const orders = ordersResponse.orders || ordersResponse || [];
                if (orders.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; padding: 2rem; color: #718096;">Sipari≈ü bulunamadƒ±.</p>'; return;
                }
                listEl.innerHTML = orders.map(order => `
                    <div class="list-item" onclick="viewOrder(${order.id})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>#${order.order_number}</strong>
                                <p style="color: #718096; font-size: 0.875rem;">${new Date(order.order_date).toLocaleDateString('tr-TR')}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-weight: 600;">${order.total_amount} TL</p>
                                <span class="status-badge" style="background: #e2e8f0; color: #4a5568;">${order.status}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Sipari≈üler y√ºklenemedi:', error);
                listEl.innerHTML = `<p style="text-align:center; padding: 2rem; color: red;">Sipari≈üler y√ºklenemedi: ${error.message}</p>`;
            }
        }

        async function loadDeliveryNotes() {
            const listEl = document.getElementById('deliveryNotesList');
            listEl.innerHTML = '<p style="text-align:center; padding: 2rem;">Y√ºkleniyor...</p>';
             try {
                    const deliveryNotesResponse = await apiCall(`/api/delivery-notes?customer_id=${customerId}`);
                    const deliveryNotes = deliveryNotesResponse.delivery_notes || [];
                    if (deliveryNotes.length === 0) {
                        listEl.innerHTML = '<p style="text-align:center; padding: 2rem; color: #718096;">ƒ∞rsaliye bulunamadƒ±.</p>'; return;
                    }
                    listEl.innerHTML = deliveryNotes.map(dn => `
                        <div class="list-item" onclick="viewDeliveryNote(${dn.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${dn.delivery_number}</strong>
                                    <p style="color: #718096; font-size: 0.875rem;">${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-weight: 600;">${dn.total_amount || 0} TL</p>
                                    <span class="status-badge ${dn.is_invoiced ? 'status-paid' : 'status-unpaid'}">${dn.is_invoiced ? 'Faturalandƒ±' : 'Bekliyor'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('ƒ∞rsaliyeler y√ºklenemedi:', error);
                listEl.innerHTML = `<p style="text-align:center; padding: 2rem; color: red;">ƒ∞rsaliyeler y√ºklenemedi: ${error.message}</p>`;
            }
        }

        async function loadInvoices() {
            const listEl = document.getElementById('invoicesList');
            listEl.innerHTML = '<p style="text-align:center; padding: 2rem;">Y√ºkleniyor...</p>';
            try {
                    const invoicesResponse = await apiCall(`/api/invoices?customer_id=${customerId}`);
                    const invoices = invoicesResponse.invoices || [];
                    if (invoices.length === 0) {
                        listEl.innerHTML = '<p style="text-align:center; padding: 2rem; color: #718096;">Fatura bulunamadƒ±.</p>'; return;
                    }
                    listEl.innerHTML = invoices.map(inv => `
                        <div class="list-item" onclick="viewInvoice(${inv.id})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${inv.invoice_number}</strong>
                                    <p style="color: #718096; font-size: 0.875rem;">${new Date(inv.invoice_date || inv.created_at).toLocaleDateString('tr-TR')}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-weight: 600;">${inv.total_amount} TL</p>
                                    <p style="color: #28a745; font-size: 0.875rem;">√ñdenen: ${inv.paid_amount || 0} TL</p>
                                    <span class="status-badge ${inv.status === 'paid' ? 'status-paid' : inv.status === 'partial' ? 'status-partial' : 'status-unpaid'}">${inv.status || 'Bekliyor'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Faturalar y√ºklenemedi:', error);
                listEl.innerHTML = `<p style="text-align:center; padding: 2rem; color: red;">Faturalar y√ºklenemedi: ${error.message}</p>`;
            }
        }

        async function loadPayments() {
            const listEl = document.getElementById('paymentsList');
            listEl.innerHTML = '<p style="text-align:center; padding: 2rem;">Y√ºkleniyor...</p>';
            try {
                    const paymentsResponse = await apiCall(`/api/account-transactions?customer_id=${customerId}&transaction_type=credit`);
                    const payments = paymentsResponse.transactions || [];
                    if (payments.length === 0) {
                        listEl.innerHTML = '<p style="text-align:center; padding: 2rem; color: #718096;">Tahsilat bulunamadƒ±.</p>'; return;
                    }
                    listEl.innerHTML = payments.map(payment => `
                        <div class="list-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${payment.reference_number || 'Genel Tahsilat'}</strong>
                                    <p style="color: #718096; font-size: 0.875rem;">${new Date(payment.transaction_date).toLocaleDateString('tr-TR')}</p>
                                    <p style="color: #718096; font-size: 0.875rem;">${payment.description}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="font-weight: 600; color: #28a745;">${payment.amount} TL</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Tahsilatlar y√ºklenemedi:', error);
                listEl.innerHTML = `<p style="text-align:center; padding: 2rem; color: red;">Tahsilatlar y√ºklenemedi: ${error.message}</p>`;
            }
        }

        async function loadAccountMovements() {
            const listEl = document.getElementById('accountMovements');
            listEl.innerHTML = '<p style="text-align:center; padding: 2rem;">Y√ºkleniyor...</p>';
            try {
                    const movementsResponse = await apiCall(`/api/account-transactions?customer_id=${customerId}`);
                    const movements = movementsResponse.transactions || [];
                    if (movements.length === 0) {
                        listEl.innerHTML = '<p style="text-align:center; padding: 2rem; color: #718096;">Cari hareket bulunamadƒ±.</p>'; return;
                    }
                    listEl.innerHTML = movements.map(movement => `
                        <div class="list-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${movement.description}</strong>
                                    <p style="color: #718096; font-size: 0.875rem;">${new Date(movement.transaction_date).toLocaleDateString('tr-TR')}</p>
                                    <p style="color: #718096; font-size: 0.875rem;">${movement.reference_number || ''}</p>
                                </div>
                                <div style="text-align: right;">
                                    ${movement.transaction_type === 'debit' ? `<p style="font-weight: 600; color: #dc3545;">Bor√ß: ${movement.amount} TL</p>` : ''}
                                    ${movement.transaction_type === 'credit' ? `<p style="font-weight: 600; color: #28a745;">Alacak: ${movement.amount} TL</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
            } catch (error) {
                console.error('Cari hareketler y√ºklenemedi:', error);
                listEl.innerHTML = `<p style="text-align:center; padding: 2rem; color: red;">Cari hareketler y√ºklenemedi: ${error.message}</p>`;
            }
        }

        function showTab(tabName, clickedTab) {
            // T√ºm sekmeleri gizle
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Se√ßili sekmeyi g√∂ster
            document.getElementById(tabName + '-tab').classList.add('active');
            clickedTab.classList.add('active');

            // Veri daha √∂nce y√ºklenmemi≈üse y√ºkle
            if (!clickedTab.dataset.loaded) {
                switch (tabName) {
                    case 'orders': loadOrders(); break;
                    case 'delivery-notes': loadDeliveryNotes(); break;
                    case 'invoices': loadInvoices(); break;
                    case 'payments': loadPayments(); break;
                    case 'account': loadAccountMovements(); break;
                    // Ekstre sekmesi zaten kendi butonuyla √ßalƒ±≈üƒ±yor
                }
                clickedTab.dataset.loaded = "true";
            }
        }

        function viewOrder(orderId) {
            window.location.href = `/order-detail-admin.html?id=${orderId}`;
        }

        function viewDeliveryNote(id) {
            window.location.href = `/delivery-note-detail.html?id=${id}`;
        }
        
        function viewInvoice(id) {
            window.location.href = `/invoice-detail.html?id=${id}`;
        }

        function createNewOrder() {
            window.location.href = `/order-detail.html?customer_id=${customerId}`;
        }

        function createInvoiceFromDeliveryNotes() {
            // M√º≈üteri ID'sini kullanarak ilgili sayfaya y√∂nlendir.
            window.location.href = `/invoice-from-delivery.html?customer_id=${customerId}`;
        }

        async function addPayment() {
            console.log('addPayment fonksiyonu √ßaƒürƒ±ldƒ±');
            console.log('customerId:', customerId);
            
            try {
                console.log('API √ßaƒürƒ±larƒ± ba≈ülatƒ±lƒ±yor...');
                // Kasalarƒ± ve faturalarƒ± y√ºkle
                const [cashRegisters, invoices] = await Promise.all([
                    apiCall('/api/cash-registers').catch(() => ({ cash_registers: [] })),
                    apiCall(`/api/invoices?customer_id=${customerId}`).catch(() => ({ invoices: [] }))
                ]);
                
                console.log('Kasalar:', cashRegisters);
                console.log('Faturalar:', invoices);
                console.log('ƒ∞lk fatura detayƒ±:', invoices[0]);
                console.log('remaining_amount var mƒ±?', invoices[0] ? invoices[0].remaining_amount : 'Fatura yok');
            
                const cashRegistersList = cashRegisters.cash_registers || cashRegisters || [];
                const cashRegisterOptions = cashRegistersList.map(cr => 
                    `<option value="${cr.id}">${cr.name} (${cr.balance || 0} TL)</option>`
                ).join('');
                console.log('Kasa se√ßenekleri:', cashRegisterOptions);
                
                const invoicesList = invoices.invoices || invoices || [];
                const unpaidInvoices = invoicesList.filter(inv => (inv.remaining_amount || inv.total_amount) > 0);
                console.log('√ñdenmemi≈ü faturalar:', unpaidInvoices);
                const invoiceOptions = unpaidInvoices.map(inv => 
                    `<option value="${inv.id}">${inv.invoice_number} - Kalan: ${inv.remaining_amount || inv.total_amount} TL</option>`
                ).join('');
                console.log('Fatura se√ßenekleri:', invoiceOptions);
                
                console.log('PaymentForm olu≈üturuluyor...');
                const paymentForm = `
                <div onclick="event.stopPropagation()" style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 600px; margin: 2rem auto;">
                    <h3 style="margin-bottom: 1.5rem; text-align: center; color: #2d3748;">üí∞ Yeni Tahsilat Ekle</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Tutar:</label>
                        <input type="number" id="paymentAmount" placeholder="0.00" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">√ñdeme Y√∂ntemi:</label>
                        <select id="paymentMethod" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="cash">Nakit</option>
                            <option value="transfer">Havale</option>
                            <option value="pos">POS</option>
                            <option value="check">√áek</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Kasa:</label>
                        <select id="cashRegister" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            ${cashRegisterOptions}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Fatura Se√ßin (Opsiyonel):</label>
                        <select id="invoiceSelect" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Genel Tahsilat</option>
                            ${invoiceOptions}
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Referans No:</label>
                        <input type="text" id="referenceNumber" placeholder="Opsiyonel" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="submitPayment()" style="padding: 0.75rem 2rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Tahsilat Ekle</button>
                        <button onclick="closePaymentForm()" style="padding: 0.75rem 2rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ƒ∞ptal</button>
                    </div>
                </div>
            `;
            
                console.log('Modal olu≈üturuluyor...');
                // Modal'i g√∂ster
                const modal = document.createElement('div');
                modal.id = 'paymentModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5);';
                modal.innerHTML = paymentForm;
                document.body.appendChild(modal);
                console.log('Modal eklendi:', modal);
            } catch (error) {
                console.error('Tahsilat formu a√ßƒ±lamadƒ±:', error);
                alert('Tahsilat formu a√ßƒ±lamadƒ±: ' + error.message);
            }
        }
        
        function closePaymentForm() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function submitPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const cashRegisterId = document.getElementById('cashRegister').value;
            const invoiceId = document.getElementById('invoiceSelect').value || null;
            const reference = document.getElementById('referenceNumber').value;

            if (!amount || amount <= 0) {
                alert('Ge√ßerli bir tutar girin!');
                return;
            }

            try {
                await apiCall('/api/account-transactions', {
                    method: 'POST',
                    body: JSON.stringify({
                        customer_id: customerId,
                        transaction_type: 'credit',
                        amount: amount,
                        transaction_date: new Date().toISOString().split('T')[0],
                        description: `Admin panelinden ${method} ile tahsilat`,
                        reference_number: reference || `PAY-${Date.now()}`
                    })
                });
                
                alert('Tahsilat ba≈üarƒ±yla eklendi!');
                closePaymentForm();
                
                // Verileri yenile
                await loadSummaryData();
                await loadPayments(); // Sadece ilgili sekmeyi yenile
            } catch (error) {
                alert('Tahsilat eklenemedi: ' + error.message);
            }
        }

        // Ekstre fonksiyonlarƒ±
        async function generateEkstre() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßin!');
                return;
            }
            
            try {
                const movementsResponse = await apiCall(`/api/account-transactions?customer_id=${customerId}&start_date=${startDate}&end_date=${endDate}`);
                const movements = movementsResponse.transactions || [];
                const customerResponse = await apiCall(`/api/customers/${customerId}`);
                const customer = customerResponse.customer || customerResponse;
                
                let html = `
                    <div style="padding: 2rem; background: white; border-radius: 8px;">
                        <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">
                            <h2 style="color: #2d3748; margin-bottom: 0.5rem;">M√ú≈ûTERƒ∞ EKSTRESƒ∞</h2>
                            <p style="color: #718096;">${customer.company_name}</p>
                            <p style="color: #718096; font-size: 0.875rem;">${startDate} - ${endDate}</p>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">Tarih</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left;">A√ßƒ±klama</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: right;">Bor√ß</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: right;">Alacak</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: right;">Bakiye</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let runningBalance = 0;
                movements.forEach(movement => {
                    runningBalance += (movement.debit_amount || 0) - (movement.credit_amount || 0);
                    html += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 0.75rem;">${new Date(movement.movement_date).toLocaleDateString('tr-TR')}</td>
                            <td style="border: 1px solid #ddd; padding: 0.75rem;">${movement.description}</td>
                            <td style="border: 1px solid #ddd; padding: 0.75rem; text-align: right; color: #dc3545;">${movement.debit_amount > 0 ? movement.debit_amount.toLocaleString() + ' TL' : '-'}</td>
                            <td style="border: 1px solid #ddd; padding: 0.75rem; text-align: right; color: #28a745;">${movement.credit_amount > 0 ? movement.credit_amount.toLocaleString() + ' TL' : '-'}</td>
                            <td style="border: 1px solid #ddd; padding: 0.75rem; text-align: right; font-weight: 600;">${runningBalance.toLocaleString()} TL</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa; font-weight: 600;">
                                    <td colspan="4" style="border: 1px solid #ddd; padding: 0.75rem; text-align: right;">SON BAKƒ∞YE:</td>
                                    <td style="border: 1px solid #ddd; padding: 0.75rem; text-align: right; color: ${runningBalance >= 0 ? '#dc3545' : '#28a745'};">${runningBalance.toLocaleString()} TL</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                document.getElementById('ekstreContent').innerHTML = html;
            } catch (error) {
                alert('Ekstre olu≈üturulamadƒ±: ' + error.message);
            }
        }
        
        async function downloadEkstrePDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('L√ºtfen √∂nce ekstre g√∂r√ºnt√ºleyin!');
                return;
            }
            
            try {
                const response = await fetch(`/api/cari/customers/${customerId}/ekstre-pdf?start_date=${startDate}&end_date=${endDate}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('PDF olu≈üturulamadƒ±');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ekstre_${customerId}_${startDate}_${endDate}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('PDF indirilemedi: ' + error.message);
            }
        }
        
        async function downloadEkstreExcel() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('L√ºtfen √∂nce ekstre g√∂r√ºnt√ºleyin!');
                return;
            }
            
            try {
                const response = await fetch(`/api/cari/customers/${customerId}/ekstre-excel?start_date=${startDate}&end_date=${endDate}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('Excel olu≈üturulamadƒ±');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ekstre_${customerId}_${startDate}_${endDate}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Excel indirilemedi: ' + error.message);
            }
        }
        
        // Sayfa y√ºklendiƒüinde m√º≈üteri verilerini y√ºkle
        getCustomerIdFromURL();
    </script>
</body>
</html>