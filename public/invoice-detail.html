<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatura Detayƒ±</title>
    <link rel="stylesheet" href="/theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .header { background: #007bff; color: white; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card { background: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn { padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; margin-right: 1rem; }
        .btn:hover { background: #0056b3; }
        .btn-back { background: #6c757d; }
        .btn-success { background: #28a745; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .items-table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .items-table th, .items-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .items-table th { background: #f8f9fa; font-weight: 600; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .status-partial { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Fatura Detayƒ±</h1>
    </div>

    <div class="container" style="display: flex; flex-direction: column;">
        <div style="margin-bottom: 2rem;">
            <a href="/admin.html" class="btn btn-back">‚Üê Admin Paneline D√∂n</a>
        </div>

        <!-- Fatura Bilgileri - √úst Kutu -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üßæ Fatura Bilgileri</h2>
            <div id="invoiceInfo">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>

        <!-- Fatura Kalemleri - Orta Kutu -->
        <div class="card" style="margin-bottom: 2rem;">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üìã Fatura Kalemleri</h2>
            <div id="invoiceItems">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>

        <!-- Tahsilat ƒ∞≈ülemleri - Alt Kutu -->
        <div class="card">
            <h2 style="color: #2d3748; margin-bottom: 1.5rem; text-align: center; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem;">üí≥ Tahsilat ƒ∞≈ülemleri</h2>
            <div id="paymentSection">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let invoiceId = null;

        if (!authToken) {
            window.location.href = '/';
        }

        async function apiCall(url, options = {}) {
            console.log('API √ßaƒürƒ±sƒ±:', url);
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));
            
            if (!response.ok) {
                const text = await response.text();
                console.log('Hata response:', text);
                throw new Error(`HTTP ${response.status}: ${text}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.log('JSON olmayan response:', text.substring(0, 200));
                throw new Error('Response JSON formatƒ±nda deƒüil');
            }
            
            return response.json();
        }

        function getInvoiceIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            invoiceId = urlParams.get('id');
            if (invoiceId) {
                loadInvoiceData();
            } else {
                alert('Fatura ID bulunamadƒ±');
                window.location.href = '/admin.html';
            }
        }

        async function loadInvoiceData() {
            try {
                console.log('Fatura ID:', invoiceId);
                console.log('Auth Token:', authToken ? 'Var' : 'Yok');
                
                // Fatura bilgilerini al
                const invoice = await apiCall(`/api/cari/invoices/${invoiceId}`);
                console.log('Fatura verisi:', invoice);
                
                const items = await apiCall(`/api/cari/invoices/${invoiceId}/items`);
                console.log('Fatura kalemleri:', items);

                // Faturaya dahil irsaliyeleri al
                const deliveryNotes = await apiCall(`/api/cari/invoices/${invoiceId}/delivery-notes`);
                
                // Fatura bilgilerini g√∂ster
                let deliveryNotesHtml = '';
                if (deliveryNotes.length > 0) {
                    deliveryNotesHtml = `
                        <p><strong>ƒ∞rsaliyeler:</strong> 
                            ${deliveryNotes.map(dn => 
                                `<a href="/delivery-note-detail.html?id=${dn.id}" style="color: #007bff; text-decoration: none; margin-right: 0.5rem;">${dn.delivery_note_number}</a>`
                            ).join('')}
                        </p>
                    `;
                }
                
                document.getElementById('invoiceInfo').innerHTML = `
                    <div class="info-grid">
                        <div>
                            <p><strong>Fatura No:</strong> 
                                <span id="invoiceNumberDisplay">${invoice.invoice_number}</span>
                                <button onclick="editInvoiceNumber()" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úèÔ∏è D√ºzenle</button>
                            </p>
                            <p><strong>M√º≈üteri:</strong> ${invoice.customer_name}</p>
                            <p><strong>Fatura Tarihi:</strong> ${new Date(invoice.invoice_date).toLocaleDateString('tr-TR')}</p>
                            ${deliveryNotesHtml}
                        </div>
                        <div>
                            <p><strong>Toplam Tutar:</strong> ${invoice.total_amount} TL</p>
                            <p><strong>√ñdenen Tutar:</strong> ${invoice.paid_amount || 0} TL</p>
                            <p><strong>Kalan Tutar:</strong> ${invoice.total_amount - (invoice.paid_amount || 0)} TL</p>
                            <p><strong>Durum:</strong> <span class="status-badge status-${invoice.status}">${invoice.status_text}</span></p>
                        </div>
                    </div>
                `;

                let itemsHtml = `
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>√úr√ºn</th>
                                <th>Miktar</th>
                                <th>Birim Fiyat (KDV Hari√ß)</th>
                                <th>KDV %</th>
                                <th>KDV Tutarƒ±</th>
                                <th>Toplam (KDV Dahil)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                let totalVat = 0;
                let totalWithoutVat = 0;
                
                items.forEach(item => {
                    const vatRate = item.vat_rate || 20;
                    const priceWithoutVat = item.unit_price;
                    const subtotal = priceWithoutVat * item.quantity;
                    const vatAmount = (subtotal * vatRate) / 100;
                    const totalWithVat = subtotal + vatAmount;
                    
                    totalVat += vatAmount;
                    totalWithoutVat += subtotal;
                    
                    itemsHtml += `
                        <tr>
                            <td>${item.product_name}</td>
                            <td>${item.quantity}</td>
                            <td>${priceWithoutVat.toFixed(2)} TL</td>
                            <td>%${vatRate}</td>
                            <td>${vatAmount.toFixed(2)} TL</td>
                            <td>${totalWithVat.toFixed(2)} TL</td>
                        </tr>
                    `;
                });

                itemsHtml += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa;">
                                <td colspan="5">Ara Toplam (KDV Hari√ß)</td>
                                <td>${totalWithoutVat.toFixed(2)} TL</td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td colspan="5">KDV Toplamƒ±</td>
                                <td>${totalVat.toFixed(2)} TL</td>
                            </tr>
                            <tr style="background: #e9ecef; font-weight: 600; font-size: 1.1rem;">
                                <td colspan="5">GENEL TOPLAM (KDV Dahil)</td>
                                <td>${(totalWithoutVat + totalVat).toFixed(2)} TL</td>
                            </tr>
                        </tfoot>
                    </table>
                `;

                document.getElementById('invoiceItems').innerHTML = itemsHtml;

                // Tahsilat b√∂l√ºm√º
                const remainingAmount = invoice.total_amount - (invoice.paid_amount || 0);
                if (remainingAmount > 0) {
                    document.getElementById('paymentSection').innerHTML = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h4 style="margin-bottom: 1rem;">Yeni Tahsilat</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div>
                                    <label>Tutar (Max: ${remainingAmount} TL):</label>
                                    <input type="number" id="paymentAmount" max="${remainingAmount}" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label>√ñdeme Y√∂ntemi:</label>
                                    <select id="paymentMethod" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="cash">Nakit</option>
                                        <option value="transfer">Havale</option>
                                        <option value="pos">POS</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Referans No:</label>
                                    <input type="text" id="referenceNumber" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <button class="btn btn-success" onclick="addPayment()">Tahsilat Ekle</button>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('paymentSection').innerHTML = `
                        <div style="text-align: center; color: #28a745; font-weight: 600;">
                            ‚úÖ Bu fatura tamamen √∂denmi≈ütir.
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Fatura verileri y√ºklenemedi:', error);
                alert('Fatura verileri y√ºklenemedi: ' + error.message);
            }
        }

        async function addPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('referenceNumber').value;

            if (!amount || amount <= 0) {
                alert('Ge√ßerli bir tutar girin!');
                return;
            }

            try {
                // Kasalarƒ± y√ºkle
                const cashRegisters = await apiCall('/api/cari/cash-registers');
                const cashRegisterId = cashRegisters.length > 0 ? cashRegisters[0].id : 1;
                
                // Fatura bilgilerini al
                const invoice = await apiCall(`/api/cari/invoices/${invoiceId}`);
                
                await apiCall('/api/cari/payments', {
                    method: 'POST',
                    body: JSON.stringify({
                        customerId: invoice.customer_id,
                        invoiceId: invoiceId,
                        amount: amount,
                        paymentMethod: method,
                        cashRegisterId: cashRegisterId,
                        referenceNumber: reference,
                        notes: `${method} ile tahsilat`
                    })
                });
                
                alert('Tahsilat ba≈üarƒ±yla eklendi!');
                location.reload(); // Sayfayƒ± yenile
            } catch (error) {
                alert('Tahsilat eklenemedi: ' + error.message);
            }
        }

        // Fatura numarasƒ±nƒ± d√ºzenle
        function editInvoiceNumber() {
            const currentNumber = document.getElementById('invoiceNumberDisplay').textContent;
            const newNumber = prompt('Yeni fatura numarasƒ±nƒ± girin:', currentNumber);
            
            if (newNumber && newNumber !== currentNumber) {
                updateInvoiceNumber(newNumber);
            }
        }
        
        async function updateInvoiceNumber(newNumber) {
            try {
                await apiCall(`/api/cari/invoices/${invoiceId}/update-number`, {
                    method: 'PUT',
                    body: JSON.stringify({ invoiceNumber: newNumber })
                });
                
                document.getElementById('invoiceNumberDisplay').textContent = newNumber;
                alert('Fatura numarasƒ± ba≈üarƒ±yla g√ºncellendi!');
            } catch (error) {
                alert('Fatura numarasƒ± g√ºncellenemedi: ' + error.message);
            }
        }

        // Sayfa y√ºklendiƒüinde fatura verilerini y√ºkle
        getInvoiceIdFromURL();
    </script>
</body>
</html>