<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">
    <title>SatÄ±ÅŸ Paneli - Saha CRM</title>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/mobile.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                background-color: #28a745; /* Sales Panel Theme Color */
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 24px;
                z-index: 1002;
                box-shadow: 0 4px 12px rgba(0,0,0,0.25);
                transition: transform 0.3s ease, background-color 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .mobile-menu-toggle.active {
                background-color: #6c757d;
                transform: rotate(45deg);
            }
            .sidebar.mobile-open {
                transform: translateY(0);
                border-top-left-radius: 16px;
                border-top-right-radius: 16px;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            }
        }
    </style>

</head>
<body>


    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- User Profile Dropdown -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px;">
        <div onclick="toggleProfileMenu()" style="padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 8px;">
            <div>
                <div id="userName" style="font-weight: 600; color: #2d3748; font-size: 0.9em;">KullanÄ±cÄ±</div>
                <div id="currentDateTime" style="font-size: 0.75em; color: #666; margin-top: 2px;">--</div>
            </div>
            <div style="color: #666; font-size: 0.8em;">â–¼</div>
        </div>
        <div id="profileMenu" style="display: none; border-top: 1px solid #e2e8f0; padding: 8px 0;">
            <a href="#" onclick="openProfile()" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; text-decoration: none; color: #2d3748; font-size: 0.875em;">
                <span>ğŸ‘¤</span> Profil
            </a>
            <a href="#" onclick="logout()" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; text-decoration: none; color: #2d3748; font-size: 0.875em;">
                <span>ğŸšª</span> Ã‡Ä±kÄ±ÅŸ
            </a>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: white; font-weight: 600; margin-bottom: 0.5rem;">Saha CRM</h2>
                <p style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">SatÄ±ÅŸ Paneli</p>
            </div>
            
            <h3>MenÃ¼</h3>
            <ul id="salesMenu" style="list-style: none; padding: 0;" data-menu-container>
                <li data-key="sales_dashboard"><a href="#" onclick="showDashboard()">ğŸ“Š Dashboard</a></li>
                <li data-key="sales_customers"><a href="#" onclick="showCustomers()">ğŸ¢ MÃ¼ÅŸteriler</a></li>
                <li data-key="sales_orders"><a href="#" onclick="showOrders()">ğŸ“‹ SipariÅŸler</a></li>
                <li data-key="sales_delivery_notes"><a href="#" onclick="showDeliveryNotes()">ğŸ“‹ Ä°rsaliyeler</a></li>
                <li data-key="sales_appointments"><a href="#" onclick="showAppointments()">ğŸ“… Randevu & GÃ¶revler</a></li>
                <li data-key="sales_new_visit"><a href="#" onclick="showNewVisit()">ğŸ†• Yeni Ziyaret</a></li>
                <li data-key="sales_accounts"><a href="#" onclick="showAccounting()">ğŸ’° Cari Hesap</a></li>
                <li data-key="sales_map"><a href="/map.html">ğŸ—ºï¸ Harita</a></li>
                <li data-key="logout"><a href="#" onclick="logout()" style="margin-top: 2rem; color: rgba(255,255,255,0.6);">ğŸšº Ã‡Ä±kÄ±ÅŸ</a></li>
            </ul>
        </div>

        <div class="content" id="content">
            <div class="card">
                <h2>SatÄ±ÅŸ Dashboard</h2>
                <p>SatÄ±ÅŸ paneline hoÅŸ geldiniz!</p>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h3>ğŸ‘¤ Profil Bilgileri</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label>Ad Soyad:</label>
                    <input type="text" id="profile_full_name" required>
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="profile_email" required>
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="profile_phone">
                </div>
                <div class="form-group">
                    <label>Mevcut Åifre:</label>
                    <input type="password" id="current_password">
                </div>
                <div class="form-group">
                    <label>Yeni Åifre:</label>
                    <input type="password" id="new_password">
                </div>
                <div class="form-group">
                    <label>Yeni Åifre Tekrar:</label>
                    <input type="password" id="confirm_password">
                </div>
                <button type="submit" class="btn">GÃ¼ncelle</button>
            </form>
        </div>
    </div>

    <!-- SipariÅŸ Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h3>Yeni SipariÅŸ</h3>
            <form id="orderForm">
                <div class="form-group">
                    <label>MÃ¼ÅŸteri:</label>
                    <select id="order_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>SipariÅŸ Tarihi:</label>
                    <input type="date" id="order_date" required>
                </div>
                
                <!-- ÃœrÃ¼n SeÃ§imi -->
                <div class="form-group">
                    <label>ÃœrÃ¼nler:</label>
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem; background: #f8f9fa;">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                            <div style="flex: 2;">
                                <label>ÃœrÃ¼n:</label>
                                <select id="product_select">
                                    <option value="">ÃœrÃ¼n SeÃ§iniz</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label>Miktar:</label>
                                <input type="number" id="product_quantity" min="1" value="1">
                            </div>
                            <button type="button" onclick="addProductToOrder()" class="btn" style="background: #28a745;">+ Ekle</button>
                        </div>
                        <div id="selected_products" style="max-height: 200px; overflow-y: auto;">
                            <!-- SeÃ§ilen Ã¼rÃ¼nler buraya eklenecek -->
                        </div>
                        <div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                            <strong>Toplam: <span id="order_total">0.00</span> TL</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Teslimat Tarihi:</label>
                    <input type="date" id="order_delivery_date">
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="order_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">SipariÅŸ OluÅŸtur</button>
            </form>
        </div>
    </div>

    <!-- Ziyaret Modal -->
    <div id="visitModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('visitModal')">&times;</span>
            <h3>Yeni Ziyaret / GÃ¶rÃ¼ÅŸme KaydÄ±</h3>
            <form id="visitForm">
                <input type="hidden" id="visit_customer_id">
                <div class="form-group">
                    <label>MÃ¼ÅŸteri:</label>
                    <input type="text" id="visit_customer_name" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>GÃ¶rÃ¼ÅŸme Tipi:</label>
                    <select id="visit_type" required>
                        <option value="visit">Ziyaret</option>
                        <option value="call">Telefon</option>
                        <option value="online">Online ToplantÄ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>SonuÃ§:</label>
                    <select id="visit_result" required onchange="toggleNextAction(this.value, 'visitNextActionSection')">
                        <option value="sale">SatÄ±ÅŸ YapÄ±ldÄ±</option>
                        <option value="potential">Potansiyel</option>
                        <option value="follow_up">Takip Gerekli</option>
                        <option value="not_interested">Ä°lgilenmiyor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="visit_notes" rows="3" placeholder="GÃ¶rÃ¼ÅŸme detaylarÄ±, mÃ¼ÅŸteri talepleri..."></textarea>
                </div>

                <!-- Sonraki Ä°ÅŸlem BÃ¶lÃ¼mÃ¼ -->
                <div id="visitNextActionSection" style="display: none; border-top: 1px solid #ddd; margin-top: 1rem; padding-top: 1rem;">
                    <h4 style="margin-bottom: 1rem;">Sonraki AdÄ±m Planla</h4>
                    <div class="form-group">
                        <label>Sonraki Ä°ÅŸlem:</label>
                        <select id="visit_next_action" onchange="toggleNextActionDate(this.value, 'visitNextDateSection', 'visitNextTimeSection')">
                            <option value="">SeÃ§iniz</option>
                            <option value="appointment">Randevu Planla</option>
                            <option value="call">Telefon GÃ¶rÃ¼ÅŸmesi Planla</option>
                            <option value="visit">Tekrar Ziyaret Planla</option>
                        </select>
                    </div>
                    <input type="date" id="visit_next_date" style="display: none; width: 48%; margin-right: 4%;">
                    <input type="time" id="visit_next_time" style="display: none; width: 48%;">
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Cari Hesap Detay Modal -->
    <div id="accountDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('accountDetailModal')">&times;</span>
            <div id="accountDetailContent">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Aktivite Detay Modal -->
    <div id="activityDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('activityDetailModal')">&times;</span>
            <div id="activityDetailContent">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- MÃ¼ÅŸteri Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
            <h3 id="customerModalTitle">Yeni MÃ¼ÅŸteri</h3>
            <form id="customerForm">
                <input type="hidden" id="customer_edit_id">
                <div class="form-group">
                    <label>Firma AdÄ±:</label>
                    <input type="text" id="company_name" required>
                </div>
                <div class="form-group">
                    <label>Yetkili KiÅŸi:</label>
                    <input type="text" id="contact_person">
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="customer_phone">
                </div>
                <div class="form-group">
                    <label>Cep Telefonu:</label>
                    <input type="tel" id="customer_mobile_phone">
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="customer_email">
                </div>
                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="customer_address" rows="3"></textarea>
                </div>
                <button type="submit" class="btn" id="customerSubmitBtn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- GÃ¶rev Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h3>âœ… Yeni GÃ¶rev</h3>
            <form id="taskForm">
                <div class="form-group">
                    <label>MÃ¼ÅŸteri:</label>
                    <select id="task_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>GÃ¶rev BaÅŸlÄ±ÄŸÄ±:</label>
                    <input type="text" id="task_title" required>
                </div>
                <div class="form-group">
                    <label>AÃ§Ä±klama:</label>
                    <textarea id="task_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ã–ncelik:</label>
                    <select id="task_priority" required>
                        <option value="low">DÃ¼ÅŸÃ¼k</option>
                        <option value="medium">Orta</option>
                        <option value="high">YÃ¼ksek</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>BitiÅŸ Tarihi:</label>
                    <input type="date" id="task_due_date" required>
                </div>
                <button type="submit" class="btn">GÃ¶rev OluÅŸtur</button>
            </form>
        </div>
    </div>

    <!-- Yeni MÃ¼ÅŸteri Modal (Harita) -->
    <div id="newCustomerFromMapModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('newCustomerFromMapModal')">&times;</span>
            <h3>ğŸ¢ Yeni MÃ¼ÅŸteri KaydÄ±</h3>
            <form id="newCustomerFromMapForm">
                <input type="hidden" id="map_lat">
                <input type="hidden" id="map_lng">
                <div class="form-group">
                    <label>Firma AdÄ±:</label>
                    <input type="text" id="map_company_name" required>
                </div>
                <div class="form-group">
                    <label>Yetkili KiÅŸi:</label>
                    <input type="text" id="map_contact_person">
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="map_phone">
                </div>
                <div class="form-group">
                    <label>Cep Telefonu:</label>
                    <input type="tel" id="map_mobile_phone">
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="map_email">
                </div>
                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="map_address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Ziyaret Notu:</label>
                    <textarea id="visit_note" rows="3" placeholder="Ziyaret sÄ±rasÄ±nda alÄ±nan notlar..."></textarea>
                </div>
                <div class="form-group">
                    <label>Ziyaret Sonucu:</label>
                    <select id="visit_result" required>
                        <option value="">SonuÃ§ SeÃ§iniz</option>
                        <option value="positive">Olumlu - SipariÅŸ AlÄ±ndÄ±</option>
                        <option value="potential">Potansiyel - Takip Edilecek</option>
                        <option value="negative">Olumsuz - Ä°lgilenmiyor</option>
                    </select>
                </div>
                <div id="nextActionSection" style="display: none;">
                    <div class="form-group">
                        <label>Sonraki Ä°ÅŸlem:</label>
                        <select id="next_action">
                            <option value="">SeÃ§iniz</option>
                            <option value="appointment">Randevu Planla</option>
                            <option value="call">Telefon GÃ¶rÃ¼ÅŸmesi</option>
                            <option value="visit">Tekrar Ziyaret</option>
                        </select>
                    </div>
                    <div class="form-group" id="nextDateSection" style="display: none;">
                        <label>Tarih:</label>
                        <input type="date" id="next_date">
                    </div>
                    <div class="form-group" id="nextTimeSection" style="display: none;">
                        <label>Saat:</label>
                        <input type="time" id="next_time">
                    </div>
                </div>
                <button type="submit" class="btn">MÃ¼ÅŸteri Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Randevu Planlama Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('appointmentModal')">&times;</span>
            <h3>ğŸ“… Yeni Randevu Planla</h3>
            <div style="margin: 1.5rem 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label>Tarih:</label>
                        <input type="date" id="appointmentDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label>Saat:</label>
                        <input type="time" id="appointmentTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label>Randevu Tipi:</label>
                    <select id="appointmentType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="visit">Ziyaret</option>
                        <option value="call">Telefon GÃ¶rÃ¼ÅŸmesi</option>
                        <option value="meeting">ToplantÄ±</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label>Randevu Notu:</label>
                    <textarea id="appointmentNote" rows="3" placeholder="Randevu hakkÄ±nda notlar..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="text-align: center;">
                    <button onclick="saveAppointment()" class="btn btn-success">âœ“ Randevu Kaydet</button>
                    <button onclick="closeModal('appointmentModal')" class="btn" style="background: #6c757d; margin-left: 0.5rem;">Ä°ptal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Randevu/GÃ¶rev Detay Modal -->
    <div id="appointmentDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('appointmentDetailModal')">&times;</span>
            <div id="appointmentDetailContent">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Ä°rsaliye Modal -->
    <div id="deliveryNoteModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('deliveryNoteModal')">&times;</span>
            <h3 id="deliveryNoteModalTitle">ğŸšš Yeni Ä°rsaliye</h3>
            <form id="deliveryNoteForm">
                <div class="form-group">
                    <label>Ä°rsaliye No:</label>
                    <input type="text" id="delivery_number" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>MÃ¼ÅŸteri:</label>
                    <select id="delivery_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Teslimat Tarihi:</label>
                    <input type="date" id="dn_delivery_date" required>
                </div>
                <div class="form-group">
                    <label>Teslimat Saati:</label>
                    <input type="time" id="delivery_time">
                </div>
                <div class="form-group">
                    <label>Teslimat Adresi:</label>
                    <textarea id="delivery_address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="delivery_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Ä°rsaliye Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Ä°rsaliye Detay Modal -->
    <div id="deliveryDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('deliveryDetailModal')">&times;</span>
            <div id="deliveryDetailContent"></div>
        </div>
    </div>

    <script>
        // Consolidate all script-level variables at the top to prevent initialization errors.
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let orderProducts = [];
        let currentBusinesses = [];
        let selectedDeliveries = [];
        
        // Global profile functions
        window.toggleProfileMenu = function() {
            const menu = document.getElementById('profileMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        };
        
        window.updateDateTime = function() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR');
            const timeStr = now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
            
            const userNameEl = document.getElementById('userName');
            const dateTimeEl = document.getElementById('currentDateTime');
            
            if (userNameEl) {
                let welcomeName = currentUser.full_name || 'KullanÄ±cÄ±';
                if (currentUser.role_name && !currentUser.role_name.includes('SatÄ±ÅŸ')) {
                    welcomeName += ` (${currentUser.role_name})`;
                }
                userNameEl.textContent = welcomeName;
            }
            if (dateTimeEl) dateTimeEl.textContent = `${dateStr} - ${timeStr}`;
        };
        
        window.openProfile = function() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                document.getElementById('profile_full_name').value = currentUser.full_name || '';
                document.getElementById('profile_email').value = currentUser.email || '';
                document.getElementById('profile_phone').value = currentUser.phone || '';
                modal.style.display = 'block';
            }
            toggleProfileMenu();
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000);
        });
        

        
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword && newPassword !== confirmPassword) {
                alert('Åifreler eÅŸleÅŸmiyor!');
                return;
            }
            
            const formData = {
                full_name: document.getElementById('profile_full_name').value,
                email: document.getElementById('profile_email').value,
                phone: document.getElementById('profile_phone').value
            };
            
            if (newPassword) {
                formData.password = newPassword;
            }
            
            try {
                await apiCall(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                
                // Local storage'daki kullanÄ±cÄ± bilgilerini gÃ¼ncelle
                currentUser.full_name = formData.full_name;
                currentUser.email = formData.email;
                currentUser.phone = formData.phone;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                alert('Profil baÅŸarÄ±yla gÃ¼ncellendi!');
                document.getElementById('profileForm').reset();
                closeModal('profileModal');
                updateProfileInfo();
            } catch (error) {
                alert('GÃ¼ncelleme hatasÄ±: ' + error.message);
            }
        });
        
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('profileMenu');
            if (menu && !event.target.closest('[onclick="toggleProfileMenu()"]') && !event.target.closest('#profileMenu')) {
                menu.style.display = 'none';
            }
        });

        console.log('ğŸ”‘ Auth token:', authToken ? 'Mevcut' : 'Yok');
        console.log('ğŸ‘¤ Current user:', currentUser);

        // Yetki kontrolÃ¼
        const salesAllowedRoles = ['SatÄ±ÅŸ Personeli', 'YÃ¶netici', 'SatÄ±ÅŸ MÃ¼dÃ¼rÃ¼'];
        const userRole = currentUser.role_name || '';
        
        if (!salesAllowedRoles.some(role => userRole.includes(role))) {
            alert('Bu sayfaya eriÅŸim yetkiniz yok. Ana sayfaya yÃ¶nlendiriliyorsunuz.');
            // KullanÄ±cÄ±yÄ± kendi paneline veya ana sayfaya yÃ¶nlendir
            window.location.href = '/';
            // Scriptin geri kalanÄ±nÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± engelle
            throw new Error("Yetkisiz eriÅŸim");
        }

        if (!authToken) {
            console.log('âš ï¸ Token yok, ana sayfaya yÃ¶nlendiriliyor');
            // GeÃ§ici olarak token kontrolÃ¼nÃ¼ devre dÄ±ÅŸÄ± bÄ±rak
            // window.location.href = '/';
            
            // Test iÃ§in dummy token ve user oluÅŸtur
            authToken = 'dummy-token';
            currentUser = { id: 1, full_name: 'Test KullanÄ±cÄ±sÄ±', role: 'admin' };
            console.log('ğŸ“ Test modu: Dummy token ve user oluÅŸturuldu');
        }

        async function apiCall(url, options = {}) {
            try {
                console.log('ğŸ”— API Ã§aÄŸrÄ±sÄ±:', url);
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                // Authorization header'Ä± her zaman ekle
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(url, {
                    ...options,
                    headers: headers
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                console.log('ğŸ“¡ Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API hatasÄ±:', errorText);
                    throw new Error(`API hatasÄ±: ${response.status} - ${errorText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    console.log('âœ… API yanÄ±tÄ±:', data);
                    return data;
                } else {
                    const text = await response.text();
                    console.error('âŒ JSON bekleniyor ama HTML geldi:', text.substring(0, 200));
                    throw new Error('Veriler yÃ¼klenemedi: Unexpected token \'<\', "<!DOCTYPE "... is not valid JSON');
                }
            } catch (error) {
                console.error('âŒ API Ã§aÄŸrÄ±sÄ± hatasÄ±:', error);
                throw error;
            }
        }

        function setupMenuVisibility() {
            const permissions = currentUser.permissions || {};

            // Admin (permissions.all: true) her ÅŸeyi gÃ¶rÃ¼r
            if (permissions.all === true) {
                console.log('Admin kullanÄ±cÄ±sÄ±, tÃ¼m menÃ¼ler gÃ¶steriliyor.');
                return;
            }

            console.log('KullanÄ±cÄ± yetkileri kontrol ediliyor:', permissions);
            const menuItems = document.querySelectorAll('#salesMenu [data-key]');

            menuItems.forEach(item => {
                const key = item.dataset.key;
                // 'logout' gibi anahtar kelimeleri her zaman gÃ¶ster
                if (key && key !== 'logout' && !permissions[key]) {
                    console.log(`ğŸš« MenÃ¼ gizleniyor: ${key}`);
                    item.style.display = 'none';
                }
            });
        }

        function toggleNextAction(result, sectionId) {
            const nextActionSection = document.getElementById(sectionId);
            if (result === 'potential' || result === 'follow_up') {
                nextActionSection.style.display = 'block';
            } else {
                nextActionSection.style.display = 'none';
            }
        }

        function toggleNextActionDate(action, dateId, timeId) {
            const dateSection = document.getElementById(dateId);
            const timeSection = document.getElementById(timeId);
            if (action) {
                dateSection.style.display = 'inline-block';
                timeSection.style.display = 'inline-block';
            } else {
                dateSection.style.display = 'none';
                timeSection.style.display = 'none';
            }
        }

        async function showDashboard() {
            try {
                const statsResponse = await apiCall(`/api/sales/dashboard/${currentUser.id}`);
                const stats = statsResponse.stats || {};

                const today = new Date().toISOString().split('T')[0];
                const appointmentsResponse = await apiCall(`/api/appointments?assigned_to=${currentUser.id}&start_date=${today}`);
                const todayAppointments = appointmentsResponse.appointments || [];

                const ordersResponse = await apiCall(`/api/orders?sales_rep_id=${currentUser.id}`);
                const userOrders = ordersResponse.orders || [];
                const orderStatuses = userOrders.reduce((acc, order) => {
                    acc[order.status] = (acc[order.status] || 0) + 1;
                    return acc;
                }, {});

                const salesPercentage = stats.monthlySalesTarget > 0 ? Math.round((stats.currentMonthlySales / stats.monthlySalesTarget) * 100) : 0;
                const visitPercentage = stats.monthlyVisitTarget > 0 ? Math.round((stats.currentMonthlyVisits / stats.monthlyVisitTarget) * 100) : 0;
                const collectionPercentage = stats.monthlyCollectionTarget > 0 ? Math.round((stats.currentMonthlyCollection / stats.monthlyCollectionTarget) * 100) : 0;
                
                // EÄŸer tÃ¼m temel veriler sÄ±fÄ±r ise, kullanÄ±cÄ±ya bir baÅŸlangÄ±Ã§ ekranÄ± gÃ¶ster
                const isDataEmpty = 
                    stats.monthlySalesTarget === 0 &&
                    stats.currentMonthlySales === 0 &&
                    stats.monthlyVisitTarget === 0 &&
                    stats.currentMonthlyVisits === 0;

                if (isDataEmpty && todayAppointments.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="card">
                            <h2>ğŸ“Š SatÄ±ÅŸ Dashboard</h2>
                            <p>HoÅŸ geldiniz, ${currentUser.full_name || 'KullanÄ±cÄ±'}!</p>
                            <div style="background: #e3f2fd; border-left: 4px solid #007bff; padding: 1.5rem; margin: 1.5rem 0; border-radius: 8px;">
                                <h4 style="margin-top: 0; color: #0056b3;">BaÅŸlamaya HazÄ±r!</h4>
                                <p style="color: #333; line-height: 1.6;">Dashboard'unuzda veri gÃ¶rÃ¼ntÃ¼lemek iÃ§in henÃ¼z yeterli aktivite yok veya yÃ¶neticiniz tarafÄ±ndan bu ay iÃ§in bir hedef belirlenmemiÅŸ.</p>
                                <p style="color: #555; font-size: 0.9em; margin-top: 1rem;">Yeni mÃ¼ÅŸteri ziyaretleri ve sipariÅŸler oluÅŸturarak baÅŸlayabilirsiniz.</p>
                                <div style="margin-top: 1.5rem;">
                                    <a href="/visit-nearby.html" class="btn" style="text-decoration: none; background: #fd7e14;">ğŸ†• Yeni Ziyaret</a>
                                    <button class="btn" onclick="openOrderModal()" style="background: #28a745; margin-left: 0.5rem;">ğŸ“ Yeni SipariÅŸ</button>
                                </div>
                            </div>
                        </div>`;
                    return; // Fonksiyonun geri kalanÄ±nÄ± Ã§alÄ±ÅŸtÄ±rma
                }

                document.getElementById('content').innerHTML = `
                    <!-- Hedefler ve GerÃ§ekleÅŸmeler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- AylÄ±k SatÄ±ÅŸ Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">AylÄ±k SatÄ±ÅŸ Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: ${(stats.monthlySalesTarget || 0).toLocaleString('tr-TR')} TL</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ğŸ’°</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">GerÃ§ekleÅŸen: ${(stats.currentMonthlySales || 0).toLocaleString('tr-TR')} TL</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">${salesPercentage}%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${salesPercentage}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #48bb78;">Kalan: ${((stats.monthlySalesTarget || 0) - (stats.currentMonthlySales || 0)).toLocaleString('tr-TR')} TL</div>
                        </div>
                        
                        <!-- AylÄ±k Ziyaret Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">AylÄ±k Ziyaret Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: ${stats.monthlyVisitTarget} ziyaret</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #48bb78, #38a169); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ğŸ¯</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">GerÃ§ekleÅŸen: ${stats.currentMonthlyVisits} ziyaret</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">${visitPercentage}%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${visitPercentage}%; height: 100%; background: linear-gradient(90deg, #48bb78, #38a169); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #48bb78;">Kalan: ${stats.monthlyVisitTarget - stats.currentMonthlyVisits} ziyaret</div>
                        </div>
                        
                        <!-- AylÄ±k Tahsilat Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">AylÄ±k Tahsilat Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: ${(stats.monthlyCollectionTarget || 0).toLocaleString('tr-TR')} TL</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ed8936, #dd6b20); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">ğŸ’³</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">GerÃ§ekleÅŸen: ${(stats.currentMonthlyCollection || 0).toLocaleString('tr-TR')} TL</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">${collectionPercentage}%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${collectionPercentage}%; height: 100%; background: linear-gradient(90deg, #ed8936, #dd6b20); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #ed8936;">Kalan: ${((stats.monthlyCollectionTarget || 0) - (stats.currentMonthlyCollection || 0)).toLocaleString('tr-TR')} TL</div>
                        </div>
                    </div>
                    
                    <!-- BugÃ¼nkÃ¼ Randevular -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">ğŸ“… BugÃ¼nkÃ¼ Randevular</h3>
                        <div id="todayAppointments" style="display: grid; gap: 0.5rem;">
                            ${todayAppointments.length > 0 ? todayAppointments.map(apt => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #48bb78; flex-wrap: wrap; gap: 0.5rem;">
                                    <div>
                                        <strong>${apt.start_time || 'TÃ¼m GÃ¼n'} - ${apt.customer_name || apt.title}</strong>
                                        <div style="font-size: 0.875rem; color: #666;">${apt.description || 'AÃ§Ä±klama yok'}</div>
                                    </div>
                                    <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;" onclick="completeActivity('appointment', ${apt.id})">âœ“ Tamamla</button>
                                </div>
                            `).join('') : '<p style="color: #666; text-align: center;">BugÃ¼n iÃ§in randevu yok.</p>'}
                        </div>
                    </div>
                    

                    
                    <!-- SipariÅŸ Durumu ve MÃ¼ÅŸteri HaritasÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- SipariÅŸ Durumu -->
                        <div class="card" style="margin-bottom: 0;">
                            <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">ğŸ“‹ SipariÅŸ Durumu</h3>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #e8f5e8; border-radius: 4px;">
                                    <span>Bekleyen</span>
                                    <strong style="color: #48bb78;">${orderStatuses.pending || 0} sipariÅŸ</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
                                    <span>Ãœretimde</span>
                                    <strong style="color: #ed8936;">${orderStatuses.production || 0} sipariÅŸ</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #d4edda; border-radius: 4px;">
                                    <span>Teslim Edildi</span>
                                    <strong style="color: #155724;">${orderStatuses.delivered || 0} sipariÅŸ</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8d7da; border-radius: 4px;">
                                    <span>Ä°ptal</span>
                                    <strong style="color: #721c24;">${orderStatuses.cancelled || 0} sipariÅŸ</strong>
                                </div>
                            </div>
                            <button class="btn" onclick="showOrders()" style="width: 100%; margin-top: 1rem;">TÃ¼m SipariÅŸleri GÃ¶rÃ¼ntÃ¼le</button>
                        </div>
                        
                        <!-- MÃ¼ÅŸteri HaritasÄ± -->
                        <div class="card" style="margin-bottom: 0;">
                            <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">ğŸ—ºï¸ MÃ¼ÅŸteri HaritasÄ±</h3>
                            <div id="customerMap" style="height: 200px; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem;"></div>
                            <button class="btn" onclick="window.location.href='/map.html'" style="width: 100%;">HaritayÄ± AÃ§</button>
                        </div>
                    </div>
                `;
                
                // Grafikleri Ã§iz
                setTimeout(() => {
                    initCustomerMap();
                }, 100);
                
            } catch (error) {
                console.error('Dashboard yÃ¼klenemedi:', error);
                showDashboardFallback(error.message);
            }
        }
        
        function showDashboardFallback(errorMessage = '') {
            document.getElementById('content').innerHTML = `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                    <h2>Dashboard YÃ¼klenemedi</h2>
                    <p style="color: #666; margin: 1rem 0 0.5rem 0;">
                        Dashboard verileri yÃ¼klenirken bir sorun oluÅŸtu. Bu durum genellikle eksik veritabanÄ± tablolarÄ±ndan veya geÃ§ici bir sunucu hatasÄ±ndan kaynaklanabilir.
                    </p>
                    ${errorMessage ? `
                    <div style="background: #ffebeb; border: 1px solid #ffcdd2; color: #c62828; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left; font-family: monospace; font-size: 0.8em; word-break: break-all;">
                        <strong>Teknik Hata DetayÄ±:</strong><br>
                        ${errorMessage}
                    </div>
                    ` : ''}
                    <p style="font-size: 0.8em; color: #999; margin-bottom: 1.5rem;">
                        (Hata kaynaÄŸÄ±: <code>/api/sales/dashboard/:userId</code>)
                    </p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: left; font-size: 0.875rem;">
                        <strong>OlasÄ± Ã‡Ã¶zÃ¼mler:</strong>
                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                            <li>SayfayÄ± yenilemeyi deneyin.</li>
                            <li>YukarÄ±daki teknik hata mesajÄ± "relation ... does not exist" gibi bir ifade iÃ§eriyorsa, bu durum veritabanÄ± tablolarÄ±nÄ±n eksik olduÄŸunu gÃ¶sterir. Sistem yÃ¶neticinizden kurulumu tamamlamasÄ±nÄ± isteyin.</li>
                            <li>Sorun devam ederse, lÃ¼tfen sistem yÃ¶neticinizle iletiÅŸime geÃ§in.</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="showDashboard()" style="margin-top: 1.5rem; background: #007bff;">Tekrar Dene</button>
                </div>
            `;
        }

        async function initCustomerMap() {
             const mapElement = document.getElementById('customerMap');
             if (!mapElement) return;
 
             // Clear previous content and ensure it has a height
             mapElement.innerHTML = ''; 
             mapElement.style.height = '200px';
 
             try {
                 // Initialize map on the element
                 const map = L.map(mapElement).setView([41.0082, 28.9784], 10); // Default to Istanbul
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                     attribution: 'Â© OpenStreetMap contributors'
                 }).addTo(map);
 
                 const customersResponse = await apiCall(`/api/customers?sales_rep_id=${currentUser.id}`);
                 const customers = customersResponse.customers || [];
 
                 if (customers.length > 0) {
                     const validCustomers = customers.filter(c => c.latitude && c.longitude);
                     if (validCustomers.length > 0) {
                         const bounds = L.latLngBounds(validCustomers.map(c => [c.latitude, c.longitude]));
                         map.fitBounds(bounds.pad(0.1));
                     }
 
                     validCustomers.forEach(c => {
                         L.marker([c.latitude, c.longitude])
                             .addTo(map)
                             .bindPopup(`<b>${c.company_name}</b><br>${c.address || ''}`);
                     });
                } else {
                     mapElement.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Haritada gÃ¶sterilecek mÃ¼ÅŸteri bulunamadÄ±.</p>';
                }
            } catch (error) {
                console.error('Harita yÃ¼klenemedi:', error);
                mapElement.innerHTML = '<p style="text-align: center; color: red;">Harita yÃ¼klenemedi.</p>';
            }
        }

        async function showVisit() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>MÃ¼ÅŸteri Ziyaret</h2>
                        <button class="btn" onclick="openVisitModal()">Yeni Ziyaret KaydÄ±</button>
                        
                        <h3 style="margin-top: 2rem;">YakÄ±ndaki MÃ¼ÅŸteriler</h3>
                        <div id="nearbyCustomers">
                            ${customers.map(customer => `
                                <div class="customer-card" onclick="selectCustomer(${customer.id})">
                                    <h4>${customer.company_name}</h4>
                                    <p>Yetkili: ${customer.contact_person || '-'}</p>
                                    <p>Telefon: ${customer.phone || '-'}</p>
                                    <p>Durum: ${customer.customer_status}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Ziyaret sayfasÄ± yÃ¼klenemedi:', error);
            }
        }

        async function showCustomers() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                let html = `
                    <div class="card">
                        <h2>MÃ¼ÅŸterilerim</h2>
                        <button class="btn" onclick="openCustomerModal()" style="margin-bottom: 1rem;">+ Yeni MÃ¼ÅŸteri</button>
                        <div style="display: grid; gap: 1rem;">
                `;
                
                customers.forEach(customer => {
                    html += `
                        <div class="customer-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <h4>${customer.company_name}</h4>
                                    <p>Yetkili: ${customer.contact_person || '-'}</p>
                                    <p>Telefon: ${customer.phone || '-'}</p>
                                    <p>Durum: ${customer.customer_status}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn" onclick="editCustomer(${customer.id})" style="background: #ed8936;">âœï¸ DÃ¼zenle</button>
                                    <button class="btn" onclick="visitCustomer(${customer.id})">ğŸ“‹ Ziyaret</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('MÃ¼ÅŸteriler yÃ¼klenemedi:', error);
            }
        }

        async function showOrders() {
            try {
                // Sadece mevcut kullanÄ±cÄ±ya ait sipariÅŸleri getir
                const ordersResponse = await apiCall(`/api/orders?sales_rep_id=${currentUser.id}`);
                const myOrders = ordersResponse.orders || [];
                
                let html = `
                    <div class="card">
                        <h2>SipariÅŸlerim</h2>
                        <button class="btn" onclick="openOrderModal()">Yeni SipariÅŸ</button>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>SipariÅŸ No</th>
                                        <th>MÃ¼ÅŸteri</th>
                                        <th>Tarih</th>
                                        <th>Tutar</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                myOrders.forEach(order => {
                    const statusText = getOrderStatusText(order.status);
                    html += `
                        <tr onclick="viewOrderDetail(${order.id})" style="cursor: pointer;">
                            <td>#${order.order_number}</td>
                            <td>${order.company_name || 'Bilinmiyor'}</td>
                            <td>${new Date(order.order_date).toLocaleDateString('tr-TR')}</td>
                            <td>${order.total_amount} TL</td>
                            <td>${statusText}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('SipariÅŸler yÃ¼klenemedi:', error);
            }
        }

        async function showMap() {
            window.location.href = '/map.html';
        }

        function selectCustomer(customerId) {
            document.querySelectorAll('.customer-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.customer-card').classList.add('active');
        }

        async function visitCustomer(customerId) {
            try {
                const customerResponse = await apiCall(`/api/customers/${customerId}`);
                const customer = customerResponse.customer;

                document.getElementById('visit_customer_id').value = customer.id;
                document.getElementById('visit_customer_name').value = customer.company_name;
                
                // Reset and hide the next action section
                document.getElementById('visitForm').reset();
                document.getElementById('visitNextActionSection').style.display = 'none';
                toggleNextActionDate('', 'visitNextDateSection', 'visitNextTimeSection');

                document.getElementById('visitModal').style.display = 'block';
            } catch (error) {
                alert('MÃ¼ÅŸteri bilgileri yÃ¼klenemedi: ' + error.message);
            }
        }

        function viewCustomerDetail(customerId) {
            window.location.href = `/customer-detail.html?id=${customerId}`;
        }

        async function openVisitModal() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('customer_id');
                customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri SeÃ§iniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('visitModal').style.display = 'block';
            } catch (error) {
                alert('MÃ¼ÅŸteriler yÃ¼klenemedi: ' + error.message);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function openOrderModal(preselectedCustomer = null) {
            try {
                const [customersResponse, productsResponse] = await Promise.all([
                    apiCall('/api/customers'),
                    apiCall('/api/products')
                ]);
                
                const customers = customersResponse.customers || [];
                const products = productsResponse.products || [];

                const customerSelect = document.getElementById('order_customer_id');
                customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri SeÃ§iniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });

                if (preselectedCustomer) {
                    let optionExists = false;
                    for (let i = 0; i < customerSelect.options.length; i++) {
                        if (customerSelect.options[i].value == preselectedCustomer.id) {
                            optionExists = true;
                            break;
                        }
                    }
                    if (!optionExists) customerSelect.add(new Option(preselectedCustomer.name, preselectedCustomer.id));
                    customerSelect.value = preselectedCustomer.id;
                }
                
                const productSelect = document.getElementById('product_select');
                productSelect.innerHTML = '<option value="">ÃœrÃ¼n SeÃ§iniz</option>';
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ${product.unit_price} TL`;
                    option.dataset.price = product.unit_price;
                    option.dataset.name = product.name;
                    productSelect.appendChild(option);
                });
                
                document.getElementById('order_date').value = new Date().toISOString().split('T')[0];
                orderProducts = [];
                updateOrderDisplay();
                
                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                alert('Veriler yÃ¼klenemedi: ' + error.message);
            }
        }
        
        function addProductToOrder() {
            const productSelect = document.getElementById('product_select');
            const quantityInput = document.getElementById('product_quantity');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            if (!selectedOption.value) {
                alert('LÃ¼tfen bir Ã¼rÃ¼n seÃ§in!');
                return;
            }
            
            const quantity = parseInt(quantityInput.value);
            if (!quantity || quantity < 1) {
                alert('LÃ¼tfen geÃ§erli bir miktar girin!');
                return;
            }
            
            const productId = selectedOption.value;
            const productName = selectedOption.dataset.name;
            const productPrice = parseFloat(selectedOption.dataset.price);
            
            // AynÄ± Ã¼rÃ¼n varsa miktarÄ±nÄ± artÄ±r
            const existingProduct = orderProducts.find(p => p.id === productId);
            if (existingProduct) {
                existingProduct.quantity += quantity;
            } else {
                orderProducts.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity
                });
            }
            
            // Formu temizle
            productSelect.selectedIndex = 0;
            quantityInput.value = 1;
            
            updateOrderDisplay();
        }
        
        function removeProductFromOrder(index) {
            orderProducts.splice(index, 1);
            updateOrderDisplay();
        }
        
        function updateOrderDisplay() {
            const container = document.getElementById('selected_products');
            const totalElement = document.getElementById('order_total');
            
            if (orderProducts.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">HenÃ¼z Ã¼rÃ¼n eklenmedi</p>';
                totalElement.textContent = '0.00';
                return;
            }
            
            let total = 0;
            container.innerHTML = orderProducts.map((product, index) => {
                const subtotal = product.price * product.quantity;
                total += subtotal;
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${product.name || 'Ä°simsiz ÃœrÃ¼n'}</strong><br>
                            <small>${product.quantity} x ${product.price} TL = ${subtotal.toFixed(2)} TL</small>
                        </div>
                        <button type="button" onclick="removeProductFromOrder(${index})" class="btn" style="background: #dc3545; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Sil</button>
                    </div>
                `;
            }).join('');
            
            totalElement.textContent = total.toFixed(2);
        }
        
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (orderProducts.length === 0) { alert('LÃ¼tfen en az bir Ã¼rÃ¼n ekleyin!'); return; }
            const total = orderProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            const formData = { customer_id: document.getElementById('order_customer_id').value, order_date: document.getElementById('order_date').value, delivery_date: document.getElementById('order_delivery_date').value, total_amount: total, notes: document.getElementById('order_notes').value, items: orderProducts };
            try {
                const result = await apiCall('/api/orders', { method: 'POST', body: JSON.stringify(formData) });
                const orderNumber = result.order?.order_number || result.order_number || 'SIP' + Date.now();
                alert(`SipariÅŸ baÅŸarÄ±yla oluÅŸturuldu! SipariÅŸ No: ${orderNumber}`);
                document.getElementById('orderForm').reset();
                orderProducts = [];
                closeModal('orderModal');
                showOrders();
            } catch (error) { alert('Hata: ' + error.message); }
        });
        
        document.getElementById('visitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerId = document.getElementById('visit_customer_id').value;
            const customerName = document.getElementById('visit_customer_name').value;

            const visitData = {
                customer_id: customerId,
                visit_type: document.getElementById('visit_type').value,
                result: document.getElementById('visit_result').value,
                notes: document.getElementById('visit_notes').value,
                visit_date: new Date().toISOString(),
                next_contact_date: document.getElementById('visit_next_date').value || null
            };
            
            const nextActionData = {
                action: document.getElementById('visit_next_action').value,
                date: document.getElementById('visit_next_date').value,
                time: document.getElementById('visit_next_time').value
            };

            try {
                // 1. Ziyareti kaydet
                await apiCall('/api/visits', {
                    method: 'POST',
                    body: JSON.stringify(visitData)
                });
                
                // 2. Gerekliyse takip randevusu oluÅŸtur
                if ((visitData.result === 'potential' || visitData.result === 'follow_up') && nextActionData.action && nextActionData.date) {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: `${nextActionData.action} - ${customerName}`,
                            description: `Ã–nceki ziyaret sonrasÄ± takip.`,
                            type: nextActionData.action,
                            priority: 'medium',
                            start_date: nextActionData.date,
                            start_time: nextActionData.time || null,
                            assigned_to: currentUser.id,
                            customer_id: customerId
                        })
                    });
                    alert('Ziyaret kaydedildi ve takip randevusu oluÅŸturuldu!');
                } else {
                    alert('Ziyaret kaydÄ± baÅŸarÄ±yla oluÅŸturuldu!');
                }
                
                document.getElementById('visitForm').reset();
                closeModal('visitModal');
                showDashboard(); // Dashboard'u yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        async function openTaskModal() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('task_customer_id');
                customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri SeÃ§iniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('taskModal').style.display = 'block';
            } catch (error) {
                alert('MÃ¼ÅŸteriler yÃ¼klenemedi: ' + error.message);
            }
        }
        
        async function completeActivity(type, id) {
            if (confirm(`${type === 'appointment' ? 'Randevu' : type === 'task' ? 'GÃ¶rev' : 'Ziyaret'} tamamlandÄ± olarak iÅŸaretlensin mi?`)) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'Aktivite tamamlandÄ±'
                        })
                    });
                    alert('Aktivite tamamlandÄ±!');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function editActivity(type, id) {
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const appointment = response.appointment;
                
                // Basit edit modal aÃ§
                const newTitle = prompt('Yeni baÅŸlÄ±k:', appointment.title);
                if (newTitle && newTitle !== appointment.title) {
                    await apiCall(`/api/appointments/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...appointment,
                            title: newTitle
                        })
                    });
                    alert('GÃ¼ncellendi!');
                    showAppointments();
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function showAppointmentDetail(id) {
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                const typeNames = {
                    'appointment': 'Randevu',
                    'task': 'GÃ¶rev', 
                    'visit': 'Ziyaret',
                    'call': 'Telefon',
                    'meeting': 'ToplantÄ±'
                };
                
                const statusNames = {
                    'pending': 'Bekliyor',
                    'in_progress': 'Devam Ediyor',
                    'completed': 'TamamlandÄ±',
                    'cancelled': 'Ä°ptal Edildi'
                };
                
                document.getElementById('appointmentDetailContent').innerHTML = `
                    <h3>${typeNames[apt.type] || apt.type} DetayÄ±</h3>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div><strong>BaÅŸlÄ±k:</strong> ${apt.title}</div>
                            <div><strong>Durum:</strong> <span style="color: ${apt.status === 'completed' ? '#28a745' : apt.status === 'pending' ? '#ffc107' : '#007bff'};">${statusNames[apt.status] || apt.status}</span></div>
                            <div><strong>Tarih:</strong> ${new Date(apt.start_date).toLocaleDateString('tr-TR')}</div>
                            <div><strong>Saat:</strong> ${apt.start_time || '09:00'}</div>
                            <div><strong>MÃ¼ÅŸteri:</strong> ${apt.customer_name || 'Genel'}</div>
                            <div><strong>Ã–ncelik:</strong> ${apt.priority}</div>
                        </div>
                        ${apt.description ? `<div style="margin-top: 1rem;"><strong>AÃ§Ä±klama:</strong><br>${apt.description}</div>` : ''}
                        ${apt.location ? `<div style="margin-top: 0.5rem;"><strong>Konum:</strong> ${apt.location}</div>` : ''}
                        ${apt.completion_notes ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: 4px;"><strong>Tamamlanma Notu:</strong><br>${apt.completion_notes}</div>` : ''}
                    </div>
                    
                    <!-- Not Ekleme -->
                    <div style="margin: 1rem 0;">
                        <label><strong>Yeni Not Ekle:</strong></label>
                        <textarea id="newNote" rows="3" placeholder="Not yazÄ±n..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;"></textarea>
                    </div>
                    
                    <!-- Ä°ÅŸlem ButonlarÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1.5rem 0;">
                        ${apt.status === 'pending' ? `
                            <button onclick="completeAppointmentWithNote(${apt.id})" class="btn" style="background: #28a745;">âœ“ Tamamla</button>
                            <button onclick="rescheduleAppointment(${apt.id})" class="btn" style="background: #ffc107;">ğŸ“… Yeniden Planla</button>
                        ` : ''}
                        ${apt.customer_id ? `
                            <button onclick="createOrderFromAppointment(${apt.customer_id}, '${apt.customer_name}')" class="btn" style="background: #007bff;">ğŸ“‹ SipariÅŸ OluÅŸtur</button>
                            <button onclick="scheduleFollowUp(${apt.customer_id}, '${apt.customer_name}')" class="btn" style="background: #6f42c1;">ğŸ”„ Takip Randevusu</button>
                        ` : ''}
                        <button onclick="addNoteToAppointment(${apt.id})" class="btn" style="background: #17a2b8;">ğŸ“ Not Ekle</button>
                        <button onclick="markAsNotInterested(${apt.id})" class="btn" style="background: #dc3545;">âŒ Ä°lgilenmiyor</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="closeModal('appointmentDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                    </div>
                `;
                
                document.getElementById('appointmentDetailModal').style.display = 'block';
            } catch (error) {
                alert('Detay yÃ¼klenemedi: ' + error.message);
            }
        }
        
        async function completeAppointmentWithNote(id) {
            const note = document.getElementById('newNote').value;
            try {
                await apiCall(`/api/appointments/${id}/complete`, {
                    method: 'POST',
                    body: JSON.stringify({
                        completion_notes: note || 'TamamlandÄ±'
                    })
                });
                
                // MÃ¼ÅŸteriyi potansiyel olarak kaydet
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                if (apt.customer_id) {
                    try {
                        await apiCall(`/api/customers/${apt.customer_id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                customer_status: 'potential'
                            })
                        });
                    } catch (error) {
                        console.log('MÃ¼ÅŸteri durumu gÃ¼ncellenemedi:', error.message);
                    }
                }
                
                alert('Randevu tamamlandÄ± ve mÃ¼ÅŸteri potansiyel olarak iÅŸaretlendi!');
                closeModal('appointmentDetailModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function addNoteToAppointment(id) {
            const note = document.getElementById('newNote').value;
            if (!note.trim()) {
                alert('LÃ¼tfen bir not yazÄ±n!');
                return;
            }
            
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                const updatedDescription = apt.description ? 
                    `${apt.description}\n\n[${new Date().toLocaleString('tr-TR')}] ${note}` : 
                    `[${new Date().toLocaleString('tr-TR')}] ${note}`;
                
                await apiCall(`/api/appointments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        ...apt,
                        description: updatedDescription
                    })
                });
                
                alert('Not eklendi!');
                document.getElementById('newNote').value = '';
                showAppointmentDetail(id); // DetayÄ± yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function rescheduleAppointment(id) {
            // Takvim modalÄ±nÄ± aÃ§
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentType').value = 'appointment';
            document.getElementById('appointmentNote').value = 'Yeniden planlanan randevu';
            
            // Global deÄŸiÅŸkenleri ayarla
            window.rescheduleAppointmentId = id;
            window.isRescheduleMode = true;
            
            closeModal('appointmentDetailModal');
            document.getElementById('appointmentModal').style.display = 'block';
        }
        
        async function createOrderFromAppointment(customerId, customerName) {
            try {
                const customerForModal = { id: customerId, name: customerName };
                // SipariÅŸ modalÄ±nÄ± aÃ§
                closeModal('appointmentDetailModal');
                openOrderModal(customerForModal);
            } catch (error) {
                console.error('SipariÅŸ formu aÃ§Ä±lÄ±rken hata:', error.message);
                alert('SipariÅŸ formu aÃ§Ä±lÄ±rken bir hata oluÅŸtu.');
            }
        }
        
        async function scheduleFollowUp(customerId, customerName) {
            // Takvim modalÄ±nÄ± aÃ§
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentType').value = 'visit';
            document.getElementById('appointmentNote').value = `Takip randevusu - ${customerName}`;
            
            // Global deÄŸiÅŸkenleri ayarla
            window.followUpCustomerId = customerId;
            window.followUpCustomerName = customerName;
            window.isFollowUpMode = true;
            
            closeModal('appointmentDetailModal');
            document.getElementById('appointmentModal').style.display = 'block';
        }
        
        async function markAsNotInterested(id) {
            if (confirm('MÃ¼ÅŸteri ilgilenmiyor olarak iÅŸaretlensin mi?')) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'MÃ¼ÅŸteri ilgilenmiyor'
                        })
                    });
                    
                    alert('MÃ¼ÅŸteri ilgilenmiyor olarak iÅŸaretlendi.');
                    closeModal('appointmentDetailModal');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function completeTask(id) {
            if (confirm('GÃ¶rev tamamlandÄ± olarak iÅŸaretlensin mi?')) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'GÃ¶rev tamamlandÄ±'
                        })
                    });
                    alert('GÃ¶rev tamamlandÄ±!');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // GÃ¶rev formundan gelen verileri /api/appointments endpoint'ine uygun hale getir
            const formData = {
                customer_id: document.getElementById('task_customer_id').value,
                title: document.getElementById('task_title').value,
                description: document.getElementById('task_description').value,
                priority: document.getElementById('task_priority').value,
                start_date: document.getElementById('task_due_date').value, // BitiÅŸ tarihi, baÅŸlangÄ±Ã§ tarihi olarak atanÄ±r
                type: 'task', // Bu bir gÃ¶revdir
                assigned_to: currentUser.id,
                status: 'pending'
            };
            
            try {
                await apiCall('/api/appointments', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                alert('GÃ¶rev baÅŸarÄ±yla oluÅŸturuldu!');
                document.getElementById('taskForm').reset();
                closeModal('taskModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerId = document.getElementById('customer_edit_id').value;
            const formData = {
                company_name: document.getElementById('company_name').value,
                contact_person: document.getElementById('contact_person').value,
                phone: document.getElementById('customer_phone').value,
                mobile_phone: document.getElementById('customer_mobile_phone').value,
                email: document.getElementById('customer_email').value,
                address: document.getElementById('customer_address').value,
                assigned_sales_rep: currentUser.id
            };
            
            try {
                if (customerId) {
                    // GÃ¼ncelleme
                    await apiCall(`/api/customers/${customerId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('MÃ¼ÅŸteri baÅŸarÄ±yla gÃ¼ncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/customers', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('MÃ¼ÅŸteri baÅŸarÄ±yla eklendi!');
                }
                
                document.getElementById('customerForm').reset();
                closeModal('customerModal');
                showCustomers();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        function drawSalesChart() {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Veri
            const months = ['Oca', 'Åub', 'Mar', 'Nis', 'May', 'Haz'];
            const target = [100, 120, 110, 130, 125, 140];
            const actual = [85, 95, 105, 115, 130, 125];
            
            const maxValue = Math.max(...target, ...actual) * 1.1;
            const barWidth = (width - 80) / (months.length * 2.5);
            
            // Grid Ã§izgiler
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 40 + (i * (height - 80) / 5);
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(width - 20, y);
                ctx.stroke();
            }
            
            months.forEach((month, index) => {
                const x = 60 + (index * 2.5) * barWidth;
                const targetHeight = (target[index] / maxValue) * (height - 80);
                const actualHeight = (actual[index] / maxValue) * (height - 80);
                
                // Hedef bar (daha ince)
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(x, height - targetHeight - 40, barWidth * 0.6, targetHeight);
                
                // GerÃ§ekleÅŸen bar (gradient)
                const gradient = ctx.createLinearGradient(0, height - 40, 0, height - actualHeight - 40);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, height - actualHeight - 40, barWidth * 0.6, actualHeight);
                
                // Ay etiketi
                ctx.fillStyle = '#718096';
                ctx.font = '12px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText(month, x + barWidth * 0.3, height - 15);
            });
            
            // Legend
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(40, 15, 12, 12);
            ctx.fillStyle = '#718096';
            ctx.font = '11px Poppins';
            ctx.textAlign = 'left';
            ctx.fillText('Hedef', 58, 25);
            
            ctx.fillStyle = '#667eea';
            ctx.fillRect(100, 15, 12, 12);
            ctx.fillText('GerÃ§ekleÅŸen', 118, 25);
        }
        
        function drawVisitChart() {
            const canvas = document.getElementById('visitChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 10;
            const radius = 70;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const data = [
                { label: 'BaÅŸarÄ±lÄ±', value: 60, color: '#48bb78' },
                { label: 'Potansiyel', value: 25, color: '#ed8936' },
                { label: 'Olumsuz', value: 15, color: '#f56565' }
            ];
            
            let currentAngle = -Math.PI / 2; // BaÅŸlangÄ±Ã§ Ã¼st nokta
            
            data.forEach((item, index) => {
                const sliceAngle = (item.value / 100) * 2 * Math.PI;
                
                // Gradient oluÅŸtur
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                gradient.addColorStop(0, item.color);
                gradient.addColorStop(1, item.color + '80');
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Ã‡ember kenarÄ±
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
            
            // Legend
            let legendY = canvas.height - 60;
            data.forEach((item, index) => {
                ctx.fillStyle = item.color;
                ctx.fillRect(20, legendY + (index * 20), 12, 12);
                
                ctx.fillStyle = '#718096';
                ctx.font = '11px Poppins';
                ctx.textAlign = 'left';
                ctx.fillText(`${item.label} ${item.value}%`, 38, legendY + (index * 20) + 9);
            });
        }
        
        async function showCalendar() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2>ğŸ“… Takvim ve Aktiviteler</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- BugÃ¼nkÃ¼ Aktiviteler -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: #2d3748; margin-bottom: 1rem;">ğŸ“… BugÃ¼nkÃ¼ Aktiviteler</h3>
                            <div id="todayActivities">
                                <div onclick="showActivityDetail(1)" style="border-left: 4px solid #48bb78; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>09:00</strong> - ABC Restaurant ziyareti
                                    <div style="font-size: 0.875rem; color: #666;">SipariÅŸ takibi</div>
                                </div>
                                <div onclick="showActivityDetail(2)" style="border-left: 4px solid #ed8936; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>14:00</strong> - XYZ Cafe randevusu
                                    <div style="font-size: 0.875rem; color: #666;">Yeni Ã¼rÃ¼n tanÄ±tÄ±mÄ±</div>
                                </div>
                                <div onclick="showActivityDetail(3)" style="border-left: 4px solid #f56565; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>16:30</strong> - DEF Otel telefon gÃ¶rÃ¼ÅŸmesi
                                    <div style="font-size: 0.875rem; color: #666;">Tahsilat takibi</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bu Hafta PlanlÄ± -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: #2d3748; margin-bottom: 1rem;">ğŸ“† Bu Hafta PlanlÄ±</h3>
                            <div id="weekActivities">
                                <div onclick="showActivityDetail(4)" style="border-left: 4px solid #42A5F5; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>YarÄ±n 10:00</strong> - GHI Market
                                    <div style="font-size: 0.875rem; color: #666;">AylÄ±k sipariÅŸ planlamasÄ±</div>
                                </div>
                                <div onclick="showActivityDetail(5)" style="border-left: 4px solid #9f7aea; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>PerÅŸembe 15:00</strong> - JKL Restaurant
                                    <div style="font-size: 0.875rem; color: #666;">Yeni mÃ¼ÅŸteri ziyareti</div>
                                </div>
                                <div onclick="showActivityDetail(6)" style="border-left: 4px solid #48bb78; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>Cuma 11:00</strong> - MNO Cafe
                                    <div style="font-size: 0.875rem; color: #666;">SipariÅŸ teslim takibi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yeni Aktivite Ekleme -->
                    <div style="background: white; border: 2px dashed #e2e8f0; padding: 2rem; border-radius: 8px; text-align: center;">
                        <h3 style="color: #2d3748; margin-bottom: 1rem;">â• Yeni Aktivite Ekle</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; align-items: end;">
                            <div>
                                <label>Tarih:</label>
                                <input type="date" id="activityDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>Saat:</label>
                                <input type="time" id="activityTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>MÃ¼ÅŸteri:</label>
                                <select id="activityCustomer" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">MÃ¼ÅŸteri SeÃ§iniz</option>
                                    <option value="1">ABC Restaurant</option>
                                    <option value="2">XYZ Cafe</option>
                                    <option value="3">DEF Otel</option>
                                </select>
                            </div>
                            <button onclick="addActivity()" class="btn">â• Ekle</button>
                        </div>
                        <div style="margin-top: 1rem;">
                            <input type="text" id="activityNote" placeholder="Aktivite notu..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            
            // BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
            document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
        }
        
        function showActivityDetail(activityId) {
            // Ã–rnek veri - gerÃ§ekte API'den gelecek
            const activities = {
                1: {
                    customer: 'ABC Restaurant',
                    time: '09:00',
                    type: 'Ziyaret',
                    status: 'PlanlÄ±',
                    notes: 'SipariÅŸ takibi yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-15', note: 'Yeni Ã¼rÃ¼nler tanÄ±tÄ±ldÄ±, olumlu karÅŸÄ±landÄ±', result: 'Potansiyel' },
                        { date: '2025-08-10', note: '500 TL sipariÅŸ alÄ±ndÄ±', result: 'SatÄ±ÅŸ' },
                        { date: '2025-08-05', note: 'Ä°lk ziyaret, tanÄ±ÅŸma toplantÄ±sÄ±', result: 'Potansiyel' }
                    ]
                },
                2: {
                    customer: 'XYZ Cafe',
                    time: '14:00',
                    type: 'Randevu',
                    status: 'OnaylanmÄ±ÅŸ',
                    notes: 'Yeni Ã¼rÃ¼n tanÄ±tÄ±mÄ± yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-12', note: 'Fiyat teklifi verildi, dÃ¼ÅŸÃ¼nÃ¼yor', result: 'Potansiyel' },
                        { date: '2025-08-08', note: 'MÃ¼ÅŸteri ilgili ama karar veremedi', result: 'Potansiyel' }
                    ]
                },
                3: {
                    customer: 'DEF Otel',
                    time: '16:30',
                    type: 'Telefon',
                    status: 'PlanlÄ±',
                    notes: 'Tahsilat takibi yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-18', note: '1200 TL sipariÅŸ verildi, Ã¶deme 30 gÃ¼n vade', result: 'SatÄ±ÅŸ' },
                        { date: '2025-08-14', note: 'BÃ¼yÃ¼k sipariÅŸ potansiyeli var', result: 'Potansiyel' }
                    ]
                },
                4: {
                    customer: 'GHI Market',
                    time: 'YarÄ±n 10:00',
                    type: 'Ziyaret',
                    status: 'PlanlÄ±',
                    notes: 'AylÄ±k sipariÅŸ planlamasÄ± yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-16', note: '2500 TL bÃ¼yÃ¼k sipariÅŸ alÄ±ndÄ±', result: 'SatÄ±ÅŸ' },
                        { date: '2025-08-10', note: 'AylÄ±k ihtiyaÃ§ belirlendi', result: 'Potansiyel' }
                    ]
                },
                5: {
                    customer: 'JKL Restaurant',
                    time: 'PerÅŸembe 15:00',
                    type: 'Ziyaret',
                    status: 'Yeni MÃ¼ÅŸteri',
                    notes: 'Yeni mÃ¼ÅŸteri ziyareti, tanÄ±tÄ±m yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-17', note: 'Ä°lk irtibat kuruldu, ilgili gÃ¶rÃ¼nÃ¼yor', result: 'Potansiyel' }
                    ]
                },
                6: {
                    customer: 'MNO Cafe',
                    time: 'Cuma 11:00',
                    type: 'Takip',
                    status: 'PlanlÄ±',
                    notes: 'SipariÅŸ teslim takibi yapÄ±lacak',
                    previousVisits: [
                        { date: '2025-08-19', note: '800 TL sipariÅŸ verildi, teslim bekliyor', result: 'SatÄ±ÅŸ' },
                        { date: '2025-08-12', note: 'Fiyat listesi verildi', result: 'Potansiyel' }
                    ]
                }
            };
            
            const activity = activities[activityId];
            if (!activity) return;
            
            document.getElementById('activityDetailContent').innerHTML = `
                <h3>ğŸ“… ${activity.customer} - Aktivite DetayÄ±</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 1.5rem 0;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h4>BugÃ¼nkÃ¼ Aktivite</h4>
                        <p><strong>Saat:</strong> ${activity.time}</p>
                        <p><strong>Tip:</strong> ${activity.type}</p>
                        <p><strong>Durum:</strong> <span style="color: #48bb78;">${activity.status}</span></p>
                        <p><strong>Not:</strong> ${activity.notes}</p>
                        <button onclick="completeActivity(${activityId})" class="btn btn-success" style="margin-top: 0.5rem;">âœ“ TamamlandÄ± Olarak Ä°ÅŸaretle</button>
                        <div id="completedActions-${activityId}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <h5 style="margin-bottom: 0.5rem;">Sonraki AÅŸama:</h5>
                            <button onclick="scheduleNextMeeting(${activityId})" class="btn" style="background: #42A5F5; margin-right: 0.5rem; margin-bottom: 0.5rem;">ğŸ“… Tekrar Randevu</button>
                            <button onclick="createOrder(${activityId})" class="btn" style="background: #48bb78; margin-right: 0.5rem; margin-bottom: 0.5rem;">ğŸ“ SipariÅŸ Yap</button>
                            <button onclick="scheduleCall(${activityId})" class="btn" style="background: #ed8936; margin-right: 0.5rem; margin-bottom: 0.5rem;">ğŸ“ Telefon Planla</button>
                            <button onclick="markAsNotInterested(${activityId})" class="btn" style="background: #f56565; margin-bottom: 0.5rem;">âŒ Ä°lgilenmiyor</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h4>MÃ¼ÅŸteri Bilgileri</h4>
                        <p><strong>Firma:</strong> ${activity.customer}</p>
                        <p><strong>Son Ziyaret:</strong> ${activity.previousVisits[0].date}</p>
                        <p><strong>Toplam Ziyaret:</strong> ${activity.previousVisits.length} kez</p>
                        <button onclick="viewCustomerDetail(1)" class="btn" style="margin-top: 0.5rem;">ğŸ‘¥ MÃ¼ÅŸteri DetayÄ±</button>
                    </div>
                </div>
                
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                    <h4>ğŸ“ Ã–nceki GÃ¶rÃ¼ÅŸme NotlarÄ±</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${activity.previousVisits.map(visit => `
                            <div style="border-bottom: 1px solid #f1f5f9; padding: 0.75rem 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong>${new Date(visit.date).toLocaleDateString('tr-TR')}</strong>
                                    <span style="background: ${visit.result === 'SatÄ±ÅŸ' ? '#d4edda' : '#fff3cd'}; color: ${visit.result === 'SatÄ±ÅŸ' ? '#155724' : '#856404'}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${visit.result}</span>
                                </div>
                                <p style="color: #666; font-size: 0.9rem;">${visit.note}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <button onclick="addVisitNote(${activityId})" class="btn">â• Yeni Not Ekle</button>
                    <button onclick="closeModal('activityDetailModal')" class="btn" style="background: #6c757d; margin-left: 0.5rem;">Kapat</button>
                </div>
            `;
            
            document.getElementById('activityDetailModal').style.display = 'block';
        }
        
        function completeActivity(activityId) {
            // TamamlandÄ± butonunu gizle ve aksiyon butonlarÄ±nÄ± gÃ¶ster
            event.target.style.display = 'none';
            document.getElementById(`completedActions-${activityId}`).style.display = 'block';
            alert('Aktivite tamamlandÄ±! Sonraki aÅŸamayÄ± seÃ§in.');
        }
        
        function scheduleNextMeeting(activityId) {
            const date = prompt('Randevu tarihi (YYYY-MM-DD):');
            const time = prompt('Randevu saati (HH:MM):');
            if (date && time) {
                alert(`Yeni randevu planlandÄ±: ${date} ${time}`);
                closeModal('activityDetailModal');
            }
        }
        
        function createOrder(activityId) {
            if (confirm('SipariÅŸ sayfasÄ±na yÃ¶nlendirileceksiniz. Devam etmek istiyor musunuz?')) {
                window.location.href = '/order-detail.html';
            }
        }
        
        function scheduleCall(activityId) {
            const date = prompt('Telefon gÃ¶rÃ¼ÅŸmesi tarihi (YYYY-MM-DD):');
            const time = prompt('Telefon gÃ¶rÃ¼ÅŸmesi saati (HH:MM):');
            if (date && time) {
                alert(`Telefon gÃ¶rÃ¼ÅŸmesi planlandÄ±: ${date} ${time}`);
                closeModal('activityDetailModal');
            }
        }
        
        function markAsNotInterested(activityId) {
            if (confirm('MÃ¼ÅŸteri ilgilenmiyor olarak iÅŸaretlenecek. Emin misiniz?')) {
                alert('MÃ¼ÅŸteri ilgilenmiyor olarak iÅŸaretlendi.');
                closeModal('activityDetailModal');
            }
        }
        
        function addVisitNote(activityId) {
            const note = prompt('Yeni gÃ¶rÃ¼ÅŸme notu:');
            if (note) {
                alert('Not eklendi: ' + note);
                // Burada API'ye kaydet
            }
        }

        function addActivity() {
            const date = document.getElementById('activityDate').value;
            const time = document.getElementById('activityTime').value;
            const customer = document.getElementById('activityCustomer').value;
            const note = document.getElementById('activityNote').value;
            
            if (!date || !time || !customer) {
                alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
                return;
            }
            
            alert('Aktivite eklendi! (VeritabanÄ± entegrasyonu yapÄ±lacak)');
            
            // Formu temizle
            document.getElementById('activityTime').value = '';
            document.getElementById('activityCustomer').value = '';
            document.getElementById('activityNote').value = '';
        }

        async function showDeliveryNotes() {
            try {
                const deliveryNotesResponse = await apiCall('/api/delivery-notes');
                const deliveryNotes = deliveryNotesResponse.delivery_notes || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸšš Ä°rsaliye YÃ¶netimi</h2>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" onclick="openDeliveryNoteModal()" style="background: #28a745;">+ Yeni Ä°rsaliye</button>
                            </div>
                        </div>
                        
                        <div id="deliveryNotesContainer">
                            ${deliveryNotes.length > 0 ? `
                                <div style="display: grid; gap: 1rem;">
                                    ${deliveryNotes.map(dn => {
                                        const statusColors = {
                                            'pending': '#ffc107',
                                            'in_transit': '#007bff', 
                                            'delivered': '#28a745',
                                            'cancelled': '#dc3545'
                                        };
                                        const statusNames = {
                                            'pending': 'HazÄ±rlanÄ±yor',
                                            'in_transit': 'Yolda',
                                            'delivered': 'Teslim Edildi',
                                            'cancelled': 'Ä°ptal'
                                        };
                                        const color = statusColors[dn.status] || '#6c757d';
                                        return `
                                            <div class="delivery-note-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white; border-left: 4px solid ${color};">
                                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                                    <div>
                                                        <h4 style="margin-bottom: 0.5rem;">${dn.delivery_number}</h4>
                                                        <p style="margin-bottom: 0.25rem;"><strong>MÃ¼ÅŸteri:</strong> ${dn.customer_name || 'Bilinmiyor'}</p>
                                                        <p style="margin-bottom: 0.25rem;"><strong>Tarih:</strong> ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}</p>
                                                        <p style="margin-bottom: 0.25rem;"><strong>Durum:</strong> <span style="color: ${color}; font-weight: 600;">${statusNames[dn.status] || dn.status}</span></p>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                        <button class="btn" onclick="viewDeliveryNote(${dn.id})" style="background: #007bff; font-size: 0.875rem;">ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le</button>
                                                        ${dn.status === 'pending' ? `<button class="btn" onclick="startDelivery(${dn.id})" style="background: #ffc107; font-size: 0.875rem;">ğŸšš GÃ¶nder</button>` : ''}
                                                        ${dn.status === 'in_transit' ? `<button class="btn" onclick="completeDelivery(${dn.id})" style="background: #28a745; font-size: 0.875rem;">âœ… Teslim Et</button>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p style="text-align: center; color: #666; padding: 2rem;">HenÃ¼z irsaliye kaydÄ± yok.</p>'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Ä°rsaliyeler yÃ¼klenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸšš Ä°rsaliye YÃ¶netimi</h2>
                        <p style="color: #dc3545;">Ä°rsaliyeler yÃ¼klenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function showAppointments() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const appointmentsResponse = await apiCall(`/api/appointments?assigned_to=${currentUser.id}`);
                const appointments = appointmentsResponse.appointments || [];
                
                const today = new Date().toISOString().split('T')[0];
                const todayAppointments = appointments.filter(apt => apt.start_date === today);
                const upcomingAppointments = appointments.filter(apt => apt.start_date > today && apt.status === 'pending').slice(0, 5);
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ“… Randevu & GÃ¶rev YÃ¶netimi</h2>
                        
                        <!-- HÄ±zlÄ± Eylemler -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <button class="btn" onclick="openAppointmentModal()" style="background: #007bff; padding: 1rem;">
                                ğŸ“… Yeni Randevu
                            </button>
                            <button class="btn" onclick="openTaskModal()" style="background: #28a745; padding: 1rem;">
                                âœ… Yeni GÃ¶rev
                            </button>
                            <button class="btn" onclick="openVisitModal()" style="background: #fd7e14; padding: 1rem;">
                                ğŸ¢ Yeni Ziyaret
                            </button>
                        </div>
                        
                        <!-- BugÃ¼nkÃ¼ Aktiviteler -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3>ğŸ“‹ BugÃ¼nkÃ¼ Aktiviteler (${todayAppointments.length})</h3>
                            <div id="todayActivities">
                                ${todayAppointments.length > 0 ? `
                                    <div style="display: grid; gap: 0.75rem;">
                                        ${todayAppointments.map(apt => {
                                            const typeColors = {
                                                'appointment': '#007bff',
                                                'task': '#28a745', 
                                                'visit': '#fd7e14',
                                                'call': '#6f42c1',
                                                'meeting': '#20c997'
                                            };
                                            const color = typeColors[apt.type] || '#6c757d';
                                            return `
                                                <div style="background: white; border-left: 4px solid ${color}; padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${apt.start_time || '09:00'} - ${apt.customer_name || apt.title}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${apt.type}: ${apt.description || apt.title}</div>
                                                        <div style="font-size: 0.75rem; color: #999;">Durum: ${apt.status === 'pending' ? 'Bekliyor' : apt.status === 'completed' ? 'TamamlandÄ±' : apt.status}</div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn" onclick="showAppointmentDetail(${apt.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">ğŸ‘ï¸ Detay</button>
                                                        ${apt.status === 'pending' ? `<button class="btn" onclick="completeActivity('${apt.type}', ${apt.id})" style="background: #28a745; padding: 0.25rem 0.5rem; font-size: 0.75rem;">âœ“ Tamamla</button>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p style="color: #666; text-align: center; padding: 2rem;">BugÃ¼n iÃ§in planlanmÄ±ÅŸ aktivite yok.</p>'}
                            </div>
                        </div>
                        
                        <!-- HaftalÄ±k GÃ¶rÃ¼nÃ¼m -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <!-- YaklaÅŸan Randevular -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #007bff; margin-bottom: 1rem;">ğŸ“… YaklaÅŸan Randevular (${upcomingAppointments.length})</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${upcomingAppointments.length > 0 ? upcomingAppointments.map(apt => {
                                        const date = new Date(apt.start_date);
                                        const dateStr = date.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'short' });
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #007bff;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${dateStr} ${apt.start_time || '09:00'}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${apt.customer_name || apt.title}</div>
                                                        <div style="font-size: 0.75rem; color: #999;">${apt.type} - ${apt.priority}</div>
                                                    </div>
                                                    <button class="btn" onclick="showAppointmentDetail(${apt.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">ğŸ‘ï¸ Detay</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<p style="color: #666; text-align: center; padding: 1rem;">YaklaÅŸan randevu yok.</p>'}
                                </div>
                            </div>
                            
                            <!-- Bekleyen GÃ¶revler -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #28a745; margin-bottom: 1rem;">âœ… Bekleyen GÃ¶revler</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${appointments.filter(apt => apt.type === 'task' && apt.status === 'pending').slice(0, 4).map(task => {
                                        const priorityColors = {
                                            'urgent': '#dc3545',
                                            'high': '#fd7e14', 
                                            'medium': '#ffc107',
                                            'low': '#28a745'
                                        };
                                        const color = priorityColors[task.priority] || '#6c757d';
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${task.title}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${task.customer_name || 'Genel'} - <span style="color: ${color};">${task.priority}</span></div>
                                                        <div style="font-size: 0.75rem; color: #999;">${task.start_date}</div>
                                                    </div>
                                                    <button class="btn" onclick="showAppointmentDetail(${task.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">ğŸ‘ï¸ Detay</button>
                                                    <button class="btn" onclick="completeTask(${task.id})" style="background: #28a745; padding: 0.25rem 0.5rem; font-size: 0.75rem;">âœ“</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<p style="color: #666; text-align: center; padding: 1rem;">Bekleyen gÃ¶rev yok.</p>'}
                                </div>
                            </div>
                            
                            <!-- Son Ziyaretler -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #fd7e14; margin-bottom: 1rem;">ğŸ¢ Son Ziyaretler</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${appointments.filter(apt => apt.type === 'visit' && apt.status === 'completed').slice(0, 4).map(visit => {
                                        const date = new Date(visit.completion_date || visit.start_date);
                                        const dateStr = date.toLocaleDateString('tr-TR');
                                        const resultColors = {
                                            'completed': '#28a745',
                                            'potential': '#ffc107',
                                            'negative': '#dc3545'
                                        };
                                        const color = resultColors.completed;
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                                <div>
                                                    <strong>${visit.customer_name || visit.title}</strong>
                                                    <div style="font-size: 0.875rem; color: #666;">${dateStr} - <span style="color: ${color};">TamamlandÄ±</span></div>
                                                    <div style="font-size: 0.75rem; color: #999;">${visit.completion_notes || visit.description}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<p style="color: #666; text-align: center; padding: 1rem;">Son ziyaret yok.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Randevu sayfasÄ± yÃ¼klenemedi:', error);
            }
        }
        
        async function showAccounting() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ’° Cari Hesap Takibi</h2>
                        <p style="color: #666; margin-bottom: 1.5rem;">MÃ¼ÅŸterilerinizin cari hesap durumlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyebilirsiniz.</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            ${customers.map(customer => `
                                <div class="customer-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                        <div>
                                            <h4 style="margin-bottom: 0.5rem;">${customer.company_name}</h4>
                                            <p style="color: #666; font-size: 0.875rem;">Yetkili: ${customer.contact_person || '-'}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Toplam BorÃ§</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: #dc3545;">${(Math.random() * 50000 + 10000).toFixed(0)} â‚º</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Toplam Alacak</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: #28a745;">${(Math.random() * 30000 + 5000).toFixed(0)} â‚º</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Bakiye</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: ${Math.random() > 0.5 ? '#dc3545' : '#28a745'};">${(Math.random() * 20000 - 10000).toFixed(0)} â‚º</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Vade Durumu</div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: ${Math.random() > 0.7 ? '#dc3545' : '#28a745'};">${Math.random() > 0.7 ? 'Vadesi GeÃ§miÅŸ' : 'Normal'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn" onclick="viewAccountDetail(${customer.id})" style="background: #007bff; font-size: 0.875rem;">ğŸ“Š Detay GÃ¶rÃ¼ntÃ¼le</button>
                                        <button class="btn" onclick="viewAccountHistory(${customer.id})" style="background: #6c757d; font-size: 0.875rem;">ğŸ“‹ Hareket GeÃ§miÅŸi</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Cari hesap sayfasÄ± yÃ¼klenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ’° Cari Hesap</h2>
                        <p style="color: #dc3545;">Cari hesap bilgileri yÃ¼klenemedi.</p>
                    </div>
                `;
            }
        }
        
        function viewAccountDetail(customerId) {
            // MÃ¼ÅŸteri cari hesap detayÄ±nÄ± modal ile gÃ¶ster
            document.getElementById('content').innerHTML += `
                <div id="accountDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeModal('accountDetailModal')">&times;</span>
                        <h3>ğŸ“Š Cari Hesap DetayÄ±</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Toplam SatÄ±ÅŸ</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #007bff;">${(Math.random() * 100000 + 50000).toFixed(0)} â‚º</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Ã–denen Tutar</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #28a745;">${(Math.random() * 80000 + 40000).toFixed(0)} â‚º</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Kalan BorÃ§</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #dc3545;">${(Math.random() * 20000 + 10000).toFixed(0)} â‚º</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Ortalama Vade</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #6c757d;">${Math.floor(Math.random() * 30 + 15)} gÃ¼n</div>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                            <h4>Son Hareketler</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Tarih</th>
                                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Ä°ÅŸlem</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">BorÃ§</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">Alacak</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">Bakiye</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Array.from({length: 10}, (_, i) => {
                                            const isDebit = Math.random() > 0.5;
                                            const amount = (Math.random() * 5000 + 1000).toFixed(0);
                                            const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toLocaleDateString('tr-TR');
                                            return `
                                                <tr>
                                                    <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9;">${date}</td>
                                                    <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9;">${isDebit ? 'SatÄ±ÅŸ FaturasÄ±' : 'Tahsilat'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; color: #dc3545;">${isDebit ? amount + ' â‚º' : '-'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; color: #28a745;">${!isDebit ? amount + ' â‚º' : '-'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; font-weight: 600;">${(Math.random() * 20000 - 10000).toFixed(0)} â‚º</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1rem;">
                            <button onclick="closeModal('accountDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function viewAccountHistory(customerId) {
            alert('Hareket geÃ§miÅŸi gÃ¶rÃ¼ntÃ¼leme Ã¶zelliÄŸi yakÄ±nda eklenecek.');
        }
        
        function showNewVisit() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    loadNearbyBusinesses(lat, lng);
                }, function(error) {
                    alert('Konum bilgisi alÄ±namadÄ±. LÃ¼tfen konum izni verin.');
                    loadNearbyBusinesses(41.0082, 28.9784); // Ä°stanbul varsayÄ±lan
                });
            } else {
                alert('TarayÄ±cÄ±nÄ±z konum desteÄŸi saÄŸlamÄ±yor.');
                loadNearbyBusinesses(41.0082, 28.9784);
            }
        }
        
        async function loadNearbyBusinesses(lat, lng) {
            let nearbyBusinesses = [];
            
            try {
                const radius = 1000;
                const query = `[out:json][timeout:25];(node["amenity"~"^(restaurant|cafe|bar|fast_food)$"](around:${radius},${lat},${lng});node["shop"~"^(bakery|convenience)$"](around:${radius},${lat},${lng});node["tourism"~"^(hotel)$"](around:${radius},${lat},${lng}););out geom;`;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                const data = await response.json();
                nearbyBusinesses = data.elements.map((element, index) => {
                    const distance = calculateDistance(lat, lng, element.lat, element.lon);
                    const name = element.tags.name || `Ä°ÅŸletme ${index + 1}`;
                    const type = getBusinessType(element.tags);
                    const address = formatAddress(element.tags);
                    
                    return {
                        id: element.id,
                        name: name,
                        type: type,
                        address: address,
                        distance: `${Math.round(distance)}m`,
                        lat: element.lat,
                        lng: element.lon
                    };
                }).sort((a, b) => parseInt(a.distance) - parseInt(b.distance)).slice(0, 15);
            } catch (error) {
                console.error('API hatasÄ±:', error);
            }
            
            if (nearbyBusinesses.length === 0) {
                nearbyBusinesses = [
                    { id: 'f1', name: 'Yerel Restaurant', type: 'Restaurant', address: 'Mevcut konum yakÄ±nÄ±', distance: '100m', lat: lat + 0.001, lng: lng + 0.001 },
                    { id: 'f2', name: 'Mahalle Kahvesi', type: 'Cafe', address: 'Mevcut konum yakÄ±nÄ±', distance: '200m', lat: lat - 0.001, lng: lng + 0.001 }
                ];
            }
            
            // Global array'i gÃ¼ncelle
            currentBusinesses = nearbyBusinesses;
            
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2>ğŸ†• Yeni Ziyaret - YakÄ±ndaki Ä°ÅŸletmeler</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">Mevcut konumunuza yakÄ±n iÅŸletmeleri seÃ§erek yeni mÃ¼ÅŸteri kaydÄ± oluÅŸturabilirsiniz.</p>
                    
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">ğŸ“</span>
                        <span>Konum: ${lat.toFixed(4)}, ${lng.toFixed(4)} - ${nearbyBusinesses.length} iÅŸletme bulundu</span>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${nearbyBusinesses.map((business, index) => {
                            const cleanName = String(business.name).replace(/'/g, '&#39;');
                            const cleanAddress = String(business.address).replace(/'/g, '&#39;');
                            const cleanType = String(business.type).replace(/'/g, '&#39;');
                            
                            return `
                                <div class="business-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;" 
                                     data-business-id="${business.id}" data-index="${index}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin-bottom: 0.5rem; color: #2d3748;">${cleanName}</h4>
                                            <p style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">ğŸ¢ ${cleanType}</p>
                                            <p style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">ğŸ“ ${cleanAddress}</p>
                                            <p style="color: #007bff; font-size: 0.875rem; font-weight: 600;">ğŸš¶ ${business.distance}</p>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            <button class="btn visit-btn" data-index="${index}" style="background: #28a745; padding: 0.5rem 1rem; font-size: 0.875rem;">ğŸ‘¥ Ziyaret Et</button>
                                            <button class="btn map-btn" data-lat="${business.lat}" data-lng="${business.lng}" style="background: #6c757d; padding: 0.25rem 0.5rem; font-size: 0.75rem;">ğŸ—ºï¸ Harita</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 1rem;">Listede olmayan bir iÅŸletme mi ziyaret edeceksiniz?</p>
                        <button class="btn" onclick="openManualBusinessEntry(${lat}, ${lng})" style="background: #fd7e14;">â• Manuel Ä°ÅŸletme Ekle</button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                setupBusinessEventListeners();
            }, 100);
        }
        
        function selectBusiness(id, name, type, address, lat, lng) {
            const cleanName = String(name).replace(/'/g, '');
            const cleanAddress = String(address).replace(/'/g, '');
            
            document.getElementById('map_company_name').value = cleanName;
            document.getElementById('map_address').value = cleanAddress;
            document.getElementById('map_lat').value = lat;
            document.getElementById('map_lng').value = lng;
            document.getElementById('newCustomerFromMapModal').style.display = 'block';
        }
        
        function viewOnMap(lat, lng) {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        }
        
        function setupBusinessEventListeners() {
            document.querySelectorAll('.visit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    const business = currentBusinesses[index];
                    if (business) {
                        selectBusiness(business.id, business.name, business.type, business.address, business.lat, business.lng);
                    }
                });
            });
            
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    viewOnMap(lat, lng);
                });
            });
        }
        
        function openManualBusinessEntry(lat, lng) {
            // Konum bilgisini URL parametresi olarak ekleyerek yeni mÃ¼ÅŸteri sayfasÄ±na yÃ¶nlendir.
            const locationParam = (lat && lng) ? `?lat=${lat}&lng=${lng}` : '';
            window.location.href = `/new-customer.html${locationParam}`;
        }
        
        document.getElementById('visit_result').addEventListener('change', function() {
            const result = this.value;
            const nextActionSection = document.getElementById('nextActionSection');
            
            if (result === 'potential') {
                nextActionSection.style.display = 'block';
            } else {
                nextActionSection.style.display = 'none';
            }
        });
        
        document.getElementById('next_action').addEventListener('change', function() {
            const action = this.value;
            const dateSection = document.getElementById('nextDateSection');
            const timeSection = document.getElementById('nextTimeSection');
            
            if (action) {
                dateSection.style.display = 'block';
                timeSection.style.display = 'block';
            } else {
                dateSection.style.display = 'none';
                timeSection.style.display = 'none';
            }
        });
        
        document.getElementById('newCustomerFromMapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerFormData = {
                company_name: document.getElementById('map_company_name').value,
                contact_person: document.getElementById('map_contact_person').value,
                phone: document.getElementById('map_phone').value,
                mobile_phone: document.getElementById('map_mobile_phone').value,
                email: document.getElementById('map_email').value,
                address: document.getElementById('map_address').value,
                assigned_sales_rep: currentUser.id,
                latitude: document.getElementById('map_lat').value,
                longitude: document.getElementById('map_lng').value
            };
            
            const visitFormData = {
                visit_note: document.getElementById('visit_note').value,
                visit_result: document.getElementById('visit_result').value,
                next_action: document.getElementById('next_action').value,
                next_date: document.getElementById('next_date').value,
                next_time: document.getElementById('next_time').value
            };

            try {
                // MÃ¼ÅŸteriyi oluÅŸtur
                const newCustomerResponse = await apiCall('/api/customers', {
                    method: 'POST',
                    body: JSON.stringify(customerFormData)
                });
                const newCustomer = newCustomerResponse.customer;

                // Ziyaret kaydÄ±nÄ± oluÅŸtur
                await apiCall('/api/visits', {
                    method: 'POST',
                    body: JSON.stringify({
                        customer_id: newCustomer.id,
                        visit_type: 'visit',
                        result: visitFormData.visit_result,
                        notes: visitFormData.visit_note,
                        visit_date: new Date().toISOString()
                    })
                });

                // Ziyaret sonucuna gÃ¶re sonraki adÄ±mÄ± belirle
                switch (visitFormData.visit_result) {
                    case 'positive': // SatÄ±ÅŸ YapÄ±ldÄ±
                        closeModal('newCustomerFromMapModal');
                        openOrderModal({ id: newCustomer.id, name: newCustomer.company_name });
                        break;
                    case 'potential': // Takip Gerekli
                        alert(`MÃ¼ÅŸteri '${newCustomer.company_name}' potansiyel olarak kaydedildi.`);
                        if (visitFormData.next_action && visitFormData.next_date) {
                            try {
                                await apiCall('/api/appointments', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        title: `${visitFormData.next_action} - ${newCustomer.company_name}`,
                                        description: `Yeni mÃ¼ÅŸteri ziyareti sonrasÄ± takip.`,
                                        type: visitFormData.next_action,
                                        priority: 'medium',
                                        start_date: visitFormData.next_date,
                                        start_time: visitFormData.next_time || null,
                                        assigned_to: currentUser.id,
                                        customer_id: newCustomer.id
                                    })
                                });
                                alert('Takip randevusu baÅŸarÄ±yla oluÅŸturuldu!');
                            } catch (error) {
                                alert('Takip randevusu oluÅŸturulurken hata oluÅŸtu: ' + error.message);
                            }
                        }
                        closeModal('newCustomerFromMapModal');
                        showDashboard(); // Dashboard'a dÃ¶n
                        break;
                    case 'negative': // Ä°lgilenmiyor
                    default:
                        alert(`MÃ¼ÅŸteri '${newCustomer.company_name}' ilgilenmiyor olarak kaydedildi.`);
                        closeModal('newCustomerFromMapModal');
                        showNewVisit(); // Listeyi yenile
                        break;
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;
            
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function getBusinessType(tags) {
            if (tags.amenity) {
                const types = {
                    'restaurant': 'Restaurant',
                    'cafe': 'Cafe',
                    'bar': 'Bar',
                    'fast_food': 'Fast Food'
                };
                return types[tags.amenity] || 'Restaurant';
            }
            if (tags.shop) {
                const types = {
                    'bakery': 'FÄ±rÄ±n',
                    'convenience': 'Market'
                };
                return types[tags.shop] || 'MaÄŸaza';
            }
            if (tags.tourism === 'hotel') return 'Otel';
            return 'Ä°ÅŸletme';
        }
        
        function formatAddress(tags) {
            const parts = [];
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:housenumber']) parts.push('No:' + tags['addr:housenumber']);
            if (tags['addr:neighbourhood']) parts.push(tags['addr:neighbourhood']);
            
            return parts.length > 0 ? parts.join(' ') : 'Adres bilgisi yok';
        }
        
        function completeAppointment(id) {
            if (confirm('Randevu tamamlandÄ± olarak iÅŸaretlensin mi?')) {
                alert('Randevu tamamlandÄ±!');
                showDashboard();
            }
        }

        // MÃ¼ÅŸteri yÃ¶netimi fonksiyonlarÄ±
        function openCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'Yeni MÃ¼ÅŸteri';
            document.getElementById('customerSubmitBtn').textContent = 'Kaydet';
            document.getElementById('customerForm').reset();
            document.getElementById('customer_edit_id').value = '';
            document.getElementById('customerModal').style.display = 'block';
        }

        async function editCustomer(customerId) {
            try {
                const customer = await apiCall(`/api/customers/${customerId}`);
                
                document.getElementById('customerModalTitle').textContent = 'MÃ¼ÅŸteri DÃ¼zenle';
                document.getElementById('customerSubmitBtn').textContent = 'GÃ¼ncelle';
                document.getElementById('customer_edit_id').value = customerId;
                document.getElementById('company_name').value = customer.customer.company_name || '';
                document.getElementById('contact_person').value = customer.customer.contact_person || '';
                document.getElementById('customer_phone').value = customer.customer.phone || '';
                document.getElementById('customer_mobile_phone').value = customer.customer.mobile_phone || '';
                document.getElementById('customer_email').value = customer.customer.email || '';
                document.getElementById('customer_address').value = customer.customer.address || '';
                
                document.getElementById('customerModal').style.display = 'block';
            } catch (error) {
                alert('MÃ¼ÅŸteri bilgileri yÃ¼klenemedi: ' + error.message);
            }
        }

        async function openDeliveryNoteModal() {
            try {
                const numberResponse = await apiCall('/api/delivery-notes/generate-number');
                document.getElementById('delivery_number').value = numberResponse.delivery_number;
                
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('delivery_customer_id');
                customerSelect.innerHTML = '<option value="">MÃ¼ÅŸteri SeÃ§iniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('delivery_date').value = new Date().toISOString().split('T')[0];
                document.getElementById('delivery_time').value = '14:00';
                document.getElementById('deliveryNoteModal').style.display = 'block';
            } catch (error) {
                alert('Modal aÃ§Ä±lamadÄ±: ' + error.message);
            }
        }
        
        document.getElementById('deliveryNoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                delivery_number: document.getElementById('delivery_number').value,
                customer_id: document.getElementById('delivery_customer_id').value,
                delivery_date: document.getElementById('dn_delivery_date').value,
                delivery_time: document.getElementById('delivery_time').value || null,
                delivery_address: document.getElementById('delivery_address').value,
                notes: document.getElementById('delivery_notes').value
            };
            
            try {
                await apiCall('/api/delivery-notes', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                alert('Ä°rsaliye oluÅŸturuldu!');
                document.getElementById('deliveryNoteForm').reset();
                closeModal('deliveryNoteModal');
                showDeliveryNotes();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        async function viewDeliveryNote(id) {
            try {
                const response = await apiCall(`/api/delivery-notes/${id}`);
                const dn = response.delivery_note;
                
                const statusNames = {
                    'pending': 'HazÄ±rlanÄ±yor',
                    'in_transit': 'Yolda', 
                    'delivered': 'Teslim Edildi'
                };
                
                document.getElementById('deliveryDetailContent').innerHTML = `
                    <h3>ğŸšš Ä°rsaliye DetayÄ±</h3>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div><strong>Ä°rsaliye No:</strong> ${dn.delivery_number}</div>
                            <div><strong>Durum:</strong> ${statusNames[dn.status] || dn.status}</div>
                            <div><strong>MÃ¼ÅŸteri:</strong> ${dn.customer_name || 'Bilinmiyor'}</div>
                            <div><strong>Tarih:</strong> ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}</div>
                        </div>
                        ${dn.notes ? `<div style="margin-top: 1rem;"><strong>Notlar:</strong><br>${dn.notes}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
                        ${dn.status === 'pending' ? `<button onclick="startDelivery(${dn.id})" class="btn" style="background: #ffc107;">ğŸšš GÃ¶nder</button>` : ''}
                        ${dn.status === 'in_transit' ? `<button onclick="completeDelivery(${dn.id})" class="btn" style="background: #28a745;">âœ… Teslim Et</button>` : ''}
                    </div>
                    <div style="text-align: center;">
                        <button onclick="closeModal('deliveryDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                    </div>
                `;
                
                document.getElementById('deliveryDetailModal').style.display = 'block';
            } catch (error) {
                alert('Detay yÃ¼klenemedi: ' + error.message);
            }
        }
        
        async function startDelivery(id) {
            if (confirm('Ä°rsaliye gÃ¶nderiye baÅŸlatÄ±lsÄ±n mÄ±?')) {
                try {
                    await apiCall(`/api/delivery-notes/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'in_transit' })
                    });
                    alert('Ä°rsaliye yola Ã§Ä±ktÄ±!');
                    closeModal('deliveryDetailModal');
                    showDeliveryNotes();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function completeDelivery(id) {
            const customerName = prompt('Teslim alan kiÅŸinin adÄ±:');
            if (customerName) {
                try {
                    await apiCall(`/api/delivery-notes/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            status: 'delivered',
                            customer_name: customerName,
                            signature_date: new Date().toISOString()
                        })
                    });
                    alert('Ä°rsaliye teslim edildi! Muhasebe departmanÄ±na faturalaÅŸma iÃ§in gÃ¶nderildi.');
                    closeModal('deliveryDetailModal');
                    showDeliveryNotes();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function showInvoices() {
            try {
                const invoicesResponse = await apiCall('/api/invoices');
                const invoices = invoicesResponse.invoices || [];
                
                const userRole = currentUser.role || 'employee';
                const isAccounting = userRole === 'accounting' || userRole === 'admin';
                const isSales = userRole === 'sales';
                
                if (isSales) {
                    // SatÄ±ÅŸ temsilcisi sadece cari hesap gÃ¶rebilir
                    showAccounting();
                    return;
                }
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ§¾ Fatura YÃ¶netimi</h2>
                        
                        ${isAccounting ? `
                            <div style="margin-bottom: 1.5rem;">
                                <button class="btn" onclick="showPendingDeliveries()" style="background: #28a745;">ğŸ“‹ FaturalaÅŸacak Ä°rsaliyeler</button>
                            </div>
                        ` : `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                                <strong>âš ï¸ Yetki KÄ±sÄ±tlamasÄ±:</strong> SatÄ±ÅŸ temsilcileri sadece cari hesap bilgilerini gÃ¶rebilir.
                            </div>
                        `}
                        
                        <div style="display: grid; gap: 1rem;">
                            ${invoices.map(invoice => {
                                const statusColors = {
                                    'draft': '#6c757d',
                                    'sent': '#007bff',
                                    'paid': '#28a745', 
                                    'overdue': '#dc3545'
                                };
                                const statusNames = {
                                    'draft': 'Taslak',
                                    'sent': 'GÃ¶nderildi',
                                    'paid': 'Ã–dendi',
                                    'overdue': 'Vadesi GeÃ§miÅŸ'
                                };
                                return `
                                    <div style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; border-left: 4px solid ${statusColors[invoice.status]};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <h4>${invoice.invoice_number}</h4>
                                                <p><strong>MÃ¼ÅŸteri:</strong> ${invoice.customer_name}</p>
                                                <p><strong>Tutar:</strong> ${invoice.total_amount} TL</p>
                                                <p><strong>Durum:</strong> <span style="color: ${statusColors[invoice.status]};">${statusNames[invoice.status]}</span></p>
                                            </div>
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                <button class="btn" onclick="viewInvoice(${invoice.id})" style="background: #007bff;">ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le</button>
                                                ${isAccounting && invoice.status === 'sent' ? `<button class="btn" onclick="markAsPaid(${invoice.id})" style="background: #28a745;">ğŸ’° Ã–dendi</button>` : ''}
                                                ${isAccounting ? `<button class="btn" onclick="deleteInvoice(${invoice.id})" style="background: #dc3545;">ğŸ—‘ï¸ Sil</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Faturalar yÃ¼klenemedi:', error);
            }
        }
        
        async function showPendingDeliveries() {
            try {
                const response = await apiCall('/api/delivery-notes?status=delivered');
                const deliveries = response.delivery_notes || [];
                
                // MÃ¼ÅŸteriye gÃ¶re grupla
                const groupedByCustomer = deliveries.reduce((acc, delivery) => {
                    const key = delivery.customer_id;
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(delivery);
                    return acc;
                }, {});
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ“‹ FaturalaÅŸacak Ä°rsaliyeler</h2>
                        <div style="margin-bottom: 1rem;">
                            <button class="btn" onclick="showInvoices()" style="background: #6c757d;">ğŸ”™ Faturalara DÃ¶n</button>
                            <button class="btn" onclick="createBulkInvoice()" style="background: #28a745; margin-left: 0.5rem;" id="bulkInvoiceBtn" disabled>ğŸ§¾ SeÃ§ili Ä°rsaliyeleri FaturalaÅŸtÄ±r (<span id="selectedCount">0</span>)</button>
                        </div>
                        
                        ${Object.entries(groupedByCustomer).map(([customerId, customerDeliveries]) => `
                            <div style="margin-bottom: 2rem; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                                <h4 style="margin-bottom: 1rem; color: #007bff;">${customerDeliveries[0].customer_name} (${customerDeliveries.length} Ä°rsaliye)</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${customerDeliveries.map(delivery => `
                                        <div style="padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="checkbox" id="delivery_${delivery.id}" onchange="toggleDeliverySelection(${delivery.id}, '${delivery.customer_name}')">
                                                <div>
                                                    <strong>${delivery.delivery_number}</strong>
                                                    <div style="font-size: 0.875rem; color: #666;">Teslim: ${new Date(delivery.delivery_date).toLocaleDateString('tr-TR')}</div>
                                                </div>
                                            </div>
                                            <button class="btn" onclick="createSingleInvoice(${delivery.id})" style="background: #007bff; font-size: 0.75rem;">ğŸ§¾ Tekil Fatura</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div style="margin-top: 0.5rem; text-align: right;">
                                    <button class="btn" onclick="selectAllCustomerDeliveries(${customerId})" style="background: #6c757d; font-size: 0.75rem;">âœ“ TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                selectedDeliveries = [];
                updateBulkButton();
            } catch (error) {
                alert('Ä°rsaliyeler yÃ¼klenemedi: ' + error.message);
            }
        }
        
        function toggleDeliverySelection(deliveryId, customerName) {
            const checkbox = document.getElementById(`delivery_${deliveryId}`);
            if (checkbox.checked) {
                selectedDeliveries.push({ id: deliveryId, customer: customerName });
            } else {
                selectedDeliveries = selectedDeliveries.filter(d => d.id !== deliveryId);
            }
            updateBulkButton();
        }
        
        function selectAllCustomerDeliveries(customerId) {
            const checkboxes = document.querySelectorAll(`input[id^="delivery_"]`);
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.click();
                }
            });
        }
        
        function updateBulkButton() {
            const btn = document.getElementById('bulkInvoiceBtn');
            const count = document.getElementById('selectedCount');
            if (btn && count) {
                count.textContent = selectedDeliveries.length;
                btn.disabled = selectedDeliveries.length === 0;
            }
        }
        
        async function createBulkInvoice() {
            if (selectedDeliveries.length === 0) {
                alert('LÃ¼tfen en az bir irsaliye seÃ§in!');
                return;
            }
            
            // AynÄ± mÃ¼ÅŸteri kontrolÃ¼
            const customers = [...new Set(selectedDeliveries.map(d => d.customer))];
            if (customers.length > 1) {
                alert('FarklÄ± mÃ¼ÅŸterilerin irsaliyeleri birleÅŸtirilemez!');
                return;
            }
            
            if (confirm(`${selectedDeliveries.length} irsaliye iÃ§in birleÅŸik fatura oluÅŸturulsun mu?`)) {
                try {
                    const response = await apiCall('/api/invoices/bulk-from-deliveries', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            delivery_note_ids: selectedDeliveries.map(d => d.id)
                        })
                    });
                    
                    alert(`BirleÅŸik fatura oluÅŸturuldu! Fatura No: ${response.invoice.invoice_number}`);
                    showInvoices();
                } catch (error) {
                    alert('Fatura oluÅŸturma hatasÄ±: ' + error.message);
                }
            }
        }
        
        function createSingleInvoice(deliveryId) {
            createInvoiceFromDelivery(deliveryId);
        }
        
        async function createInvoiceFromDelivery(deliveryId) {
            if (confirm('Bu irsaliye iÃ§in fatura oluÅŸturulsun mu?')) {
                try {
                    const response = await apiCall('/api/invoices/from-delivery', {
                        method: 'POST',
                        body: JSON.stringify({ delivery_note_id: deliveryId })
                    });
                    
                    alert(`Fatura oluÅŸturuldu! Fatura No: ${response.invoice.invoice_number}`);
                    showInvoices();
                } catch (error) {
                    alert('Fatura oluÅŸturma hatasÄ±: ' + error.message);
                }
            }
        }
        
        async function markAsPaid(invoiceId) {
            const amount = prompt('Ã–denen tutar:');
            if (amount) {
                try {
                    await apiCall(`/api/invoices/${invoiceId}/payment`, {
                        method: 'POST',
                        body: JSON.stringify({ amount: parseFloat(amount) })
                    });
                    
                    alert('Ã–deme kaydedildi!');
                    showInvoices();
                } catch (error) {
                    alert('Ã–deme kaydetme hatasÄ±: ' + error.message);
                }
            }
        }
        
        async function deleteInvoice(invoiceId) {
            if (confirm('FaturayÄ± silmek istediÄŸinizden emin misiniz?')) {
                try {
                    await apiCall(`/api/invoices/${invoiceId}`, { method: 'DELETE' });
                    alert('Fatura silindi!');
                    showInvoices();
                } catch (error) {
                    alert('Silme hatasÄ±: ' + error.message);
                }
            }
        }
        
        function viewInvoice(invoiceId) {
            alert(`Fatura detayÄ±: ${invoiceId}`);
        }
        
        async function viewOrderDetail(orderId) {
            try {
                const orderResponse = await apiCall(`/api/orders/${orderId}`);
                const order = orderResponse.order || orderResponse;
                
                const itemsResponse = await apiCall(`/api/orders/${orderId}/items`);
                const items = itemsResponse.items || [];
                
                // ÃœrÃ¼n bilgilerini kontrol et ve dÃ¼zelt
                console.log('SipariÅŸ kalemleri RAW:', JSON.stringify(items, null, 2));
                
                const itemsWithProducts = items.map((item, index) => {
                    console.log(`Kalem ${index + 1}:`, {
                        product_name: item.product_name,
                        name: item.name,
                        product_id: item.product_id,
                        unit: item.unit
                    });
                    
                    // ÃœrÃ¼n adÄ±nÄ± Ã¶ncelik sÄ±rasÄ±na gÃ¶re al
                    let productName = item.product_name || item.name || 'Bilinmeyen ÃœrÃ¼n';
                    
                    // EÄŸer Ã¼rÃ¼n adÄ± boÅŸ veya geÃ§ersizse, product_id'den Ã§ekmeye Ã§alÄ±ÅŸ
                    if (!productName || productName === 'Bilinmeyen ÃœrÃ¼n') {
                        productName = `ÃœrÃ¼n ID: ${item.product_id || 'Bilinmiyor'}`;
                    }
                    
                    return {
                        ...item,
                        product_name: productName,
                        product_description: item.product_description || item.description || '',
                        product_unit: item.unit || item.product_unit || 'adet'
                    };
                });
                
                console.log('DÃ¼zeltilmiÅŸ Ã¼rÃ¼n bilgileri:', itemsWithProducts.map(i => ({ product_name: i.product_name, unit: i.product_unit })));
                
                // KullanÄ±cÄ± rolÃ¼ne gÃ¶re yetki kontrolÃ¼
                const userRole = currentUser.role || 'employee';
                const canEditPrice = ['admin', 'sales', 'manager'].includes(userRole);
                const canEditQuantity = ['admin', 'sales', 'manager', 'production'].includes(userRole);
                const canComplete = userRole === 'production';
                
                // Tarih formatlamasÄ± - null/undefined kontrolÃ¼
                const formatDate = (dateStr) => {
                    if (!dateStr || dateStr === '1970-01-01' || new Date(dateStr).getFullYear() < 2020) {
                        return 'BelirtilmemiÅŸ';
                    }
                    return new Date(dateStr).toLocaleDateString('tr-TR');
                };
                
                const deliveryDateValue = order.delivery_date && order.delivery_date !== '1970-01-01' ? order.delivery_date.split('T')[0] : '';
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>ğŸ“‹ SipariÅŸ DetayÄ± - #${order.order_number}</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h4>SipariÅŸ Bilgileri</h4>
                                <p><strong>MÃ¼ÅŸteri:</strong> ${order.company_name || order.customer_name || 'Bilinmiyor'}</p>
                                <p><strong>Tarih:</strong> ${formatDate(order.order_date)}</p>
                                <p><strong>Teslimat:</strong> 
                                    ${canEditPrice ? `<input type="date" id="delivery_date" value="${deliveryDateValue}" style="border: 1px solid #ddd; padding: 0.25rem;">` : formatDate(order.delivery_date)}
                                </p>
                                <p><strong>Durum:</strong> ${getOrderStatusText(order.status)}</p>
                                ${canEditPrice ? `<p><strong>Toplam:</strong> ${parseFloat(order.total_amount || 0).toFixed(2)} TL</p>` : ''}
                            </div>
                            <div>
                                <h4>Ä°ÅŸlemler</h4>
                                ${canEditPrice ? `<button class="btn" onclick="updateOrder(${orderId})" style="background: #007bff; margin: 0.25rem;">ğŸ’¾ GÃ¼ncelle</button>` : ''}
                                ${canEditPrice ? `<button class="btn" onclick="cancelOrder(${orderId})" style="background: #dc3545; margin: 0.25rem;">âŒ Ä°ptal Et</button>` : ''}
                                ${canComplete && order.status === 'production' ? `<button class="btn" onclick="completeProduction(${orderId})" style="background: #28a745; margin: 0.25rem;">âœ… Ãœretim Tamamla</button>` : ''}
                                <button class="btn" onclick="showOrders()" style="background: #6c757d; margin: 0.25rem;">ğŸ”™ Geri</button>
                            </div>
                        </div>
                        
                        <h4>SipariÅŸ Kalemleri</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÃœrÃ¼n</th>
                                    <th>Miktar</th>
                                    ${canEditPrice ? '<th>Birim Fiyat</th>' : ''}
                                    ${canEditPrice ? '<th>Toplam</th>' : ''}
                                    ${canEditQuantity ? '<th>Ä°ÅŸlem</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsWithProducts.map(item => `
                                    <tr>
                                        <td>
                                            <strong>${item.product_name}</strong>
                                            ${item.product_description ? `<div style="font-size: 0.875rem; color: #666;">${item.product_description}</div>` : ''}
                                            <div style="font-size: 0.75rem; color: #999;">Birim: ${item.product_unit || 'adet'}</div>
                                        </td>
                                        <td>${canEditQuantity ? `<input type="number" id="qty_${item.id}" value="${item.quantity}" min="1" style="width: 80px; border: 1px solid #ddd; padding: 0.25rem;">` : `${item.quantity} ${item.product_unit || 'adet'}`}</td>
                                        ${canEditPrice ? `<td>${parseFloat(item.unit_price || 0).toFixed(2)} TL</td>` : ''}
                                        ${canEditPrice ? `<td>${((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)} TL</td>` : ''}
                                        ${canEditQuantity ? `<td><button class="btn" onclick="updateItem(${item.id})" style="background: #ffc107; padding: 0.25rem 0.5rem; font-size: 0.75rem;">GÃ¼ncelle</button></td>` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        ${order.notes ? `<div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;"><strong>Notlar:</strong><br>${order.notes}</div>` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('SipariÅŸ detayÄ± yÃ¼klenemedi:', error);
                alert('SipariÅŸ detayÄ± yÃ¼klenemedi: ' + error.message);
            }
        }
        
        async function updateOrder(orderId) {
            const deliveryDate = document.getElementById('delivery_date').value;
            try {
                await apiCall(`/api/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ delivery_date: deliveryDate })
                });
                alert('SipariÅŸ gÃ¼ncellendi!');
                viewOrderDetail(orderId);
            } catch (error) {
                alert('GÃ¼ncelleme hatasÄ±: ' + error.message);
            }
        }
        
        async function cancelOrder(orderId) {
            if (confirm('SipariÅŸi iptal etmek istediÄŸinizden emin misiniz?')) {
                try {
                    await apiCall(`/api/orders/${orderId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'cancelled' })
                    });
                    alert('SipariÅŸ iptal edildi!');
                    showOrders();
                } catch (error) {
                    alert('Ä°ptal hatasÄ±: ' + error.message);
                }
            }
        }
        
        async function completeProduction(orderId) {
            if (confirm('Ãœretim tamamlandÄ± olarak iÅŸaretlensin ve irsaliyeye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lsÃ¼n mÃ¼?')) {
                try {
                    await apiCall(`/api/orders/${orderId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'completed' })
                    });
                    
                    // Ä°rsaliye oluÅŸtur
                    const deliveryNumber = 'IRS' + Date.now().toString().slice(-6);
                    await apiCall('/api/delivery-notes', {
                        method: 'POST',
                        body: JSON.stringify({
                            delivery_number: deliveryNumber,
                            order_id: orderId,
                            delivery_date: new Date().toISOString().split('T')[0],
                            status: 'pending'
                        })
                    });
                    
                    alert('Ãœretim tamamlandÄ± ve irsaliye oluÅŸturuldu!');
                    showOrders();
                } catch (error) {
                    alert('Tamamlama hatasÄ±: ' + error.message);
                }
            }
        }
        
        async function updateItem(itemId) {
            const newQty = document.getElementById(`qty_${itemId}`).value;
            try {
                await apiCall(`/api/order-items/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ quantity: parseInt(newQty) })
                });
                alert('Miktar gÃ¼ncellendi!');
                location.reload();
            } catch (error) {
                alert('GÃ¼ncelleme hatasÄ±: ' + error.message);
            }
        }
        
        function getOrderStatusText(status) {
            const statusMap = {
                'pending': 'Bekliyor',
                'confirmed': 'OnaylandÄ±',
                'production': 'Ãœretimde',
                'completed': 'TamamlandÄ±',
                'ready_for_delivery': 'Teslimat HazÄ±r',
                'delivered': 'Teslim Edildi',
                'cancelled': 'Ä°ptal Edildi'
            };
            return statusMap[status] || status;
        }

        function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('token'); // Eski anahtarlarÄ± da temizle
                localStorage.removeItem('user');   // Eski anahtarlarÄ± da temizle
                window.location.href = '/';
            }
        }

       function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const toggleBtn = document.querySelector('.mobile-menu-toggle');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            if (toggleBtn) {
                toggleBtn.classList.toggle('active');
                toggleBtn.innerHTML = toggleBtn.classList.contains('active') ? '&times;' : 'â˜°';
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const toggleBtn = document.querySelector('.mobile-menu-toggle');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            if (toggleBtn) {
                toggleBtn.classList.remove('active');
                toggleBtn.innerHTML = 'â˜°';
            }
        }
        
        // MenÃ¼ linklerine tÄ±klandÄ±ÄŸÄ±nda mobil menÃ¼yÃ¼ kapat
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', closeMobileMenu);
        });
        
        showDashboard();
        
        setTimeout(() => {
            updateDateTime();
            setupMenuVisibility();
        }, 100);
        
        setInterval(() => {
            // Bu fonksiyon artÄ±k yok: updateUserInfo();
            updateDateTime();
        }, 60000);
    </script>
    <script>
        async function saveAppointment() {
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const type = document.getElementById('appointmentType').value;
            const note = document.getElementById('appointmentNote').value;
            
            if (!date || !time) {
                alert('LÃ¼tfen tarih ve saat seÃ§in!');
                return;
            }
            
            try {
                if (window.isRescheduleMode && window.rescheduleAppointmentId) {
                    const response = await apiCall(`/api/appointments/${window.rescheduleAppointmentId}`);
                    const apt = response.appointment;
                    
                    await apiCall(`/api/appointments/${window.rescheduleAppointmentId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...apt,
                            start_date: date,
                            start_time: time,
                            description: note
                        })
                    });
                    
                    alert('Randevu yeniden planlandÄ±!');
                    window.isRescheduleMode = false;
                    window.rescheduleAppointmentId = null;
                } else if (window.isFollowUpMode && window.followUpCustomerId) {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: `Takip Randevusu - ${window.followUpCustomerName}`,
                            description: note,
                            type: type,
                            priority: 'medium',
                            start_date: date,
                            start_time: time,
                            assigned_to: currentUser.id,
                            customer_id: window.followUpCustomerId,
                            location: window.followUpCustomerName
                        })
                    });
                    
                    alert('Takip randevusu oluÅŸturuldu!');
                    window.isFollowUpMode = false;
                    window.followUpCustomerId = null;
                    window.followUpCustomerName = null;
                } else {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: `${type} - ${note || 'Randevu'}`,
                            description: note,
                            type: type,
                            priority: 'medium',
                            start_date: date,
                            start_time: time,
                            assigned_to: currentUser.id
                        })
                    });
                    
                    alert('Randevu baÅŸarÄ±yla kaydedildi!');
                }
                
                closeModal('appointmentModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
    </script>
    

</body>
</html>