<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#28a745">
    <title>Satış Paneli - Saha CRM</title>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/mobile.css">

</head>
<body>


    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: white; font-weight: 600; margin-bottom: 0.5rem;">Saha CRM</h2>
                <p style="color: rgba(255,255,255,0.7); font-size: 0.875rem;">Satış Paneli</p>
            </div>
            
            <h3>Menü</h3>
            <ul style="list-style: none; padding: 0;">
                <li><a href="#" onclick="showDashboard()">📊 Dashboard</a></li>
                <li><a href="#" onclick="showCustomers()">🏢 Müşteriler</a></li>
                <li><a href="#" onclick="showOrders()">📋 Siparişler</a></li>
                <li><a href="#" onclick="showDeliveryNotes()">📋 İrsaliyeler</a></li>
                <li><a href="#" onclick="showAppointments()">📅 Randevu & Görevler</a></li>
                <li><a href="#" onclick="showNewVisit()">🆕 Yeni Ziyaret</a></li>
                <li><a href="#" onclick="showAccounting()">💰 Cari Hesap</a></li>
                <li><a href="/map.html">🗺️ Harita</a></li>
                <li><a href="#" onclick="logout()" style="margin-top: 2rem; color: rgba(255,255,255,0.6);">🚺 Çıkış</a></li>
            </ul>
        </div>

        <div class="content" id="content">
            <div class="card">
                <h2>Satış Dashboard</h2>
                <p>Satış paneline hoş geldiniz!</p>
            </div>
        </div>
    </div>

    <!-- Sipariş Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('orderModal')">&times;</span>
            <h3>Yeni Sipariş</h3>
            <form id="orderForm">
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="order_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Sipariş Tarihi:</label>
                    <input type="date" id="order_date" required>
                </div>
                
                <!-- Ürün Seçimi -->
                <div class="form-group">
                    <label>Ürünler:</label>
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem; background: #f8f9fa;">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                            <div style="flex: 2;">
                                <label>Ürün:</label>
                                <select id="product_select">
                                    <option value="">Ürün Seçiniz</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label>Miktar:</label>
                                <input type="number" id="product_quantity" min="1" value="1">
                            </div>
                            <button type="button" onclick="addProductToOrder()" class="btn" style="background: #28a745;">+ Ekle</button>
                        </div>
                        <div id="selected_products" style="max-height: 200px; overflow-y: auto;">
                            <!-- Seçilen ürünler buraya eklenecek -->
                        </div>
                        <div style="text-align: right; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                            <strong>Toplam: <span id="order_total">0.00</span> TL</strong>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Teslimat Tarihi:</label>
                    <input type="date" id="delivery_date">
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="order_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Sipariş Oluştur</button>
            </form>
        </div>
    </div>

    <!-- Ziyaret Modal -->
    <div id="visitModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('visitModal')">&times;</span>
            <h3>Müşteri Ziyareti</h3>
            <form id="visitForm">
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Ziyaret Tipi:</label>
                    <select id="visit_type" required>
                        <option value="visit">Ziyaret</option>
                        <option value="call">Telefon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Sonuç:</label>
                    <select id="result" required>
                        <option value="sale">Satış Yapıldı</option>
                        <option value="potential">Potansiyel</option>
                        <option value="not_interested">İlgilenmiyor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Sonraki İletişim Tarihi:</label>
                    <input type="date" id="next_contact_date">
                </div>
                <button type="submit" class="btn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Aktivite Detay Modal -->
    <div id="activityDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('activityDetailModal')">&times;</span>
            <div id="activityDetailContent">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Müşteri Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
            <h3 id="customerModalTitle">Yeni Müşteri</h3>
            <form id="customerForm">
                <input type="hidden" id="customer_edit_id">
                <div class="form-group">
                    <label>Firma Adı:</label>
                    <input type="text" id="company_name" required>
                </div>
                <div class="form-group">
                    <label>Yetkili Kişi:</label>
                    <input type="text" id="contact_person">
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="customer_phone">
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="customer_email">
                </div>
                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="customer_address" rows="3"></textarea>
                </div>
                <button type="submit" class="btn" id="customerSubmitBtn">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Görev Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h3>✅ Yeni Görev</h3>
            <form id="taskForm">
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="task_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Görev Başlığı:</label>
                    <input type="text" id="task_title" required>
                </div>
                <div class="form-group">
                    <label>Açıklama:</label>
                    <textarea id="task_description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Öncelik:</label>
                    <select id="task_priority" required>
                        <option value="low">Düşük</option>
                        <option value="medium">Orta</option>
                        <option value="high">Yüksek</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bitiş Tarihi:</label>
                    <input type="date" id="task_due_date" required>
                </div>
                <button type="submit" class="btn">Görev Oluştur</button>
            </form>
        </div>
    </div>

    <!-- Yeni Müşteri Modal (Harita) -->
    <div id="newCustomerFromMapModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('newCustomerFromMapModal')">&times;</span>
            <h3>🏢 Yeni Müşteri Kaydı</h3>
            <form id="newCustomerFromMapForm">
                <input type="hidden" id="map_lat">
                <input type="hidden" id="map_lng">
                <div class="form-group">
                    <label>Firma Adı:</label>
                    <input type="text" id="map_company_name" required>
                </div>
                <div class="form-group">
                    <label>Yetkili Kişi:</label>
                    <input type="text" id="map_contact_person">
                </div>
                <div class="form-group">
                    <label>Telefon:</label>
                    <input type="tel" id="map_phone">
                </div>
                <div class="form-group">
                    <label>E-posta:</label>
                    <input type="email" id="map_email">
                </div>
                <div class="form-group">
                    <label>Adres:</label>
                    <textarea id="map_address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Ziyaret Notu:</label>
                    <textarea id="visit_note" rows="3" placeholder="Ziyaret sırasında alınan notlar..."></textarea>
                </div>
                <div class="form-group">
                    <label>Ziyaret Sonucu:</label>
                    <select id="visit_result" required>
                        <option value="">Sonuç Seçiniz</option>
                        <option value="positive">Olumlu - Sipariş Alındı</option>
                        <option value="potential">Potansiyel - Takip Edilecek</option>
                        <option value="negative">Olumsuz - İlgilenmiyor</option>
                    </select>
                </div>
                <div id="nextActionSection" style="display: none;">
                    <div class="form-group">
                        <label>Sonraki İşlem:</label>
                        <select id="next_action">
                            <option value="">Seçiniz</option>
                            <option value="appointment">Randevu Planla</option>
                            <option value="call">Telefon Görüşmesi</option>
                            <option value="visit">Tekrar Ziyaret</option>
                        </select>
                    </div>
                    <div class="form-group" id="nextDateSection" style="display: none;">
                        <label>Tarih:</label>
                        <input type="date" id="next_date">
                    </div>
                    <div class="form-group" id="nextTimeSection" style="display: none;">
                        <label>Saat:</label>
                        <input type="time" id="next_time">
                    </div>
                </div>
                <button type="submit" class="btn">Müşteri Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Sipariş Oluşturma Modal -->
    <div id="quickOrderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('quickOrderModal')">&times;</span>
            <h3>📋 Hızlı Sipariş</h3>
            <form id="quickOrderForm">
                <input type="hidden" id="quick_customer_id">
                <div class="form-group">
                    <label>Müşteri:</label>
                    <input type="text" id="quick_customer_name" readonly>
                </div>
                <div class="form-group">
                    <label>Sipariş Tutaru0131:</label>
                    <input type="number" id="quick_amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Teslimat Tarihi:</label>
                    <input type="date" id="quick_delivery_date">
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="quick_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Sipariş Oluştur</button>
            </form>
        </div>
    </div>

    <!-- Randevu Planlama Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('appointmentModal')">&times;</span>
            <h3>📅 Yeni Randevu Planla</h3>
            <div style="margin: 1.5rem 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label>Tarih:</label>
                        <input type="date" id="appointmentDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label>Saat:</label>
                        <input type="time" id="appointmentTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label>Randevu Tipi:</label>
                    <select id="appointmentType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="visit">Ziyaret</option>
                        <option value="call">Telefon Görüşmesi</option>
                        <option value="meeting">Toplantı</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label>Randevu Notu:</label>
                    <textarea id="appointmentNote" rows="3" placeholder="Randevu hakkında notlar..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>
                <div style="text-align: center;">
                    <button onclick="saveAppointment()" class="btn btn-success">✓ Randevu Kaydet</button>
                    <button onclick="closeModal('appointmentModal')" class="btn" style="background: #6c757d; margin-left: 0.5rem;">İptal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Randevu/Görev Detay Modal -->
    <div id="appointmentDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('appointmentDetailModal')">&times;</span>
            <div id="appointmentDetailContent">
                <!-- JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- İrsaliye Modal -->
    <div id="deliveryNoteModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('deliveryNoteModal')">&times;</span>
            <h3 id="deliveryNoteModalTitle">🚚 Yeni İrsaliye</h3>
            <form id="deliveryNoteForm">
                <div class="form-group">
                    <label>İrsaliye No:</label>
                    <input type="text" id="delivery_number" readonly style="background: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label>Müşteri:</label>
                    <select id="delivery_customer_id" required></select>
                </div>
                <div class="form-group">
                    <label>Teslimat Tarihi:</label>
                    <input type="date" id="delivery_date" required>
                </div>
                <div class="form-group">
                    <label>Teslimat Saati:</label>
                    <input type="time" id="delivery_time">
                </div>
                <div class="form-group">
                    <label>Teslimat Adresi:</label>
                    <textarea id="delivery_address" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Notlar:</label>
                    <textarea id="delivery_notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">İrsaliye Kaydet</button>
            </form>
        </div>
    </div>

    <!-- İrsaliye Detay Modal -->
    <div id="deliveryDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('deliveryDetailModal')">&times;</span>
            <div id="deliveryDetailContent"></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

        console.log('🔑 Auth token:', authToken ? 'Mevcut' : 'Yok');
        console.log('👤 Current user:', currentUser);

        if (!authToken) {
            console.log('⚠️ Token yok, ana sayfaya yönlendiriliyor');
            // Geçici olarak token kontrolünü devre dışı bırak
            // window.location.href = '/';
            
            // Test için dummy token ve user oluştur
            authToken = 'dummy-token';
            currentUser = { id: 1, full_name: 'Test Kullanıcısı' };
            console.log('📝 Test modu: Dummy token ve user oluşturuldu');
        }

        async function apiCall(url, options = {}) {
            try {
                console.log('🔗 API çağrısı:', url);
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                // Sadece gerçek token varsa Authorization header'ı ekle
                if (authToken && authToken !== 'dummy-token') {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                
                const response = await fetch(url, {
                    ...options,
                    headers: headers
                });
                
                console.log('📡 Response status:', response.status);
                console.log('📡 Response headers:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API hatası:', errorText);
                    throw new Error(`API hatası: ${response.status} - ${errorText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    console.log('✅ API yanıtı:', data);
                    return data;
                } else {
                    const text = await response.text();
                    console.error('❌ JSON bekleniyor ama HTML geldi:', text.substring(0, 200));
                    throw new Error('Veriler yüklenemedi: Unexpected token \'<\', "<!DOCTYPE "... is not valid JSON');
                }
            } catch (error) {
                console.error('❌ API çağrısı hatası:', error);
                throw error;
            }
        }

        async function showDashboard() {
            try {
                const stats = await apiCall('/api/dashboard/stats');
                const targetsResponse = await apiCall(`/api/targets/user/${currentUser.id}`);
                const targets = targetsResponse.targets || [];
                const salesTarget = targets.find(t => t.target_type === 'sales');
                const visitsTarget = targets.find(t => t.target_type === 'visits');
                
                document.getElementById('content').innerHTML = `
                    <!-- Hedefler ve Gerçekleşmeler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- Aylık Satış Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">Aylık Satış Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: ${salesTarget ? salesTarget.target_value.toLocaleString() : '100,000'} TL</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">💰</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">Gerçekleşen: 75,000 TL</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">75%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 75%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #48bb78;">Kalan: 25,000 TL</div>
                        </div>
                        
                        <!-- Aylık Ziyaret Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">Aylık Ziyaret Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: ${visitsTarget ? visitsTarget.target_value : '30'} ziyaret</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #48bb78, #38a169); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">🎯</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">Gerçekleşen: 22 ziyaret</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">73%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 73%; height: 100%; background: linear-gradient(90deg, #48bb78, #38a169); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #48bb78;">Kalan: 8 ziyaret</div>
                        </div>
                        
                        <!-- Aylık Tahsilat Hedefi -->
                        <div class="card" style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">Aylık Tahsilat Hedefi</h3>
                                    <p style="color: #718096; font-size: 0.875rem;">Hedef: 90,000 TL</p>
                                </div>
                                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ed8936, #dd6b20); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">💳</div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: #718096;">Gerçekleşen: 68,000 TL</span>
                                    <span style="font-size: 0.875rem; color: #2d3748; font-weight: 600;">76%</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                    <div style="width: 76%; height: 100%; background: linear-gradient(90deg, #ed8936, #dd6b20); transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            <div style="font-size: 0.875rem; color: #ed8936;">Kalan: 22,000 TL</div>
                        </div>
                    </div>
                    
                    <!-- Bugünkü Randevular -->
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">📅 Bugünkü Randevular</h3>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #48bb78; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong>09:00 - ABC Restaurant</strong>
                                    <div style="font-size: 0.875rem; color: #666;">Sipariş takibi ve yeni ürün tanıtımı</div>
                                </div>
                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;" onclick="completeAppointment(1)">✓ Tamamla</button>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ed8936; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong>14:00 - XYZ Cafe</strong>
                                    <div style="font-size: 0.875rem; color: #666;">Aylık sipariş planlanması</div>
                                </div>
                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;" onclick="completeAppointment(2)">✓ Tamamla</button>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9f7aea; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong>16:30 - DEF Otel</strong>
                                    <div style="font-size: 0.875rem; color: #666;">Tahsilat takibi</div>
                                </div>
                                <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;" onclick="completeAppointment(3)">✓ Tamamla</button>
                            </div>
                        </div>
                    </div>
                    

                    
                    <!-- Sipariş Durumu ve Müşteri Haritası -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- Sipariş Durumu -->
                        <div class="card" style="margin-bottom: 0;">
                            <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">📋 Sipariş Durumu</h3>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #e8f5e8; border-radius: 4px;">
                                    <span>Onaylandı</span>
                                    <strong style="color: #48bb78;">8 sipariş</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fff3cd; border-radius: 4px;">
                                    <span>Hazırlanıyor</span>
                                    <strong style="color: #ed8936;">5 sipariş</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #d4edda; border-radius: 4px;">
                                    <span>Teslim Edildi</span>
                                    <strong style="color: #155724;">12 sipariş</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8d7da; border-radius: 4px;">
                                    <span>İptal</span>
                                    <strong style="color: #721c24;">2 sipariş</strong>
                                </div>
                            </div>
                            <button class="btn" onclick="showOrders()" style="width: 100%; margin-top: 1rem;">Tüm Siparişleri Görüntüle</button>
                        </div>
                        
                        <!-- Müşteri Haritası -->
                        <div class="card" style="margin-bottom: 0;">
                            <h3 style="color: #2d3748; font-weight: 600; margin-bottom: 1rem;">🗺️ Müşteri Haritası</h3>
                            <div style="height: 200px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <div style="text-align: center; color: #666;">
                                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">🗺️</div>
                                    <div>Yakındaki müşteriler</div>
                                    <div style="font-size: 0.875rem;">5 km çevrede 12 müşteri</div>
                                </div>
                            </div>
                            <button class="btn" onclick="window.location.href='/map.html'" style="width: 100%;">Haritayı Aç</button>
                        </div>
                    </div>
                `;
                
                // Grafikleri çiz
                setTimeout(() => {
                    drawSalesChart();
                    drawVisitChart();
                }, 100);
                
            } catch (error) {
                console.error('Dashboard yüklenemedi:', error);
                showDashboardFallback();
            }
        }
        
        function showDashboardFallback() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2>Satış Dashboard</h2>
                    <p>Hoş geldiniz, ${currentUser.full_name}</p>
                    <div style="margin-top: 2rem;">
                        <button class="btn" onclick="window.location.href='/order-detail.html'">📝 Yeni Sipariş</button>
                    </div>
                </div>
            `;
        }

        async function showVisit() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>Müşteri Ziyaret</h2>
                        <button class="btn" onclick="openVisitModal()">Yeni Ziyaret Kaydı</button>
                        
                        <h3 style="margin-top: 2rem;">Yakındaki Müşteriler</h3>
                        <div id="nearbyCustomers">
                            ${customers.map(customer => `
                                <div class="customer-card" onclick="selectCustomer(${customer.id})">
                                    <h4>${customer.company_name}</h4>
                                    <p>Yetkili: ${customer.contact_person || '-'}</p>
                                    <p>Telefon: ${customer.phone || '-'}</p>
                                    <p>Durum: ${customer.customer_status}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Ziyaret sayfası yüklenemedi:', error);
            }
        }

        async function showCustomers() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                let html = `
                    <div class="card">
                        <h2>Müşterilerim</h2>
                        <button class="btn" onclick="openCustomerModal()" style="margin-bottom: 1rem;">+ Yeni Müşteri</button>
                        <div style="display: grid; gap: 1rem;">
                `;
                
                customers.forEach(customer => {
                    html += `
                        <div class="customer-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <h4>${customer.company_name}</h4>
                                    <p>Yetkili: ${customer.contact_person || '-'}</p>
                                    <p>Telefon: ${customer.phone || '-'}</p>
                                    <p>Durum: ${customer.customer_status}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn" onclick="editCustomer(${customer.id})" style="background: #ed8936;">✏️ Düzenle</button>
                                    <button class="btn" onclick="visitCustomer(${customer.id})">📋 Ziyaret</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Müşteriler yüklenemedi:', error);
            }
        }

        async function showOrders() {
            try {
                const ordersResponse = await apiCall('/api/orders');
                const orders = ordersResponse.orders || [];
                const myOrders = orders; // Tüm siparişleri göster
                
                let html = `
                    <div class="card">
                        <h2>Siparişlerim</h2>
                        <button class="btn" onclick="openOrderModal()">Yeni Sipariş</button>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Müşteri</th>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                myOrders.forEach(order => {
                    html += `
                        <tr>
                            <td>#${order.order_number}</td>
                            <td>${order.company_name || 'Bilinmiyor'}</td>
                            <td>${new Date(order.order_date).toLocaleDateString('tr-TR')}</td>
                            <td>${order.total_amount} TL</td>
                            <td>${order.status}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('content').innerHTML = html;
                
            } catch (error) {
                console.error('Siparişler yüklenemedi:', error);
            }
        }

        async function showMap() {
            window.location.href = '/map.html';
        }

        function selectCustomer(customerId) {
            document.querySelectorAll('.customer-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.customer-card').classList.add('active');
        }

        function visitCustomer(customerId) {
            openVisitModal();
            document.getElementById('customer_id').value = customerId;
        }
        
        function viewCustomerDetail(customerId) {
            window.location.href = `/customer-detail.html?id=${customerId}`;
        }

        async function openVisitModal() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('customer_id');
                customerSelect.innerHTML = '<option value="">Müşteri Seçiniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('visitModal').style.display = 'block';
            } catch (error) {
                alert('Müşteriler yüklenemedi: ' + error.message);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        let orderProducts = [];
        
        async function openOrderModal() {
            try {
                const [customersResponse, productsResponse] = await Promise.all([
                    apiCall('/api/customers'),
                    apiCall('/api/products')
                ]);
                
                const customers = customersResponse.customers || [];
                const products = productsResponse.products || [];

                const customerSelect = document.getElementById('order_customer_id');
                customerSelect.innerHTML = '<option value="">Müşteri Seçiniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                const productSelect = document.getElementById('product_select');
                productSelect.innerHTML = '<option value="">Ürün Seçiniz</option>';
                products.forEach(product => {
                    productSelect.innerHTML += `<option value="${product.id}" data-price="${product.unit_price}" data-name="${product.name}">${product.name} - ${product.unit_price} TL</option>`;
                });
                
                document.getElementById('order_date').value = new Date().toISOString().split('T')[0];
                orderProducts = [];
                updateOrderDisplay();
                
                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                alert('Veriler yüklenemedi: ' + error.message);
            }
        }
        
        function addProductToOrder() {
            const productSelect = document.getElementById('product_select');
            const quantityInput = document.getElementById('product_quantity');
            
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            if (!selectedOption.value) {
                alert('Lütfen bir ürün seçin!');
                return;
            }
            
            const quantity = parseInt(quantityInput.value);
            if (!quantity || quantity < 1) {
                alert('Lütfen geçerli bir miktar girin!');
                return;
            }
            
            const productId = selectedOption.value;
            const productName = selectedOption.dataset.name;
            const productPrice = parseFloat(selectedOption.dataset.price);
            
            // Aynı ürün varsa miktarını artır
            const existingProduct = orderProducts.find(p => p.id === productId);
            if (existingProduct) {
                existingProduct.quantity += quantity;
            } else {
                orderProducts.push({
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity
                });
            }
            
            // Formu temizle
            productSelect.selectedIndex = 0;
            quantityInput.value = 1;
            
            updateOrderDisplay();
        }
        
        function removeProductFromOrder(index) {
            orderProducts.splice(index, 1);
            updateOrderDisplay();
        }
        
        function updateOrderDisplay() {
            const container = document.getElementById('selected_products');
            const totalElement = document.getElementById('order_total');
            
            if (orderProducts.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 1rem;">Henüz ürün eklenmedi</p>';
                totalElement.textContent = '0.00';
                return;
            }
            
            let total = 0;
            container.innerHTML = orderProducts.map((product, index) => {
                const subtotal = product.price * product.quantity;
                total += subtotal;
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.5rem;">
                        <div>
                            <strong>${product.name}</strong><br>
                            <small>${product.quantity} x ${product.price} TL = ${subtotal.toFixed(2)} TL</small>
                        </div>
                        <button type="button" onclick="removeProductFromOrder(${index})" class="btn" style="background: #dc3545; padding: 0.25rem 0.5rem; font-size: 0.75rem;">Sil</button>
                    </div>
                `;
            }).join('');
            
            totalElement.textContent = total.toFixed(2);
        }
        
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (orderProducts.length === 0) {
                alert('Lütfen en az bir ürün ekleyin!');
                return;
            }
            
            const total = orderProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            
            const formData = {
                customer_id: document.getElementById('order_customer_id').value,
                order_date: document.getElementById('order_date').value,
                delivery_date: document.getElementById('delivery_date').value,
                total_amount: total,
                notes: document.getElementById('order_notes').value,
                products: orderProducts
            };
            
            try {
                const result = await apiCall('/api/orders', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                alert(`Sipariş başarıyla oluşturuldu! Sipariş No: ${result.order.order_number || 'SIP' + Date.now()}`);
                document.getElementById('orderForm').reset();
                orderProducts = [];
                closeModal('orderModal');
                showOrders();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        document.getElementById('visitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                customer_id: document.getElementById('customer_id').value,
                visit_type: document.getElementById('visit_type').value,
                result: document.getElementById('result').value,
                notes: document.getElementById('notes').value,
                next_contact_date: document.getElementById('next_contact_date').value,
                visit_date: new Date().toISOString()
            };
            
            try {
                await apiCall('/api/visits', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                alert('Ziyaret kaydı başarıyla oluşturuldu!');
                document.getElementById('visitForm').reset();
                closeModal('visitModal');
                showVisit();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        async function openTaskModal() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('task_customer_id');
                customerSelect.innerHTML = '<option value="">Müşteri Seçiniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('taskModal').style.display = 'block';
            } catch (error) {
                alert('Müşteriler yüklenemedi: ' + error.message);
            }
        }
        
        async function completeActivity(type, id) {
            if (confirm(`${type === 'appointment' ? 'Randevu' : type === 'task' ? 'Görev' : 'Ziyaret'} tamamlandı olarak işaretlensin mi?`)) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'Aktivite tamamlandı'
                        })
                    });
                    alert('Aktivite tamamlandı!');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function editActivity(type, id) {
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const appointment = response.appointment;
                
                // Basit edit modal aç
                const newTitle = prompt('Yeni başlık:', appointment.title);
                if (newTitle && newTitle !== appointment.title) {
                    await apiCall(`/api/appointments/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...appointment,
                            title: newTitle
                        })
                    });
                    alert('Güncellendi!');
                    showAppointments();
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function showAppointmentDetail(id) {
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                const typeNames = {
                    'appointment': 'Randevu',
                    'task': 'Görev', 
                    'visit': 'Ziyaret',
                    'call': 'Telefon',
                    'meeting': 'Toplantı'
                };
                
                const statusNames = {
                    'pending': 'Bekliyor',
                    'in_progress': 'Devam Ediyor',
                    'completed': 'Tamamlandı',
                    'cancelled': 'İptal Edildi'
                };
                
                document.getElementById('appointmentDetailContent').innerHTML = `
                    <h3>${typeNames[apt.type] || apt.type} Detayı</h3>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div><strong>Başlık:</strong> ${apt.title}</div>
                            <div><strong>Durum:</strong> <span style="color: ${apt.status === 'completed' ? '#28a745' : apt.status === 'pending' ? '#ffc107' : '#007bff'};">${statusNames[apt.status] || apt.status}</span></div>
                            <div><strong>Tarih:</strong> ${new Date(apt.start_date).toLocaleDateString('tr-TR')}</div>
                            <div><strong>Saat:</strong> ${apt.start_time || '09:00'}</div>
                            <div><strong>Müşteri:</strong> ${apt.customer_name || 'Genel'}</div>
                            <div><strong>Öncelik:</strong> ${apt.priority}</div>
                        </div>
                        ${apt.description ? `<div style="margin-top: 1rem;"><strong>Açıklama:</strong><br>${apt.description}</div>` : ''}
                        ${apt.location ? `<div style="margin-top: 0.5rem;"><strong>Konum:</strong> ${apt.location}</div>` : ''}
                        ${apt.completion_notes ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: #d4edda; border-radius: 4px;"><strong>Tamamlanma Notu:</strong><br>${apt.completion_notes}</div>` : ''}
                    </div>
                    
                    <!-- Not Ekleme -->
                    <div style="margin: 1rem 0;">
                        <label><strong>Yeni Not Ekle:</strong></label>
                        <textarea id="newNote" rows="3" placeholder="Not yazın..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem;"></textarea>
                    </div>
                    
                    <!-- İşlem Butonları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin: 1.5rem 0;">
                        ${apt.status === 'pending' ? `
                            <button onclick="completeAppointmentWithNote(${apt.id})" class="btn" style="background: #28a745;">✓ Tamamla</button>
                            <button onclick="rescheduleAppointment(${apt.id})" class="btn" style="background: #ffc107;">📅 Yeniden Planla</button>
                        ` : ''}
                        ${apt.customer_id ? `
                            <button onclick="createOrderFromAppointment(${apt.customer_id}, '${apt.customer_name}')" class="btn" style="background: #007bff;">📋 Sipariş Oluştur</button>
                            <button onclick="scheduleFollowUp(${apt.customer_id}, '${apt.customer_name}')" class="btn" style="background: #6f42c1;">🔄 Takip Randevusu</button>
                        ` : ''}
                        <button onclick="addNoteToAppointment(${apt.id})" class="btn" style="background: #17a2b8;">📝 Not Ekle</button>
                        <button onclick="markAsNotInterested(${apt.id})" class="btn" style="background: #dc3545;">❌ İlgilenmiyor</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1rem;">
                        <button onclick="closeModal('appointmentDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                    </div>
                `;
                
                document.getElementById('appointmentDetailModal').style.display = 'block';
            } catch (error) {
                alert('Detay yüklenemedi: ' + error.message);
            }
        }
        
        async function completeAppointmentWithNote(id) {
            const note = document.getElementById('newNote').value;
            try {
                await apiCall(`/api/appointments/${id}/complete`, {
                    method: 'POST',
                    body: JSON.stringify({
                        completion_notes: note || 'Tamamlandı'
                    })
                });
                
                // Müşteriyi potansiyel olarak kaydet
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                if (apt.customer_id) {
                    try {
                        await apiCall(`/api/customers/${apt.customer_id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                customer_status: 'potential'
                            })
                        });
                    } catch (error) {
                        console.log('Müşteri durumu güncellenemedi:', error.message);
                    }
                }
                
                alert('Randevu tamamlandı ve müşteri potansiyel olarak işaretlendi!');
                closeModal('appointmentDetailModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function addNoteToAppointment(id) {
            const note = document.getElementById('newNote').value;
            if (!note.trim()) {
                alert('Lütfen bir not yazın!');
                return;
            }
            
            try {
                const response = await apiCall(`/api/appointments/${id}`);
                const apt = response.appointment;
                
                const updatedDescription = apt.description ? 
                    `${apt.description}\n\n[${new Date().toLocaleString('tr-TR')}] ${note}` : 
                    `[${new Date().toLocaleString('tr-TR')}] ${note}`;
                
                await apiCall(`/api/appointments/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        ...apt,
                        description: updatedDescription
                    })
                });
                
                alert('Not eklendi!');
                document.getElementById('newNote').value = '';
                showAppointmentDetail(id); // Detayı yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
        
        async function rescheduleAppointment(id) {
            // Takvim modalını aç
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentType').value = 'appointment';
            document.getElementById('appointmentNote').value = 'Yeniden planlanan randevu';
            
            // Global değişkenleri ayarla
            window.rescheduleAppointmentId = id;
            window.isRescheduleMode = true;
            
            closeModal('appointmentDetailModal');
            document.getElementById('appointmentModal').style.display = 'block';
        }
        
        async function createOrderFromAppointment(customerId, customerName) {
            try {
                // Müşteriyi kaydet
                await apiCall('/api/customers', {
                    method: 'POST',
                    body: JSON.stringify({
                        company_name: customerName,
                        customer_status: 'potential',
                        assigned_sales_rep: currentUser.id
                    })
                });
                
                // Sipariş modalını aç
                document.getElementById('quick_customer_id').value = customerId;
                document.getElementById('quick_customer_name').value = customerName;
                closeModal('appointmentDetailModal');
                document.getElementById('quickOrderModal').style.display = 'block';
            } catch (error) {
                console.log('Müşteri zaten mevcut veya hata:', error.message);
                // Sipariş modalını aç
                document.getElementById('quick_customer_id').value = customerId;
                document.getElementById('quick_customer_name').value = customerName;
                closeModal('appointmentDetailModal');
                document.getElementById('quickOrderModal').style.display = 'block';
            }
        }
        
        async function scheduleFollowUp(customerId, customerName) {
            // Takvim modalını aç
            document.getElementById('appointmentDate').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentType').value = 'visit';
            document.getElementById('appointmentNote').value = `Takip randevusu - ${customerName}`;
            
            // Global değişkenleri ayarla
            window.followUpCustomerId = customerId;
            window.followUpCustomerName = customerName;
            window.isFollowUpMode = true;
            
            closeModal('appointmentDetailModal');
            document.getElementById('appointmentModal').style.display = 'block';
        }
        
        async function markAsNotInterested(id) {
            if (confirm('Müşteri ilgilenmiyor olarak işaretlensin mi?')) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'Müşteri ilgilenmiyor'
                        })
                    });
                    
                    alert('Müşteri ilgilenmiyor olarak işaretlendi.');
                    closeModal('appointmentDetailModal');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function completeTask(id) {
            if (confirm('Görev tamamlandı olarak işaretlensin mi?')) {
                try {
                    await apiCall(`/api/appointments/${id}/complete`, {
                        method: 'POST',
                        body: JSON.stringify({
                            completion_notes: 'Görev tamamlandı'
                        })
                    });
                    alert('Görev tamamlandı!');
                    showAppointments();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                customer_id: document.getElementById('task_customer_id').value,
                title: document.getElementById('task_title').value,
                description: document.getElementById('task_description').value,
                priority: document.getElementById('task_priority').value,
                due_date: document.getElementById('task_due_date').value,
                status: 'pending'
            };
            
            try {
                alert('Görev başarıyla oluşturuldu!');
                document.getElementById('taskForm').reset();
                closeModal('taskModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerId = document.getElementById('customer_edit_id').value;
            const formData = {
                company_name: document.getElementById('company_name').value,
                contact_person: document.getElementById('contact_person').value,
                phone: document.getElementById('customer_phone').value,
                email: document.getElementById('customer_email').value,
                address: document.getElementById('customer_address').value,
                assigned_sales_rep: 1
            };
            
            try {
                if (customerId) {
                    // Güncelleme
                    await apiCall(`/api/customers/${customerId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    alert('Müşteri başarıyla güncellendi!');
                } else {
                    // Yeni ekleme
                    await apiCall('/api/customers', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    alert('Müşteri başarıyla eklendi!');
                }
                
                document.getElementById('customerForm').reset();
                closeModal('customerModal');
                showCustomers();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        function drawSalesChart() {
            const canvas = document.getElementById('salesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Veri
            const months = ['Oca', 'Şub', 'Mar', 'Nis', 'May', 'Haz'];
            const target = [100, 120, 110, 130, 125, 140];
            const actual = [85, 95, 105, 115, 130, 125];
            
            const maxValue = Math.max(...target, ...actual) * 1.1;
            const barWidth = (width - 80) / (months.length * 2.5);
            
            // Grid çizgiler
            ctx.strokeStyle = '#f1f5f9';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = 40 + (i * (height - 80) / 5);
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(width - 20, y);
                ctx.stroke();
            }
            
            months.forEach((month, index) => {
                const x = 60 + (index * 2.5) * barWidth;
                const targetHeight = (target[index] / maxValue) * (height - 80);
                const actualHeight = (actual[index] / maxValue) * (height - 80);
                
                // Hedef bar (daha ince)
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(x, height - targetHeight - 40, barWidth * 0.6, targetHeight);
                
                // Gerçekleşen bar (gradient)
                const gradient = ctx.createLinearGradient(0, height - 40, 0, height - actualHeight - 40);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(x, height - actualHeight - 40, barWidth * 0.6, actualHeight);
                
                // Ay etiketi
                ctx.fillStyle = '#718096';
                ctx.font = '12px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText(month, x + barWidth * 0.3, height - 15);
            });
            
            // Legend
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(40, 15, 12, 12);
            ctx.fillStyle = '#718096';
            ctx.font = '11px Poppins';
            ctx.textAlign = 'left';
            ctx.fillText('Hedef', 58, 25);
            
            ctx.fillStyle = '#667eea';
            ctx.fillRect(100, 15, 12, 12);
            ctx.fillText('Gerçekleşen', 118, 25);
        }
        
        function drawVisitChart() {
            const canvas = document.getElementById('visitChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 10;
            const radius = 70;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const data = [
                { label: 'Başarılı', value: 60, color: '#48bb78' },
                { label: 'Potansiyel', value: 25, color: '#ed8936' },
                { label: 'Olumsuz', value: 15, color: '#f56565' }
            ];
            
            let currentAngle = -Math.PI / 2; // Başlangıç üst nokta
            
            data.forEach((item, index) => {
                const sliceAngle = (item.value / 100) * 2 * Math.PI;
                
                // Gradient oluştur
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                gradient.addColorStop(0, item.color);
                gradient.addColorStop(1, item.color + '80');
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Çember kenarı
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
            });
            
            // Legend
            let legendY = canvas.height - 60;
            data.forEach((item, index) => {
                ctx.fillStyle = item.color;
                ctx.fillRect(20, legendY + (index * 20), 12, 12);
                
                ctx.fillStyle = '#718096';
                ctx.font = '11px Poppins';
                ctx.textAlign = 'left';
                ctx.fillText(`${item.label} ${item.value}%`, 38, legendY + (index * 20) + 9);
            });
        }
        
        async function showCalendar() {
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2>📅 Takvim ve Aktiviteler</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- Bugünkü Aktiviteler -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: #2d3748; margin-bottom: 1rem;">📅 Bugünkü Aktiviteler</h3>
                            <div id="todayActivities">
                                <div onclick="showActivityDetail(1)" style="border-left: 4px solid #48bb78; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>09:00</strong> - ABC Restaurant ziyareti
                                    <div style="font-size: 0.875rem; color: #666;">Sipariş takibi</div>
                                </div>
                                <div onclick="showActivityDetail(2)" style="border-left: 4px solid #ed8936; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>14:00</strong> - XYZ Cafe randevusu
                                    <div style="font-size: 0.875rem; color: #666;">Yeni ürün tanıtımı</div>
                                </div>
                                <div onclick="showActivityDetail(3)" style="border-left: 4px solid #f56565; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>16:30</strong> - DEF Otel telefon görüşmesi
                                    <div style="font-size: 0.875rem; color: #666;">Tahsilat takibi</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bu Hafta Planlı -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                            <h3 style="color: #2d3748; margin-bottom: 1rem;">📆 Bu Hafta Planlı</h3>
                            <div id="weekActivities">
                                <div onclick="showActivityDetail(4)" style="border-left: 4px solid #42A5F5; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>Yarın 10:00</strong> - GHI Market
                                    <div style="font-size: 0.875rem; color: #666;">Aylık sipariş planlaması</div>
                                </div>
                                <div onclick="showActivityDetail(5)" style="border-left: 4px solid #9f7aea; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>Perşembe 15:00</strong> - JKL Restaurant
                                    <div style="font-size: 0.875rem; color: #666;">Yeni müşteri ziyareti</div>
                                </div>
                                <div onclick="showActivityDetail(6)" style="border-left: 4px solid #48bb78; padding: 0.5rem 1rem; margin: 0.5rem 0; background: white; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'">
                                    <strong>Cuma 11:00</strong> - MNO Cafe
                                    <div style="font-size: 0.875rem; color: #666;">Sipariş teslim takibi</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yeni Aktivite Ekleme -->
                    <div style="background: white; border: 2px dashed #e2e8f0; padding: 2rem; border-radius: 8px; text-align: center;">
                        <h3 style="color: #2d3748; margin-bottom: 1rem;">➕ Yeni Aktivite Ekle</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; align-items: end;">
                            <div>
                                <label>Tarih:</label>
                                <input type="date" id="activityDate" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>Saat:</label>
                                <input type="time" id="activityTime" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>Müşteri:</label>
                                <select id="activityCustomer" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Müşteri Seçiniz</option>
                                    <option value="1">ABC Restaurant</option>
                                    <option value="2">XYZ Cafe</option>
                                    <option value="3">DEF Otel</option>
                                </select>
                            </div>
                            <button onclick="addActivity()" class="btn">➕ Ekle</button>
                        </div>
                        <div style="margin-top: 1rem;">
                            <input type="text" id="activityNote" placeholder="Aktivite notu..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            
            // Bugünün tarihini varsayılan olarak ayarla
            document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
        }
        
        function showActivityDetail(activityId) {
            // Örnek veri - gerçekte API'den gelecek
            const activities = {
                1: {
                    customer: 'ABC Restaurant',
                    time: '09:00',
                    type: 'Ziyaret',
                    status: 'Planlı',
                    notes: 'Sipariş takibi yapılacak',
                    previousVisits: [
                        { date: '2025-08-15', note: 'Yeni ürünler tanıtıldı, olumlu karşılandı', result: 'Potansiyel' },
                        { date: '2025-08-10', note: '500 TL sipariş alındı', result: 'Satış' },
                        { date: '2025-08-05', note: 'İlk ziyaret, tanışma toplantısı', result: 'Potansiyel' }
                    ]
                },
                2: {
                    customer: 'XYZ Cafe',
                    time: '14:00',
                    type: 'Randevu',
                    status: 'Onaylanmış',
                    notes: 'Yeni ürün tanıtımı yapılacak',
                    previousVisits: [
                        { date: '2025-08-12', note: 'Fiyat teklifi verildi, düşünüyor', result: 'Potansiyel' },
                        { date: '2025-08-08', note: 'Müşteri ilgili ama karar veremedi', result: 'Potansiyel' }
                    ]
                },
                3: {
                    customer: 'DEF Otel',
                    time: '16:30',
                    type: 'Telefon',
                    status: 'Planlı',
                    notes: 'Tahsilat takibi yapılacak',
                    previousVisits: [
                        { date: '2025-08-18', note: '1200 TL sipariş verildi, ödeme 30 gün vade', result: 'Satış' },
                        { date: '2025-08-14', note: 'Büyük sipariş potansiyeli var', result: 'Potansiyel' }
                    ]
                },
                4: {
                    customer: 'GHI Market',
                    time: 'Yarın 10:00',
                    type: 'Ziyaret',
                    status: 'Planlı',
                    notes: 'Aylık sipariş planlaması yapılacak',
                    previousVisits: [
                        { date: '2025-08-16', note: '2500 TL büyük sipariş alındı', result: 'Satış' },
                        { date: '2025-08-10', note: 'Aylık ihtiyaç belirlendi', result: 'Potansiyel' }
                    ]
                },
                5: {
                    customer: 'JKL Restaurant',
                    time: 'Perşembe 15:00',
                    type: 'Ziyaret',
                    status: 'Yeni Müşteri',
                    notes: 'Yeni müşteri ziyareti, tanıtım yapılacak',
                    previousVisits: [
                        { date: '2025-08-17', note: 'İlk irtibat kuruldu, ilgili görünüyor', result: 'Potansiyel' }
                    ]
                },
                6: {
                    customer: 'MNO Cafe',
                    time: 'Cuma 11:00',
                    type: 'Takip',
                    status: 'Planlı',
                    notes: 'Sipariş teslim takibi yapılacak',
                    previousVisits: [
                        { date: '2025-08-19', note: '800 TL sipariş verildi, teslim bekliyor', result: 'Satış' },
                        { date: '2025-08-12', note: 'Fiyat listesi verildi', result: 'Potansiyel' }
                    ]
                }
            };
            
            const activity = activities[activityId];
            if (!activity) return;
            
            document.getElementById('activityDetailContent').innerHTML = `
                <h3>📅 ${activity.customer} - Aktivite Detayı</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 1.5rem 0;">
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h4>Bugünkü Aktivite</h4>
                        <p><strong>Saat:</strong> ${activity.time}</p>
                        <p><strong>Tip:</strong> ${activity.type}</p>
                        <p><strong>Durum:</strong> <span style="color: #48bb78;">${activity.status}</span></p>
                        <p><strong>Not:</strong> ${activity.notes}</p>
                        <button onclick="completeActivity(${activityId})" class="btn btn-success" style="margin-top: 0.5rem;">✓ Tamamlandı Olarak İşaretle</button>
                        <div id="completedActions-${activityId}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <h5 style="margin-bottom: 0.5rem;">Sonraki Aşama:</h5>
                            <button onclick="scheduleNextMeeting(${activityId})" class="btn" style="background: #42A5F5; margin-right: 0.5rem; margin-bottom: 0.5rem;">📅 Tekrar Randevu</button>
                            <button onclick="createOrder(${activityId})" class="btn" style="background: #48bb78; margin-right: 0.5rem; margin-bottom: 0.5rem;">📝 Sipariş Yap</button>
                            <button onclick="scheduleCall(${activityId})" class="btn" style="background: #ed8936; margin-right: 0.5rem; margin-bottom: 0.5rem;">📞 Telefon Planla</button>
                            <button onclick="markAsNotInterested(${activityId})" class="btn" style="background: #f56565; margin-bottom: 0.5rem;">❌ İlgilenmiyor</button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                        <h4>Müşteri Bilgileri</h4>
                        <p><strong>Firma:</strong> ${activity.customer}</p>
                        <p><strong>Son Ziyaret:</strong> ${activity.previousVisits[0].date}</p>
                        <p><strong>Toplam Ziyaret:</strong> ${activity.previousVisits.length} kez</p>
                        <button onclick="viewCustomerDetail(1)" class="btn" style="margin-top: 0.5rem;">👥 Müşteri Detayı</button>
                    </div>
                </div>
                
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                    <h4>📝 Önceki Görüşme Notları</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${activity.previousVisits.map(visit => `
                            <div style="border-bottom: 1px solid #f1f5f9; padding: 0.75rem 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong>${new Date(visit.date).toLocaleDateString('tr-TR')}</strong>
                                    <span style="background: ${visit.result === 'Satış' ? '#d4edda' : '#fff3cd'}; color: ${visit.result === 'Satış' ? '#155724' : '#856404'}; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">${visit.result}</span>
                                </div>
                                <p style="color: #666; font-size: 0.9rem;">${visit.note}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 1rem; text-align: center;">
                    <button onclick="addVisitNote(${activityId})" class="btn">➕ Yeni Not Ekle</button>
                    <button onclick="closeModal('activityDetailModal')" class="btn" style="background: #6c757d; margin-left: 0.5rem;">Kapat</button>
                </div>
            `;
            
            document.getElementById('activityDetailModal').style.display = 'block';
        }
        
        function completeActivity(activityId) {
            // Tamamlandı butonunu gizle ve aksiyon butonlarını göster
            event.target.style.display = 'none';
            document.getElementById(`completedActions-${activityId}`).style.display = 'block';
            alert('Aktivite tamamlandı! Sonraki aşamayı seçin.');
        }
        
        function scheduleNextMeeting(activityId) {
            const date = prompt('Randevu tarihi (YYYY-MM-DD):');
            const time = prompt('Randevu saati (HH:MM):');
            if (date && time) {
                alert(`Yeni randevu planlandı: ${date} ${time}`);
                closeModal('activityDetailModal');
            }
        }
        
        function createOrder(activityId) {
            if (confirm('Sipariş sayfasına yönlendirileceksiniz. Devam etmek istiyor musunuz?')) {
                window.location.href = '/order-detail.html';
            }
        }
        
        function scheduleCall(activityId) {
            const date = prompt('Telefon görüşmesi tarihi (YYYY-MM-DD):');
            const time = prompt('Telefon görüşmesi saati (HH:MM):');
            if (date && time) {
                alert(`Telefon görüşmesi planlandı: ${date} ${time}`);
                closeModal('activityDetailModal');
            }
        }
        
        function markAsNotInterested(activityId) {
            if (confirm('Müşteri ilgilenmiyor olarak işaretlenecek. Emin misiniz?')) {
                alert('Müşteri ilgilenmiyor olarak işaretlendi.');
                closeModal('activityDetailModal');
            }
        }
        
        function addVisitNote(activityId) {
            const note = prompt('Yeni görüşme notu:');
            if (note) {
                alert('Not eklendi: ' + note);
                // Burada API'ye kaydet
            }
        }

        function addActivity() {
            const date = document.getElementById('activityDate').value;
            const time = document.getElementById('activityTime').value;
            const customer = document.getElementById('activityCustomer').value;
            const note = document.getElementById('activityNote').value;
            
            if (!date || !time || !customer) {
                alert('Lütfen tüm alanları doldurun!');
                return;
            }
            
            alert('Aktivite eklendi! (Veritabanı entegrasyonu yapılacak)');
            
            // Formu temizle
            document.getElementById('activityTime').value = '';
            document.getElementById('activityCustomer').value = '';
            document.getElementById('activityNote').value = '';
        }

        async function showDeliveryNotes() {
            try {
                const deliveryNotesResponse = await apiCall('/api/delivery-notes');
                const deliveryNotes = deliveryNotesResponse.delivery_notes || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>🚚 İrsaliye Yönetimi</h2>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn" onclick="openDeliveryNoteModal()" style="background: #28a745;">+ Yeni İrsaliye</button>
                            </div>
                        </div>
                        
                        <div id="deliveryNotesContainer">
                            ${deliveryNotes.length > 0 ? `
                                <div style="display: grid; gap: 1rem;">
                                    ${deliveryNotes.map(dn => {
                                        const statusColors = {
                                            'pending': '#ffc107',
                                            'in_transit': '#007bff', 
                                            'delivered': '#28a745',
                                            'cancelled': '#dc3545'
                                        };
                                        const statusNames = {
                                            'pending': 'Hazırlanıyor',
                                            'in_transit': 'Yolda',
                                            'delivered': 'Teslim Edildi',
                                            'cancelled': 'İptal'
                                        };
                                        const color = statusColors[dn.status] || '#6c757d';
                                        return `
                                            <div class="delivery-note-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white; border-left: 4px solid ${color};">
                                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                                    <div>
                                                        <h4 style="margin-bottom: 0.5rem;">${dn.delivery_number}</h4>
                                                        <p style="margin-bottom: 0.25rem;"><strong>Müşteri:</strong> ${dn.customer_name || 'Bilinmiyor'}</p>
                                                        <p style="margin-bottom: 0.25rem;"><strong>Tarih:</strong> ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}</p>
                                                        <p style="margin-bottom: 0.25rem;"><strong>Durum:</strong> <span style="color: ${color}; font-weight: 600;">${statusNames[dn.status] || dn.status}</span></p>
                                                    </div>
                                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                        <button class="btn" onclick="viewDeliveryNote(${dn.id})" style="background: #007bff; font-size: 0.875rem;">👁️ Görüntüle</button>
                                                        ${dn.status === 'pending' ? `<button class="btn" onclick="startDelivery(${dn.id})" style="background: #ffc107; font-size: 0.875rem;">🚚 Gönder</button>` : ''}
                                                        ${dn.status === 'in_transit' ? `<button class="btn" onclick="completeDelivery(${dn.id})" style="background: #28a745; font-size: 0.875rem;">✅ Teslim Et</button>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p style="text-align: center; color: #666; padding: 2rem;">Henüz irsaliye kaydı yok.</p>'}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('İrsaliyeler yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>🚚 İrsaliye Yönetimi</h2>
                        <p style="color: #dc3545;">İrsaliyeler yüklenemedi: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function showAppointments() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const appointmentsResponse = await apiCall(`/api/appointments?assigned_to=${currentUser.id}`);
                const appointments = appointmentsResponse.appointments || [];
                
                const today = new Date().toISOString().split('T')[0];
                const todayAppointments = appointments.filter(apt => apt.start_date === today);
                const upcomingAppointments = appointments.filter(apt => apt.start_date > today && apt.status === 'pending').slice(0, 5);
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>📅 Randevu & Görev Yönetimi</h2>
                        
                        <!-- Hızlı Eylemler -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <button class="btn" onclick="openAppointmentModal()" style="background: #007bff; padding: 1rem;">
                                📅 Yeni Randevu
                            </button>
                            <button class="btn" onclick="openTaskModal()" style="background: #28a745; padding: 1rem;">
                                ✅ Yeni Görev
                            </button>
                            <button class="btn" onclick="openVisitModal()" style="background: #fd7e14; padding: 1rem;">
                                🏢 Yeni Ziyaret
                            </button>
                        </div>
                        
                        <!-- Bugünkü Aktiviteler -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                            <h3>📋 Bugünkü Aktiviteler (${todayAppointments.length})</h3>
                            <div id="todayActivities">
                                ${todayAppointments.length > 0 ? `
                                    <div style="display: grid; gap: 0.75rem;">
                                        ${todayAppointments.map(apt => {
                                            const typeColors = {
                                                'appointment': '#007bff',
                                                'task': '#28a745', 
                                                'visit': '#fd7e14',
                                                'call': '#6f42c1',
                                                'meeting': '#20c997'
                                            };
                                            const color = typeColors[apt.type] || '#6c757d';
                                            return `
                                                <div style="background: white; border-left: 4px solid ${color}; padding: 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${apt.start_time || '09:00'} - ${apt.customer_name || apt.title}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${apt.type}: ${apt.description || apt.title}</div>
                                                        <div style="font-size: 0.75rem; color: #999;">Durum: ${apt.status === 'pending' ? 'Bekliyor' : apt.status === 'completed' ? 'Tamamlandı' : apt.status}</div>
                                                    </div>
                                                    <div style="display: flex; gap: 0.5rem;">
                                                        <button class="btn" onclick="showAppointmentDetail(${apt.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">👁️ Detay</button>
                                                        ${apt.status === 'pending' ? `<button class="btn" onclick="completeActivity('${apt.type}', ${apt.id})" style="background: #28a745; padding: 0.25rem 0.5rem; font-size: 0.75rem;">✓ Tamamla</button>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p style="color: #666; text-align: center; padding: 2rem;">Bugün için planlanmış aktivite yok.</p>'}
                            </div>
                        </div>
                        
                        <!-- Haftalık Görünüm -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <!-- Yaklaşan Randevular -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #007bff; margin-bottom: 1rem;">📅 Yaklaşan Randevular (${upcomingAppointments.length})</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${upcomingAppointments.length > 0 ? upcomingAppointments.map(apt => {
                                        const date = new Date(apt.start_date);
                                        const dateStr = date.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'short' });
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #007bff;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${dateStr} ${apt.start_time || '09:00'}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${apt.customer_name || apt.title}</div>
                                                        <div style="font-size: 0.75rem; color: #999;">${apt.type} - ${apt.priority}</div>
                                                    </div>
                                                    <button class="btn" onclick="showAppointmentDetail(${apt.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">👁️ Detay</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : '<p style="color: #666; text-align: center; padding: 1rem;">Yaklaşan randevu yok.</p>'}
                                </div>
                            </div>
                            
                            <!-- Bekleyen Görevler -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #28a745; margin-bottom: 1rem;">✅ Bekleyen Görevler</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${appointments.filter(apt => apt.type === 'task' && apt.status === 'pending').slice(0, 4).map(task => {
                                        const priorityColors = {
                                            'urgent': '#dc3545',
                                            'high': '#fd7e14', 
                                            'medium': '#ffc107',
                                            'low': '#28a745'
                                        };
                                        const color = priorityColors[task.priority] || '#6c757d';
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${task.title}</strong>
                                                        <div style="font-size: 0.875rem; color: #666;">${task.customer_name || 'Genel'} - <span style="color: ${color};">${task.priority}</span></div>
                                                        <div style="font-size: 0.75rem; color: #999;">${task.start_date}</div>
                                                    </div>
                                                    <button class="btn" onclick="showAppointmentDetail(${task.id})" style="background: #007bff; padding: 0.25rem 0.5rem; font-size: 0.75rem;">👁️ Detay</button>
                                                    <button class="btn" onclick="completeTask(${task.id})" style="background: #28a745; padding: 0.25rem 0.5rem; font-size: 0.75rem;">✓</button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<p style="color: #666; text-align: center; padding: 1rem;">Bekleyen görev yok.</p>'}
                                </div>
                            </div>
                            
                            <!-- Son Ziyaretler -->
                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1.5rem;">
                                <h4 style="color: #fd7e14; margin-bottom: 1rem;">🏢 Son Ziyaretler</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${appointments.filter(apt => apt.type === 'visit' && apt.status === 'completed').slice(0, 4).map(visit => {
                                        const date = new Date(visit.completion_date || visit.start_date);
                                        const dateStr = date.toLocaleDateString('tr-TR');
                                        const resultColors = {
                                            'completed': '#28a745',
                                            'potential': '#ffc107',
                                            'negative': '#dc3545'
                                        };
                                        const color = resultColors.completed;
                                        return `
                                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${color};">
                                                <div>
                                                    <strong>${visit.customer_name || visit.title}</strong>
                                                    <div style="font-size: 0.875rem; color: #666;">${dateStr} - <span style="color: ${color};">Tamamlandı</span></div>
                                                    <div style="font-size: 0.75rem; color: #999;">${visit.completion_notes || visit.description}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || '<p style="color: #666; text-align: center; padding: 1rem;">Son ziyaret yok.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Randevu sayfası yüklenemedi:', error);
            }
        }
        
        async function showAccounting() {
            try {
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>💰 Cari Hesap Takibi</h2>
                        <p style="color: #666; margin-bottom: 1.5rem;">Müşterilerinizin cari hesap durumlarını görüntüleyebilirsiniz.</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            ${customers.map(customer => `
                                <div class="customer-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white;">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                        <div>
                                            <h4 style="margin-bottom: 0.5rem;">${customer.company_name}</h4>
                                            <p style="color: #666; font-size: 0.875rem;">Yetkili: ${customer.contact_person || '-'}</p>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Toplam Borç</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: #dc3545;">${(Math.random() * 50000 + 10000).toFixed(0)} ₺</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Toplam Alacak</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: #28a745;">${(Math.random() * 30000 + 5000).toFixed(0)} ₺</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Bakiye</div>
                                            <div style="font-size: 1.25rem; font-weight: 600; color: ${Math.random() > 0.5 ? '#dc3545' : '#28a745'};">${(Math.random() * 20000 - 10000).toFixed(0)} ₺</div>
                                        </div>
                                        <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">Vade Durumu</div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: ${Math.random() > 0.7 ? '#dc3545' : '#28a745'};">${Math.random() > 0.7 ? 'Vadesi Geçmiş' : 'Normal'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <button class="btn" onclick="viewAccountDetail(${customer.id})" style="background: #007bff; font-size: 0.875rem;">📊 Detay Görüntüle</button>
                                        <button class="btn" onclick="viewAccountHistory(${customer.id})" style="background: #6c757d; font-size: 0.875rem;">📋 Hareket Geçmişi</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Cari hesap sayfası yüklenemedi:', error);
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <h2>💰 Cari Hesap</h2>
                        <p style="color: #dc3545;">Cari hesap bilgileri yüklenemedi.</p>
                    </div>
                `;
            }
        }
        
        function viewAccountDetail(customerId) {
            // Müşteri cari hesap detayını modal ile göster
            document.getElementById('content').innerHTML += `
                <div id="accountDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeModal('accountDetailModal')">&times;</span>
                        <h3>📊 Cari Hesap Detayı</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Toplam Satış</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #007bff;">${(Math.random() * 100000 + 50000).toFixed(0)} ₺</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Ödenen Tutar</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #28a745;">${(Math.random() * 80000 + 40000).toFixed(0)} ₺</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Kalan Borç</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #dc3545;">${(Math.random() * 20000 + 10000).toFixed(0)} ₺</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 0.875rem; color: #666; margin-bottom: 0.5rem;">Ortalama Vade</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #6c757d;">${Math.floor(Math.random() * 30 + 15)} gün</div>
                            </div>
                        </div>
                        
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem;">
                            <h4>Son Hareketler</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;">Tarih</th>
                                            <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #e2e8f0;">İşlem</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">Borç</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">Alacak</th>
                                            <th style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #e2e8f0;">Bakiye</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Array.from({length: 10}, (_, i) => {
                                            const isDebit = Math.random() > 0.5;
                                            const amount = (Math.random() * 5000 + 1000).toFixed(0);
                                            const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toLocaleDateString('tr-TR');
                                            return `
                                                <tr>
                                                    <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9;">${date}</td>
                                                    <td style="padding: 0.5rem; border-bottom: 1px solid #f1f5f9;">${isDebit ? 'Satış Faturası' : 'Tahsilat'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; color: #dc3545;">${isDebit ? amount + ' ₺' : '-'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; color: #28a745;">${!isDebit ? amount + ' ₺' : '-'}</td>
                                                    <td style="padding: 0.5rem; text-align: right; border-bottom: 1px solid #f1f5f9; font-weight: 600;">${(Math.random() * 20000 - 10000).toFixed(0)} ₺</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1rem;">
                            <button onclick="closeModal('accountDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function viewAccountHistory(customerId) {
            alert('Hareket geçmişi görüntüleme özelliği yakında eklenecek.');
        }
        
        function showNewVisit() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    loadNearbyBusinesses(lat, lng);
                }, function(error) {
                    alert('Konum bilgisi alınamadı. Lütfen konum izni verin.');
                    loadNearbyBusinesses(41.0082, 28.9784); // İstanbul varsayılan
                });
            } else {
                alert('Tarayıcınız konum desteği sağlamıyor.');
                loadNearbyBusinesses(41.0082, 28.9784);
            }
        }
        
        async function loadNearbyBusinesses(lat, lng) {
            let nearbyBusinesses = [];
            
            try {
                const radius = 1000;
                const query = `[out:json][timeout:25];(node["amenity"~"^(restaurant|cafe|bar|fast_food)$"](around:${radius},${lat},${lng});node["shop"~"^(bakery|convenience)$"](around:${radius},${lat},${lng});node["tourism"~"^(hotel)$"](around:${radius},${lat},${lng}););out geom;`;
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                const data = await response.json();
                nearbyBusinesses = data.elements.map((element, index) => {
                    const distance = calculateDistance(lat, lng, element.lat, element.lon);
                    const name = element.tags.name || `İşletme ${index + 1}`;
                    const type = getBusinessType(element.tags);
                    const address = formatAddress(element.tags);
                    
                    return {
                        id: element.id,
                        name: name,
                        type: type,
                        address: address,
                        distance: `${Math.round(distance)}m`,
                        lat: element.lat,
                        lng: element.lon
                    };
                }).sort((a, b) => parseInt(a.distance) - parseInt(b.distance)).slice(0, 15);
            } catch (error) {
                console.error('API hatası:', error);
            }
            
            if (nearbyBusinesses.length === 0) {
                nearbyBusinesses = [
                    { id: 'f1', name: 'Yerel Restaurant', type: 'Restaurant', address: 'Mevcut konum yakını', distance: '100m', lat: lat + 0.001, lng: lng + 0.001 },
                    { id: 'f2', name: 'Mahalle Kahvesi', type: 'Cafe', address: 'Mevcut konum yakını', distance: '200m', lat: lat - 0.001, lng: lng + 0.001 }
                ];
            }
            
            // Global array'i güncelle
            currentBusinesses = nearbyBusinesses;
            
            document.getElementById('content').innerHTML = `
                <div class="card">
                    <h2>🆕 Yeni Ziyaret - Yakındaki İşletmeler</h2>
                    <p style="color: #666; margin-bottom: 1.5rem;">Mevcut konumunuza yakın işletmeleri seçerek yeni müşteri kaydı oluşturabilirsiniz.</p>
                    
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2rem;">📍</span>
                        <span>Konum: ${lat.toFixed(4)}, ${lng.toFixed(4)} - ${nearbyBusinesses.length} işletme bulundu</span>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        ${nearbyBusinesses.map((business, index) => {
                            const cleanName = String(business.name).replace(/'/g, '&#39;');
                            const cleanAddress = String(business.address).replace(/'/g, '&#39;');
                            const cleanType = String(business.type).replace(/'/g, '&#39;');
                            
                            return `
                                <div class="business-card" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;" 
                                     data-business-id="${business.id}" data-index="${index}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 style="margin-bottom: 0.5rem; color: #2d3748;">${cleanName}</h4>
                                            <p style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">🏢 ${cleanType}</p>
                                            <p style="color: #666; font-size: 0.875rem; margin-bottom: 0.25rem;">📍 ${cleanAddress}</p>
                                            <p style="color: #007bff; font-size: 0.875rem; font-weight: 600;">🚶 ${business.distance}</p>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            <button class="btn visit-btn" data-index="${index}" style="background: #28a745; padding: 0.5rem 1rem; font-size: 0.875rem;">👥 Ziyaret Et</button>
                                            <button class="btn map-btn" data-lat="${business.lat}" data-lng="${business.lng}" style="background: #6c757d; padding: 0.25rem 0.5rem; font-size: 0.75rem;">🗺️ Harita</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 2rem; text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 1rem;">Listede olmayan bir işletme mi ziyaret edeceksiniz?</p>
                        <button class="btn" onclick="openManualBusinessEntry()" style="background: #fd7e14;">➕ Manuel İşletme Ekle</button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                setupBusinessEventListeners();
            }, 100);
        }
        
        function selectBusiness(id, name, type, address, lat, lng) {
            const cleanName = String(name).replace(/'/g, '');
            const cleanAddress = String(address).replace(/'/g, '');
            
            document.getElementById('map_company_name').value = cleanName;
            document.getElementById('map_address').value = cleanAddress;
            document.getElementById('map_lat').value = lat;
            document.getElementById('map_lng').value = lng;
            document.getElementById('newCustomerFromMapModal').style.display = 'block';
        }
        
        function viewOnMap(lat, lng) {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        }
        
        let currentBusinesses = [];
        
        function setupBusinessEventListeners() {
            document.querySelectorAll('.visit-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.dataset.index);
                    const business = currentBusinesses[index];
                    if (business) {
                        selectBusiness(business.id, business.name, business.type, business.address, business.lat, business.lng);
                    }
                });
            });
            
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    viewOnMap(lat, lng);
                });
            });
        }
        
        function openManualBusinessEntry() {
            document.getElementById('map_company_name').value = '';
            document.getElementById('map_address').value = '';
            document.getElementById('map_lat').value = '';
            document.getElementById('map_lng').value = '';
            document.getElementById('newCustomerFromMapModal').style.display = 'block';
        }
        
        document.getElementById('visit_result').addEventListener('change', function() {
            const result = this.value;
            const nextActionSection = document.getElementById('nextActionSection');
            
            if (result === 'potential') {
                nextActionSection.style.display = 'block';
            } else {
                nextActionSection.style.display = 'none';
            }
        });
        
        document.getElementById('next_action').addEventListener('change', function() {
            const action = this.value;
            const dateSection = document.getElementById('nextDateSection');
            const timeSection = document.getElementById('nextTimeSection');
            
            if (action) {
                dateSection.style.display = 'block';
                timeSection.style.display = 'block';
            } else {
                dateSection.style.display = 'none';
                timeSection.style.display = 'none';
            }
        });
        
        document.getElementById('newCustomerFromMapForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                company_name: document.getElementById('map_company_name').value,
                contact_person: document.getElementById('map_contact_person').value,
                phone: document.getElementById('map_phone').value,
                email: document.getElementById('map_email').value,
                address: document.getElementById('map_address').value,
                assigned_sales_rep: 1,
                latitude: document.getElementById('map_lat').value,
                longitude: document.getElementById('map_lng').value
            };
            
            const visitData = {
                visit_note: document.getElementById('visit_note').value,
                visit_result: document.getElementById('visit_result').value,
                next_action: document.getElementById('next_action').value,
                next_date: document.getElementById('next_date').value,
                next_time: document.getElementById('next_time').value
            };
            
            try {
                // Simulate customer creation
                const customerId = Math.floor(Math.random() * 1000) + 100;
                
                if (visitData.visit_result === 'positive') {
                    // Sipariş oluşturma modalını aç
                    document.getElementById('quick_customer_id').value = customerId;
                    document.getElementById('quick_customer_name').value = formData.company_name;
                    closeModal('newCustomerFromMapModal');
                    document.getElementById('quickOrderModal').style.display = 'block';
                } else {
                    alert(`Müşteri kaydı oluşturuldu! Ziyaret sonucu: ${visitData.visit_result === 'potential' ? 'Potansiyel' : 'Olumsuz'}`);
                    
                    if (visitData.next_action && visitData.next_date) {
                        try {
                            const appointmentData = {
                                title: `${visitData.next_action} - ${formData.company_name}`,
                                description: `Yeni ziyaret sonrası planlanan ${visitData.next_action}`,
                                type: visitData.next_action,
                                priority: 'medium',
                                start_date: visitData.next_date,
                                start_time: visitData.next_time || '09:00',
                                assigned_to: currentUser.id,
                                customer_id: customerId,
                                location: formData.company_name,
                                address: formData.address
                            };
                            
                            console.log('Randevu verisi gönderiliyor:', appointmentData);
                            
                            await apiCall('/api/appointments', {
                                method: 'POST',
                                body: JSON.stringify(appointmentData)
                            });
                            
                            alert(`Randevu başarıyla planlandı: ${visitData.next_date} ${visitData.next_time || '09:00'}`);
                        } catch (error) {
                            console.error('Randevu kaydedilemedi:', error);
                            alert(`Müşteri kaydedildi ancak randevu kaydedilemedi: ${error.message}`);
                        }
                    }
                    
                    document.getElementById('newCustomerFromMapForm').reset();
                    closeModal('newCustomerFromMapModal');
                    showNewVisit();
                }
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        document.getElementById('quickOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                customer_id: document.getElementById('quick_customer_id').value,
                total_amount: document.getElementById('quick_amount').value,
                delivery_date: document.getElementById('quick_delivery_date').value,
                notes: document.getElementById('quick_notes').value,
                order_date: new Date().toISOString().split('T')[0]
            };
            
            try {
                const orderNumber = 'SP' + Date.now().toString().slice(-6);
                alert(`Sipariş başarıyla oluşturuldu! Sipariş No: ${orderNumber}`);
                
                document.getElementById('quickOrderForm').reset();
                closeModal('quickOrderModal');
                showNewVisit();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lng2-lng1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function getBusinessType(tags) {
            if (tags.amenity) {
                const types = {
                    'restaurant': 'Restaurant',
                    'cafe': 'Cafe',
                    'bar': 'Bar',
                    'fast_food': 'Fast Food'
                };
                return types[tags.amenity] || 'Restaurant';
            }
            if (tags.shop) {
                const types = {
                    'bakery': 'Fırın',
                    'convenience': 'Market'
                };
                return types[tags.shop] || 'Mağaza';
            }
            if (tags.tourism === 'hotel') return 'Otel';
            return 'İşletme';
        }
        
        function formatAddress(tags) {
            const parts = [];
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:housenumber']) parts.push('No:' + tags['addr:housenumber']);
            if (tags['addr:neighbourhood']) parts.push(tags['addr:neighbourhood']);
            
            return parts.length > 0 ? parts.join(' ') : 'Adres bilgisi yok';
        }
        
        function completeAppointment(id) {
            if (confirm('Randevu tamamlandı olarak işaretlensin mi?')) {
                alert('Randevu tamamlandı!');
                showDashboard();
            }
        }

        // Müşteri yönetimi fonksiyonları
        function openCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'Yeni Müşteri';
            document.getElementById('customerSubmitBtn').textContent = 'Kaydet';
            document.getElementById('customerForm').reset();
            document.getElementById('customer_edit_id').value = '';
            document.getElementById('customerModal').style.display = 'block';
        }

        async function editCustomer(customerId) {
            try {
                const customer = await apiCall(`/api/customers/${customerId}`);
                
                document.getElementById('customerModalTitle').textContent = 'Müşteri Düzenle';
                document.getElementById('customerSubmitBtn').textContent = 'Güncelle';
                document.getElementById('customer_edit_id').value = customerId;
                document.getElementById('company_name').value = customer.customer.company_name || '';
                document.getElementById('contact_person').value = customer.customer.contact_person || '';
                document.getElementById('customer_phone').value = customer.customer.phone || '';
                document.getElementById('customer_email').value = customer.customer.email || '';
                document.getElementById('customer_address').value = customer.customer.address || '';
                
                document.getElementById('customerModal').style.display = 'block';
            } catch (error) {
                alert('Müşteri bilgileri yüklenemedi: ' + error.message);
            }
        }

        async function openDeliveryNoteModal() {
            try {
                const numberResponse = await apiCall('/api/delivery-notes/generate-number');
                document.getElementById('delivery_number').value = numberResponse.delivery_number;
                
                const customersResponse = await apiCall('/api/customers');
                const customers = customersResponse.customers || [];
                
                const customerSelect = document.getElementById('delivery_customer_id');
                customerSelect.innerHTML = '<option value="">Müşteri Seçiniz</option>';
                customers.forEach(customer => {
                    customerSelect.innerHTML += `<option value="${customer.id}">${customer.company_name}</option>`;
                });
                
                document.getElementById('delivery_date').value = new Date().toISOString().split('T')[0];
                document.getElementById('delivery_time').value = '14:00';
                document.getElementById('deliveryNoteModal').style.display = 'block';
            } catch (error) {
                alert('Modal açılamadı: ' + error.message);
            }
        }
        
        document.getElementById('deliveryNoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                delivery_number: document.getElementById('delivery_number').value,
                customer_id: document.getElementById('delivery_customer_id').value,
                delivery_date: document.getElementById('delivery_date').value,
                delivery_time: document.getElementById('delivery_time').value,
                delivery_address: document.getElementById('delivery_address').value,
                notes: document.getElementById('delivery_notes').value
            };
            
            try {
                await apiCall('/api/delivery-notes', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                alert('İrsaliye oluşturuldu!');
                document.getElementById('deliveryNoteForm').reset();
                closeModal('deliveryNoteModal');
                showDeliveryNotes();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });
        
        async function viewDeliveryNote(id) {
            try {
                const response = await apiCall(`/api/delivery-notes/${id}`);
                const dn = response.delivery_note;
                
                const statusNames = {
                    'pending': 'Hazırlanıyor',
                    'in_transit': 'Yolda', 
                    'delivered': 'Teslim Edildi'
                };
                
                document.getElementById('deliveryDetailContent').innerHTML = `
                    <h3>🚚 İrsaliye Detayı</h3>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div><strong>İrsaliye No:</strong> ${dn.delivery_number}</div>
                            <div><strong>Durum:</strong> ${statusNames[dn.status] || dn.status}</div>
                            <div><strong>Müşteri:</strong> ${dn.customer_name || 'Bilinmiyor'}</div>
                            <div><strong>Tarih:</strong> ${new Date(dn.delivery_date).toLocaleDateString('tr-TR')}</div>
                        </div>
                        ${dn.notes ? `<div style="margin-top: 1rem;"><strong>Notlar:</strong><br>${dn.notes}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin: 1rem 0;">
                        ${dn.status === 'pending' ? `<button onclick="startDelivery(${dn.id})" class="btn" style="background: #ffc107;">🚚 Gönder</button>` : ''}
                        ${dn.status === 'in_transit' ? `<button onclick="completeDelivery(${dn.id})" class="btn" style="background: #28a745;">✅ Teslim Et</button>` : ''}
                    </div>
                    <div style="text-align: center;">
                        <button onclick="closeModal('deliveryDetailModal')" class="btn" style="background: #6c757d;">Kapat</button>
                    </div>
                `;
                
                document.getElementById('deliveryDetailModal').style.display = 'block';
            } catch (error) {
                alert('Detay yüklenemedi: ' + error.message);
            }
        }
        
        async function startDelivery(id) {
            if (confirm('İrsaliye gönderiye başlatılsın mı?')) {
                try {
                    await apiCall(`/api/delivery-notes/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'in_transit' })
                    });
                    alert('İrsaliye yola çıktı!');
                    closeModal('deliveryDetailModal');
                    showDeliveryNotes();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        async function completeDelivery(id) {
            const customerName = prompt('Teslim alan kişinin adı:');
            if (customerName) {
                try {
                    await apiCall(`/api/delivery-notes/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            status: 'delivered',
                            customer_name: customerName,
                            signature_date: new Date().toISOString()
                        })
                    });
                    alert('İrsaliye teslim edildi!');
                    closeModal('deliveryDetailModal');
                    showDeliveryNotes();
                } catch (error) {
                    alert('Hata: ' + error.message);
                }
            }
        }
        
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        function updateUserInfo() {
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.innerHTML = `
                    <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">Satış Dashboard</div>
                    <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Hoş geldiniz, ${currentUser.full_name}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">
                        ${new Date().toLocaleDateString('tr-TR')} - ${new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                `;
            }
        }
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }
        
        // Menü linklerine tıklandığında mobil menüyü kapat
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', closeMobileMenu);
        });
        
        showDashboard();
        
        setTimeout(() => {
            updateUserInfo();
        }, 100);
        
        setInterval(updateUserInfo, 60000);
    </script>
    <div id="userInfo" style="position: fixed; bottom: 1rem; left: 1rem; background: rgba(40, 167, 69, 0.9); padding: 0.75rem; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 180px; font-size: 0.875rem;">
        <!-- JavaScript ile doldurulacak -->
    </div>
    <script>
        async function saveAppointment() {
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const type = document.getElementById('appointmentType').value;
            const note = document.getElementById('appointmentNote').value;
            
            if (!date || !time) {
                alert('Lütfen tarih ve saat seçin!');
                return;
            }
            
            try {
                if (window.isRescheduleMode && window.rescheduleAppointmentId) {
                    const response = await apiCall(`/api/appointments/${window.rescheduleAppointmentId}`);
                    const apt = response.appointment;
                    
                    await apiCall(`/api/appointments/${window.rescheduleAppointmentId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...apt,
                            start_date: date,
                            start_time: time,
                            description: note
                        })
                    });
                    
                    alert('Randevu yeniden planlandı!');
                    window.isRescheduleMode = false;
                    window.rescheduleAppointmentId = null;
                } else if (window.isFollowUpMode && window.followUpCustomerId) {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: `Takip Randevusu - ${window.followUpCustomerName}`,
                            description: note,
                            type: type,
                            priority: 'medium',
                            start_date: date,
                            start_time: time,
                            assigned_to: currentUser.id,
                            customer_id: window.followUpCustomerId,
                            location: window.followUpCustomerName
                        })
                    });
                    
                    alert('Takip randevusu oluşturuldu!');
                    window.isFollowUpMode = false;
                    window.followUpCustomerId = null;
                    window.followUpCustomerName = null;
                } else {
                    await apiCall('/api/appointments', {
                        method: 'POST',
                        body: JSON.stringify({
                            title: `${type} - ${note || 'Randevu'}`,
                            description: note,
                            type: type,
                            priority: 'medium',
                            start_date: date,
                            start_time: time,
                            assigned_to: currentUser.id
                        })
                    });
                    
                    alert('Randevu başarıyla kaydedildi!');
                }
                
                closeModal('appointmentModal');
                showAppointments();
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        }
    </script>
</body>
</html>