<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şirket Ayarları - Saha CRM</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .logo-preview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 1rem;
            border: 1px solid var(--border);
            padding: 0.5rem;
            border-radius: 8px;
        }
        .favicon-preview {
            width: 32px;
            height: 32px;
            margin-top: 1rem;
            border: 1px solid var(--border);
            padding: 0.25rem;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" style="background: #007bff; position: fixed; width: 280px; height: 100vh; overflow-y: auto;">
            <h3 style="color: white; padding: 0 1.5rem; margin-bottom: 1rem;">Ayarlar</h3>
            <ul style="list-style: none; padding: 0 1.5rem;">
                <li><a href="company-settings.html" style="color: white; font-weight: bold; background: rgba(255,255,255,0.1); text-decoration: none; display: block; padding: 0.75rem 1rem; border-radius: 8px;">🏢 Şirket Ayarları</a></li>
                <li><a href="mail-settings.html" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.75rem 1rem;">📧 Mail Ayarları</a></li>
                <li><a href="setup.html" style="color: rgba(255,255,255,0.9); text-decoration: none; display: block; padding: 0.75rem 1rem;">🔧 Sistem Kurulumu</a></li>
                <li style="margin-top: 2rem;"><a href="/admin.html" class="btn" style="width: 100%; text-align: center; background: rgba(255,255,255,0.2);">← Admin Paneline Dön</a></li>
            </ul>
        </div>
        <div class="content" style="margin-left: 280px;">
            <div class="card">
                <h2>🏢 Şirket Ayarları</h2>
                <p style="color: var(--text-light); margin-top: -0.5rem; margin-bottom: 2rem;">Şirket bilgilerinizi ve logonuzu buradan güncelleyebilirsiniz.</p>
                
                <form id="companySettingsForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="company_name">Şirket Adı</label>
                            <input type="text" id="company_name" name="company_name">
                        </div>
                        <div class="form-group">
                            <label for="email">E-posta</label>
                            <input type="email" id="email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="phone">Telefon</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="website">Web Sitesi</label>
                            <input type="url" id="website" name="website" placeholder="https://www.example.com">
                        </div>
                        <div class="form-group">
                            <label for="tax_office">Vergi Dairesi</label>
                            <input type="text" id="tax_office" name="tax_office">
                        </div>
                        <div class="form-group">
                            <label for="tax_number">Vergi Numarası</label>
                            <input type="text" id="tax_number" name="tax_number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address">Adres</label>
                        <textarea id="address" name="address" rows="3"></textarea>
                    </div>

                    <div class="form-grid" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <div class="form-group">
                            <label for="logo">Şirket Logosu</label>
                            <input type="file" id="logo" name="logo" accept="image/png, image/jpeg, image/svg+xml">
                            <img id="logoPreview" src="" alt="Logo Önizleme" class="logo-preview" style="display: none;">
                            <input type="hidden" id="existing_logo_url" name="existing_logo_url">
                        </div>
                        <div class="form-group">
                            <label for="favicon">Favicon</label>
                            <input type="file" id="favicon" name="favicon" accept="image/x-icon, image/png">
                            <img id="faviconPreview" src="" alt="Favicon Önizleme" class="favicon-preview" style="display: none;">
                            <input type="hidden" id="existing_favicon_url" name="existing_favicon_url">
                        </div>
                    </div>

                    <button type="submit" class="btn">Ayarları Kaydet</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            window.location.href = '/';
        }

        async function apiCall(url, options = {}) {
            const defaultHeaders = {
                'Authorization': `Bearer ${authToken}`
            };
            // FormData için Content-Type'ı tarayıcıya bırak
            if (!(options.body instanceof FormData)) {
                defaultHeaders['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(url, {
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'API hatası');
            }
            return response.json();
        }

        async function loadSettings() {
            try {
                const response = await apiCall('/api/company-settings');
                const settings = response.settings;
                if (settings) {
                    document.getElementById('company_name').value = settings.company_name || '';
                    document.getElementById('address').value = settings.address || '';
                    document.getElementById('phone').value = settings.phone || '';
                    document.getElementById('email').value = settings.email || '';
                    document.getElementById('website').value = settings.website || '';
                    document.getElementById('tax_office').value = settings.tax_office || '';
                    document.getElementById('tax_number').value = settings.tax_number || '';
                    
                    if (settings.logo_url) {
                        document.getElementById('logoPreview').src = settings.logo_url;
                        document.getElementById('logoPreview').style.display = 'block';
                        document.getElementById('existing_logo_url').value = settings.logo_url;
                    }
                    if (settings.favicon_url) {
                        document.getElementById('faviconPreview').src = settings.favicon_url;
                        document.getElementById('faviconPreview').style.display = 'block';
                        document.getElementById('existing_favicon_url').value = settings.favicon_url;
                    }
                }
            } catch (error) {
                console.error('Ayarlar yüklenemedi:', error);
                alert('Ayarlar yüklenemedi: ' + error.message);
            }
        }

        document.getElementById('companySettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const result = await apiCall('/api/company-settings', {
                    method: 'POST',
                    body: formData
                });
                alert(result.message || 'Ayarlar başarıyla güncellendi!');
                loadSettings(); // Verileri yenile
            } catch (error) {
                alert('Hata: ' + error.message);
            }
        });

        window.onload = loadSettings;
    </script>
</body>
</html>
