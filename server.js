require("dotenv").config();
const express = require("express");
const cors = require("cors");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const { Pool } = require("pg");
const path = require("path");

const app = express();
app.use(cors());
app.use(express.json());

// ---------------- STATƒ∞K DOSYALAR ---------------- //
app.use(express.static(path.join(__dirname, "public")));
app.get("/admin", (req, res) => {
  res.sendFile(path.join(__dirname, "public", "admin.html"));
});

// ---------------- POSTGRESQL BAƒûLANTI ---------------- //
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

// Baƒülantƒ±yƒ± test et
pool.connect()
  .then(() => console.log("‚úÖ PostgreSQL baƒülantƒ±sƒ± ba≈üarƒ±lƒ±"))
  .catch(err => console.error("‚ùå PostgreSQL baƒülantƒ± hatasƒ±:", err));

// ---------------- TEST ---------------- //
app.get("/", (req, res) => {
  res.send("Saha CRM Sistemi √áalƒ±≈üƒ±yor üöÄ (Postgres)");
});

// ---------------- AUTH ---------------- //
app.post("/api/register", async (req, res) => {
  try {
    console.log("Register isteƒüi geldi:", req.body);
    const { username, password, full_name, email, role_id, department_id } = req.body;
    
    // Kullanƒ±cƒ± kontrol√º
    const existingUser = await pool.query("SELECT * FROM users WHERE username = $1", [username]);
    console.log("Register kontrol sonucu:", existingUser.rows.length);

    if (existingUser.rows.length > 0) {
      return res.status(400).json({ error: "Kullanƒ±cƒ± zaten mevcut" });
    }

    // ≈ûifreyi hash'le
    const hashedPassword = await bcrypt.hash(password, 10);
    
    // Yeni kullanƒ±cƒ± ekle
    await pool.query(
      "INSERT INTO users (username, password_hash, full_name, email, role_id, department_id, is_active) VALUES ($1, $2, $3, $4, $5, $6, $7)",
      [username, hashedPassword, full_name || username, email, role_id || 1, department_id || 1, true]
    );

    console.log("Yeni kullanƒ±cƒ± eklendi:", username);
    res.json({ success: true, message: "Kullanƒ±cƒ± ba≈üarƒ±yla eklendi" });
  } catch (err) {
    console.error("Register hatasƒ±:", err);
    res.status(500).json({ error: "Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu" });
  }
});

// ---------------- DEBUG LOGIN ENDPOINT ---------------- //
app.post("/api/login", async (req, res) => {
  try {
    console.log("üîç DEBUG - Login isteƒüi geldi:", req.body);
    const { username, password } = req.body;
    
    // √ñnce kullanƒ±cƒ±yƒ± basit sorgu ile ara
    console.log("üîç DEBUG - Kullanƒ±cƒ± aranƒ±yor:", username);
    const simpleResult = await pool.query("SELECT * FROM users WHERE username = $1", [username]);
    console.log("üîç DEBUG - Basit sorgu sonucu:", simpleResult.rows.length);
    
    if (simpleResult.rows.length > 0) {
      const user = simpleResult.rows[0];
      console.log("üîç DEBUG - Bulunan kullanƒ±cƒ±:");
      console.log("  - ID:", user.id);
      console.log("  - Username:", user.username);
      console.log("  - Password Hash:", user.password_hash ? user.password_hash.substring(0, 20) + "..." : "NULL");
      console.log("  - Hash Length:", user.password_hash ? user.password_hash.length : 0);
      console.log("  - Is Active:", user.is_active);
      console.log("  - Role ID:", user.role_id);
      console.log("  - Department ID:", user.department_id);
    }
    
    // Orijinal karma≈üƒ±k sorgu
    const result = await pool.query(
      `SELECT u.*, r.name as role_name, d.name as department_name 
       FROM users u 
       LEFT JOIN roles r ON u.role_id = r.id 
       LEFT JOIN departments d ON u.department_id = d.id 
       WHERE u.username = $1 AND u.is_active = true`,
      [username]
    );
    
    console.log("üîç DEBUG - Karma≈üƒ±k sorgu sonucu:", result.rows.length);
    
    if (result.rows.length === 0) {
      console.log("‚ùå DEBUG - Kullanƒ±cƒ± bulunamadƒ± (karma≈üƒ±k sorgu)");
      
      // is_active = false mi kontrol et
      const inactiveCheck = await pool.query("SELECT * FROM users WHERE username = $1 AND is_active = false", [username]);
      if (inactiveCheck.rows.length > 0) {
        console.log("‚ùå DEBUG - Kullanƒ±cƒ± inactive durumda!");
      }
      
      // Roles tablosunu kontrol et
      const rolesCheck = await pool.query("SELECT * FROM roles WHERE id = 1");
      console.log("üîç DEBUG - Role ID 1 mevcut mu:", rolesCheck.rows.length > 0);
      
      // Departments tablosunu kontrol et
      const deptCheck = await pool.query("SELECT * FROM departments WHERE id = 1");
      console.log("üîç DEBUG - Department ID 1 mevcut mu:", deptCheck.rows.length > 0);
      
      return res.status(401).json({ error: "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±" });
    }

    const user = result.rows[0];
    console.log("‚úÖ DEBUG - Kullanƒ±cƒ± bulundu, ≈üifre kontrol ediliyor...");
    console.log("üîç DEBUG - Girilen ≈üifre:", password);
    console.log("üîç DEBUG - DB Hash (ilk 30 karakter):", user.password_hash ? user.password_hash.substring(0, 30) : "NULL");
    
    // ≈ûifre kontrol√º
    if (!user.password_hash) {
      console.log("‚ùå DEBUG - Password hash NULL!");
      return res.status(401).json({ error: "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±" });
    }
    
    console.log("üîç DEBUG - bcrypt.compare ba≈ülatƒ±lƒ±yor...");
    const isMatch = await bcrypt.compare(password, user.password_hash);
    console.log("üéØ DEBUG - ≈ûifre e≈üle≈üme sonucu:", isMatch);
    
    if (!isMatch) {
      console.log("‚ùå DEBUG - ≈ûifre e≈üle≈ümedi");
      
      // Manuel test hash ile kontrol et
      const testHash = '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi';
      const testMatch = await bcrypt.compare('1234', testHash);
      console.log("üß™ DEBUG - Test hash ile '1234' e≈üle≈ümesi:", testMatch);
      
      return res.status(401).json({ error: "Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±" });
    }

    // JWT token olu≈ütur
    const token = jwt.sign(
      { 
        userId: user.id, 
        username: user.username,
        role: user.role_name || 'user',
        department: user.department_name
      },
      process.env.JWT_SECRET || "fallback_secret_key_change_in_production",
      { expiresIn: "24h" }
    );

    console.log("‚úÖ DEBUG - Login ba≈üarƒ±lƒ±:", username);
    res.json({ 
      success: true,
      token,
      user: {
        id: user.id,
        username: user.username,
        full_name: user.full_name,
        email: user.email,
        role: user.role_name || 'user',
        department: user.department_name
      }
    });
  } catch (err) {
    console.error("üí• DEBUG - Login hatasƒ±:", err);
    res.status(500).json({ error: "Giri≈ü sƒ±rasƒ±nda sunucu hatasƒ± olu≈ütu: " + err.message });
  }
});

// ---------------- JWT MIDDLEWARE ---------------- //
const authenticateToken = (req, res, next) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'Access token gerekli' });
  }

  jwt.verify(token, process.env.JWT_SECRET || "fallback_secret_key_change_in_production", (err, user) => {
    if (err) {
      return res.status(403).json({ error: 'Ge√ßersiz token' });
    }
    req.user = user;
    next();
  });
};

// ---------------- USER PROFILE ---------------- //
app.get("/api/profile", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT u.id, u.username, u.full_name, u.email, u.phone, 
              r.name as role_name, d.name as department_name
       FROM users u 
       LEFT JOIN roles r ON u.role_id = r.id 
       LEFT JOIN departments d ON u.department_id = d.id 
       WHERE u.id = $1`,
      [req.user.userId]
    );
    
    if (result.rows.length === 0) {
      return res.status(404).json({ error: 'Kullanƒ±cƒ± bulunamadƒ±' });
    }
    
    res.json(result.rows[0]);
  } catch (err) {
    console.error("Profile hatasƒ±:", err);
    res.status(500).json({ error: "Profil bilgileri alƒ±namadƒ±" });
  }
});

// ---------------- √úR√úNLER ---------------- //
app.get("/api/products", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query("SELECT * FROM products ORDER BY id DESC");
    res.json(result.rows);
  } catch (err) {
    console.error("√úr√ºnler alƒ±namadƒ±:", err);
    res.status(500).json({ error: "√úr√ºnler alƒ±namadƒ±" });
  }
});

app.post("/api/products", authenticateToken, async (req, res) => {
  try {
    const { name, price, description, category } = req.body;
    if (!name || !price) {
      return res.status(400).json({ error: "√úr√ºn adƒ± ve fiyat zorunlu" });
    }
    
    await pool.query(
      "INSERT INTO products (name, price, description, category) VALUES ($1, $2, $3, $4)",
      [name, parseFloat(price), description || '', category || 'Genel']
    );
    
    res.json({ success: true, message: "√úr√ºn ba≈üarƒ±yla eklendi" });
  } catch (err) {
    console.error("√úr√ºn eklenemedi:", err);
    res.status(500).json({ error: "√úr√ºn eklenemedi" });
  }
});

// ---------------- Sƒ∞PARƒ∞≈ûLER ---------------- //
app.get("/api/orders", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query(
      `SELECT o.*, p.name as product_name, c.name as customer_name
       FROM orders o 
       LEFT JOIN products p ON o.product_id = p.id 
       LEFT JOIN customers c ON o.customer_id = c.id
       ORDER BY o.created_at DESC`
    );
    res.json(result.rows);
  } catch (err) {
    console.error("Sipari≈üler alƒ±namadƒ±:", err);
    res.status(500).json({ error: "Sipari≈üler alƒ±namadƒ±" });
  }
});

app.post("/api/orders", authenticateToken, async (req, res) => {
  try {
    const { customer_id, product_id, quantity, notes } = req.body;
    if (!customer_id || !product_id || !quantity) {
      return res.status(400).json({ error: "M√º≈üteri, √ºr√ºn ve miktar zorunlu" });
    }
    
    await pool.query(
      "INSERT INTO orders (customer_id, product_id, quantity, notes, status, created_by) VALUES ($1, $2, $3, $4, $5, $6)",
      [customer_id, product_id, parseInt(quantity), notes || '', 'pending', req.user.userId]
    );
    
    res.json({ success: true, message: "Sipari≈ü ba≈üarƒ±yla eklendi" });
  } catch (err) {
    console.error("Sipari≈ü eklenemedi:", err);
    res.status(500).json({ error: "Sipari≈ü eklenemedi" });
  }
});

// ---------------- M√ú≈ûTERƒ∞LER ---------------- //
app.get("/api/customers", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query("SELECT * FROM customers ORDER BY created_at DESC");
    res.json(result.rows);
  } catch (err) {
    console.error("M√º≈üteriler alƒ±namadƒ±:", err);
    res.status(500).json({ error: "M√º≈üteriler alƒ±namadƒ±" });
  }
});

app.post("/api/customers", authenticateToken, async (req, res) => {
  try {
    const { name, phone, email, address, company } = req.body;
    if (!name) {
      return res.status(400).json({ error: "M√º≈üteri adƒ± zorunlu" });
    }
    
    await pool.query(
      "INSERT INTO customers (name, phone, email, address, company) VALUES ($1, $2, $3, $4, $5)",
      [name, phone || '', email || '', address || '', company || '']
    );
    
    res.json({ success: true, message: "M√º≈üteri ba≈üarƒ±yla eklendi" });
  } catch (err) {
    console.error("M√º≈üteri eklenemedi:", err);
    res.status(500).json({ error: "M√º≈üteri eklenemedi" });
  }
});

// ---------------- DASHBOARD STATS ---------------- //
app.get("/api/stats", authenticateToken, async (req, res) => {
  try {
    // Toplam sipari≈üler
    const ordersResult = await pool.query("SELECT COUNT(*) as total FROM orders");
    const totalOrders = parseInt(ordersResult.rows[0].total);

    // Toplam m√º≈üteriler
    const customersResult = await pool.query("SELECT COUNT(*) as total FROM customers");
    const totalCustomers = parseInt(customersResult.rows[0].total);

    // Toplam √ºr√ºnler
    const productsResult = await pool.query("SELECT COUNT(*) as total FROM products");
    const totalProducts = parseInt(productsResult.rows[0].total);

    // Bu ay sipari≈üler
    const monthlyOrdersResult = await pool.query(
      "SELECT COUNT(*) as total FROM orders WHERE DATE_TRUNC('month', created_at) = DATE_TRUNC('month', CURRENT_DATE)"
    );
    const monthlyOrders = parseInt(monthlyOrdersResult.rows[0].total);

    res.json({
      totalOrders,
      totalCustomers, 
      totalProducts,
      monthlyOrders,
      totalRevenue: totalOrders * 150, // Dummy calculation
    });
  } catch (err) {
    console.error("Stats hatasƒ±:", err);
    res.json({
      totalOrders: 0,
      totalCustomers: 0,
      totalProducts: 0,
      monthlyOrders: 0,
      totalRevenue: 0
    });
  }
});

// ---------------- ROLES & DEPARTMENTS ---------------- //
app.get("/api/roles", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query("SELECT * FROM roles ORDER BY name");
    res.json(result.rows);
  } catch (err) {
    console.error("Roller alƒ±namadƒ±:", err);
    res.status(500).json({ error: "Roller alƒ±namadƒ±" });
  }
});

app.get("/api/departments", authenticateToken, async (req, res) => {
  try {
    const result = await pool.query("SELECT * FROM departments ORDER BY name");
    res.json(result.rows);
  } catch (err) {
    console.error("Departmanlar alƒ±namadƒ±:", err);
    res.status(500).json({ error: "Departmanlar alƒ±namadƒ±" });
  }
});

// ---------------- DEBUG ENDPOINTS (Ge√ßici) ---------------- //
app.post("/api/create-admin", async (req, res) => {
  try {
    console.log('üîß Admin olu≈üturuluyor...');
    
    const hashedPassword = await bcrypt.hash('1234', 10);
    console.log('üîß Hash olu≈üturuldu:', hashedPassword.substring(0, 20) + '...');
    
    // √ñnce sil
    await pool.query("DELETE FROM users WHERE username = 'admin1'");
    console.log('üîß Eski admin silindi');
    
    // Roles ve departments olu≈ütur
    await pool.query("INSERT INTO roles (id, name) VALUES (1, 'Admin') ON CONFLICT (id) DO NOTHING");
    await pool.query("INSERT INTO departments (id, name) VALUES (1, 'IT') ON CONFLICT (id) DO NOTHING");
    
    // Sonra ekle
    const result = await pool.query(
      `INSERT INTO users (username, password_hash, full_name, email, role_id, department_id, is_active) 
       VALUES ($1, $2, $3, $4, $5, $6, $7) 
       RETURNING id, username`,
      ['admin1', hashedPassword, 'Admin User', 'admin@test.com', 1, 1, true]
    );
    
    console.log('üîß Yeni admin eklendi:', result.rows[0]);
    
    res.json({ 
      success: true,
      message: 'Admin kullanƒ±cƒ± olu≈üturuldu',
      user: result.rows[0],
      credentials: {
        username: 'admin1',
        password: '1234'
      }
    });
    
  } catch (error) {
    console.error('üîß Admin olu≈üturma hatasƒ±:', error);
    res.status(500).json({ error: error.message });
  }
});

// ---------------- ERROR HANDLER ---------------- //
app.use((err, req, res, next) => {
  console.error('Sunucu hatasƒ±:', err);
  res.status(500).json({ error: 'Sunucu hatasƒ± olu≈ütu' });
});

// ---------------- 404 HANDLER ---------------- //
app.use((req, res) => {
  res.status(404).json({ error: 'Endpoint bulunamadƒ±' });
});

// ---------------- SUNUCU ---------------- //
const PORT = process.env.PORT || 10000;
app.listen(PORT, () => {
  console.log(`üöÄ Server running on port ${PORT}`);
  console.log(`üì± Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`üîê JWT Secret: ${process.env.JWT_SECRET ? '‚úÖ Tanƒ±mlƒ±' : '‚ùå Tanƒ±msƒ±z'}`);
});